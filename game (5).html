<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <!-- CRITICAL: Content Security Policy for Capacitor Android WebView -->
    <!-- This MUST be before any scripts to allow inline JavaScript and onclick handlers -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src * 'self' data: gap: https://ssl.gstatic.com blob:; 
                   style-src * 'self' 'unsafe-inline' https://fonts.googleapis.com; 
                   script-src * 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com blob:; 
                   font-src * 'self' https://fonts.gstatic.com data:;
                   img-src * 'self' data: blob: content:;
                   connect-src * 'self' ws: wss: http: https:;
                   media-src * 'self' blob: data:;">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Force landscape orientation -->
    <meta name="screen-orientation" content="landscape">
    <meta name="x5-orientation" content="landscape">
    <meta name="msapplication-orientation" content="landscape">
    <title>FootLogic - Dynasty Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CRITICAL: Capacitor Core JS - это инжектируется автоматически при сборке APK -->
    <!-- Для веб-версии используем заглушку -->
    <script>
        // Ожидаем полной загрузки DOM перед инициализацией
        document.addEventListener('DOMContentLoaded', function() {
            initCapacitorBridge();
        });
        
        function initCapacitorBridge() {
            // Capacitor initialization helper - ИСПРАВЛЕННАЯ ВЕРСИЯ
            window.CapacitorReady = new Promise((resolve) => {
                // Функция проверки Capacitor
                function checkCapacitor() {
                    if (window.Capacitor && typeof window.Capacitor.isNativePlatform === 'function') {
                        const isNative = window.Capacitor.isNativePlatform();
                        console.log('Capacitor: Detected, isNative:', isNative);
                        return isNative;
                    }
                    return null;
                }
                
                // Первая проверка
                const result = checkCapacitor();
                if (result !== null) {
                    console.log('Capacitor: Initialized immediately');
                    resolve(result);
                    return;
                }
                
                // Если Capacitor ещё не загружен, ждём его
                let attempts = 0;
                const maxAttempts = 50; // 50 * 100ms = 5 секунд макс
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    const result = checkCapacitor();
                    
                    if (result !== null) {
                        clearInterval(checkInterval);
                        console.log('Capacitor: Initialized after', attempts * 100, 'ms');
                        resolve(result);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.log('Capacitor: Not detected after timeout, running as web app');
                        resolve(false);
                    }
                }, 100);
                
                // Также слушаем Capacitor-специфичные события
                window.addEventListener('capacitorDidLoad', () => {
                    clearInterval(checkInterval);
                    console.log('Capacitor: capacitorDidLoad event fired');
                    resolve(true);
                });
            });
        }
        
        // Helper to safely get Capacitor plugins
        window.getCapacitorPlugin = function(name) {
            try {
                // Capacitor 3+ использует Capacitor.Plugins
                if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins[name]) {
                    return window.Capacitor.Plugins[name];
                }
                // Fallback для некоторых плагинов которые регистрируются глобально
                if (window[name]) {
                    return window[name];
                }
            } catch (e) {
                console.warn('Error getting Capacitor plugin:', name, e);
            }
            return null;
        };
        
        // Check if running in Capacitor native environment
        window.isCapacitorNative = function() {
            try {
                return window.Capacitor && 
                       typeof window.Capacitor.isNativePlatform === 'function' && 
                       window.Capacitor.isNativePlatform();
            } catch (e) {
                return false;
            }
        };
        
        // Функция для получения лица игрока по его ID
        // Лица лежат в папке datapack/playerface/faces/playerid.png
        // Если нет в папке, использовать nonface.png
        window.getPlayerFacePath = function(playerId) {
            return `datapack/playerface/faces/${playerId}.png`;
        };
        
        window.getPlayerFaceHTML = function(playerId, sizeClass = 'w-16 h-16 md:w-24 md:h-24') {
            const facePath = window.getPlayerFacePath(playerId);
            const defaultFace = 'datapack/playerface/faces/nonface.png';
            return `<img 
                src="${facePath}" 
                onerror="this.src='${defaultFace}'; this.onerror=null;" 
                class="${sizeClass} object-cover rounded-full player-face-img"
                alt="Player face"
            >`;
        };
        
        // ИСПРАВЛЕНО: Функция для скрытия статус бара (предотвращает появление при свайпе)
        window.hideStatusBar = async function() {
            try {
                // Пробуем использовать Capacitor StatusBar плагин
                const StatusBar = window.getCapacitorPlugin('StatusBar');
                if (StatusBar && typeof StatusBar.hide === 'function') {
                    await StatusBar.hide();
                    console.log('StatusBar hidden via Capacitor plugin');
                }
                
                // Также пробуем установить immersive mode через AndroidFullScreen если доступен
                const AndroidFullScreen = window.getCapacitorPlugin('AndroidFullScreen');
                if (AndroidFullScreen) {
                    if (typeof AndroidFullScreen.immersiveMode === 'function') {
                        await AndroidFullScreen.immersiveMode();
                        console.log('Immersive mode enabled');
                    } else if (typeof AndroidFullScreen.leanMode === 'function') {
                        await AndroidFullScreen.leanMode();
                        console.log('Lean mode enabled');
                    }
                }
                
                // Fallback для Android WebView через Navigation Bar API
                if (window.NavigationBar) {
                    try {
                        await window.NavigationBar.hide();
                    } catch (e) { /* ignore */ }
                }
            } catch (e) {
                console.warn('Could not hide status bar:', e.message);
            }
        };
        
        // ========== STORAGE MANAGER v3.0 ==========
        // Full save system using Capacitor Filesystem
        // All data saved to Documents/FootLogic/
        // Supports: careers, mods, logos, UI cache, datapack
        
        window.StorageManager = {
            initialized: false,
            basePath: 'FootLogic',
            savesDir: 'saves',
            modsDir: 'mods',
            dataDir: 'data',
            cacheDir: 'cache',
            uiDir: 'ui',
            maxSlots: 15,
            datapackCached: false,
            _directory: null,
            _isNative: false,
            _memoryCache: new Map(), // In-memory cache for faster access
            
            // Get Directory constant for Capacitor
            getDirectory: function() {
                if (this._directory) return this._directory;
                
                try {
                    // Try Capacitor 5+ Directory enum first
                    if (window.Capacitor?.Plugins?.Filesystem?.Directory) {
                        const Dir = window.Capacitor.Plugins.Filesystem.Directory;
                        if (Dir.Documents) {
                            this._directory = Dir.Documents;
                            console.log('StorageManager v3: Using Capacitor Directory.Documents');
                            return this._directory;
                        }
                        if (Dir.Data) {
                            this._directory = Dir.Data;
                            console.log('StorageManager v3: Using Capacitor Directory.Data');
                            return this._directory;
                        }
                        if (Dir.ExternalStorage) {
                            this._directory = Dir.ExternalStorage;
                            console.log('StorageManager v3: Using Capacitor Directory.ExternalStorage');
                            return this._directory;
                        }
                    }
                    
                    // Capacitor 3/4 string values
                    this._directory = 'Documents';
                    console.log('StorageManager v3: Using "Documents" string');
                    return this._directory;
                    
                } catch (e) {
                    console.warn('StorageManager v3: getDirectory error:', e);
                    this._directory = 'Documents';
                    return this._directory;
                }
            },
            
            // Check if running on native platform
            isNative: function() {
                return this._isNative || (window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform());
            },
            
            // Get Filesystem plugin
            getFilesystem: function() {
                return window.getCapacitorPlugin('Filesystem');
            },
            
            // Initialize StorageManager - creates all required directories
            init: async function() {
                if (this.initialized) return true;
                
                try {
                    // Check if native
                    if (window.CapacitorReady) {
                        this._isNative = await window.CapacitorReady;
                    }
                    
                    const Filesystem = this.getFilesystem();
                    const directory = this.getDirectory();
                    
                    if (Filesystem && this.isNative()) {
                        // Create all directories
                        const dirs = [
                            this.basePath,
                            `${this.basePath}/${this.savesDir}`,
                            `${this.basePath}/${this.modsDir}`,
                            `${this.basePath}/${this.dataDir}`,
                            `${this.basePath}/${this.dataDir}/logos`,
                            `${this.basePath}/${this.dataDir}/faces`,
                            `${this.basePath}/${this.cacheDir}`,
                            `${this.basePath}/${this.uiDir}`
                        ];
                        
                        for (const dir of dirs) {
                            try {
                                await Filesystem.mkdir({
                                    path: dir,
                                    directory: directory,
                                    recursive: true
                                });
                            } catch (e) {
                                // Directory exists - OK
                                if (!e.message?.includes('exists')) {
                                    console.warn('StorageManager v3: mkdir warning for', dir, ':', e.message);
                                }
                            }
                        }
                        
                        this.initialized = true;
                        console.log('StorageManager v3: Initialized with Capacitor Filesystem in', directory);
                        console.log('StorageManager v3: Base path = Documents/FootLogic/');
                        return true;
                    } else {
                        // Web fallback - use localStorage
                        this.initialized = true;
                        console.log('StorageManager v3: Initialized with localStorage fallback');
                        return true;
                    }
                } catch (e) {
                    console.error('StorageManager v3: Init error:', e);
                    this.initialized = true;
                    return true;
                }
            },
            
            // Check if datapack is cached
            isDatapackCached: async function() {
                await this.init();
                try {
                    const Filesystem = window.getCapacitorPlugin('Filesystem');
                    if (!Filesystem) return false;
                    
                    const result = await Filesystem.readFile({
                        path: `${this.basePath}/${this.dataDir}/datapack_cached.json`,
                        directory: this.getDirectory(),
                        encoding: 'utf8'
                    });
                    const cached = JSON.parse(result.data);
                    this.datapackCached = !!cached.version;
                    console.log('StorageManager: Datapack cache found, version:', cached.version);
                    return this.datapackCached;
                } catch (e) {
                    return false;
                }
            },
            
            // Cache datapack info
            cacheDatapack: async function(datapackData) {
                await this.init();
                try {
                    const Filesystem = window.getCapacitorPlugin('Filesystem');
                    if (!Filesystem) {
                        localStorage.setItem('footlogic_datapack_cache', JSON.stringify(datapackData));
                        return true;
                    }
                    
                    await Filesystem.writeFile({
                        path: `${this.basePath}/${this.dataDir}/datapack_cached.json`,
                        data: JSON.stringify({ version: '1.0', cachedAt: new Date().toISOString(), data: datapackData }),
                        directory: this.getDirectory(),
                        encoding: 'utf8'
                    });
                    this.datapackCached = true;
                    console.log('StorageManager: Datapack cached successfully');
                    return true;
                } catch (e) {
                    console.error('StorageManager: Cache datapack error:', e);
                    return false;
                }
            },
            
            // Get cached datapack
            getCachedDatapack: async function() {
                await this.init();
                try {
                    const Filesystem = window.getCapacitorPlugin('Filesystem');
                    if (!Filesystem) {
                        const saved = localStorage.getItem('footlogic_datapack_cache');
                        return saved ? JSON.parse(saved) : null;
                    }
                    
                    const result = await Filesystem.readFile({
                        path: `${this.basePath}/${this.dataDir}/datapack_cached.json`,
                        directory: this.getDirectory(),
                        encoding: 'utf8'
                    });
                    const cached = JSON.parse(result.data);
                    return cached.data || null;
                } catch (e) {
                    return null;
                }
            },
            
            // Copy file to cache (for logos, faces)
            cacheFile: async function(sourcePath, destSubPath) {
                await this.init();
                try {
                    const Filesystem = window.getCapacitorPlugin('Filesystem');
                    if (!Filesystem) return sourcePath; // Return original path for web
                    
                    // Try to read from cache first
                    const cachedPath = `${this.basePath}/${this.dataDir}/${destSubPath}`;
                    try {
                        await Filesystem.stat({
                            path: cachedPath,
                            directory: this.getDirectory()
                        });
                        // File exists in cache
                        return `file://${cachedPath}`;
                    } catch (e) {
                        // File not in cache, need to copy
                    }
                    
                    return sourcePath; // Return original path if caching fails
                } catch (e) {
                    return sourcePath;
                }
            },
            
            // Получение информации о всех слотах сохранения - ИСПРАВЛЕНО v2.1
            getSaveSlots: async function() {
                await this.init();
                const slots = [];
                
                for (let i = 1; i <= this.maxSlots; i++) {
                    const slotData = await this.loadSlot(i, true); // только метаданные
                    const meta = slotData?.meta || {};
                    slots.push({
                        slot: i,
                        isEmpty: !slotData,
                        teamName: meta.teamName || null,
                        teamId: meta.teamId || null,
                        season: meta.season || null,
                        week: meta.week || null,
                        totalWeeks: meta.totalWeeks || 38,
                        leagueId: meta.leagueId || null,
                        leagueName: meta.leagueName || null,
                        leagueCountry: meta.leagueCountry || null,
                        savedAt: meta.savedAt || null,
                        version: meta.version || '1.0.0',
                        // Дополнительная информация
                        teamRating: meta.teamRating || null,
                        budget: meta.budget || null,
                        position: meta.position || null,
                        points: meta.points || null
                    });
                }
                
                return slots;
            },
            
            // Сохранение в слот - FIXED v2.2
            saveToSlot: async function(slotNumber, gameData) {
                await this.init();
                
                const userTeam = window.STATE?.allTeams?.find(t => t.id === window.STATE?.userTeamId);
                const leagueInfo = window.STATE?.leaguesMap?.get(String(userTeam?.leagueId));
                
                const saveData = {
                    meta: {
                        teamName: userTeam?.name || 'Unknown',
                        teamId: window.STATE?.userTeamId || null,
                        season: window.STATE?.season || 1,
                        week: (window.STATE?.calendar?.currentWeek || 0) + 1,
                        totalWeeks: window.STATE?.calendar?.totalWeeks || 38,
                        leagueId: userTeam?.leagueId || null,
                        leagueName: leagueInfo?.name || userTeam?.leagueName || 'Unknown League',
                        leagueCountry: leagueInfo?.country || leagueInfo?.nation || 'Unknown',
                        savedAt: new Date().toISOString(),
                        version: '2.2.0',
                        // FIXED: Additional meta information with correct property references
                        teamRating: userTeam?.teamRating || 0,
                        budget: userTeam?.budget || 0,
                        position: this._getTeamPosition(userTeam),
                        points: userTeam?.pts || userTeam?.points || 0
                    },
                    data: gameData
                };
                
                const filename = `slot${slotNumber}.json`;
                const content = JSON.stringify(saveData);
                
                try {
                    const Filesystem = window.getCapacitorPlugin('Filesystem');
                    
                    if (Filesystem) {
                        await Filesystem.writeFile({
                            path: `${this.basePath}/${this.savesDir}/${filename}`,
                            data: content,
                            directory: this.getDirectory(),
                            encoding: 'utf8'
                        });
                        console.log(`StorageManager: Saved to slot ${slotNumber}`);
                        return true;
                    } else {
                        // localStorage fallback
                        localStorage.setItem(`footlogic_save_slot_${slotNumber}`, content);
                        console.log(`StorageManager: Saved to localStorage slot ${slotNumber}`);
                        return true;
                    }
                } catch (e) {
                    console.error('StorageManager: Save error:', e);
                    // Fallback
                    try {
                        localStorage.setItem(`footlogic_save_slot_${slotNumber}`, content);
                        return true;
                    } catch (e2) {
                        return false;
                    }
                }
            },
            
            // Вспомогательная функция для получения позиции команды
            _getTeamPosition: function(team) {
                if (!team || !window.STATE?.allTeams) return 0;
                const leagueTeams = window.STATE.allTeams
                    .filter(t => String(t.leagueId) === String(team.leagueId))
                    .sort((a, b) => {
                        if ((b.pts || 0) !== (a.pts || 0)) return (b.pts || 0) - (a.pts || 0);
                        const gdA = (a.gf || 0) - (a.ga || 0);
                        const gdB = (b.gf || 0) - (b.ga || 0);
                        if (gdB !== gdA) return gdB - gdA;
                        return (b.gf || 0) - (a.gf || 0);
                    });
                return leagueTeams.findIndex(t => t.id === team.id) + 1;
            },
            
            // Загрузка из слота
            loadSlot: async function(slotNumber, metaOnly = false) {
                await this.init();
                
                const filename = `slot${slotNumber}.json`;
                
                try {
                    const Filesystem = window.getCapacitorPlugin('Filesystem');
                    
                    if (Filesystem) {
                        try {
                            const result = await Filesystem.readFile({
                                path: `${this.basePath}/${this.savesDir}/${filename}`,
                                directory: this.getDirectory(),
                                encoding: 'utf8'
                            });
                            
                            const parsed = JSON.parse(result.data);
                            return metaOnly ? { meta: parsed.meta } : parsed;
                        } catch (e) {
                            if (e.message?.includes('not exist') || e.message?.includes('ENOENT')) {
                                return null; // Слот пустой
                            }
                            throw e;
                        }
                    } else {
                        // localStorage fallback
                        const saved = localStorage.getItem(`footlogic_save_slot_${slotNumber}`);
                        if (!saved) return null;
                        const parsed = JSON.parse(saved);
                        return metaOnly ? { meta: parsed.meta } : parsed;
                    }
                } catch (e) {
                    console.warn('StorageManager: Load error:', e);
                    // Fallback
                    try {
                        const saved = localStorage.getItem(`footlogic_save_slot_${slotNumber}`);
                        if (!saved) return null;
                        const parsed = JSON.parse(saved);
                        return metaOnly ? { meta: parsed.meta } : parsed;
                    } catch (e2) {
                        return null;
                    }
                }
            },
            
            // Удаление слота
            deleteSlot: async function(slotNumber) {
                await this.init();
                
                const filename = `slot${slotNumber}.json`;
                
                try {
                    const Filesystem = window.getCapacitorPlugin('Filesystem');
                    
                    if (Filesystem) {
                        await Filesystem.deleteFile({
                            path: `${this.basePath}/${this.savesDir}/${filename}`,
                            directory: this.getDirectory()
                        });
                    }
                    
                    localStorage.removeItem(`footlogic_save_slot_${slotNumber}`);
                    return true;
                } catch (e) {
                    console.warn('StorageManager: Delete error:', e);
                    localStorage.removeItem(`footlogic_save_slot_${slotNumber}`);
                    return true;
                }
            },
            
            // Универсальные get/set для ModAPI и других данных
            set: async function(key, value) {
                await this.init();
                
                const content = JSON.stringify(value);
                
                try {
                    const Filesystem = window.getCapacitorPlugin('Filesystem');
                    
                    if (Filesystem) {
                        await Filesystem.writeFile({
                            path: `${this.basePath}/${this.modsDir}/${key}.json`,
                            data: content,
                            directory: this.getDirectory(),
                            encoding: 'utf8'
                        });
                        return true;
                    } else {
                        localStorage.setItem(key, content);
                        return true;
                    }
                } catch (e) {
                    localStorage.setItem(key, content);
                    return true;
                }
            },
            
            get: async function(key) {
                await this.init();
                
                try {
                    const Filesystem = window.getCapacitorPlugin('Filesystem');
                    
                    if (Filesystem) {
                        try {
                            const result = await Filesystem.readFile({
                                path: `${this.basePath}/${this.modsDir}/${key}.json`,
                                directory: this.getDirectory(),
                                encoding: 'utf8'
                            });
                            return JSON.parse(result.data);
                        } catch (e) {
                            // Файл не существует - пробуем localStorage
                            const saved = localStorage.getItem(key);
                            return saved ? JSON.parse(saved) : null;
                        }
                    } else {
                        const saved = localStorage.getItem(key);
                        return saved ? JSON.parse(saved) : null;
                    }
                } catch (e) {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : null;
                }
            },
            
            remove: async function(key) {
                await this.init();
                
                try {
                    const Filesystem = window.getCapacitorPlugin('Filesystem');
                    
                    if (Filesystem) {
                        try {
                            await Filesystem.deleteFile({
                                path: `${this.basePath}/${this.modsDir}/${key}.json`,
                                directory: this.getDirectory()
                            });
                        } catch (e) {}
                    }
                    
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    localStorage.removeItem(key);
                    return true;
                }
            }
        };
        
        // ========== MOD API SYSTEM v4.0 - ПОЛНОСТЬЮ ПЕРЕРАБОТАННЫЙ ==========
        // Расширенный Event-Driven API с поддержкой хуков, модификаторов и UI
        
        window.ModAPI = {
            version: '4.0.0',
            mods: [],
            events: {},
            interceptors: {},
            customScreens: {},
            customCommands: {},
            customWidgets: {},
            menuItems: [],
            timers: [],
            storage: {},
            hooks: {},
            patches: {},
            _initialized: false,
            _debug: false,
            _inCareer: false, // FIXED: Добавлена инициализация флага карьеры
            
            // ==================== CORE ====================
            
            // Включить/выключить отладку
            setDebug: function(enabled) {
                this._debug = enabled;
                console.log('ModAPI: Debug mode', enabled ? 'enabled' : 'disabled');
            },
            
            log: function(...args) {
                if (this._debug) console.log('[ModAPI]', ...args);
            },
            
            registerMod: function(modInfo) {
                if (!modInfo.id || !modInfo.name || !modInfo.version) {
                    console.error('ModAPI: Invalid mod - requires id, name, version');
                    return false;
                }
                
                // Проверяем существует ли мод
                const existingIdx = this.mods.findIndex(m => m.id === modInfo.id);
                if (existingIdx !== -1) {
                    // Обновляем существующий мод вместо дублирования
                    console.log('ModAPI: Updating existing mod:', modInfo.id);
                    const oldMod = this.mods[existingIdx];
                    if (oldMod.onDisable) {
                        try { oldMod.onDisable(this); } catch(e) {}
                    }
                    this.mods[existingIdx] = { ...modInfo, enabled: oldMod.enabled, code: oldMod.code || modInfo.code };
                    return true;
                }
                
                const mod = { 
                    ...modInfo, 
                    enabled: true,
                    loadedAt: Date.now(),
                    _eventHandlers: [],
                    // ИСПРАВЛЕНО: Гарантируем что код сохранён
                    code: modInfo.code || modInfo._sourceCode || ''
                };
                this.mods.push(mod);
                
                // Регистрируем легаси хуки как event listeners
                const legacyHooks = [
                    'onGameLoad', 'onSeasonStart', 'onSeasonEnd', 
                    'onWeekStart', 'onWeekEnd', 'onMatchStart', 'onMatchEnd',
                    'onGoal', 'onTransfer', 'onPlayerTrain', 'onInjury', 'onTacticChange',
                    'onMatchSimulate', 'onPlayerBuy', 'onPlayerSell', 'onBudgetChange',
                    'onFormationChange', 'onSave', 'onLoad', 'onDashboardRender'
                ];
                
                legacyHooks.forEach(hook => {
                    if (typeof mod[hook] === 'function') {
                        const eventName = hook.charAt(2).toLowerCase() + hook.slice(3);
                        const handler = mod[hook].bind(mod);
                        this.on(eventName, handler, 10, mod.id);
                        mod._eventHandlers.push({ event: eventName, handler });
                    }
                });
                
                // Инициализация мода
                try {
                    // Вызываем init() всегда при регистрации
                    if (mod.init) mod.init(this);
                    
                    // FIXED: onEnable вызываем только для menu-модов ИЛИ если мы уже в карьере
                    // Career-моды будут активированы через _activateCareerMods() при загрузке/создании карьеры
                    if (mod.onEnable && mod.enabled) {
                        if (mod.modType === 'menu') {
                            // Menu-моды активируются сразу
                            mod.onEnable(this);
                            console.log('ModAPI: Activated menu mod:', mod.id);
                        } else if (this._inCareer) {
                            // Career-моды активируются только если мы уже в карьере
                            mod.onEnable(this);
                            console.log('ModAPI: Activated career mod (already in career):', mod.id);
                        } else {
                            console.log('ModAPI: Career mod registered, will activate on career load:', mod.id);
                        }
                    }
                    
                    this.trigger('modRegistered', { mod, api: this });
                } catch (e) {
                    console.error('ModAPI: Init error for', mod.id, e);
                    this.showNotification(`Failed to init mod: ${mod.name}`, 3000, 'error');
                }
                
                console.log('ModAPI: Registered', mod.name, 'v' + mod.version, '(type:', mod.modType || 'career', ')');
                this._debouncedSaveMods(); // Автосохранение с задержкой
                return true;
            },
            
            unregisterMod: function(modId) {
                const idx = this.mods.findIndex(m => m.id === modId);
                if (idx === -1) return false;
                
                const mod = this.mods[idx];
                
                // Вызываем onDisable
                if (mod.onDisable) {
                    try { mod.onDisable(this); } catch(e) {}
                }
                
                // Удаляем все event handlers мода
                if (mod._eventHandlers) {
                    mod._eventHandlers.forEach(({ event, handler }) => {
                        this.off(event, handler);
                    });
                }
                
                // Удаляем menu items мода
                this.menuItems = this.menuItems.filter(item => item.modId !== modId);
                
                // Удаляем custom screens мода
                Object.keys(this.customScreens).forEach(key => {
                    if (this.customScreens[key].modId === modId) {
                        delete this.customScreens[key];
                    }
                });
                
                this.trigger('modUnregistered', { modId, mod });
                this.mods.splice(idx, 1);
                this.saveMods();
                
                console.log('ModAPI: Unregistered', mod.name);
                return true;
            },
            
            toggleMod: function(modId, enabled) {
                const mod = this.mods.find(m => m.id === modId);
                if (!mod) return false;
                
                const wasEnabled = mod.enabled;
                mod.enabled = enabled;
                
                console.log('ModAPI: Toggling mod', modId, 'to', enabled, ', inCareer:', this._inCareer);
                
                // FIXED: Учитываем режим карьеры для career-модов
                if (wasEnabled && !enabled && mod.onDisable) {
                    try { 
                        mod.onDisable(this); 
                        console.log('ModAPI: Disabled mod:', modId);
                    } catch(e) {
                        console.error('ModAPI: Error disabling mod:', modId, e);
                    }
                }
                if (!wasEnabled && enabled && mod.onEnable) {
                    // Для career-модов активируем только если мы в карьере
                    if (mod.modType === 'menu' || this._inCareer) {
                        try { 
                            mod.onEnable(this); 
                            console.log('ModAPI: Enabled mod:', modId);
                        } catch(e) {
                            console.error('ModAPI: Error enabling mod:', modId, e);
                        }
                    } else {
                        console.log('ModAPI: Mod will activate when entering career:', modId);
                    }
                }
                
                this.trigger('modToggled', { modId, enabled, mod });
                
                // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Сохраняем СРАЗУ, без debounce
                this.saveMods();
                
                this._renderCustomMenuItems(); // Обновляем меню
                return true;
            },
            
            getMod: function(modId) {
                return this.mods.find(m => m.id === modId);
            },
            
            getEnabledMods: function() {
                return this.mods.filter(m => m.enabled);
            },
            
            // ==================== РАСШИРЕННАЯ EVENT SYSTEM ====================
            
            on: function(event, handler, priority = 10, modId = null) {
                if (!this.events[event]) this.events[event] = [];
                const entry = { handler, priority, modId, id: Date.now() + Math.random() };
                this.events[event].push(entry);
                this.events[event].sort((a, b) => b.priority - a.priority);
                return entry.id; // Возвращаем ID для возможности удаления
            },
            
            once: function(event, handler, priority = 10) {
                const wrapper = (data) => {
                    this.off(event, wrapper);
                    return handler(data);
                };
                return this.on(event, wrapper, priority);
            },
            
            off: function(event, handlerOrId) {
                if (!this.events[event]) return false;
                if (typeof handlerOrId === 'number') {
                    this.events[event] = this.events[event].filter(h => h.id !== handlerOrId);
                } else {
                    this.events[event] = this.events[event].filter(h => h.handler !== handlerOrId);
                }
                return true;
            },
            
            _normalizeEventPayload: function(event, data) {
                // Provide backwards-compatible fields for mods
                if (!event || !data || typeof data !== 'object') return data;

                // Match end payload normalization for mods expecting homeTeamId/homeScore/result
                if (event === 'matchEnd' || event === 'onMatchEnd') {
                    const homeTeamId = data.homeTeamId ?? data.homeId;
                    const awayTeamId = data.awayTeamId ?? data.awayId;
                    const homeScore = data.homeScore ?? data.homeGoals;
                    const awayScore = data.awayScore ?? data.awayGoals;

                    const normalized = {
                        ...data,
                        homeTeamId,
                        awayTeamId,
                        homeScore,
                        awayScore
                    };

                    const userTeamId = window.STATE?.userTeamId;
                    if (userTeamId != null && (homeTeamId == userTeamId || awayTeamId == userTeamId)) {
                        const userIsHome = homeTeamId == userTeamId;
                        const userGoals = userIsHome ? homeScore : awayScore;
                        const oppGoals = userIsHome ? awayScore : homeScore;

                        normalized.result =
                            userGoals > oppGoals ? 'win' : userGoals < oppGoals ? 'loss' : 'draw';
                        normalized.userTeamId = userTeamId;
                    }

                    return normalized;
                }

                return data;
            },

            _triggerInternal: function(event, data) {
                const payload = this._normalizeEventPayload(event, data);
                if (!this.events[event]) return payload;

                let result = payload;
                for (const sub of this.events[event]) {
                    // Проверяем что мод включен
                    if (sub.modId) {
                        const mod = this.getMod(sub.modId);
                        if (mod && !mod.enabled) continue;
                    }

                    try {
                        const r = sub.handler(result, this);
                        if (r !== undefined) result = r;
                    } catch (e) {
                        console.error(`ModAPI: Error in event "${event}"`, e);
                    }
                }
                return result;
            },

            trigger: function(event, data) {
                this.log('Event:', event, data);

                // Legacy compatibility: allow triggering "onMatchEnd" while listeners subscribe to "matchEnd"
                if (typeof event === 'string' && /^on[A-Z]/.test(event)) {
                    const normalized = event.charAt(2).toLowerCase() + event.slice(3);
                    const hasNormalizedListeners = Array.isArray(this.events[normalized]) && this.events[normalized].length > 0;

                    const resNormalized = this._triggerInternal(normalized, data);
                    if (normalized !== event) {
                        const resOriginal = this._triggerInternal(event, data);
                        return hasNormalizedListeners ? resNormalized : resOriginal;
                    }
                    return resNormalized;
                }

                return this._triggerInternal(event, data);
            },
            
            // Алиасы для совместимости
            emit: function(event, data) { return this.trigger(event, data); },
            fire: function(event, data) { return this.trigger(event, data); },
            dispatch: function(event, data) { return this.trigger(event, data); },
            
            // ==================== INTERCEPTORS & HOOKS ====================
            
            // Intercept позволяет модифицировать результаты функций
            intercept: function(target, handler, modId) {
                if (!this.interceptors[target]) this.interceptors[target] = [];
                this.interceptors[target].push({ handler, modId, id: Date.now() });
                this.log('Interceptor added for:', target);
            },
            
            runInterceptors: function(target, args, result) {
                if (!this.interceptors[target]) return result;
                let res = result;
                for (const interceptor of this.interceptors[target]) {
                    // Проверяем что мод включен
                    if (interceptor.modId) {
                        const mod = this.getMod(interceptor.modId);
                        if (mod && !mod.enabled) continue;
                    }
                    try {
                        const r = interceptor.handler(args, res, this);
                        if (r !== undefined) res = r;
                    } catch (e) { 
                        console.error('ModAPI: Interceptor error', e); 
                    }
                }
                return res;
            },
            
            // Hooks - позволяют модам добавлять код перед/после функций
            addHook: function(hookName, callback, when = 'after', modId = null) {
                if (!this.hooks[hookName]) this.hooks[hookName] = { before: [], after: [] };
                this.hooks[hookName][when].push({ callback, modId });
                this.log('Hook added:', hookName, when);
            },
            
            runHooks: function(hookName, when, context = {}) {
                if (!this.hooks[hookName] || !this.hooks[hookName][when]) return context;
                for (const hook of this.hooks[hookName][when]) {
                    if (hook.modId) {
                        const mod = this.getMod(hook.modId);
                        if (mod && !mod.enabled) continue;
                    }
                    try {
                        const result = hook.callback(context, this);
                        if (result !== undefined) context = result;
                    } catch (e) {
                        console.error('ModAPI: Hook error', hookName, e);
                    }
                }
                return context;
            },
            
            // Patch - напрямую модифицирует глобальные функции
            patch: function(funcName, wrapper, modId = null) {
                if (typeof window[funcName] !== 'function') {
                    console.error('ModAPI: Cannot patch - function not found:', funcName);
                    return false;
                }
                
                if (!this.patches[funcName]) {
                    this.patches[funcName] = {
                        original: window[funcName],
                        wrappers: []
                    };
                }
                
                this.patches[funcName].wrappers.push({ wrapper, modId });
                
                // Создаём обёртку
                const self = this;
                window[funcName] = function(...args) {
                    let result = self.patches[funcName].original.apply(this, args);
                    for (const w of self.patches[funcName].wrappers) {
                        if (w.modId) {
                            const mod = self.getMod(w.modId);
                            if (mod && !mod.enabled) continue;
                        }
                        try {
                            const r = w.wrapper(args, result, self.patches[funcName].original, self);
                            if (r !== undefined) result = r;
                        } catch(e) {
                            console.error('ModAPI: Patch error', funcName, e);
                        }
                    }
                    return result;
                };
                
                this.log('Patched function:', funcName);
                return true;
            },
            
            unpatch: function(funcName) {
                if (this.patches[funcName]) {
                    window[funcName] = this.patches[funcName].original;
                    delete this.patches[funcName];
                    return true;
                }
                return false;
            },
            
            // ==================== STATE ACCESS ====================
            
            getState: function() {
                return window.STATE || null;
            },
            
            getFullState: function() {
                return window.STATE;
            },
            
            getSeason: function() {
                return window.STATE ? window.STATE.season : null;
            },
            
            getCalendar: function() {
                return window.STATE ? window.STATE.calendar : null;
            },
            
            getCurrentWeek: function() {
                return window.STATE?.calendar?.currentWeek || 0;
            },
            
            getCurrentView: function() {
                return window.STATE?.view || 'dashboard';
            },
            
            getUserTeamId: function() {
                return window.STATE?.userTeamId;
            },
            
            // ==================== TEAMS ====================
            
            getUserTeam: function() {
                if (!window.STATE?.allTeams) return null;
                return window.STATE.allTeams.find(t => t.id === window.STATE.userTeamId);
            },
            
            getAllTeams: function() {
                return window.STATE?.allTeams || [];
            },
            
            getTeamById: function(teamId) {
                return window.STATE?.allTeams?.find(t => t.id === teamId || t.id === String(teamId));
            },
            
            getTeamByName: function(name) {
                return window.STATE?.allTeams?.find(t => 
                    t.name.toLowerCase().includes(name.toLowerCase())
                );
            },
            
            getTeamsByLeague: function(leagueId) {
                return window.STATE?.allTeams?.filter(t => t.leagueId === leagueId) || [];
            },
            
            getTeamSquad: function(teamId) {
                const team = this.getTeamById(teamId);
                return team ? team.squad : [];
            },
            
            getTeamStarters: function(teamId) {
                const team = this.getTeamById(teamId);
                if (!team) return [];
                return team.squad.filter(p => team.starters?.includes(p.internalId || p.id));
            },
            
            getTeamBench: function(teamId) {
                const team = this.getTeamById(teamId);
                if (!team) return [];
                return team.squad.filter(p => !team.starters?.includes(p.internalId || p.id));
            },
            
            getTeamFormation: function(teamId) {
                const team = this.getTeamById(teamId);
                return team?.formation || '4-3-3';
            },
            
            getTeamTactic: function(teamId) {
                const team = this.getTeamById(teamId);
                return team?.tactic || 'balanced';
            },
            
            getTeamBudget: function(teamId) {
                const team = this.getTeamById(teamId);
                return team?.budget || 0;
            },
            
            getTeamStats: function(teamId) {
                const team = this.getTeamById(teamId);
                if (!team) return null;
                return {
                    played: team.played || 0,
                    won: team.won || 0,
                    drawn: team.drawn || 0,
                    lost: team.lost || 0,
                    goalsFor: team.gf || 0,
                    goalsAgainst: team.ga || 0,
                    goalDiff: (team.gf || 0) - (team.ga || 0),
                    points: team.pts || 0,
                    form: team.form || []
                };
            },
            
            getLeagueTable: function(leagueId) {
                const teams = this.getTeamsByLeague(leagueId);
                return teams.sort((a, b) => {
                    if ((b.pts || 0) !== (a.pts || 0)) return (b.pts || 0) - (a.pts || 0);
                    const gdA = (a.gf || 0) - (a.ga || 0);
                    const gdB = (b.gf || 0) - (b.ga || 0);
                    if (gdB !== gdA) return gdB - gdA;
                    return (b.gf || 0) - (a.gf || 0);
                });
            },
            
            // ==================== PLAYERS ====================
            
            getAllPlayers: function() {
                const players = [];
                window.STATE?.allTeams?.forEach(team => {
                    team.squad?.forEach(p => {
                        players.push({ ...p, teamId: team.id, teamName: team.name });
                    });
                });
                return players;
            },
            
            getPlayerById: function(playerId) {
                if (!window.STATE?.allTeams) return null;
                for (const team of window.STATE.allTeams) {
                    const player = team.squad?.find(p => 
                        p.internalId === playerId || p.id === playerId || 
                        String(p.internalId) === String(playerId)
                    );
                    if (player) return { player, team };
                }
                return null;
            },
            
            getPlayersByPosition: function(position) {
                return this.getAllPlayers().filter(p => 
                    p.pos === position || p.position === position
                );
            },
            
            getPlayersByNation: function(nation) {
                return this.getAllPlayers().filter(p => 
                    p.nation?.toLowerCase() === nation.toLowerCase()
                );
            },
            
            getPlayersByRatingRange: function(minRating, maxRating) {
                return this.getAllPlayers().filter(p => 
                    p.rating >= minRating && p.rating <= maxRating
                );
            },
            
            getPlayersByAge: function(minAge, maxAge) {
                return this.getAllPlayers().filter(p => 
                    p.age >= minAge && p.age <= maxAge
                );
            },
            
            getTopScorers: function(limit = 10) {
                return this.getAllPlayers()
                    .filter(p => p.goals > 0)
                    .sort((a, b) => (b.goals || 0) - (a.goals || 0))
                    .slice(0, limit);
            },
            
            getTopAssists: function(limit = 10) {
                return this.getAllPlayers()
                    .filter(p => p.assists > 0)
                    .sort((a, b) => (b.assists || 0) - (a.assists || 0))
                    .slice(0, limit);
            },
            
            searchPlayers: function(query) {
                const q = query.toLowerCase();
                return this.getAllPlayers().filter(p => 
                    p.name?.toLowerCase().includes(q) ||
                    p.nation?.toLowerCase().includes(q) ||
                    p.pos?.toLowerCase().includes(q)
                );
            },
            
            // ==================== LEAGUES ====================
            
            getAllLeagues: function() {
                return window.STATE?.leagues || [];
            },
            
            getLeagueById: function(leagueId) {
                return window.STATE?.leagues?.find(l => l.id === leagueId);
            },
            
            getLeaguesByCountry: function(country) {
                return window.STATE?.leagues?.filter(l => 
                    l.country?.toLowerCase() === country.toLowerCase()
                ) || [];
            },
            
            // ==================== SCHEDULE & MATCHES ====================
            
            getSchedule: function() {
                return window.STATE?.schedule || [];
            },
            
            getMatchesByWeek: function(week) {
                return window.STATE?.schedule?.filter(m => m.week === week) || [];
            },
            
            getTeamMatches: function(teamId) {
                return window.STATE?.schedule?.filter(m => 
                    m.homeId === teamId || m.awayId === teamId
                ) || [];
            },
            
            getNextMatch: function(teamId) {
                const currentWeek = this.getCurrentWeek();
                return this.getTeamMatches(teamId).find(m => 
                    m.week >= currentWeek && !m.played
                );
            },
            
            getMatchHistory: function(teamId) {
                return this.getTeamMatches(teamId).filter(m => m.played);
            },
            
            getHeadToHead: function(teamA, teamB) {
                return window.STATE?.schedule?.filter(m => 
                    (m.homeId === teamA && m.awayId === teamB) ||
                    (m.homeId === teamB && m.awayId === teamA)
                ) || [];
            },
            
            // ==================== CUPS & EUROPEAN ====================
            
            getCupData: function() {
                return window.STATE?.cup || null;
            },
            
            getEuropeanCompetitions: function() {
                return window.STATE?.euro || {};
            },
            
            getUserEuropeanComp: function() {
                const euro = window.STATE?.euro;
                if (!euro) return null;
                const userTeamId = this.getUserTeamId();
                
                for (const [compId, comp] of Object.entries(euro)) {
                    if (comp.teams?.includes(userTeamId)) {
                        return { compId, ...comp };
                    }
                }
                return null;
            },
            
            // ==================== TRANSFERS ====================
            
            getTransferMarket: function() {
                return window.STATE?.transferMarket || [];
            },
            
            getTransferHistory: function() {
                return window.STATE?.transferHistory || [];
            },
            
            getTeamTransfers: function(teamId) {
                return this.getTransferHistory().filter(t => 
                    t.fromTeam === teamId || t.toTeam === teamId
                );
            },
            
            // ==================== MODIFICATIONS ====================
            
            modifyPlayer: function(playerId, changes) {
                const result = this.getPlayerById(playerId);
                if (!result) return false;
                
                const { player } = result;
                const allowedFields = [
                    'rating', 'pot', 'stamina', 'morale', 'form', 'energy',
                    'goals', 'assists', 'yellowCards', 'redCards', 'appearances',
                    'injured', 'injuryWeeks', 'value', 'wage', 'contractEnd',
                    'happiness', 'fitness', 'sharpness'
                ];
                
                Object.keys(changes).forEach(key => {
                    if (allowedFields.includes(key)) {
                        const oldVal = player[key];
                        player[key] = changes[key];
                        this.emit('playerStatChanged', { playerId, stat: key, oldVal, newVal: changes[key] });
                    }
                });
                
                this.emit('playerModified', { playerId, changes, player });
                return true;
            },
            
            modifyTeam: function(teamId, changes) {
                const team = this.getTeamById(teamId);
                if (!team) return false;
                
                const allowedFields = [
                    'budget', 'morale', 'reputation', 'fanBase', 'stadiumCapacity',
                    'trainingFacilities', 'youthFacilities', 'form', 'mentality',
                    'pts', 'won', 'drawn', 'lost', 'gf', 'ga', 'played'
                ];
                
                Object.keys(changes).forEach(key => {
                    if (allowedFields.includes(key)) {
                        const oldVal = team[key];
                        team[key] = changes[key];
                        this.emit('teamStatChanged', { teamId, stat: key, oldVal, newVal: changes[key] });
                    }
                });
                
                this.emit('teamModified', { teamId, changes, team });
                return true;
            },
            
            setFormation: function(teamId, formation) {
                const team = this.getTeamById(teamId);
                if (!team) return false;
                team.formation = formation;
                this.emit('formationChanged', { teamId, formation });
                return true;
            },
            
            setTactic: function(teamId, tactic) {
                const team = this.getTeamById(teamId);
                if (!team) return false;
                team.tactic = tactic;
                this.emit('tacticChanged', { teamId, tactic });
                return true;
            },
            
            transferPlayer: function(playerId, toTeamId, fee = 0) {
                const result = this.getPlayerById(playerId);
                if (!result) return false;
                
                const { player, team: fromTeam } = result;
                const toTeam = this.getTeamById(toTeamId);
                if (!toTeam) return false;
                
                // Remove from old team
                fromTeam.squad = fromTeam.squad.filter(p => 
                    (p.internalId || p.id) !== (player.internalId || player.id)
                );
                
                // Add to new team
                toTeam.squad.push(player);
                
                // Update budgets
                if (fee > 0) {
                    fromTeam.budget = (fromTeam.budget || 0) + fee;
                    toTeam.budget = (toTeam.budget || 0) - fee;
                }
                
                this.emit('playerTransferred', { 
                    player, fromTeam: fromTeam.id, toTeam: toTeamId, fee 
                });
                
                return true;
            },
            
            createPlayer: function(playerData) {
                const player = {
                    id: 'mod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    internalId: 'mod_' + Date.now(),
                    name: playerData.name || 'New Player',
                    pos: playerData.pos || 'CM',
                    rating: playerData.rating || 70,
                    pot: playerData.pot || playerData.rating + 5,
                    age: playerData.age || 20,
                    nation: playerData.nation || 'INT',
                    value: playerData.value || 1000000,
                    wage: playerData.wage || 10000,
                    stamina: 100,
                    morale: 80,
                    energy: 100,
                    goals: 0,
                    assists: 0,
                    appearances: 0,
                    ...playerData
                };
                
                this.emit('playerCreated', player);
                return player;
            },
            
            addPlayerToTeam: function(player, teamId) {
                const team = this.getTeamById(teamId);
                if (!team) return false;
                
                if (!team.squad) team.squad = [];
                team.squad.push(player);
                
                this.emit('playerAddedToTeam', { player, teamId });
                return true;
            },
            
            removePlayerFromTeam: function(playerId, teamId) {
                const team = this.getTeamById(teamId);
                if (!team) return false;
                
                const idx = team.squad?.findIndex(p => 
                    (p.internalId || p.id) === playerId
                );
                
                if (idx > -1) {
                    const player = team.squad[idx];
                    team.squad.splice(idx, 1);
                    this.emit('playerRemovedFromTeam', { player, teamId });
                    return true;
                }
                return false;
            },
            
            // ==================== MATCH SIMULATION ====================
            
            simulateMatch: function(homeId, awayId, options = {}) {
                if (window.simulateMatch) {
                    const result = window.simulateMatch(homeId, awayId);
                    result.modOptions = options;
                    return this.runInterceptors('simulateMatch', { homeId, awayId, options }, result);
                }
                return null;
            },
            
            getMatchStrength: function(teamId) {
                const team = this.getTeamById(teamId);
                if (!team) return 0;
                
                const starters = this.getTeamStarters(teamId);
                if (starters.length === 0) return team.rating || 70;
                
                const avgRating = starters.reduce((sum, p) => sum + (p.rating || 70), 0) / starters.length;
                const avgEnergy = starters.reduce((sum, p) => sum + (p.energy || 100), 0) / starters.length;
                const morale = team.morale || 70;
                
                return avgRating * (avgEnergy / 100) * (morale / 100);
            },
            
            // ==================== UI ====================
            
            // ИСПРАВЛЕНО: Используем защищённый контейнер для уведомлений
            showNotification: function(message, duration = 3000, type = 'mod') {
                const root = this.getModRoot();
                const colors = {
                    mod: '#4caf50',
                    success: '#4caf50',
                    error: '#f44336',
                    warning: '#ff9800',
                    info: '#2196f3'
                };
                
                const notif = document.createElement('div');
                notif.className = 'fixed top-4 right-4 z-[9999] bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl';
                notif.style.cssText = `border-left: 4px solid ${colors[type] || colors.mod}; pointer-events: auto;`;
                notif.innerHTML = `<div class="flex items-center gap-3">
                    <span style="color: ${colors[type] || colors.mod}" class="text-xl font-bold">${type.toUpperCase()}</span>
                    <span>${message}</span>
                </div>`;
                root.appendChild(notif);
                
                setTimeout(() => {
                    notif.style.opacity = '0';
                    notif.style.transition = 'opacity 0.3s';
                    setTimeout(() => notif.remove(), 300);
                }, duration);
            },
            
            // ИСПРАВЛЕНО: Используем защищённый контейнер для модалок
            showModal: function(options) {
                const root = this.getModRoot();
                const modal = document.createElement('div');
                modal.id = 'mod-modal-' + Date.now();
                modal.className = 'fixed inset-0 z-[9998] flex items-center justify-center bg-black/70';
                modal.style.pointerEvents = 'auto';
                modal.innerHTML = `
                    <div class="bg-slate-800 rounded-2xl p-6 max-w-lg w-full mx-4 border border-white/10 shadow-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-black text-white">${options.title || 'Mod'}</h3>
                            <button onclick="document.getElementById('${modal.id}').remove()" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-red-500/30 flex items-center justify-center text-slate-400 hover:text-red-400">X</button>
                        </div>
                        <div class="text-slate-300 mb-6">${options.content || ''}</div>
                        <div class="flex gap-3 justify-end">
                            ${options.buttons?.map(btn => `
                                <button onclick="${btn.onClick || ''}; ${btn.closeOnClick !== false ? `document.getElementById('${modal.id}').remove()` : ''}" 
                                    class="px-4 py-2 rounded-lg font-bold transition-all ${btn.primary ? 'bg-[#4caf50] text-white hover:bg-[#45a049]' : 'bg-slate-700 text-white hover:bg-slate-600'}">
                                    ${btn.label}
                                </button>
                            `).join('') || '<button onclick="document.getElementById(\'' + modal.id + '\').remove()" class="px-4 py-2 rounded-lg font-bold bg-slate-700 text-white hover:bg-slate-600">Close</button>'}
                        </div>
                    </div>
                `;
                root.appendChild(modal);
                return modal.id;
            },
            
            // ИСПРАВЛЕНО: Используем защищённый контейнер для prompt
            showPrompt: function(title, placeholder, callback) {
                const root = this.getModRoot();
                const id = 'mod-prompt-' + Date.now();
                const modal = document.createElement('div');
                modal.id = id;
                modal.className = 'fixed inset-0 z-[9998] flex items-center justify-center bg-black/70';
                modal.style.pointerEvents = 'auto';
                modal.innerHTML = `
                    <div class="bg-slate-800 rounded-2xl p-6 max-w-lg w-full mx-4 border border-white/10 shadow-2xl">
                        <h3 class="text-xl font-black text-white mb-4">${title}</h3>
                        <input type="text" id="${id}-input" placeholder="${placeholder || ''}" 
                            class="w-full bg-slate-700 text-white px-4 py-3 rounded-xl border border-white/10 focus:border-[#4caf50] outline-none mb-4">
                        <div class="flex gap-3 justify-end">
                            <button onclick="document.getElementById('${id}').remove()" class="px-4 py-2 rounded-lg font-bold bg-slate-700 text-white hover:bg-slate-600">Cancel</button>
                            <button id="${id}-confirm" class="px-4 py-2 rounded-lg font-bold bg-[#4caf50] text-white hover:bg-[#45a049]">Confirm</button>
                        </div>
                    </div>
                `;
                root.appendChild(modal);
                
                document.getElementById(id + '-confirm').onclick = () => {
                    const value = document.getElementById(id + '-input').value;
                    modal.remove();
                    if (callback) callback(value);
                };
                
                document.getElementById(id + '-input').focus();
            },
            
            // ИСПРАВЛЕНО: Используем защищённый контейнер для confirm
            showConfirm: function(title, message, onConfirm, onCancel) {
                const root = this.getModRoot();
                const id = 'mod-confirm-' + Date.now();
                const modal = document.createElement('div');
                modal.id = id;
                modal.className = 'fixed inset-0 z-[9998] flex items-center justify-center bg-black/70';
                modal.style.pointerEvents = 'auto';
                modal.innerHTML = `
                    <div class="bg-slate-800 rounded-2xl p-6 max-w-lg w-full mx-4 border border-white/10 shadow-2xl">
                        <h3 class="text-xl font-black text-white mb-4">${title}</h3>
                        <p class="text-slate-300 mb-6">${message}</p>
                        <div class="flex gap-3 justify-end">
                            <button id="${id}-cancel" class="px-4 py-2 rounded-lg font-bold bg-slate-700 text-white hover:bg-slate-600">Cancel</button>
                            <button id="${id}-confirm" class="px-4 py-2 rounded-lg font-bold bg-[#4caf50] text-white hover:bg-[#45a049]">Confirm</button>
                        </div>
                    </div>
                `;
                root.appendChild(modal);
                
                document.getElementById(id + '-confirm').onclick = () => { modal.remove(); if (onConfirm) onConfirm(); };
                document.getElementById(id + '-cancel').onclick = () => { modal.remove(); if (onCancel) onCancel(); };
            },
            
            addNews: function(title, text, type = 'mod') {
                if (window.addNews) {
                    window.addNews(title, text, type);
                }
                this.emit('newsAdded', { title, text, type });
            },
            
            // ==================== CUSTOM SCREENS ====================
            
            // ИСПРАВЛЕНО v2.2: Улучшенная регистрация экранов с гарантированным отображением
            registerScreen: function(screenId, options, modId) {
                console.log('ModAPI: Registering screen:', screenId, 'for mod:', modId);
                
                this.customScreens[screenId] = {
                    id: screenId,
                    title: options.title || screenId,
                    icon: options.icon || 'extension',
                    render: options.render || function() { return '<p>Empty screen</p>'; },
                    onOpen: options.onOpen || function() {},
                    onClose: options.onClose || function() {},
                    modId: modId
                };
                this.emit('screenRegistered', screenId);
                console.log('ModAPI: Screen registered successfully:', screenId);
                return true;
            },
            
            // ИСПРАВЛЕНО v2.3: Используем защищённый контейнер для mod screens
            openScreen: function(screenId) {
                console.log('ModAPI: Opening screen:', screenId);
                const screen = this.customScreens[screenId];
                if (!screen) {
                    console.error('ModAPI: Screen not found:', screenId);
                    return false;
                }
                
                // ИСПРАВЛЕНО: Создаём контейнер в mod-root (защищённом от очистки)
                const root = this.getModRoot();
                let container = document.getElementById('mod-screen-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'mod-screen-container';
                    root.appendChild(container);
                }
                
                // ИСПРАВЛЕНО: z-index выше Contact Club overlay, pointer-events enabled
                container.className = 'fixed inset-0 bg-slate-900 flex flex-col overflow-hidden';
                container.style.cssText = 'z-index: 999998 !important; display: flex !important; visibility: visible !important; pointer-events: auto;';
                
                // Рендерим содержимое экрана
                let screenContent = '';
                try {
                    screenContent = screen.render(this);
                } catch (e) {
                    console.error('ModAPI: Error rendering screen:', screenId, e);
                    screenContent = `<p class="text-red-400">Error rendering screen: ${e.message}</p>`;
                }
                
                container.innerHTML = `
                    <div class="flex items-center justify-between p-4 border-b border-white/5 bg-slate-800/50">
                        <h2 class="text-2xl font-black uppercase tracking-tight">${screen.title}</h2>
                        <button onclick="ModAPI.closeScreen('${screenId}')" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-red-500/20 hover:text-red-500 flex items-center justify-center text-lg">✕</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6">
                        <div id="mod-screen-content">${screenContent}</div>
                    </div>
                `;
                
                container.classList.remove('hidden');
                
                try {
                    screen.onOpen(this);
                } catch (e) {
                    console.error('ModAPI: Error in onOpen callback:', screenId, e);
                }
                
                this.emit('screenOpened', screenId);
                console.log('ModAPI: Screen opened successfully:', screenId);
                return true;
            },
            
            closeScreen: function(screenId) {
                console.log('ModAPI: Closing screen:', screenId);
                const container = document.getElementById('mod-screen-container');
                if (container) {
                    container.classList.add('hidden');
                    container.style.display = 'none';
                    container.innerHTML = '';
                }
                
                const screen = this.customScreens[screenId];
                if (screen) {
                    try {
                        screen.onClose(this);
                    } catch (e) {
                        console.error('ModAPI: Error in onClose callback:', screenId, e);
                    }
                }
                
                this.emit('screenClosed', screenId);
            },
            
            updateScreenContent: function(html) {
                const content = document.getElementById('mod-screen-content');
                if (content) content.innerHTML = html;
            },
            
            // ==================== MENU ITEMS ====================
            
            customMenuItems: [],
            
            // ИСПРАВЛЕНО v2.2: Улучшенное добавление пунктов меню
            addMenuItem: function(item) {
                if (!item.id || !item.label) {
                    console.error('ModAPI: addMenuItem requires id and label');
                    return false;
                }
                
                console.log('ModAPI: Adding menu item:', item.id, item.label);
                
                // Проверяем что пункт ещё не добавлен
                if (this.customMenuItems.find(i => i.id === item.id)) {
                    console.warn('ModAPI: Menu item already exists:', item.id);
                    return false;
                }
                
                this.customMenuItems.push({
                    id: item.id,
                    label: item.label,
                    icon: item.icon || 'extension',
                    onClick: item.onClick,
                    screenId: item.screenId,
                    order: item.order || 100,
                    modId: item.modId
                });
                
                this.customMenuItems.sort((a, b) => a.order - b.order);
                this.emit('menuItemAdded', item);
                this._renderCustomMenuItems();
                console.log('ModAPI: Menu item added successfully:', item.id);
                return true;
            },
            
            removeMenuItem: function(itemId) {
                const idx = this.customMenuItems.findIndex(i => i.id === itemId);
                if (idx > -1) {
                    this.customMenuItems.splice(idx, 1);
                    this.emit('menuItemRemoved', itemId);
                    this._renderCustomMenuItems();
                    return true;
                }
                return false;
            },
            
            // FIXED v4.0: Improved menu items rendering - adds items to sidebar navigation
            _renderCustomMenuItems: function() {
                // Only render in career mode
                if (!this._inCareer) return;
                
                // Find the nav container in sidebar (mod-nav-items div)
                let container = document.getElementById('mod-nav-items');
                
                if (!container) {
                    // If no container in sidebar, try to find landscape-nav
                    const navPanel = document.querySelector('.landscape-nav');
                    if (navPanel) {
                        const flexGrow = navPanel.querySelector('.flex-grow');
                        if (flexGrow) {
                            container = document.createElement('div');
                            container.id = 'mod-nav-items';
                            container.className = 'flex flex-col gap-1';
                            flexGrow.parentNode.insertBefore(container, flexGrow);
                        }
                    }
                }
                
                if (!container) return;
                
                // Filter only enabled mods that have menu items (career mods only when in career)
                const activeItems = this.customMenuItems.filter(item => {
                    if (item.modId) {
                        const mod = this.getMod(item.modId);
                        if (!mod || !mod.enabled) return false;
                        // Only show career mod items when in career
                        if (mod.modType !== 'menu' && !this._inCareer) return false;
                    }
                    return true;
                });
                
                if (activeItems.length === 0) {
                    container.innerHTML = '';
                    return;
                }
                
                // Clear and rebuild
                container.innerHTML = '';
                
                activeItems.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'landscape-nav-btn text-purple-400 hover:text-purple-300';
                    btn.title = item.label;
                    btn.innerHTML = item.icon || '🔧';
                    
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (item.screenId) {
                            this.openScreen(item.screenId);
                        } else if (typeof item.onClick === 'function') {
                            item.onClick(this);
                        } else if (typeof item.onClick === 'string' && item.onClick) {
                            try {
                                new Function(item.onClick)();
                            } catch (err) {
                                console.error('ModAPI: Menu item click error:', err);
                            }
                        }
                    });
                    
                    container.appendChild(btn);
                });
            },
            
            // ==================== COMMANDS ====================
            
            registerCommand: function(name, handler, description = '') {
                this.customCommands[name] = { handler, description };
            },
            
            executeCommand: function(name, ...args) {
                const cmd = this.customCommands[name];
                if (!cmd) return null;
                return cmd.handler(this, ...args);
            },
            
            listCommands: function() {
                return Object.entries(this.customCommands).map(([name, cmd]) => ({
                    name,
                    description: cmd.description
                }));
            },
            
            // ==================== TIMERS ====================
            
            setInterval: function(callback, ms, modId) {
                const id = setInterval(() => {
                    try { callback(this); } catch (e) { console.error('ModAPI: Timer error', e); }
                }, ms);
                this.timers.push({ id, modId, type: 'interval' });
                return id;
            },
            
            setTimeout: function(callback, ms, modId) {
                const id = setTimeout(() => {
                    try { callback(this); } catch (e) { console.error('ModAPI: Timer error', e); }
                    this.timers = this.timers.filter(t => t.id !== id);
                }, ms);
                this.timers.push({ id, modId, type: 'timeout' });
                return id;
            },
            
            clearTimer: function(timerId) {
                const timer = this.timers.find(t => t.id === timerId);
                if (timer) {
                    if (timer.type === 'interval') clearInterval(timerId);
                    else clearTimeout(timerId);
                    this.timers = this.timers.filter(t => t.id !== timerId);
                }
            },
            
            // ==================== STORAGE (Async via StorageManager) ====================
            
            // Синхронная версия для обратной совместимости (использует in-memory cache)
            saveData: function(modId, key, value) {
                if (!this.storage[modId]) this.storage[modId] = {};
                this.storage[modId][key] = value;
                
                // Асинхронно сохраняем через StorageManager
                this._saveModDataAsync(modId);
            },
            
            // Внутренний метод для асинхронного сохранения
            _saveModDataAsync: async function(modId) {
                try {
                    if (window.StorageManager) {
                        await window.StorageManager.set('modapi_data_' + modId, this.storage[modId]);
                    } else {
                        localStorage.setItem('modapi_data_' + modId, JSON.stringify(this.storage[modId]));
                    }
                } catch (e) {
                    console.warn('ModAPI: Failed to save mod data:', modId, e.message);
                }
            },
            
            loadData: function(modId, key, defaultValue = null) {
                // Сначала проверяем in-memory cache
                if (this.storage[modId] && this.storage[modId][key] !== undefined) {
                    return this.storage[modId][key];
                }
                
                // Для синхронного доступа используем localStorage напрямую
                if (!this.storage[modId]) {
                    try {
                        const saved = localStorage.getItem('modapi_data_' + modId);
                        this.storage[modId] = saved ? JSON.parse(saved) : {};
                    } catch (e) {
                        this.storage[modId] = {};
                    }
                }
                return this.storage[modId][key] !== undefined ? this.storage[modId][key] : defaultValue;
            },
            
            // Асинхронная версия loadData для полной поддержки Capacitor
            loadDataAsync: async function(modId, key, defaultValue = null) {
                if (!this.storage[modId]) {
                    try {
                        if (window.StorageManager) {
                            const saved = await window.StorageManager.get('modapi_data_' + modId);
                            this.storage[modId] = saved || {};
                        } else {
                            const saved = localStorage.getItem('modapi_data_' + modId);
                            this.storage[modId] = saved ? JSON.parse(saved) : {};
                        }
                    } catch (e) {
                        this.storage[modId] = {};
                    }
                }
                return this.storage[modId][key] !== undefined ? this.storage[modId][key] : defaultValue;
            },
            
            clearData: async function(modId) {
                this.storage[modId] = {};
                try { 
                    if (window.StorageManager) {
                        await window.StorageManager.remove('modapi_data_' + modId);
                    } else {
                        localStorage.removeItem('modapi_data_' + modId); 
                    }
                } catch (e) {}
            },
            
            // ==================== MOD DATA ALIASES (для совместимости с модами) ====================
            
            // Сохранить данные мода целиком (алиас для saveData)
            saveModData: function(modId, data) {
                this.saveData(modId, 'modData', data);
            },
            
            // Загрузить данные мода целиком (асинхронный, возвращает Promise)
            loadModData: async function(modId) {
                return await this.loadDataAsync(modId, 'modData', null);
            },
            
            // ==================== UTILITIES ====================
            
            formatMoney: function(amount) {
                if (amount >= 1000000000) return (amount / 1000000000).toFixed(1) + 'B';
                if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'M';
                if (amount >= 1000) return (amount / 1000).toFixed(0) + 'K';
                return amount.toString();
            },
            
            randomInt: function(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            },
            
            randomFloat: function(min, max) {
                return Math.random() * (max - min) + min;
            },
            
            randomChoice: function(array) {
                return array[Math.floor(Math.random() * array.length)];
            },
            
            shuffle: function(array) {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            },
            
            clamp: function(value, min, max) {
                return Math.min(Math.max(value, min), max);
            },
            
            lerp: function(a, b, t) {
                return a + (b - a) * t;
            },
            
            debounce: function(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            },
            
            throttle: function(func, limit) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },
            
            deepClone: function(obj) {
                return JSON.parse(JSON.stringify(obj));
            },
            
            // ==================== LOGGING ====================
            
            log: function(modId, ...args) {
                console.log(`[Mod: ${modId}]`, ...args);
            },
            
            warn: function(modId, ...args) {
                console.warn(`[Mod: ${modId}]`, ...args);
            },
            
            error: function(modId, ...args) {
                console.error(`[Mod: ${modId}]`, ...args);
            },
            
            // ==================== RENDERING HELPERS ====================
            
            getPlayerFace: function(playerId) {
                return window.getPlayerFaceHTML ? window.getPlayerFaceHTML(playerId) : '';
            },
            
            getTeamLogo: function(teamId, size = 'md') {
                const team = this.getTeamById(teamId);
                if (!team) return '';
                
                const sizes = { sm: 'w-6 h-6', md: 'w-10 h-10', lg: 'w-16 h-16' };
                
                if (team.logo) {
                    return `<img src="${team.logo}" class="${sizes[size] || sizes.md} object-contain" alt="${team.name}">`;
                }
                return `<div class="${sizes[size] || sizes.md} bg-slate-700 rounded flex items-center justify-center text-xs font-bold text-slate-400">${(team.abbr || team.name.substring(0, 3)).toUpperCase()}</div>`;
            },
            
            getRatingColor: function(rating) {
                if (rating >= 85) return '#4caf50';
                if (rating >= 75) return '#8bc34a';
                if (rating >= 65) return '#ffc107';
                if (rating >= 55) return '#ff9800';
                return '#f44336';
            },
            
            renderPlayerCard: function(player, options = {}) {
                const ratingColor = this.getRatingColor(player.rating);
                return `
                    <div class="bg-slate-800/50 rounded-xl p-4 border border-white/5 ${options.className || ''}">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="w-14 h-14 rounded-full bg-slate-700 overflow-hidden">
                                    ${this.getPlayerFace(player.internalId || player.id)}
                                </div>
                                <div class="absolute -bottom-1 -right-1 w-6 h-6 rounded-full flex items-center justify-center text-xs font-black text-white" style="background: ${ratingColor}">
                                    ${player.rating}
                                </div>
                            </div>
                            <div>
                                <div class="font-bold text-white">${player.name}</div>
                                <div class="text-xs text-slate-400">${player.pos} | ${player.age}y | ${player.nation || 'INT'}</div>
                            </div>
                        </div>
                        ${options.showStats ? `
                            <div class="mt-3 grid grid-cols-3 gap-2 text-center text-xs">
                                <div class="bg-slate-700/50 rounded p-2">
                                    <div class="text-slate-400">Goals</div>
                                    <div class="font-bold text-white">${player.goals || 0}</div>
                                </div>
                                <div class="bg-slate-700/50 rounded p-2">
                                    <div class="text-slate-400">Assists</div>
                                    <div class="font-bold text-white">${player.assists || 0}</div>
                                </div>
                                <div class="bg-slate-700/50 rounded p-2">
                                    <div class="text-slate-400">Apps</div>
                                    <div class="font-bold text-white">${player.appearances || 0}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            },
            
            renderTeamCard: function(team, options = {}) {
                const stats = this.getTeamStats(team.id);
                return `
                    <div class="bg-slate-800/50 rounded-xl p-4 border border-white/5 ${options.className || ''}">
                        <div class="flex items-center gap-3 mb-3">
                            ${this.getTeamLogo(team.id, 'md')}
                            <div>
                                <div class="font-bold text-white">${team.name}</div>
                                <div class="text-xs text-slate-400">${team.league || ''}</div>
                            </div>
                        </div>
                        ${options.showStats && stats ? `
                            <div class="grid grid-cols-4 gap-2 text-center text-xs">
                                <div class="bg-slate-700/50 rounded p-2">
                                    <div class="text-slate-400">P</div>
                                    <div class="font-bold text-white">${stats.played}</div>
                                </div>
                                <div class="bg-slate-700/50 rounded p-2">
                                    <div class="text-slate-400">W</div>
                                    <div class="font-bold text-green-400">${stats.won}</div>
                                </div>
                                <div class="bg-slate-700/50 rounded p-2">
                                    <div class="text-slate-400">D</div>
                                    <div class="font-bold text-yellow-400">${stats.drawn}</div>
                                </div>
                                <div class="bg-slate-700/50 rounded p-2">
                                    <div class="text-slate-400">L</div>
                                    <div class="font-bold text-red-400">${stats.lost}</div>
                                </div>
                            </div>
                            <div class="mt-2 text-center">
                                <span class="text-2xl font-black text-[#4caf50]">${stats.points}</span>
                                <span class="text-xs text-slate-400 ml-1">pts</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            },
            
            // ==================== SAVE/LOAD MODS v4.0 - NEW STRUCTURE ====================
            // Saves mod code to mods/src/name.js
            // Saves mod metadata to mods/mods.json
            // Mods only activate in career (except modtype:menu)

            // Debounced save to prevent too frequent saves
            _saveModsTimeout: null,
            _debouncedSaveMods: function() {
                clearTimeout(this._saveModsTimeout);
                this._saveModsTimeout = setTimeout(() => {
                    this.saveMods();
                }, 1000);
            },
            
            // Set career mode state
            setCareerMode: function(inCareer) {
                const wasInCareer = this._inCareer;
                this._inCareer = inCareer;
                if (inCareer && !wasInCareer) {
                    this._activateCareerMods();
                } else if (!inCareer && wasInCareer) {
                    this._deactivateCareerMods();
                }
            },
            
            // Activate mods that should run in career
            _activateCareerMods: function() {
                console.log('ModAPI: Activating career mods, total:', this.mods.length);
                this.mods.forEach(mod => {
                    if (mod.enabled) {
                        try {
                            // Вызываем onEnable для всех включённых модов при входе в карьеру
                            // (menu моды уже активированы при registerMod)
                            if (mod.modType !== 'menu' && mod.onEnable) {
                                console.log('ModAPI: Activating career mod:', mod.id);
                                mod.onEnable(this);
                            }
                            
                            // Вызываем init повторно если мод ещё не был инициализирован в карьере
                            if (!mod._careerInitialized && mod.init && mod.modType !== 'menu') {
                                mod.init(this);
                                mod._careerInitialized = true;
                            }
                        } catch (e) {
                            console.error('ModAPI: Failed to activate mod:', mod.id, e);
                            this.showNotification(`Mod error: ${mod.name} - ${e.message}`, 5000, 'error');
                        }
                    }
                });
                
                // Рендерим пункты меню модов
                this._renderCustomMenuItems();
            },
            
            // Deactivate career-only mods
            _deactivateCareerMods: function() {
                this.mods.forEach(mod => {
                    if (mod.modType !== 'menu') {
                        try {
                            if (mod.onDisable) mod.onDisable(this);
                        } catch (e) {}
                    }
                });
            },

            // Save mods to Documents/FootLogic/mods/src/name.js and mods/mods.json
            saveMods: async function() {
                try {
                    if (window.StorageManager) {
                        await window.StorageManager.init();
                    }
                    
                    const Filesystem = window.getCapacitorPlugin?.('Filesystem');
                    const directory = window.StorageManager?.getDirectory?.() || 'Documents';
                    
                    // Prepare mods metadata (without code)
                    const modsMetadata = this.mods.map(m => ({
                        id: m.id,
                        name: m.name,
                        version: m.version,
                        author: m.author || 'Unknown',
                        description: m.description || '',
                        modType: m.modType || 'career', // 'career' | 'menu'
                        enabled: m.enabled !== false,
                        savedAt: new Date().toISOString()
                    }));
                    
                    // Filter mods with code for file saving
                    const modsWithCode = this.mods.filter(m => m.code || m._sourceCode);
                    
                    if (Filesystem && window.StorageManager?.isNative?.()) {
                        // Create mods/src directory
                        try {
                            await Filesystem.mkdir({
                                path: 'FootLogic/mods/src',
                                directory: directory,
                                recursive: true
                            });
                        } catch (e) { /* dir exists */ }
                        
                        // Save each mod's code to mods/src/name.js
                        for (const mod of modsWithCode) {
                            const code = mod.code || mod._sourceCode || '';
                            if (code.trim()) {
                                try {
                                    await Filesystem.writeFile({
                                        path: `FootLogic/mods/src/${mod.id}.js`,
                                        data: code,
                                        directory: directory,
                                        encoding: 'utf8'
                                    });
                                } catch (e) {
                                    console.warn('ModAPI: Failed to save mod code:', mod.id, e.message);
                                }
                            }
                        }
                        
                        // Save mods metadata to mods/mods.json
                        try {
                            await Filesystem.writeFile({
                                path: 'FootLogic/mods/mods.json',
                                data: JSON.stringify(modsMetadata, null, 2),
                                directory: directory,
                                encoding: 'utf8'
                            });
                        } catch (e) {
                            console.warn('ModAPI: Failed to save mods.json:', e.message);
                        }
                        
                        console.log('ModAPI v4: Saved', modsWithCode.length, 'mods to FootLogic/mods/');
                    } else {
                        // localStorage fallback - save everything together
                        const fullData = this.mods.map(m => {
                            const meta = modsMetadata.find(meta => meta.id === m.id) || {};
                            return {
                                ...meta,
                                id: m.id,
                                name: m.name,
                                version: m.version,
                                enabled: m.enabled, // Сохраняем статус включения
                                modType: m.modType || 'career',
                                code: m.code || m._sourceCode || ''
                            };
                        }).filter(m => m.code);
                        localStorage.setItem('footlogic_mods_v4', JSON.stringify(fullData));
                        console.log('ModAPI v4: Saved', fullData.length, 'mods to localStorage');
                    }
                } catch (e) {
                    console.error('ModAPI v4: saveMods error:', e);
                    // Fallback
                    try {
                        const fallbackData = this.mods.map(m => ({
                            id: m.id, name: m.name, version: m.version,
                            author: m.author, description: m.description,
                            modType: m.modType || 'career',
                            enabled: m.enabled, code: m.code || m._sourceCode || ''
                        })).filter(m => m.code);
                        localStorage.setItem('footlogic_mods_v4', JSON.stringify(fallbackData));
                    } catch (e2) {}
                }
            },
            
            // Load mods from Documents/FootLogic/mods/mods.json and mods/src/*.js
            loadMods: async function() {
                try {
                    if (window.StorageManager) {
                        await window.StorageManager.init();
                    }
                    
                    const Filesystem = window.getCapacitorPlugin?.('Filesystem');
                    const directory = window.StorageManager?.getDirectory?.() || 'Documents';
                    let modsData = null;
                    
                    if (Filesystem && window.StorageManager?.isNative?.()) {
                        // Try to load from mods/mods.json first
                        try {
                            const metaResult = await Filesystem.readFile({
                                path: 'FootLogic/mods/mods.json',
                                directory: directory,
                                encoding: 'utf8'
                            });
                            const metadata = JSON.parse(metaResult.data);
                            
                            // Load code for each mod from mods/src/name.js
                            modsData = [];
                            for (const meta of metadata) {
                                try {
                                    const codeResult = await Filesystem.readFile({
                                        path: `FootLogic/mods/src/${meta.id}.js`,
                                        directory: directory,
                                        encoding: 'utf8'
                                    });
                                    modsData.push({
                                        ...meta,
                                        code: codeResult.data
                                    });
                                } catch (e) {
                                    console.warn('ModAPI v4: Code not found for mod:', meta.id);
                                    // Still add mod without code (will be inactive)
                                    modsData.push({ ...meta, code: '' });
                                }
                            }
                        } catch (e) {
                            // mods.json not found, try old format or scan directory
                            modsData = await this._scanModsDirectory();
                        }
                    }
                    
                    // Fallback to localStorage (new v4 format first, then v3)
                    if (!modsData || !Array.isArray(modsData) || modsData.length === 0) {
                        let saved = localStorage.getItem('footlogic_mods_v4');
                        if (!saved) saved = localStorage.getItem('footlogic_mods');
                        modsData = saved ? JSON.parse(saved) : null;
                    }
                    
                    if (!modsData || !Array.isArray(modsData) || modsData.length === 0) {
                        console.log('ModAPI v4: No saved mods found');
                        return;
                    }
                    
                    console.log('ModAPI v4: Loading', modsData.length, 'saved mods');
                    
                    let loadedCount = 0;
                    for (const modData of modsData) {
                        if (modData.code && modData.code.trim()) {
                            try {
                                const success = await this._executeModCode(modData.code, modData);
                                if (success) {
                                    loadedCount++;
                                    console.log('ModAPI v4: Loaded mod:', modData.name || modData.id);
                                }
                            } catch (e) {
                                console.error('ModAPI v4: Load error for', modData.id, ':', e.message);
                            }
                        }
                    }
                    
                    console.log('ModAPI v4: Loaded', loadedCount, 'of', modsData.length, 'mods');
                    
                    // FIXED: Устанавливаем флаг инициализации и вызываем событие
                    this._initialized = true;
                    this.trigger('modsLoaded', { count: loadedCount, total: modsData.length });
                    
                } catch (e) {
                    console.error('ModAPI v4: loadMods error:', e);
                    this._initialized = true; // Всё равно устанавливаем флаг
                }
            },
            
            // Execute mod code and register it
            _executeModCode: function(code, modData) {
                return new Promise((resolve) => {
                    try {
                        const originalRegister = this.registerMod.bind(this);
                        const codeToExecute = code.trim();
                        
                        this.registerMod = (modInfo) => {
                            modInfo._sourceCode = codeToExecute;
                            modInfo.code = codeToExecute;
                            modInfo.modType = modInfo.modType || modData.modType || 'career';
                            const result = originalRegister(modInfo);
                            
                            const mod = this.mods.find(m => m.id === modInfo.id);
                            if (mod && modData) {
                                // ИСПРАВЛЕНО: Приоритет сохраненному значению enabled
                                mod.enabled = (modData.enabled !== undefined) ? modData.enabled : true;
                                mod.modType = modInfo.modType;
                            }
                            
                            return result;
                        };
                        
                        try {
                            const modFunc = new Function(codeToExecute);
                            modFunc();
                        } catch (funcError) {
                            console.warn('ModAPI v4: Function constructor failed, trying eval:', funcError.message);
                            (0, eval)(codeToExecute);
                        }
                        
                        this.registerMod = originalRegister;
                        resolve(true);
                    } catch (e) {
                        console.error('ModAPI v4: _executeModCode error:', e);
                        resolve(false);
                    }
                });
            },
            
            // Scan mods/src directory for .js files
            _scanModsDirectory: async function() {
                try {
                    const Filesystem = window.getCapacitorPlugin?.('Filesystem');
                    if (!Filesystem) return null;
                    
                    const directory = window.StorageManager?.getDirectory?.() || 'Documents';
                    
                    const result = await Filesystem.readdir({
                        path: 'FootLogic/mods/src',
                        directory: directory
                    });
                    
                    const mods = [];
                    for (const file of result.files || []) {
                        const fileName = file.name || file;
                        if (fileName.endsWith('.js')) {
                            try {
                                const fileContent = await Filesystem.readFile({
                                    path: `FootLogic/mods/src/${fileName}`,
                                    directory: directory,
                                    encoding: 'utf8'
                                });
                                
                                mods.push({
                                    id: fileName.replace('.js', ''),
                                    name: fileName.replace('.js', ''),
                                    version: '1.0.0',
                                    modType: 'career',
                                    code: fileContent.data,
                                    enabled: true
                                });
                            } catch (e) {
                                console.warn('ModAPI v4: Failed to read mod file:', fileName);
                            }
                        }
                    }
                    
                    return mods.length > 0 ? mods : null;
                } catch (e) {
                    console.log('ModAPI v4: No mods/src directory found');
                    return null;
                }
            },
            
            importMod: function(code) {
                try {
                    const wrappedCode = code.trim();
                    
                    // Валидация кода - проверяем что есть вызов registerMod
                    if (!wrappedCode.includes('ModAPI.registerMod') && !wrappedCode.includes('registerMod(')) {
                        this.showNotification('Invalid mod: must call ModAPI.registerMod()', 5000, 'error');
                        return false;
                    }
                    
                    console.log('ModAPI: Importing mod, code length:', wrappedCode.length);
                    
                    const originalRegister = this.registerMod.bind(this);
                    const self = this;
                    let importedModId = null;
                    
                    // Переопределяем registerMod чтобы сохранить код
                    this.registerMod = function(modInfo) {
                        // ИСПРАВЛЕНО: Сохраняем код в оба поля для надёжности
                        modInfo._sourceCode = wrappedCode;
                        modInfo.code = wrappedCode;
                        importedModId = modInfo.id;
                        return originalRegister(modInfo);
                    };
                    
                    // Выполняем код мода
                    try {
                        const modFunc = new Function(wrappedCode);
                        modFunc();
                    } catch (evalError) {
                        console.warn('ModAPI: Function constructor failed, trying eval:', evalError.message);
                        (0, eval)(wrappedCode);
                    }
                    
                    this.registerMod = originalRegister;
                    
                    // ИСПРАВЛЕНО: Если мы в карьере, активируем мод сразу
                    if (this._inCareer && importedModId) {
                        const mod = this.getMod(importedModId);
                        if (mod && mod.enabled && mod.modType !== 'menu') {
                            try {
                                if (mod.onEnable) mod.onEnable(this);
                                console.log('ModAPI: Activated imported mod in career:', importedModId);
                            } catch (e) {
                                console.error('ModAPI: Failed to activate imported mod:', e);
                            }
                        }
                    }
                    
                    // ИСПРАВЛЕНО: Принудительно сохраняем моды после успешного импорта
                    this.saveMods();
                    
                    this.showNotification('Mod imported successfully!', 3000, 'success');
                    return true;
                } catch (e) {
                    console.error('ModAPI: Import error', e);
                    this.showNotification('Import failed: ' + e.message, 5000, 'error');
                    return false;
                }
            },
            
            exportMod: function(modId) {
                const mod = this.mods.find(m => m.id === modId);
                if (!mod || !mod.code) return null;
                return mod.code;
            },
            
            // ==================== UTILITY FUNCTIONS ====================
            
            // Форматирование денег
            formatMoney: function(amount) {
                if (typeof window.formatMoney === 'function') return window.formatMoney(amount);
                if (amount >= 1000000) return `€${(amount / 1000000).toFixed(1)}M`;
                if (amount >= 1000) return `€${(amount / 1000).toFixed(0)}K`;
                return `€${amount}`;
            },
            
            // Рандом в диапазоне
            random: function(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            },
            
            // Выбор случайного элемента из массива
            randomPick: function(array) {
                return array[Math.floor(Math.random() * array.length)];
            },
            
            // Проверка шанса (0-100)
            chance: function(percent) {
                return Math.random() * 100 < percent;
            },
            
            // Clamp значение в диапазоне
            clamp: function(value, min, max) {
                return Math.min(Math.max(value, min), max);
            },
            
            // Линейная интерполяция
            lerp: function(a, b, t) {
                return a + (b - a) * t;
            },
            
            // Получить текущую дату игры
            getGameDate: function() {
                const season = this.getSeason();
                const week = this.getCurrentWeek();
                return { season, week, formatted: `Season ${season}, Week ${week + 1}` };
            },
            
            // Delayed execution
            delay: function(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },
            
            // ==================== DOM HELPERS ====================
            
            // Создать элемент
            createElement: function(tag, attrs = {}, children = []) {
                const el = document.createElement(tag);
                Object.entries(attrs).forEach(([key, value]) => {
                    if (key === 'className') el.className = value;
                    else if (key === 'style' && typeof value === 'object') {
                        Object.assign(el.style, value);
                    } else if (key.startsWith('on') && typeof value === 'function') {
                        el.addEventListener(key.slice(2).toLowerCase(), value);
                    } else {
                        el.setAttribute(key, value);
                    }
                });
                children.forEach(child => {
                    if (typeof child === 'string') el.appendChild(document.createTextNode(child));
                    else if (child instanceof HTMLElement) el.appendChild(child);
                });
                return el;
            },
            
            // Query selector shorthand
            $: function(selector) { return document.querySelector(selector); },
            $$: function(selector) { return document.querySelectorAll(selector); },
            
            // ==================== GAME MODIFICATION HELPERS ====================
            // NOTE: modifyPlayer and modifyTeam are defined above in MODIFICATIONS section
            
            // Добавить деньги команде
            addBudget: function(teamId, amount) {
                const team = this.getTeamById(teamId);
                if (!team) return false;
                
                team.budget = (team.budget || 0) + amount;
                this.trigger('budgetChange', { team, amount, newBudget: team.budget });
                return team.budget;
            },
            
            // Создать случайного игрока
            generatePlayer: function(options = {}) {
                const positions = ['GK', 'CB', 'LB', 'RB', 'CDM', 'CM', 'CAM', 'LW', 'RW', 'ST'];
                const nations = ['ENG', 'ESP', 'FRA', 'GER', 'ITA', 'BRA', 'ARG', 'POR', 'NED', 'BEL'];
                
                const pos = options.position || this.randomPick(positions);
                const age = options.age || this.random(17, 35);
                const rating = options.rating || this.random(55, 85);
                const potential = options.potential || Math.min(99, rating + this.random(0, 15));
                
                return {
                    id: 'gen_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    internalId: Date.now(),
                    name: options.name || 'Generated Player',
                    pos: pos,
                    age: age,
                    nation: options.nation || this.randomPick(nations),
                    rating: rating,
                    pot: potential,
                    value: Math.floor(rating * rating * 1000),
                    wage: Math.floor(rating * 500),
                    speed: this.random(rating - 15, rating + 10),
                    shot: this.random(rating - 15, rating + 10),
                    pass: this.random(rating - 15, rating + 10),
                    dribble: this.random(rating - 15, rating + 10),
                    def: pos === 'GK' || pos === 'CB' || pos === 'CDM' ? this.random(rating - 5, rating + 10) : this.random(rating - 20, rating),
                    phys: this.random(rating - 10, rating + 10),
                    goals: 0,
                    assists: 0,
                    appearances: 0,
                    energy: 100,
                    morale: 80,
                    ...options
                };
            },
            
            // Добавить игрока в команду
            addPlayerToTeam: function(player, teamId) {
                const team = this.getTeamById(teamId);
                if (!team) return false;
                
                player.clubId = teamId;
                team.squad.push(player);
                
                if (window.calculateTeamRating) {
                    window.calculateTeamRating(team);
                }
                
                this.trigger('playerAdded', { player, team });
                return true;
            },
            
            // Удалить игрока из команды
            removePlayerFromTeam: function(playerId, teamId) {
                const team = this.getTeamById(teamId);
                if (!team) return false;
                
                const idx = team.squad.findIndex(p => 
                    p.id === playerId || p.internalId === playerId
                );
                
                if (idx === -1) return false;
                
                const player = team.squad.splice(idx, 1)[0];
                
                if (window.calculateTeamRating) {
                    window.calculateTeamRating(team);
                }
                
                this.trigger('playerRemoved', { player, team });
                return player;
            },
            
            // ==================== РАСШИРЕННЫЕ WIDGETS ====================
            
            // Добавить виджет на dashboard
            addDashboardWidget: function(widgetId, config) {
                this.customWidgets[widgetId] = {
                    id: widgetId,
                    title: config.title || 'Widget',
                    render: config.render,
                    position: config.position || 'bottom',
                    modId: config.modId || null,
                    visible: true
                };
                this.trigger('widgetAdded', { widgetId, config });
                return true;
            },
            
            removeWidget: function(widgetId) {
                delete this.customWidgets[widgetId];
            },
            
            renderWidgets: function(position = 'bottom') {
                const widgets = Object.values(this.customWidgets)
                    .filter(w => w.position === position && w.visible);
                
                return widgets.map(widget => {
                    try {
                        return widget.render(this);
                    } catch(e) {
                        console.error('ModAPI: Widget render error', widget.id, e);
                        return '';
                    }
                }).join('');
            },
            
            // ==================== DEBUGGING & TESTING ====================
            
            // Дамп состояния игры
            dumpState: function() {
                return {
                    mods: this.mods.map(m => ({ id: m.id, name: m.name, version: m.version, enabled: m.enabled })),
                    events: Object.keys(this.events),
                    interceptors: Object.keys(this.interceptors),
                    hooks: Object.keys(this.hooks),
                    customScreens: Object.keys(this.customScreens),
                    widgets: Object.keys(this.customWidgets),
                    state: {
                        season: this.getSeason(),
                        week: this.getCurrentWeek(),
                        userTeamId: this.getUserTeamId(),
                        view: this.getCurrentView()
                    }
                };
            },
            
            // Запустить тест мода
            testMod: function(modId) {
                const mod = this.getMod(modId);
                if (!mod) return { success: false, error: 'Mod not found' };
                
                const results = {
                    modId,
                    tests: [],
                    success: true
                };
                
                // Test init
                if (mod.init) {
                    try {
                        mod.init(this);
                        results.tests.push({ name: 'init', passed: true });
                    } catch(e) {
                        results.tests.push({ name: 'init', passed: false, error: e.message });
                        results.success = false;
                    }
                }
                
                // Test onEnable
                if (mod.onEnable) {
                    try {
                        mod.onEnable(this);
                        results.tests.push({ name: 'onEnable', passed: true });
                    } catch(e) {
                        results.tests.push({ name: 'onEnable', passed: false, error: e.message });
                        results.success = false;
                    }
                }
                
                return results;
            },
            
            // ==================== PROTECTED MOD CONTAINER (НОВОЕ) ====================
            
            // Получить защищённый контейнер для модов (не удаляется при renderDashboard)
            getModRoot: function() {
                let root = document.getElementById('mod-root');
                if (!root) {
                    root = document.createElement('div');
                    root.id = 'mod-root';
                    root.className = 'mod-root-container';
                    root.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999990;';
                    document.body.appendChild(root);
                }
                return root;
            },
            
            // Создать элемент в защищённом контейнере (сохранится при смене вкладок)
            createModElement: function(id, options = {}) {
                const root = this.getModRoot();
                
                // Если элемент уже существует, возвращаем его
                let el = document.getElementById(id);
                if (el) return el;
                
                el = document.createElement(options.tag || 'div');
                el.id = id;
                el.className = options.className || '';
                el.style.cssText = (options.style || '') + '; pointer-events: auto;';
                
                if (options.html) el.innerHTML = options.html;
                
                root.appendChild(el);
                console.log('ModAPI: Created protected element:', id);
                return el;
            },
            
            // Удалить элемент из защищённого контейнера
            removeModElement: function(id) {
                const el = document.getElementById(id);
                if (el && el.parentNode?.id === 'mod-root') {
                    el.remove();
                    return true;
                }
                return false;
            },
            
            // Хранилище состояния UI для модов (сохраняется при смене вкладок)
            _modUIState: {},
            
            // Сохранить состояние UI мода
            saveModUIState: function(modId, state) {
                this._modUIState[modId] = { ...state, _savedAt: Date.now() };
            },
            
            // Получить состояние UI мода
            getModUIState: function(modId) {
                return this._modUIState[modId] || null;
            },
            
            // Проверить, открыто ли окно мода
            isModWindowOpen: function(modId, windowId) {
                const state = this._modUIState[modId];
                return state && state[windowId + '_open'] === true;
            },
            
            // Пометить окно мода как открытое/закрытое
            setModWindowOpen: function(modId, windowId, isOpen) {
                if (!this._modUIState[modId]) this._modUIState[modId] = {};
                this._modUIState[modId][windowId + '_open'] = isOpen;
            },
            
            // Перерисовать все открытые окна модов (вызывается после renderDashboard)
            _refreshModWindows: function() {
                // ИСПРАВЛЕНИЕ: Перерисовываем пункты меню модов в сайдбаре
                // Это необходимо потому что renderDashboard() пересоздаёт весь DOM навигации
                this._renderCustomMenuItems();
                
                // Вызываем событие dashboardRender для всех включённых модов
                this.trigger('dashboardRender', { api: this, view: this.getCurrentView() });
                
                // Также вызываем onDashboardRender хук для легаси совместимости
                this.mods.filter(m => m.enabled).forEach(mod => {
                    if (mod.onDashboardRender) {
                        try {
                            mod.onDashboardRender(this);
                        } catch (e) {
                            console.error('ModAPI: onDashboardRender error for', mod.id, e);
                        }
                    }
                });
            }
        };
        
        // Автоматическая загрузка модов после инициализации StorageManager
        document.addEventListener('DOMContentLoaded', function() {
            // ИСПРАВЛЕНИЕ: Создаём защищённый контейнер для модов, который НЕ удаляется при renderDashboard
            let modRoot = document.getElementById('mod-root');
            if (!modRoot) {
                modRoot = document.createElement('div');
                modRoot.id = 'mod-root';
                modRoot.className = 'mod-root-container';
                modRoot.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999990;';
                document.body.appendChild(modRoot);
                console.log('ModAPI: Created protected mod-root container');
            }
            
            // Ждём инициализации StorageManager и Capacitor (уменьшена задержка)
            setTimeout(async () => {
                try {
                    if (window.StorageManager) {
                        await window.StorageManager.init();
                    }
                    console.log('ModAPI: Starting mods loading...');
                    await window.ModAPI.loadMods();
                    updateModsCountBadge();
                    console.log('ModAPI: Mods loaded successfully');
                } catch (e) {
                    console.error('ModAPI: Error during initialization:', e);
                }
            }, 500);
        });
        
        // ========== MOD MANAGER UI FUNCTIONS ==========
        
        function openModManager() {
            document.getElementById('mod-manager-screen').classList.remove('hidden');
            // FIXED: Always refresh the mods list when opening manager
            renderModsList();
            // Also re-render menu items in case mods added any
            window.ModAPI._renderCustomMenuItems();
        }
        
        function closeModManager() {
            document.getElementById('mod-manager-screen').classList.add('hidden');
            // FIXED: Re-save mods when closing manager
            window.ModAPI.saveMods();
        }
        
        function showModDocs() {
            document.getElementById('mod-docs-screen').classList.remove('hidden');
        }
        
        function closeModDocs() {
            document.getElementById('mod-docs-screen').classList.add('hidden');
        }
        
        function updateModsCountBadge() {
            const badge = document.getElementById('mods-count-badge');
            if (badge) {
                badge.textContent = window.ModAPI.mods.length;
            }
        }
        
        function renderModsList() {
            const container = document.getElementById('mods-list');
            const noModsMessage = document.getElementById('no-mods-message');
            const mods = window.ModAPI.mods;
            
            if (mods.length === 0) {
                container.innerHTML = '';
                noModsMessage.classList.remove('hidden');
                return;
            }
            
            noModsMessage.classList.add('hidden');
            
            container.innerHTML = mods.map(mod => `
                <div class="bg-slate-800/50 rounded-2xl p-5 border ${mod.enabled ? 'border-[#4caf50]/30' : 'border-white/5'} transition-all">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br ${mod.enabled ? 'from-purple-600 to-purple-800' : 'from-slate-600 to-slate-700'} rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg">
                                JS
                            </div>
                            <div>
                                <h4 class="font-black text-white">${escapeHtml(mod.name)}</h4>
                                <p class="text-xs text-slate-500">v${escapeHtml(mod.version)} by ${escapeHtml(mod.author)}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleModEnabled('${mod.id}')" 
                                    class="w-12 h-6 rounded-full ${mod.enabled ? 'bg-[#4caf50]' : 'bg-slate-600'} relative transition-all">
                                <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 ${mod.enabled ? 'right-0.5' : 'left-0.5'} transition-all shadow"></div>
                            </button>
                        </div>
                    </div>
                    
                    <p class="text-slate-400 text-sm mb-4">${escapeHtml(mod.description || 'No description')}</p>
                    
                    <div class="flex items-center gap-2">
                        <span class="px-2 py-1 rounded text-xs ${mod.enabled ? 'bg-[#4caf50]/20 text-[#4caf50]' : 'bg-slate-700 text-slate-400'}">
                            ${mod.enabled ? 'Active' : 'Disabled'}
                        </span>
                        <span class="px-2 py-1 rounded text-xs bg-slate-700 text-slate-400">ID: ${escapeHtml(mod.id)}</span>
                        <button onclick="deleteMod('${mod.id}')" class="ml-auto text-red-400 hover:text-red-300 text-xs font-bold transition-colors">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
            
            updateModsCountBadge();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function toggleModEnabled(modId) {
            const mod = window.ModAPI.mods.find(m => m.id === modId);
            if (mod) {
                window.ModAPI.toggleMod(modId, !mod.enabled);
                renderModsList();
            }
        }
        
        function deleteMod(modId) {
            if (confirm('Are you sure you want to delete this mod?')) {
                window.ModAPI.unregisterMod(modId);
                renderModsList();
            }
        }
        
        function importModFromFile() {
            document.getElementById('mod-file-input').click();
        }
        
        function handleModFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const code = e.target.result;
                
                if (window.ModAPI.importMod(code)) {
                    window.ModAPI.showNotification('Mod imported successfully!', 3000);
                    renderModsList();
                }
            };
            reader.onerror = function() {
                window.ModAPI.showNotification('Failed to read mod file', 3000);
            };
            reader.readAsText(file);
            
            // Reset input
            event.target.value = '';
        }
        
        // ========== END MOD MANAGER UI ==========
        
        // ========== END MOD API SYSTEM ==========
        
        // ВАЖНО: Функция для безопасного вызова Capacitor плагинов
        window.callCapacitorPlugin = async function(pluginName, methodName, options) {
            try {
                const plugin = window.getCapacitorPlugin(pluginName);
                if (plugin && typeof plugin[methodName] === 'function') {
                    return await plugin[methodName](options);
                } else {
                    console.warn('Plugin method not available:', pluginName, methodName);
                    return null;
                }
            } catch (e) {
                console.error('Capacitor plugin call error:', pluginName, methodName, e);
                return null;
            }
        };
    </script>



    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        
        /* Force landscape orientation - УЛУЧШЕНО для лучшей поддержки */
        @media screen and (orientation: portrait) {
            html {
                transform: rotate(-90deg);
                transform-origin: left top;
                width: 100vh;
                height: 100vw;
                overflow-x: hidden;
                position: absolute;
                top: 100%;
                left: 0;
            }
        }
        
        /* Safe area insets для устройств с выемками */
        @supports(padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
                padding-top: max(0px, env(safe-area-inset-top));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }
        }

        /* НОВОЕ: Глобальное масштабирование для маленьких экранов */
        @media screen and (max-width: 640px), screen and (max-height: 380px) {
            :root {
                font-size: 14px;
            }
            .scale-90 {
                transform: scale(0.85);
            }
        }
        
        @media screen and (max-height: 320px) {
            :root {
                font-size: 12px;
            }
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f0f; 
            color: #f0f0f0;
            overflow: hidden;
            height: 100vh;
            height: 100dvh; /* dynamic viewport height для мобильных */
            width: 100vw;
            max-width: 100vw;
            margin: 0;
            padding: 0;
            overflow-x: hidden !important;
        }
        
        /* Prevent any horizontal overflow */
        html {
            overflow-x: hidden !important;
            max-width: 100vw;
        }
        
        #app, .glass-panel, .fut-card, .modal-content-mobile {
            max-width: 100%;
            overflow-x: hidden;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content.open {
            max-height: 500px;
            transition: max-height 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .modal-animate {
            animation: fadeIn 0.15s ease-out forwards;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            70% { transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        .pop-animate {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .player-card-select {
            transition: all 0.15s;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .player-card-select:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }
        .player-card-select.selected {
            background-color: rgba(76, 175, 80, 0.2);
            border-color: #4caf50;
            transform: scale(1.01);
        }
        
        .waiting-swap {
            border: 2px solid #fbbf24 !important;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
            animation: pulse-gold 1.5s infinite;
        }
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
            50% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); }
        }

        .player-card-select.unavailable {
            background-color: rgba(200, 0, 0, 0.1);
            opacity: 0.7;
            cursor: pointer;
        }
        .player-card-select.unavailable:hover {
            opacity: 1;
            background-color: rgba(200, 0, 0, 0.2);
        }

        .clickable-name {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: all 0.15s;
        }
        .clickable-name:hover {
            color: #4caf50;
            text-decoration-color: #4caf50;
        }

        .fut-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        .fut-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 60%);
            pointer-events: none;
        }
        
        /* New Player Card Styles */
        .player-face-img {
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }
        
        .negotiation-step {
            transition: all 0.3s ease;
        }
        .negotiation-step.active {
            opacity: 1;
            transform: translateX(0);
        }
        .negotiation-step.hidden {
            display: none;
        }
        .stat-value.gold { color: #fbbf24; text-shadow: 0 0 8px rgba(251, 191, 36, 0.3); }

        .filter-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.15s;
            background: rgba(255,255,255,0.05);
            color: #94a3b8;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .filter-btn.active { background: #4caf50; color: white; }

        .ticker-line {
            opacity: 0;
            animation: slideIn 0.2s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .confetti {
            position: fixed;
            width: 8px;
            height: 8px;
            background-color: #f00;
            animation: fall linear forwards;
            z-index: 100;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }
        
        /* AWARDS CAROUSEL STYLES */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .awards-slide {
            display: none;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        
        .awards-slide.active {
            display: block;
            opacity: 1;
            transform: translateX(0);
        }
        
        .awards-slide.slide-out-left {
            display: block;
            opacity: 0;
            transform: translateX(-20px);
        }
        
        .awards-slide.slide-out-right {
            display: block;
            opacity: 0;
            transform: translateX(20px);
        }
        
        .awards-dot.active {
            background-color: #4caf50 !important;
            transform: scale(1.3);
        }
        
        /* Responsive awards carousel */
        @media screen and (max-height: 400px) {
            #awards-carousel {
                min-height: 140px !important;
            }
            .awards-slide > div {
                min-height: 120px !important;
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
            .awards-slide .text-5xl,
            .awards-slide .text-7xl {
                font-size: 2.5rem !important;
            }
        }
        
        @media screen and (orientation: landscape) and (max-height: 500px) {
            #awards-carousel {
                min-height: 150px;
            }
        }
        
        /* Loading screen styles */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-out;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(76, 175, 80, 0.2);
            border-top-color: #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: #4caf50;
            font-size: 16px;
            font-weight: 600;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading-progress {
            margin-top: 30px;
            width: 200px;
            height: 4px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%);
            border-radius: 2px;
            animation: progressBar 2s ease-in-out infinite;
        }
        
        @keyframes progressBar {
            0% { width: 0%; transform: translateX(0); }
            50% { width: 70%; }
            100% { width: 100%; transform: translateX(0); }
        }

        .type-transfer { border-left: 3px solid #4caf50; }
        .type-injury { border-left: 3px solid #ef4444; }
        .type-match { border-left: 3px solid #3b82f6; }
        .type-info { border-left: 3px solid #94a3b8; }
        .type-award { border-left: 3px solid #fbbf24; }

        .award-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
            font-weight: bold;
        }

        .stat-trophy {
            background: linear-gradient(135deg, #fbbf24 20%, #f59e0b 80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }

        .empty-slot {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.3) 100%);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            cursor: pointer;
        }
        .empty-slot:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(15, 23, 42, 0.3) 100%);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .slot-placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.65rem;
        }

        .red-card-indicator {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { background-color: rgba(239, 68, 68, 0.2); }
            50% { background-color: rgba(239, 68, 68, 0.4); }
        }

        .score-pulse {
            animation: scorePulse 0.3s ease-out;
        }
        @keyframes scorePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        /* LANDSCAPE MODE: Left compact navigation - УЛУЧШЕНО */
        .landscape-nav {
            width: 44px;
            min-width: 44px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-right: 1px solid rgba(255,255,255,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 0;
            z-index: 50;
            overflow-y: auto;
            overflow-x: hidden;
            flex-shrink: 0;
        }
        
        .landscape-nav-btn {
            width: 34px;
            height: 34px;
            min-height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            margin: 2px 0;
            transition: all 0.15s;
            font-size: 14px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .landscape-nav-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        .landscape-nav-btn.active {
            background: #4caf50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }
        
        /* Top header bar for landscape - УЛУЧШЕНО */
        .landscape-header {
            height: 28px;
            min-height: 28px;
            background: linear-gradient(90deg, #1e293b 0%, #0f172a 100%);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            flex-shrink: 0;
        }
        
        /* Horizontal pitch for landscape tactics */
        .landscape-pitch {
            background: linear-gradient(90deg, #2d5a27 0%, #3d7a37 50%, #2d5a27 100%);
            border-radius: 8px;
            position: relative;
            aspect-ratio: 16/10;
            max-height: calc(100vh - 100px);
            max-height: calc(100dvh - 100px);
        }
        
        /* Compact table styles - УЛУЧШЕНО */
        .compact-table {
            font-size: 0.65rem;
        }
        .compact-table th, .compact-table td {
            padding: 3px 6px;
        }
        
        /* Modal styles for landscape - УЛУЧШЕНО */
        .modal-landscape {
            max-width: 90vw;
            max-height: 80vh;
            max-height: 80dvh;
        }
        
        /* Extra compact content styles */
        .glass-panel {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Button touch area optimization - УЛУЧШЕНО для Capacitor/WebView */
        button, .clickable-name, .player-card-select, .menu-card-item, [onclick] {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            cursor: pointer;
        }
        
        /* Убираем задержку 300ms для touch событий */
        * {
            touch-action: manipulation;
        }
        
        button:active, .menu-card-item:active, [onclick]:active {
            transform: scale(0.97);
            opacity: 0.9;
        }
        
        /* Фикс для Android WebView - кнопки должны быть кликабельны */
        button, input, select, textarea, [onclick], .menu-card-item {
            pointer-events: auto !important;
        }
        
        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, ::before, ::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Ensure full height layout - УЛУЧШЕНО */
        html, body, #app {
            height: 100%;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
        }
        
        /* Custom scrollbar for content areas */
        .scroll-y {
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Pitch player markers */
        .pitch-player {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.15s;
        }
        .pitch-player:hover {
            transform: scale(1.1);
        }
        .pitch-player-circle {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 800;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .pitch-player-name {
            font-size: 9px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            margin-top: 3px;
            max-width: 55px;
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        
        /* НОВОЕ: Улучшенные стили для market на landscape */
        .market-row {
            transition: background-color 0.15s;
        }
        .market-row:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* НОВОЕ: Улучшенные стили для таблицы лиги */
        .league-table-row {
            transition: background-color 0.15s;
        }
        .league-table-row:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }
        
        /* УЛУЧШЕННЫЕ стили для еврокубков */
        .euro-ucl { border-color: #3b82f6; }
        .euro-uel { border-color: #f97316; }
        .euro-uecl { border-color: #10b981; }
        
        /* Градиенты для еврокубков */
        .euro-ucl-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%); }
        .euro-uel-gradient { background: linear-gradient(135deg, #9a3412 0%, #ea580c 100%); }
        .euro-uecl-gradient { background: linear-gradient(135deg, #065f46 0%, #059669 100%); }
        
        /* Карточка результата еврокубка */
        .euro-result-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .euro-result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        /* Анимация для текущего матча */
        @keyframes euro-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .euro-live {
            animation: euro-pulse 2s ease-in-out infinite;
        }
        
        /* Стили для групповой таблицы */
        .euro-table-row {
            transition: background-color 0.15s ease;
        }
        .euro-table-row:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* Бейджи квалификации */
        .euro-badge-qualified {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
        }
        .euro-badge-eliminated {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
        }
        
        /* НОВОЕ: Улучшенный toast */
        .game-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* НОВОЕ: Адаптивные стили для очень маленьких экранов */
        @media screen and (max-height: 400px) {
            .landscape-nav {
                width: 36px;
                min-width: 36px;
                padding: 2px 0;
            }
            .landscape-nav-btn {
                width: 26px;
                height: 26px;
                min-height: 26px;
                font-size: 11px;
                margin: 1px 0;
            }
            .landscape-header {
                height: 24px;
                min-height: 24px;
                padding: 0 8px;
            }
            .landscape-header .text-xs {
                font-size: 9px;
            }
        }
        
        @media screen and (max-height: 320px) {
            .landscape-nav {
                width: 32px;
                min-width: 32px;
            }
            .landscape-nav-btn {
                width: 24px;
                height: 24px;
                min-height: 24px;
                font-size: 10px;
            }
        }
        
        /* Улучшенные стили для 2D симуляции */
        #match-canvas {
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: pixelated;
        }
        
        .sim-player-glow {
            filter: drop-shadow(0 0 4px currentColor);
        }
        
        /* Drag & Drop Styles */
        .bench-player-card {
            user-select: none;
            -webkit-user-select: none;
        }
        
        .bench-player-card.dragging,
        .pitch-slot.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .pitch-slot, .pitch-slot-empty {
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .pitch-slot.drag-over,
        .pitch-slot-empty.drag-over {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }
        
        /* Golden text glow effect */
        .drop-shadow-glow {
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.6), 0 0 20px rgba(251, 191, 36, 0.4);
        }
        
        /* Stats column animations */
        .glass-panel {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Responsive stats for very small landscape screens */
        @media screen and (max-height: 360px) {
            .glass-panel h4 {
                font-size: 10px !important;
            }
        }

        /* MAIN MENU STYLES V2 */
        .menu-bg-gradient {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            position: relative;
            overflow: hidden;
        }
        .menu-background-image {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            pointer-events: none;
        }
        .player-image-menu {
            position: absolute;
            bottom: 0; left: 5%; height: 90%; z-index: 10;
            filter: drop-shadow(20px 0 30px rgba(0,0,0,0.5));
            pointer-events: none;
        }
        .menu-card-item {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 1rem;
            border-radius: 1rem;
        }
        .menu-card-item:hover {
            background: rgba(45, 55, 72, 0.8);
            border-color: #4caf50;
            transform: scale(1.03);
        }
        .card-new { border-left: 4px solid #4caf50; }
        .card-load { border-left: 4px solid #3b82f6; }
        .card-settings { border-left: 4px solid #94a3b8; }
        .card-about { border-left: 4px solid #fbbf24; }
        .glass-panel-menu {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(15px);
        }
        @keyframes slideInMenu {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-in-menu {
            animation: slideInMenu 0.4s ease-out forwards;
        }
    </style>

        <style>
        /* ИСПРАВЛЕНО v2.2: Unified Contact Club Overlay Styles */
        #contact-club-overlay {
            z-index: 999999 !important;
            background-color: rgba(2, 6, 23, 0.99) !important;
            backdrop-filter: blur(16px);
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            height: 100dvh !important;
            display: none;
            flex-direction: column;
            overflow: hidden;
            pointer-events: auto !important;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        #contact-club-overlay.visible,
        #contact-club-overlay:not(.hidden) {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .transfer-type-btn:hover {
            transform: scale(1.05);
            transition: transform 0.2s;
        }
        
        /* Landscape specific spacing adjustments */
        @media screen and (orientation: landscape) {
            #ccm-player-card {
                padding: 1rem !important;
            }
            #ccm-steps-container {
                padding: 1rem 4rem !important;
            }
        }

        .loan-dur-btn.active {
            border-color: #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.2) !important;
            color: #60a5fa !important;
        }
        
        .hidden { display: none !important; }
        </style>
        </head>
<body class="text-slate-200 antialiased h-screen">

    <div id="app" class="w-full h-full bg-slate-900"></div>

    <!-- MAIN MENU OVERLAY V2 -->
    <div id="main-menu-overlay" class="fixed inset-0 z-[200] menu-bg-gradient flex items-center justify-end pr-[5%]">
        <!-- Background Image -->
        <img id="menu-bg-img" src="" alt="Background" class="menu-background-image" style="display:none;">
        
        <!-- Player Image -->
        <img id="menu-player-img" src="" alt="Player" class="player-image-menu" style="display:none;">

        <!-- Menu Content -->
        <div class="z-20 w-full max-w-[400px] flex flex-col gap-4 scale-90 md:scale-100">
            <div class="mb-4">
                <h1 class="text-6xl font-black italic text-white uppercase leading-none tracking-tighter">
                    FOOT<span class="text-[#4caf50]">LOGIC</span>
                </h1>
                <p class="text-slate-400 font-bold tracking-[0.3em] uppercase text-[10px] mt-1">2026</p>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <!-- Row 1 -->
                <div onclick="startNewGameFromMenu()" class="menu-card-item card-new animate-in-menu" style="animation-delay: 0.1s">
                    <span class="text-[#4caf50] text-[10px] font-black uppercase mb-1">Fresh Start</span>
                    <span class="text-white font-black text-lg leading-tight">NEW<br>CAREER</span>
                </div>
                <div onclick="openLoadModal().catch(console.error)" class="menu-card-item card-load animate-in-menu" style="animation-delay: 0.2s">
                    <span class="text-blue-400 text-[10px] font-black uppercase mb-1">Continue</span>
                    <span class="text-white font-black text-lg leading-tight">LOAD<br>CAREER</span>
                </div>
                <!-- Row 2 -->
                <div onclick="showMenuSubScreen('settings-screen-menu')" class="menu-card-item card-settings animate-in-menu" style="animation-delay: 0.3s">
                    <span class="text-slate-400 text-[10px] font-black uppercase mb-1">Options</span>
                    <span class="text-white font-black text-lg leading-tight">SETTINGS</span>
                </div>
                <div onclick="showMenuSubScreen('about-screen-menu')" class="menu-card-item card-about animate-in-menu" style="animation-delay: 0.4s">
                    <span class="text-amber-400 text-[10px] font-black uppercase mb-1">Info</span>
                    <span class="text-white font-black text-lg leading-tight">ABOUT</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Screen Menu -->
    <div id="settings-screen-menu" class="hidden fixed inset-0 z-[210] bg-slate-900 flex flex-col">
        <div class="flex-1 flex flex-col">
            <div class="p-6 border-b border-white/5 flex items-center justify-between bg-slate-800/50">
                <h2 class="text-3xl font-black uppercase tracking-tight">Settings</h2>
                <button onclick="hideMenuSubScreen('settings-screen-menu')" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-red-500/20 hover:text-red-500 flex items-center justify-center transition-all text-xl">✕</button>
            </div>
            <div class="p-8 grid grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">Audio</label>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold">Music Volume</span>
                                <input type="range" class="w-32 accent-[#4caf50]">
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold">SFX Volume</span>
                                <input type="range" class="w-32 accent-[#4caf50]">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">Graphics</label>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold">60 FPS Mode</span>
                                <input type="checkbox" class="w-5 h-5 accent-[#4caf50]" checked>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mods Section -->
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">Mods</label>
                        <div class="space-y-3">
                            <button onclick="openModManager()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-between transition-all">
                                <span class="flex items-center gap-3">
                                    <span class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center text-sm">JS</span>
                                    <span>Mod Manager</span>
                                </span>
                                <span id="mods-count-badge" class="bg-slate-600 px-2 py-1 rounded text-xs">0</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mod Manager Screen -->
    <div id="mod-manager-screen" class="hidden fixed inset-0 z-[220] bg-slate-900 flex flex-col">
        <div class="flex-1 flex flex-col">
            <div class="p-4 border-b border-white/5 flex items-center justify-between bg-slate-800/50">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-black uppercase tracking-tight">Mod Manager</h2>
                    <span class="text-slate-400 text-sm">v1.0.0</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="showModDocs()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all">
                        API Docs
                    </button>
                    <button onclick="importModFromFile()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all">
                        Import Mod
                    </button>
                    <button onclick="closeModManager()" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-red-500/20 hover:text-red-500 flex items-center justify-center transition-all text-lg">X</button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <div id="mods-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Mods will be rendered here -->
                </div>
                
                <div id="no-mods-message" class="hidden flex flex-col items-center justify-center py-16 text-center">
                    <div class="w-20 h-20 bg-slate-800 rounded-2xl flex items-center justify-center mb-4">
                        <span class="text-4xl text-slate-600">JS</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-400 mb-2">No Mods Installed</h3>
                    <p class="text-slate-500 text-sm max-w-md mb-6">Import JavaScript mods to extend game functionality. Mods can add new features, modify gameplay, and customize your experience.</p>
                    <button onclick="importModFromFile()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-6 rounded-xl transition-all">
                        Import Your First Mod
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mod Documentation Screen -->
    <div id="mod-docs-screen" class="hidden fixed inset-0 z-[230] bg-slate-900 flex flex-col">
        <div class="flex-1 flex flex-col">
            <div class="p-4 border-b border-white/5 flex items-center justify-between bg-slate-800/50">
                <div>
                    <h2 class="text-2xl font-black uppercase tracking-tight">ModAPI v4.0 Documentation</h2>
                    <p class="text-xs text-slate-500 mt-1">Comprehensive modding API for FootLogic</p>
                </div>
                <button onclick="closeModDocs()" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-red-500/20 hover:text-red-500 flex items-center justify-center transition-all text-lg">X</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <div class="max-w-4xl mx-auto space-y-6 text-sm">
                    <!-- Intro -->
                    <div class="bg-gradient-to-br from-slate-800/80 to-slate-800/40 rounded-2xl p-6 border border-[#4caf50]/30">
                        <h3 class="text-lg font-black text-[#4caf50] mb-3">Getting Started</h3>
                        <p class="text-slate-300 mb-4">ModAPI v4.0 provides a powerful event-driven system to extend FootLogic. Create mods that react to game events, modify players/teams, add custom UI, and more.</p>
                        <pre class="bg-slate-900 rounded-xl p-4 overflow-x-auto text-xs"><code class="text-green-400">// Basic mod structure
ModAPI.registerMod({
    id: 'my-mod',           // Unique ID (required)
    name: 'My First Mod',   // Display name (required)
    version: '1.0.0',       // Version (required)
    author: 'Your Name',    // Author name
    description: 'Description of what this mod does',
    
    init: function(api) {
        // Called when mod is first loaded
        api.showNotification('Mod loaded!', 2000);
    },
    
    onEnable: function(api) {
        // Called when mod is enabled
    },
    
    onDisable: function(api) {
        // Called when mod is disabled
    },
    
    // Game lifecycle hooks
    onGameLoad: function(data) { },
    onSeasonStart: function(season) { },
    onSeasonEnd: function(season) { },
    onWeekStart: function(week) { },
    onWeekEnd: function(week) { },
    onMatchStart: function(match) { },
    onMatchEnd: function(match) { },
    onTransfer: function(transfer) { },
    onSave: function() { },
    onLoad: function() { }
});</code></pre>
                    </div>
                    
                    <!-- State API -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/5">
                        <h3 class="text-lg font-black text-blue-400 mb-3">State API - Reading Game Data</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <code class="text-yellow-400">api.getState()</code>
                                <p class="text-slate-500 text-xs mt-1">Full game state object</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.getUserTeam()</code>
                                <p class="text-slate-500 text-xs mt-1">User's team with squad, budget</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.getAllTeams()</code>
                                <p class="text-slate-500 text-xs mt-1">Array of all teams</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.getTeamById(id)</code>
                                <p class="text-slate-500 text-xs mt-1">Team by ID</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.getTeamByName(name)</code>
                                <p class="text-slate-500 text-xs mt-1">Team by name (partial match)</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.getPlayerById(id)</code>
                                <p class="text-slate-500 text-xs mt-1">Returns {player, team}</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.getAllPlayers()</code>
                                <p class="text-slate-500 text-xs mt-1">All players in game</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.searchPlayers(query)</code>
                                <p class="text-slate-500 text-xs mt-1">Search by name/nation/position</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.getLeagueTable(id)</code>
                                <p class="text-slate-500 text-xs mt-1">Sorted league standings</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.getCurrentWeek()</code>
                                <p class="text-slate-500 text-xs mt-1">Current week number</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.getSeason()</code>
                                <p class="text-slate-500 text-xs mt-1">Current season number</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.getTopScorers(limit)</code>
                                <p class="text-slate-500 text-xs mt-1">Top scorers list</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modification API -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/5">
                        <h3 class="text-lg font-black text-orange-400 mb-3">Modification API - Changing Game Data</h3>
                        <div class="space-y-4">
                            <div>
                                <code class="text-yellow-400">api.modifyPlayer(playerId, {rating: 90, morale: 100})</code>
                                <p class="text-slate-400 text-xs mt-1">Modify any player property</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.modifyTeam(teamId, {budget: 100000000})</code>
                                <p class="text-slate-400 text-xs mt-1">Modify any team property</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.addBudget(teamId, amount)</code>
                                <p class="text-slate-400 text-xs mt-1">Add money to team budget</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.generatePlayer({name, age, rating, position})</code>
                                <p class="text-slate-400 text-xs mt-1">Create a new player with random stats</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.addPlayerToTeam(player, teamId)</code>
                                <p class="text-slate-400 text-xs mt-1">Add player to team squad</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.removePlayerFromTeam(playerId, teamId)</code>
                                <p class="text-slate-400 text-xs mt-1">Remove player from team</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Events API -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/5">
                        <h3 class="text-lg font-black text-red-400 mb-3">Events API - React to Game Events</h3>
                        <div class="space-y-3">
                            <div>
                                <code class="text-yellow-400">api.on(event, handler, priority)</code>
                                <p class="text-slate-400 text-xs mt-1">Subscribe to events. Higher priority runs first.</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.once(event, handler)</code>
                                <p class="text-slate-400 text-xs mt-1">Subscribe once, auto-unsubscribe after</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.off(event, handler)</code>
                                <p class="text-slate-400 text-xs mt-1">Unsubscribe from event</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.trigger(event, data)</code>
                                <p class="text-slate-400 text-xs mt-1">Fire custom event</p>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-slate-900 rounded-xl">
                            <p class="text-slate-300 font-bold mb-2 text-xs">Available Events:</p>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-1 text-xs text-slate-400">
                                <span>gameLoad</span><span>seasonStart</span><span>seasonEnd</span>
                                <span>weekStart</span><span>weekEnd</span><span>matchStart</span>
                                <span>matchEnd</span><span>goal</span><span>transfer</span>
                                <span>playerBuy</span><span>playerSell</span><span>budgetChange</span>
                                <span>formationChange</span><span>injury</span><span>playerTrain</span>
                                <span>modRegistered</span><span>modToggled</span><span>save/load</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hooks & Patches -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/5">
                        <h3 class="text-lg font-black text-purple-400 mb-3">Hooks & Patches - Advanced Modifications</h3>
                        <div class="space-y-4">
                            <div>
                                <code class="text-yellow-400">api.intercept(target, handler)</code>
                                <p class="text-slate-400 text-xs mt-1">Intercept and modify function results</p>
                                <pre class="bg-slate-900 rounded-lg p-3 mt-2 text-xs"><code>// Modify all player values by 50%
api.intercept('calculatePlayerValue', (args, result) => {
    return Math.floor(result * 0.5);
});</code></pre>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.addHook(name, callback, 'before'|'after')</code>
                                <p class="text-slate-400 text-xs mt-1">Add code before/after game functions</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.patch(funcName, wrapper)</code>
                                <p class="text-slate-400 text-xs mt-1">Wrap global functions with custom logic</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- UI API -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/5">
                        <h3 class="text-lg font-black text-emerald-400 mb-3">UI API - Custom Interface</h3>
                        <div class="space-y-3">
                            <div>
                                <code class="text-yellow-400">api.showNotification(msg, duration, type)</code>
                                <p class="text-slate-400 text-xs mt-1">Types: 'success', 'error', 'info'</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.addNews(title, text, type)</code>
                                <p class="text-slate-400 text-xs mt-1">Add to news feed</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.addMenuItem({id, label, icon, onClick})</code>
                                <p class="text-slate-400 text-xs mt-1">Add sidebar menu item</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.registerScreen(id, {title, render, onOpen})</code>
                                <p class="text-slate-400 text-xs mt-1">Create custom full-screen view</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.addDashboardWidget(id, {title, render})</code>
                                <p class="text-slate-400 text-xs mt-1">Add widget to dashboard</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Utilities -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/5">
                        <h3 class="text-lg font-black text-cyan-400 mb-3">Utilities</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div>
                                <code class="text-yellow-400 text-xs">api.formatMoney(n)</code>
                                <p class="text-slate-500 text-[10px]">€1.5M, €500K</p>
                            </div>
                            <div>
                                <code class="text-yellow-400 text-xs">api.random(min, max)</code>
                                <p class="text-slate-500 text-[10px]">Random integer</p>
                            </div>
                            <div>
                                <code class="text-yellow-400 text-xs">api.randomPick(arr)</code>
                                <p class="text-slate-500 text-[10px]">Random element</p>
                            </div>
                            <div>
                                <code class="text-yellow-400 text-xs">api.chance(percent)</code>
                                <p class="text-slate-500 text-[10px]">Returns true/false</p>
                            </div>
                            <div>
                                <code class="text-yellow-400 text-xs">api.clamp(val, min, max)</code>
                                <p class="text-slate-500 text-[10px]">Limit value</p>
                            </div>
                            <div>
                                <code class="text-yellow-400 text-xs">api.delay(ms)</code>
                                <p class="text-slate-500 text-[10px]">Async wait</p>
                            </div>
                            <div>
                                <code class="text-yellow-400 text-xs">api.$(selector)</code>
                                <p class="text-slate-500 text-[10px]">querySelector</p>
                            </div>
                            <div>
                                <code class="text-yellow-400 text-xs">api.$$(selector)</code>
                                <p class="text-slate-500 text-[10px]">querySelectorAll</p>
                            </div>
                            <div>
                                <code class="text-yellow-400 text-xs">api.getGameDate()</code>
                                <p class="text-slate-500 text-[10px]">Season & week</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Storage -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/5">
                        <h3 class="text-lg font-black text-amber-400 mb-3">Storage API - Save Mod Data</h3>
                        <div class="space-y-3">
                            <div>
                                <code class="text-yellow-400">api.saveModData(modId, data)</code>
                                <p class="text-slate-400 text-xs mt-1">Save mod data persistently</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.loadModData(modId)</code>
                                <p class="text-slate-400 text-xs mt-1">Load saved mod data (async)</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.clearModData(modId)</code>
                                <p class="text-slate-400 text-xs mt-1">Delete mod data</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Debug -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/5">
                        <h3 class="text-lg font-black text-pink-400 mb-3">Debugging</h3>
                        <div class="space-y-3">
                            <div>
                                <code class="text-yellow-400">api.setDebug(true)</code>
                                <p class="text-slate-400 text-xs mt-1">Enable debug logging</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.dumpState()</code>
                                <p class="text-slate-400 text-xs mt-1">Get full API state dump</p>
                            </div>
                            <div>
                                <code class="text-yellow-400">api.testMod(modId)</code>
                                <p class="text-slate-400 text-xs mt-1">Run mod tests</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden file input for mod import -->
    <input type="file" id="mod-file-input" accept=".js,.txt" class="hidden" onchange="handleModFileSelect(event)">

    <!-- About Screen Menu -->
    <div id="about-screen-menu" class="hidden fixed inset-0 z-[210] bg-slate-900 flex flex-col">
        <div class="flex-1 flex flex-col">
            <div class="p-4 border-b border-white/5 flex items-center justify-between bg-slate-800/50">
                <h2 class="text-2xl font-black uppercase tracking-tight">About</h2>
                <button onclick="hideMenuSubScreen('about-screen-menu')" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-red-500/20 hover:text-red-500 flex items-center justify-center transition-all text-lg">✕</button>
            </div>
            <div class="flex-1 flex flex-col items-center justify-center p-4 text-center">
                <div class="w-20 h-20 bg-gradient-to-br from-[#4caf50] to-emerald-600 rounded-2xl mb-4 flex items-center justify-center shadow-xl shadow-green-900/30">
                    <span class="text-3xl font-black text-white">FL</span>
                </div>
                <h3 class="text-xl font-black text-white mb-1">FootLogic</h3>
                <p class="text-[#4caf50] text-sm font-bold mb-4">v0.0.0.7</p>
                <p class="text-slate-400 text-sm max-w-md">Developed with passion for football fans worldwide. Experience the most immersive mobile football management simulation.</p>
            </div>
        </div>
    </div>

    <!-- Load Screen Menu -->
    <div id="load-screen-menu" class="hidden fixed inset-0 z-[210] bg-slate-900 flex flex-col">
        <div class="flex-1 flex flex-col">
            <div class="p-6 border-b border-white/5 flex items-center justify-between bg-slate-800/50">
                <h2 class="text-3xl font-black uppercase tracking-tight">Load Career</h2>
                <button onclick="hideMenuSubScreen('load-screen-menu')" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-red-500/20 hover:text-red-500 flex items-center justify-center transition-all text-xl">✕</button>
            </div>
            <div class="flex-1 flex items-center justify-center p-8 text-center">
                <p class="text-slate-500 font-black text-2xl italic">No saved careers found</p>
            </div>
        </div>
    </div>

    <div id="signing-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/95 backdrop-blur-xl">
        <div class="text-center w-full max-w-4xl pop-animate relative px-4">
            <div class="absolute inset-0 bg-gradient-to-t from-[#4caf50]/20 to-transparent blur-3xl rounded-full pointer-events-none"></div>
            
            <h1 class="text-4xl md:text-6xl lg:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-slate-200 to-slate-500 mb-8 uppercase tracking-tighter drop-shadow-2xl">
                Welcome
            </h1>
            
            <div class="flex flex-col items-center justify-center mb-12 transform hover:scale-105 transition-transform duration-500">
                <div id="reveal-card" class="fut-card w-full max-w-80 md:w-96 rounded-3xl p-6 md:p-8 border-4 border-[#4caf50] shadow-[0_0_50px_rgba(76,175,80,0.5)]"></div>
            </div>

            <button onclick="closeSigningReveal()" class="relative z-50 bg-white text-slate-900 hover:bg-[#4caf50] hover:text-white font-black py-4 px-8 md:px-12 rounded-full text-lg md:text-xl uppercase tracking-widest shadow-xl transition-all hover:scale-110 active:scale-95 cursor-pointer">
                Add to Squad
            </button>
        </div>
    </div>

    <!-- PLAY OPTIONS FULL SCREEN - LANDSCAPE OPTIMIZED -->
    <div id="play-options-overlay" class="hidden fixed inset-0 z-50 bg-slate-900 flex flex-col" onclick="closePlayOptions()">
        <!-- Header -->
        <div class="flex-shrink-0 p-2 border-b border-slate-700 bg-slate-800/50 flex items-center justify-between">
            <h3 class="text-white font-black text-base uppercase tracking-widest">⚽ Match Options</h3>
            <button onclick="closePlayOptions()" class="w-7 h-7 flex items-center justify-center rounded-full bg-slate-700 hover:bg-slate-600 text-white transition-colors text-sm">✕</button>
        </div>
        
        <!-- Main Content: Left Team | Center | Right Team -->
        <div class="flex-1 flex overflow-hidden" onclick="event.stopPropagation()">
            <!-- LEFT TEAM (HOME) -->
            <div class="flex-1 flex flex-col bg-slate-900/30 border-r border-slate-700 p-2 overflow-y-auto">
                <div id="play-options-home-header" class="flex items-center gap-2 mb-2 pb-2 border-b border-slate-700/50">
                    <div id="play-options-home-logo" class="flex-shrink-0"></div>
                    <div>
                        <h2 id="play-options-home-name" class="text-white font-black text-sm">Home Team</h2>
                    </div>
                </div>
                <div id="play-options-home-squad" class="text-slate-400 text-[10px] text-center py-2 flex-1 overflow-y-auto">Loading...</div>
            </div>
            
            <!-- CENTER: Match Info & Buttons -->
            <div class="w-48 flex flex-col items-center justify-center gap-2 bg-slate-800/50 border-x border-slate-700 px-2">
                <!-- Match Info -->
                <div id="play-options-match-info" class="text-center w-full text-xs"></div>
                
                <!-- Action Buttons -->
                <div class="w-full flex flex-col gap-2">
                    <button onclick="skipMatch()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-2 rounded text-[10px] flex items-center justify-center gap-2 transition-all hover:scale-105">
                        <span class="text-lg">⏭️</span>
                        <div class="text-left">
                            <div class="font-black text-[10px]">Skip</div>
                            <div class="text-[8px] text-slate-400 font-normal">Instant</div>
                        </div>
                    </button>
                    <button onclick="startSimulateMatch()" class="bg-gradient-to-r from-[#4caf50] to-emerald-600 hover:from-[#43a047] hover:to-emerald-500 text-white font-bold py-2 px-2 rounded text-[10px] flex items-center justify-center gap-2 shadow-lg shadow-green-900/30 transition-all hover:scale-105">
                        <span class="text-lg">🎮</span>
                        <div class="text-left">
                            <div class="font-black text-[10px]">Simulate</div>
                            <div class="text-[8px] text-emerald-200 font-normal">2D Match</div>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- RIGHT TEAM (AWAY) -->
            <div class="flex-1 flex flex-col bg-slate-900/30 border-l border-slate-700 p-2 overflow-y-auto">
                <div id="play-options-away-header" class="flex items-center gap-2 mb-2 pb-2 border-b border-slate-700/50 justify-end">
                    <div>
                        <h2 id="play-options-away-name" class="text-white font-black text-sm text-right">Away Team</h2>
                    </div>
                    <div id="play-options-away-logo" class="flex-shrink-0"></div>
                </div>
                <div id="play-options-away-squad" class="text-slate-400 text-[10px] text-center py-2 flex-1 overflow-y-auto">Loading...</div>
            </div>
        </div>
    </div>

    <!-- 2D MATCH SIMULATION OVERLAY -->
    <div id="match-simulation-overlay" class="hidden fixed inset-0 z-[60] bg-black">
        <div class="w-full h-full flex">
            <!-- Left Side: Pitch (Expanded) -->
            <div class="flex-[3.5] relative bg-slate-950 overflow-hidden">
                <canvas id="match-canvas" style="width: 100%; height: 100%; object-fit: contain;"></canvas>
            </div>
            
            <!-- Right Side: Dashboard (Broadcast Style) -->
            <div class="w-64 bg-slate-900 flex flex-col border-l border-slate-800">
                <!-- Scoreboard Card -->
                <div class="p-3 bg-slate-800/50 border-b border-slate-800">
                    <div class="flex flex-col gap-3">
                        <div class="flex items-center justify-between">
                            <div id="sim-home-info" class="flex flex-col items-center gap-1 flex-1">
                                <div id="sim-home-logo"></div>
                                <span id="sim-home-name" class="text-white font-bold text-[10px] text-center truncate w-full"></span>
                            </div>
                            <div class="bg-slate-950 border border-slate-700 px-2 py-1 rounded-md mx-2">
                                <span id="sim-score" class="text-[#4caf50] font-black text-lg tracking-tight">0-0</span>
                            </div>
                            <div id="sim-away-info" class="flex flex-col items-center gap-1 flex-1">
                                <div id="sim-away-logo"></div>
                                <span id="sim-away-name" class="text-white font-bold text-[10px] text-center truncate w-full"></span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between border-t border-slate-700/50 pt-2">
                            <div class="text-[#4caf50] font-mono text-xl font-bold" id="sim-timer">00:00</div>
                            <div class="flex gap-1">
                                <button onclick="toggleSimPause()" id="sim-pause-btn" class="bg-slate-700 hover:bg-slate-600 text-white w-8 h-8 flex items-center justify-center rounded shadow">⏸️</button>
                                <button onclick="endSimulation()" class="bg-red-600 hover:bg-red-500 text-white w-8 h-8 flex items-center justify-center rounded shadow">✕</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Events Feed -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <div class="px-4 py-2 bg-slate-950 text-[10px] font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800">Match Commentary</div>
                    <div id="sim-events-feed" class="flex-1 overflow-y-auto p-4 space-y-3 text-xs font-medium text-slate-300"></div>
                </div>

                <!-- Speed Controls -->
                <div class="p-4 bg-slate-800 border-t border-slate-700">
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-2">Sim Speed</div>
                    <div class="flex gap-2">
                        <button onclick="setSimSpeed(1)" class="sim-speed-btn flex-1 py-2 text-xs font-bold rounded-lg bg-slate-700 text-white shadow-inner">1x</button>
                        <button onclick="setSimSpeed(2)" class="sim-speed-btn flex-1 py-2 text-xs font-bold rounded-lg bg-slate-900 text-slate-500">2x</button>
                        <button onclick="setSimSpeed(4)" class="sim-speed-btn flex-1 py-2 text-xs font-bold rounded-lg bg-slate-900 text-slate-500">4x</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="live-match-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black">
        <div class="w-full h-full flex flex-col bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 modal-animate">
            <!-- Top Header Bar - Compact -->
            <div class="flex-shrink-0 px-3 py-1 border-b border-slate-800 flex justify-between items-center bg-black/80">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <div class="flex flex-col">
                        <h3 class="text-white font-black text-xs uppercase tracking-widest">LIVE</h3>
                        <span id="live-stadium" class="text-[9px] text-slate-500 font-mono"></span>
                    </div>
                </div>
                <div class="bg-slate-800 px-2 py-1 rounded">
                    <div class="text-[#4caf50] font-mono text-lg font-black" id="live-timer">00'</div>
                </div>
            </div>
            
            <!-- Main Match Display - Compact -->
            <div class="flex-shrink-0 flex items-center justify-center px-2 py-2 relative">
                <!-- Score Display - Compact width -->
                <div class="relative z-10 flex items-center gap-3 w-full max-w-sm">
                    <!-- Home Team -->
                    <div class="flex-1 flex flex-col items-center text-center">
                        <div id="live-home-logo" class="mb-1"></div>
                        <h2 id="live-home-name" class="text-xs font-black text-white truncate max-w-full px-1">HOME</h2>
                    </div>
                    
                    <!-- Score Box - Compact -->
                    <div class="flex flex-col items-center flex-shrink-0">
                        <div class="bg-gradient-to-b from-slate-800 to-slate-900 border border-slate-600 rounded-lg px-3 py-2 shadow-lg">
                            <div class="flex items-center gap-2 text-2xl font-black">
                                <span id="live-score-home" class="text-white min-w-[24px] text-center">0</span>
                                <span class="text-slate-600">:</span>
                                <span id="live-score-away" class="text-white min-w-[24px] text-center">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Away Team -->
                    <div class="flex-1 flex flex-col items-center text-center">
                        <div id="live-away-logo" class="mb-1"></div>
                        <h2 id="live-away-name" class="text-xs font-black text-white truncate max-w-full px-1">AWAY</h2>
                    </div>
                </div>
            </div>
            
            <!-- Goal Scorers Display - Compact -->
            <div class="flex-shrink-0 px-4 pb-2">
                <div class="flex justify-between max-w-sm mx-auto">
                    <div id="live-home-scorers" class="text-left text-[10px] text-slate-400 space-y-0"></div>
                    <div id="live-away-scorers" class="text-right text-[10px] text-slate-400 space-y-0"></div>
                </div>
            </div>
            
            <!-- Live Feed - Expanded to take more space -->
            <div class="flex-1 border-t border-slate-800 bg-black/60 overflow-hidden">
                <div id="live-feed" class="overflow-y-auto px-3 py-2 space-y-0.5 font-mono text-xs h-full"></div>
            </div>

            <!-- Continue Button - Compact -->
            <div class="flex-shrink-0 p-2 bg-black/80 border-t border-slate-800 flex justify-center">
                <button id="btn-live-continue" class="hidden bg-[#4caf50] hover:bg-[#43a047] text-white font-black py-2 px-6 rounded-lg text-sm uppercase tracking-wider shadow-lg shadow-green-900/30 transform transition hover:scale-105">
                    Continue
                </button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div id="modal-content" class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl max-w-md w-full modal-animate overflow-hidden max-h-[90vh] flex flex-col modal-content-mobile"></div>
    </div>
    
    <div id="season-end-overlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/95 backdrop-blur-xl p-4">
        <div id="season-end-content" class="text-center max-w-2xl w-full modal-animate relative modal-content-mobile"></div>
    </div>

    <div id="player-stats-overlay" class="hidden fixed inset-0 z-[55] flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div id="player-stats-content" class="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl max-w-4xl w-full modal-animate max-h-[80vh] overflow-y-auto p-4 md:p-6"></div>
    </div>

    <div id="profile-overlay" class="hidden fixed inset-0 z-50 bg-slate-950 flex flex-col" onclick="closeProfile(event)">
        <div id="profile-content" class="w-full h-full modal-animate" onclick="event.stopPropagation()"></div>
    </div>

    <!-- CLUB INFO FULL SCREEN -->
    <div id="club-info-overlay" class="hidden fixed inset-0 z-50 bg-slate-900 flex flex-col" onclick="closeClubInfo()">
        <!-- Header -->
        <div class="flex-shrink-0 p-2 border-b border-slate-700 bg-slate-800/50 flex items-center justify-between">
            <div id="club-info-header" class="flex items-center gap-2">
                <div id="club-info-logo" class="flex-shrink-0"></div>
                <div>
                    <h2 id="club-info-name" class="text-white font-black text-sm">Club Name</h2>
                    <p id="club-info-league" class="text-slate-400 text-[9px] uppercase tracking-wider">League</p>
                </div>
            </div>
            <button onclick="closeClubInfo()" class="w-7 h-7 flex items-center justify-center rounded-full bg-slate-700 hover:bg-slate-600 text-white transition-colors text-sm">✕</button>
        </div>
        
        <!-- Stats Bar -->
        <div id="club-info-stats" class="flex-shrink-0 p-2 bg-slate-800/30 border-b border-slate-700 grid grid-cols-5 gap-2"></div>
        
        <!-- Squad List -->
        <div class="flex-1 overflow-y-auto p-2" onclick="event.stopPropagation()">
            <h3 class="text-xs font-bold text-slate-400 uppercase px-2 mb-2 tracking-widest">Squad</h3>
            <div id="club-info-squad" class="grid grid-cols-1 gap-1">Loading...</div>
        </div>
    </div>

    <div id="offer-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-800 border border-[#4caf50] rounded-xl shadow-2xl max-w-sm w-full modal-animate p-6 text-center modal-content-mobile">
            <h3 class="text-[#4caf50] font-black text-xl mb-4 uppercase tracking-widest">Transfer Offer</h3>
            <div id="offer-body" class="mb-6"></div>
            <div class="grid grid-cols-2 gap-4">
                <button id="btn-reject" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg">REJECT</button>
                <button id="btn-accept" class="bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-2 rounded-lg">ACCEPT</button>
            </div>
        </div>
    </div>

    <div id="transfer-confirm-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-md w-full modal-animate p-6 modal-content-mobile max-h-[90vh] overflow-y-auto">
            <h3 class="text-white font-black text-xl mb-4 uppercase tracking-widest border-b border-slate-700 pb-2">Confirm Transfer</h3>
            
            <div class="text-slate-300 mb-6 text-sm">
                Are you sure you want to sign <span id="tc-player-name" class="font-bold text-white"></span> from <span id="tc-club-name" class="font-bold text-white"></span>?
            </div>

            <div class="bg-slate-900/50 rounded-lg p-4 mb-4 font-mono text-sm space-y-2 border border-slate-700/50">
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Current Budget</span>
                    <span id="tc-current-budget" class="text-emerald-400 font-bold"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Transfer Fee</span>
                    <span id="tc-transfer-fee" class="text-red-400 font-bold"></span>
                </div>
                <div class="h-px bg-slate-700 my-2"></div>
                <div class="flex justify-between items-center text-base">
                    <span class="text-white font-bold">Remaining</span>
                    <span id="tc-remaining" class="font-bold"></span>
                </div>
            </div>
            
            <!-- НОВОЕ: Контейнер для информации о проверках трансфера -->
            <div id="tc-transfer-info" class="mb-4"></div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeTransferModal()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg uppercase tracking-wider text-xs">Cancel</button>
                <button id="btn-confirm-transfer" class="bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 rounded-lg uppercase tracking-wider text-xs shadow-lg shadow-green-900/20">Confirm Signing</button>
            </div>
        </div>
    </div>

    <div id="promo-relegation-overlay" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-md w-full modal-animate p-6 modal-content-mobile">
            <h3 id="pr-title" class="text-white font-black text-xl mb-4 uppercase tracking-widest border-b border-slate-700 pb-2"></h3>
            
            <div class="text-slate-300 mb-6 text-sm text-center" id="pr-message">
                
            </div>

            <div class="bg-slate-900/50 rounded-lg p-4 mb-6 font-mono text-sm space-y-2 border border-slate-700/50" id="pr-details">
                
            </div>

            <div class="flex justify-center">
                <button id="btn-pr-continue" class="bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 px-6 md:px-8 rounded-lg uppercase tracking-wider text-sm shadow-lg shadow-green-900/20">
                    CONTINUE
                </button>
            </div>
        </div>
    </div>

    <div id="slot-select-overlay" class="hidden fixed inset-0 z-[75] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-md w-full modal-animate p-6 modal-content-mobile">
            <h3 id="slot-select-title" class="text-white font-black text-xl mb-4 uppercase tracking-widest border-b border-slate-700 pb-2"></h3>
            
            <div class="mb-6 text-slate-300 text-sm" id="slot-select-subtitle">
                Select a player to fill the empty slot:
            </div>

            <div id="slot-select-players" class="max-h-96 overflow-y-auto space-y-2 mb-6">
            </div>

            <div class="flex justify-between">
                <button onclick="document.getElementById('slot-select-overlay').classList.add('hidden')" 
                        class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg">
                    Cancel
                </button>
                <div class="text-sm text-slate-400 self-center" id="slot-select-count">
                    0 players available
                </div>
            </div>
        </div>
    </div>

    <!-- CONTACT CLUB NEGOTIATION OVERLAY - FULL SCREEN -->
    <div id="contact-club-overlay" class="hidden fixed inset-0 z-[80] bg-slate-950 flex flex-col">
        <!-- Header -->
        <div class="flex-shrink-0 p-4 border-b border-slate-700 bg-slate-800/50 flex items-center justify-between">
            <div>
                <h2 class="text-white font-black text-2xl uppercase tracking-tight">Transfer Negotiation</h2>
                <p class="text-slate-400 text-xs mt-1">Contact the club to sign the player</p>
            </div>
            <button onclick="closeContactClubMenu()" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-700 hover:bg-red-600 text-white transition-colors text-lg">✕</button>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="max-w-4xl mx-auto">
                <!-- Player Card -->
                <div id="ccm-player-card" class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 mb-6 border border-slate-700 shadow-2xl">
                    <!-- Player info will be injected here -->
                </div>
                
                <!-- Negotiation Steps Container -->
                <div id="ccm-negotiation-container" class="space-y-6">
                    <!-- Step 1: Choose Transfer Type -->
                    <div id="ccm-step-type" class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <h3 class="text-white font-black text-lg mb-4 uppercase tracking-wide">Choose Transfer Type</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="window.selectTransferType('permanent')" class="transfer-type-btn bg-gradient-to-br from-emerald-600 to-emerald-700 hover:from-emerald-500 hover:to-emerald-600 text-white font-bold py-6 px-6 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                                <div class="text-2xl mb-2">💰</div>
                                <div class="text-lg font-black uppercase">Permanent Transfer</div>
                                <div class="text-xs opacity-80 mt-2">Buy the player outright</div>
                            </button>
                            <button onclick="window.selectTransferType('loan')" class="transfer-type-btn bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-6 px-6 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                                <div class="text-2xl mb-2">🤝</div>
                                <div class="text-lg font-black uppercase">Loan Deal</div>
                                <div class="text-xs opacity-80 mt-2">Temporary transfer (1-2 years)</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Club Negotiation -->
                    <div id="ccm-step-club" class="hidden bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <h3 class="text-white font-black text-lg mb-4 uppercase tracking-wide flex items-center gap-2">
                            <span>📋</span> Club Negotiation
                        </h3>
                        <div id="ccm-club-negotiation-box" class="space-y-4">
                            <!-- Club negotiation content will be injected here -->
                        </div>
                    </div>
                    
                    <!-- Step 3: Player Contract -->
                    <div id="ccm-step-player" class="hidden bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <h3 class="text-white font-black text-lg mb-4 uppercase tracking-wide flex items-center gap-2">
                            <span>✍️</span> Player Contract
                        </h3>
                        <div id="ccm-player-negotiation-box" class="space-y-4">
                            <!-- Player contract content will be injected here -->
                        </div>
                    </div>
                    
                    <!-- Step 4: Summary -->
                    <div id="ccm-step-summary" class="hidden bg-gradient-to-br from-emerald-900/30 to-emerald-800/20 rounded-xl p-6 border border-emerald-700/50">
                        <h3 class="text-emerald-400 font-black text-lg mb-4 uppercase tracking-wide flex items-center gap-2">
                            <span>✅</span> Transfer Complete!
                        </h3>
                        <div id="ccm-summary-content" class="space-y-3 text-slate-300">
                            <!-- Summary content will be injected here -->
                        </div>
                        <button onclick="closeContactClubMenu(); renderDashboard();" class="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 rounded-lg uppercase tracking-wider shadow-lg transform hover:scale-105 transition-all">
                            Continue
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ========== CRITICAL: MENU FUNCTIONS - MUST BE DEFINED FIRST ==========
        // These functions are called from onclick handlers in the HTML above
        // They must be available immediately when the page loads
        
        function showMenuSubScreen(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('hidden');
        }
        
        function hideMenuSubScreen(id) {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        }
        
        async function startNewGameFromMenu() {
            const menuOverlay = document.getElementById('main-menu-overlay');
            if (menuOverlay) menuOverlay.classList.add('hidden');
            
            // Show loading screen while fetching datapack
            if (typeof showLoadingScreen === 'function') {
                showLoadingScreen('Loading Datapack...');
            }

            try {
                let data = null;
                
                // Try to load from cache first (faster on subsequent loads)
                if (window.StorageManager) {
                    await window.StorageManager.init();
                    const cachedData = await window.StorageManager.getCachedDatapack();
                    if (cachedData) {
                        console.log('Loading datapack from cache...');
                        data = cachedData;
                    }
                }
                
                // If not cached, fetch from datapack folder
                if (!data) {
                    console.log('Fetching datapack from file...');
                    const response = await fetch('datapack/datapack.json');
                    if (!response.ok) throw new Error('Failed to load datapack/datapack.json');
                    
                    data = await response.json();
                    
                    // Cache the datapack for next time
                    if (window.StorageManager) {
                        await window.StorageManager.cacheDatapack(data);
                    }
                }
                
                if (typeof hideLoadingScreen === 'function') {
                    hideLoadingScreen();
                }

                // Process the data based on its format
                if (data.leagues && data.teams && data.players) {
                    if (typeof processNewTableFormat === 'function') processNewTableFormat(data);
                } else if (data.clubs || data.teams || Array.isArray(data)) {
                    if (typeof processNewJsonFormat === 'function') processNewJsonFormat(data);
                } else {
                    throw new Error('Unknown JSON format in datapack.json');
                }
            } catch (err) {
                console.error('Error loading default datapack:', err);
                if (typeof hideLoadingScreen === 'function') {
                    hideLoadingScreen();
                }
                // Fallback to upload screen if datapack fails
                alert('Failed to load datapack: ' + err.message);
            }
        }
        
        // Stub for openLoadModal - will be replaced by full implementation below
        // This ensures the function exists when menu buttons are clicked
        let _openLoadModalReady = false;
        let _openLoadModalImpl = null;
        
        async function openLoadModal() {
            // Wait for full implementation to load
            if (_openLoadModalImpl) {
                return _openLoadModalImpl();
            }
            // If not ready yet, show a brief loading message
            console.log('openLoadModal: waiting for full implementation...');
            await new Promise(resolve => {
                const checkReady = setInterval(() => {
                    if (_openLoadModalImpl) {
                        clearInterval(checkReady);
                        resolve();
                    }
                }, 50);
                // Timeout after 5 seconds
                setTimeout(() => {
                    clearInterval(checkReady);
                    resolve();
                }, 5000);
            });
            if (_openLoadModalImpl) {
                return _openLoadModalImpl();
            } else {
                alert('Load function not ready yet. Please try again.');
            }
        }
        
        function closeLoadModal() {
            const modal = document.getElementById('load-modal');
            if (modal) modal.remove();
        }
        
        // ========== END CRITICAL MENU FUNCTIONS ==========
        
        // ИСПРАВЛЕНО: Глобальный обработчик ошибок для fail-safe
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, 'at line', lineNo, error);
            
            // Для Capacitor/WebView - не блокируем выполнение из-за ошибок
            // Просто логируем и продолжаем
            if (window.isCapacitorNative && window.isCapacitorNative()) {
                console.warn('Capacitor: Suppressing error to prevent app freeze');
                return true; // Предотвращаем дефолтную обработку ошибки
            }
            
            // Показываем start-screen если возможно
            const app = document.getElementById('app');
            // Check if STATE exists and is not loaded yet
            const stateLoaded = typeof STATE !== 'undefined' && STATE.loaded;
            if (app && !stateLoaded) {
                try {
                    if (typeof renderUploadScreen === 'function') {
                       // renderUploadScreen();
                    } else {
                        throw new Error('renderUploadScreen not defined yet');
                    }
                } catch(e) {
                    app.innerHTML = `
                        <div class="w-full h-full flex flex-col items-center justify-center p-4 md:p-6 bg-slate-900">
                            <div class="glass-panel p-6 md:p-10 rounded-2xl max-w-2xl w-full text-center shadow-2xl">
                                <h1 class="text-3xl md:text-4xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-[#4caf50] to-cyan-400">PRO MANAGER DYNASTY</h1>
                                <p class="text-red-400 mb-4 text-sm">Error: ${msg}</p>
                                <p class="text-slate-400 mb-8 text-sm md:text-base">Select Database (JSON/SQLite) or Save File to begin.</p>
                                <label class="cursor-pointer block w-full border-2 border-dashed border-slate-600 hover:border-[#4caf50] rounded-xl p-8 md:p-12 transition-all hover:bg-slate-800/50">
                                    <div class="flex flex-col items-center">
                                        <span class="text-base md:text-lg font-bold text-slate-300">Upload File</span>
                                    </div>
                                    <input type="file" accept=".json,.db,.sqlite" class="hidden" onchange="handleFileUpload(event)">
                                </label>
                            </div>
                        </div>
                    `;
                }
            }
            return false;
        };
        
        // НОВОЕ: Обработчик для unhandled promise rejections (важно для async кода)
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            if (window.isCapacitorNative && window.isCapacitorNative()) {
                event.preventDefault(); // Предотвращаем крах приложения
            }
        });
        
        // ========== FORCE LANDSCAPE ORIENTATION ==========
        (function() {
            // Try to lock screen to landscape orientation
            async function lockLandscape() {
                try {
                    // First try Capacitor Screen Orientation plugin
                    const ScreenOrientation = window.getCapacitorPlugin('ScreenOrientation');
                    if (ScreenOrientation && ScreenOrientation.lock) {
                        await ScreenOrientation.lock({ orientation: 'landscape' });
                        console.log('Capacitor: Screen locked to landscape');
                        return;
                    }
                    
                    // Fallback to Web API
                    if (screen.orientation && screen.orientation.lock) {
                        await screen.orientation.lock('landscape');
                        console.log('Web API: Screen locked to landscape');
                    } else if (screen.lockOrientation) {
                        screen.lockOrientation('landscape');
                    } else if (screen.mozLockOrientation) {
                        screen.mozLockOrientation('landscape');
                    } else if (screen.msLockOrientation) {
                        screen.msLockOrientation('landscape');
                    }
                } catch (e) {
                    console.log('Screen orientation lock not supported:', e.message);
                }
            }
            
            // Lock orientation on page load and when entering fullscreen
            document.addEventListener('DOMContentLoaded', lockLandscape);
            document.addEventListener('fullscreenchange', lockLandscape);
            document.addEventListener('webkitfullscreenchange', lockLandscape);
            
            // For Capacitor apps, wait for ready then lock
            if (window.CapacitorReady) {
                window.CapacitorReady.then((isNative) => {
                    if (isNative) {
                        lockLandscape();
                    }
                });
            }
        })();
        


        // Мобильное состояние
        let mobileMenuOpen = false;
        
        function toggleMobileMenu() {
            // No-op in landscape mode - menu is always visible
        }
        
        function changeView(view) {
            STATE.view = view;
            STATE.activeSwapSlot = null;
            renderDashboard();
        }
        
        // No longer uses mobile menu elements in landscape mode
        function updateMobileMenuInfo() {
            // No-op - info is shown in header in landscape mode
        }

        const STATE = {
            loaded: false,
            season: 1,
            history: [],
            newsFeed: [],
            allTeams: [],
            activeLeagueTeams: [],
            schedule: [],
            userTeamId: null,
            userLeagueId: null, // НОВОЕ: текущая лига пользователя как источник истины
            view: 'next-match', 
            activeSwapSlot: null,
            freeAgents: [], // НОВОЕ: Свободные агенты
            market: {
                posFilter: 'ALL',
                posExact: '', // Точная позиция (CB, ST, RW и т.д.)
                sort: 'RATING',
                sortDir: 'DESC', // ASC или DESC
                search: '',
                ageMin: '',
                ageMax: '',
                ratingMin: '',
                ratingMax: '',
                priceMin: '',
                priceMax: '',
                nation: '',
                page: 1,
                perPage: 50,
                debounceTimer: null,
                showFreeAgents: false // НОВОЕ: переключатель для свободных агентов
            },
            leagueStats: {
                topScorers: [],
                topAssists: [],
                bestPlayers: [],
                awardsHistory: []
            },
            leaguesMap: new Map(),
            userLineupSlots: Array(11).fill(null),
            slotSelection: null,
            matchRedCards: new Map(),
            // НОВОЕ: Кубок и календарь
            cups: {},
            calendar: {
                currentWeek: 0,
                weeks: [] // { week: number, events: [{type, matchday/round, played}], played: boolean }
            },
            // НОВОЕ: Еврокубки
            europe: null,
            tableView: 'LEAGUE', // 'LEAGUE', 'UCL', 'UEL', 'UECL'
            selectedEuroGroup: 'A',
            // НОВОЕ: Текущий слот сохранения
            currentSlotId: null,
            // НОВОЕ: Тактические настройки
            currentTactic: '4-3-3',
            gamePlan: 'balanced',
            pressure: 'normal',
            benchTab: 'subs',
            // НОВОЕ: Wishlist
            wishlist: [],
            // НОВОЕ: Вкладка маркета
            marketTab: 'market' // 'market' или 'wishlist'
        };

        // НОВОЕ: Константы для еврокубков
        const EURO_SLOTS = {
            UCL: 4,  // top4 лиги
            UEL: 2,  // следующие 2
            UECL: 1  // еще 1
        };
        
        const EURO_COMP_NAMES = {
            UCL: 'Champions League',
            UEL: 'Europa League',
            UECL: 'Conference League'
        };
        
        const EURO_COMP_COLORS = {
            UCL: { bg: 'bg-blue-600', text: 'text-blue-400', border: 'border-blue-500' },
            UEL: { bg: 'bg-orange-600', text: 'text-orange-400', border: 'border-orange-500' },
            UECL: { bg: 'bg-emerald-600', text: 'text-emerald-400', border: 'border-emerald-500' }
        };

        // ========== TRANSFER RESTRICTIONS SYSTEM ==========
        
        // Расчёт силы состава клуба (средний рейтинг стартовой XI)
        function getClubStrength(team) {
            if (!team || !team.squad) return 50;
            
            let starters = [];
            if (team.id === STATE.userTeamId) {
                // Для пользователя используем слоты
                STATE.userLineupSlots.forEach(slotId => {
                    if (slotId !== null) {
                        const player = team.squad.find(p => p.internalId === slotId);
                        if (player) starters.push(player);
                    }
                });
            } else {
                starters = team.squad.filter(p => p.isStarter);
            }
            
            if (starters.length === 0) {
                // Если нет стартового состава, берём топ-11 по рейтингу
                const sorted = [...team.squad].sort((a, b) => b.rating - a.rating);
                starters = sorted.slice(0, 11);
            }
            
            if (starters.length === 0) return 50;
            
            const totalRating = starters.reduce((sum, p) => sum + p.rating, 0);
            return Math.round(totalRating / starters.length);
        }
        
        // Расчёт бюджета клуба (уже есть calculateBudget, используем его)
        function getClubBudget(team) {
            return team?.budget || 50000;
        }
        
        // Получение информации о лиге клуба
        function getLeagueInfo(team) {
            if (!team) return { division: 1, nation: 'INT' };
            const leagueInfo = STATE.leaguesMap.get(String(team.leagueId));
            return {
                division: leagueInfo?.division || 1,
                nation: leagueInfo?.nation || 'INT'
            };
        }
        
// Открыть модальное окно сохранения - УЛУЧШЕНО v2.1
async function openSaveModal() {
    // Получаем текущую информацию о карьере
    const userTeam = getTeam(STATE.userTeamId);
    const leagueInfo = STATE.leaguesMap?.get(String(userTeam?.leagueId));
    
    // Создаем HTML модалки динамически
    const modalHtml = `
    <div id="save-modal" class="fixed inset-0 bg-black/90 z-[300] flex items-center justify-center p-4 backdrop-blur-md animate-fadeIn">
        <div class="glass-panel bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 w-full max-w-lg max-h-[85vh] overflow-hidden rounded-3xl border border-slate-600/50 shadow-2xl">
            <div class="sticky top-0 bg-gradient-to-r from-slate-900 to-slate-800 p-5 border-b border-slate-700/50">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-black text-white uppercase tracking-tight">Save Career</h2>
                        <p class="text-xs text-slate-500 mt-1">Select a slot to save your progress</p>
                    </div>
                    <button onclick="closeSaveModal()" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-red-500/30 hover:text-red-400 flex items-center justify-center transition-all text-lg">✕</button>
                </div>
                <!-- Current career info -->
                <div class="mt-4 p-3 bg-slate-800/60 rounded-xl border border-white/5">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-slate-500 uppercase">Current Career</div>
                            <div class="text-white font-bold">${userTeam?.name || 'Unknown Team'}</div>
                            <div class="text-xs text-slate-400">${leagueInfo?.name || 'Unknown League'}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black text-[#4caf50]">S${STATE.season || 1}</div>
                            <div class="text-xs text-slate-500">Week ${(STATE.calendar?.currentWeek || 0) + 1}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 space-y-2 overflow-y-auto max-h-[50vh]" id="save-slots-list">
                <div class="text-center text-slate-400 py-8">
                    <div class="animate-spin w-8 h-8 border-2 border-slate-600 border-t-[#4caf50] rounded-full mx-auto mb-3"></div>
                    Loading save slots...
                </div>
            </div>
        </div>
    </div>`;

    // Вставляем в body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Рендерим слоты
    const list = document.getElementById('save-slots-list');
    let html = '';

    for (let i = 1; i <= 15; i++) {
        const info = await getSlotInfo(i);
        // Если это текущий слот, выделим его
        const isCurrent = (STATE.currentSlotId === i) ? 'ring-2 ring-cyan-500 border-cyan-500/50' : 'border-slate-700/50';
        const savedDate = info.date ? new Date(info.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) : '';
        
        html += `
        <button onclick="saveToSlot(${i})" class="w-full text-left p-4 rounded-2xl border ${isCurrent} bg-slate-800/60 hover:bg-slate-700/60 transition-all group">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-slate-500 text-xs font-bold">SLOT ${i}</span>
                        ${STATE.currentSlotId === i ? '<span class="px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-[10px] font-bold rounded">CURRENT</span>' : ''}
                    </div>
                    ${info.exists ? `
                        <div class="text-white font-bold">${info.team}</div>
                        <div class="text-xs text-slate-400 flex items-center gap-2">
                            <span>${info.league || 'Unknown'}</span>
                            <span class="text-slate-600">•</span>
                            <span>S${info.season} W${info.week || 1}</span>
                            ${savedDate ? `<span class="text-slate-600">•</span><span class="text-slate-500">${savedDate}</span>` : ''}
                        </div>
                    ` : `
                        <div class="text-slate-500">Empty Slot</div>
                    `}
                </div>
                <div class="flex items-center gap-2">
                    ${info.exists ? '<span class="text-xs text-orange-400 opacity-0 group-hover:opacity-100 transition-opacity">Overwrite</span>' : ''}
                    <div class="text-xs bg-[#4caf50] px-3 py-2 rounded-lg text-white font-bold shadow-lg shadow-[#4caf50]/20 group-hover:bg-[#43a047] transition-colors">
                        SAVE
                    </div>
                </div>
            </div>
        </button>`;
    }
    
    list.innerHTML = html;
}

function closeSaveModal() {
    const modal = document.getElementById('save-modal');
    if (modal) modal.remove();
}

// closeLoadModal is defined at the top of the script

// ========== CAPACITOR STORAGE MANAGER v2.0 ==========
// Использует Capacitor Filesystem API для нативной платформы
// Fallback на localStorage для веб-версии
// РЕШАЕТ проблему "storage is full" на Android

const StorageManager = {
    _ready: false,
    _isNative: false,
    _storageDir: 'FOOTLOGIC_DATA',
    
    async init() {
        if (this._ready) return;
        try {
            if (window.CapacitorReady) {
                this._isNative = await window.CapacitorReady;
            }
            this._ready = true;
            console.log('StorageManager v2.0: Initialized, isNative:', this._isNative);
            
            // На нативной платформе создаём директорию для данных
            if (this._isNative) {
                await this._ensureDirectory();
            }
        } catch (e) {
            console.warn('StorageManager: Init error:', e);
            this._ready = true;
        }
    },
    
    // Проверка нативной платформы
    isNative() {
        return this._isNative && (this._getFilesystem() !== null);
    },
    
    // Получение Filesystem плагина
    _getFilesystem() {
        return window.getCapacitorPlugin('Filesystem');
    },
    
    // Создание директории для данных
    async _ensureDirectory() {
        try {
            const Filesystem = this._getFilesystem();
            if (!Filesystem) return;
            
            try {
                await Filesystem.mkdir({
                    path: this._storageDir,
                    directory: 'DATA',
                    recursive: true
                });
            } catch (e) {
                // Директория уже существует - это нормально
            }
            console.log('StorageManager: Data directory ready');
        } catch (e) {
            console.warn('StorageManager: Could not create directory:', e);
        }
    },
    
    // Конвертация ключа в имя файла
    _keyToFilename(key) {
        // Заменяем недопустимые символы
        return key.replace(/[^a-zA-Z0-9_-]/g, '_') + '.json';
    },
    
    // Сохранение данных
    async set(key, value) {
        await this.init();
        try {
            const jsonValue = JSON.stringify(value);
            const sizeKB = (new Blob([jsonValue]).size / 1024).toFixed(1);
            console.log(`StorageManager: Saving ${key}, size: ${sizeKB} KB`);
            
            if (this.isNative()) {
                // Используем Filesystem API для нативной платформы
                const Filesystem = this._getFilesystem();
                const filename = this._keyToFilename(key);
                
                await Filesystem.writeFile({
                    path: `${this._storageDir}/${filename}`,
                    data: jsonValue,
                    directory: 'DATA',
                    encoding: 'utf8'
                });
                console.log('StorageManager: Saved to Filesystem:', key);
            } else {
                // Для веб используем localStorage с умной очисткой
                try {
                    localStorage.setItem(key, jsonValue);
                } catch (quotaError) {
                    if (quotaError.name === 'QuotaExceededError' || 
                        quotaError.name === 'NS_ERROR_DOM_QUOTA_REACHED' ||
                        quotaError.message.includes('quota')) {
                        console.warn('StorageManager: Quota exceeded, cleaning up...');
                        await this._cleanupForSpace(jsonValue.length);
                        localStorage.setItem(key, jsonValue);
                    } else {
                        throw quotaError;
                    }
                }
                console.log('StorageManager: Saved to localStorage:', key);
            }
            return true;
        } catch (e) {
            console.error('StorageManager.set error:', e);
            this._showStorageError(e);
            return false;
        }
    },
    
    // Чтение данных
    async get(key) {
        await this.init();
        try {
            if (this.isNative()) {
                const Filesystem = this._getFilesystem();
                const filename = this._keyToFilename(key);
                
                try {
                    const result = await Filesystem.readFile({
                        path: `${this._storageDir}/${filename}`,
                        directory: 'DATA',
                        encoding: 'utf8'
                    });
                    
                    if (result && result.data) {
                        return JSON.parse(result.data);
                    }
                } catch (readError) {
                    // Файл не существует - это нормально
                    if (!readError.message?.includes('not exist')) {
                        console.warn('StorageManager: Read error for', key, readError.message);
                    }
                }
                return null;
            } else {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : null;
            }
        } catch (e) {
            console.error('StorageManager.get error:', e);
            return null;
        }
    },
    
    // Удаление данных
    async remove(key) {
        await this.init();
        try {
            if (this.isNative()) {
                const Filesystem = this._getFilesystem();
                const filename = this._keyToFilename(key);
                
                try {
                    await Filesystem.deleteFile({
                        path: `${this._storageDir}/${filename}`,
                        directory: 'DATA'
                    });
                } catch (e) {
                    // Файл не существует - это нормально
                }
            } else {
                localStorage.removeItem(key);
            }
            return true;
        } catch (e) {
            console.error('StorageManager.remove error:', e);
            return false;
        }
    },
    
    // Получение всех ключей
    async keys() {
        await this.init();
        try {
            if (this.isNative()) {
                const Filesystem = this._getFilesystem();
                try {
                    const result = await Filesystem.readdir({
                        path: this._storageDir,
                        directory: 'DATA'
                    });
                    
                    if (result && result.files) {
                        return result.files
                            .filter(f => f.name?.endsWith('.json') || f.endsWith?.('.json'))
                            .map(f => {
                                const name = f.name || f;
                                return name.replace('.json', '').replace(/_/g, '');
                            });
                    }
                } catch (e) {
                    // Директория пустая или не существует
                }
                return [];
            } else {
                return Object.keys(localStorage);
            }
        } catch (e) {
            console.error('StorageManager.keys error:', e);
            return [];
        }
    },
    
    // Очистка места для новых данных
    async _cleanupForSpace(neededBytes) {
        console.log('StorageManager: Cleaning up space, need', (neededBytes / 1024).toFixed(1), 'KB');
        
        // 1. Удаляем кеш и временные данные
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.includes('cache') || key.includes('temp') || key.includes('_old'))) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(k => localStorage.removeItem(k));
        
        // 2. Удаляем большие данные модов (кроме кода модов)
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('modapi_data_')) {
                const data = localStorage.getItem(key);
                if (data && data.length > 10000) { // > 10KB
                    console.log('StorageManager: Removing mod data:', key);
                    localStorage.removeItem(key);
                }
            }
        }
        
        // 3. Если всё ещё мало места, удаляем старые сейвы (кроме последних 2)
        const saveSlots = [];
        for (let i = 1; i <= 5; i++) {
            const data = localStorage.getItem(`savegame_slot_${i}`);
            if (data) {
                saveSlots.push({ slot: i, size: data.length });
            }
        }
        
        // Сортируем по размеру (большие первые) и удаляем если их больше 2
        saveSlots.sort((a, b) => b.size - a.size);
        if (saveSlots.length > 2) {
            for (let i = 2; i < saveSlots.length; i++) {
                console.log('StorageManager: Removing old save slot:', saveSlots[i].slot);
                localStorage.removeItem(`savegame_slot_${saveSlots[i].slot}`);
            }
        }
        
        console.log('StorageManager: Cleanup complete, used space:', this.getUsedSpace());
    },
    
    // Показать ошибку хранилища
    _showStorageError(error) {
        const usedSpace = this.getUsedSpace();
        const message = this.isNative() 
            ? `Storage error: ${error.message}`
            : `Storage full! (${usedSpace} used)\n\nDelete old saves or clear browser data.`;
        
        if (window.showToast) {
            window.showToast(message, 'error');
        } else {
            alert(message);
        }
    },
    
    // Получить занятое место
    getUsedSpace() {
        let total = 0;
        try {
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key) {
                    const value = localStorage.getItem(key);
                    if (value) total += value.length * 2;
                }
            }
        } catch (e) {}
        
        if (total > 1024 * 1024) {
            return (total / (1024 * 1024)).toFixed(2) + ' MB';
        }
        return (total / 1024).toFixed(1) + ' KB';
    }
};

// ========== TEAM LOGOS SYSTEM ==========
// Loads and displays team logos from APK assets via Capacitor

const LogoManager = {
    // Cache of loaded logo URLs (teamId -> dataURL or file path)
    logoCache: new Map(),
    // Set of teams without logos (for faster fallback)
    missingLogos: new Set(),
    // Base path for logos in the file system
    basePath: '',
    // Initialization flag
    initialized: false,
    // Native platform flag
    _isNative: false,
    // Flag for local cache loaded
    localCacheLoaded: false,
    
    // Check if running in Capacitor
    isCapacitor() {
        return this._isNative || window.isCapacitorNative();
    },
    
    // Get Filesystem plugin
    getFilesystem() {
        return window.getCapacitorPlugin('Filesystem');
    },
    
    // Initialize the logo system
    async initialize() {
        if (this.initialized) return;
        
        try {
            // Wait for Capacitor to be ready
            if (window.CapacitorReady) {
                this._isNative = await window.CapacitorReady;
            }
            
            if (this.isCapacitor()) {
                console.log('LogoManager: Running in Capacitor native mode');
                // For Capacitor, logos are served from the webview's public folder
                this.basePath = '';
                
                // Try to load cached logos from local storage
                await this.loadLocalCache();
            } else {
                // For web preview
                this.basePath = '/logos/';
            }
            
            this.initialized = true;
            console.log('LogoManager: Initialized successfully, isCapacitor:', this.isCapacitor());
        } catch (e) {
            console.warn('LogoManager: Initialization failed:', e);
            this.initialized = true;
        }
    },
    
    // Load cached logos from FootLogic/data folder
    async loadLocalCache() {
        if (this.localCacheLoaded) return;
        
        try {
            const Filesystem = this.getFilesystem();
            if (!Filesystem) return;
            
            // Получаем правильную директорию
            const directory = window.StorageManager ? window.StorageManager.getDirectory() : 'Documents';
            
            // Try to read the logo cache index
            const cacheIndexPath = 'FootLogic/data/logo_cache_index.json';
            try {
                const result = await Filesystem.readFile({
                    path: cacheIndexPath,
                    directory: directory,
                    encoding: 'utf8'
                });
                
                const cacheIndex = JSON.parse(result.data);
                if (cacheIndex && cacheIndex.logos) {
                    for (const [teamId, logoData] of Object.entries(cacheIndex.logos)) {
                        this.logoCache.set(teamId, logoData);
                    }
                    console.log('LogoManager: Loaded', Object.keys(cacheIndex.logos).length, 'logos from local cache');
                }
            } catch (e) {
                // Cache doesn't exist yet - that's fine
                console.log('LogoManager: No local cache found, will create on first load');
            }
            
            this.localCacheLoaded = true;
        } catch (e) {
            console.warn('LogoManager: Failed to load local cache:', e);
        }
    },
    
    // Save logo cache to FootLogic/data folder
    async saveLocalCache() {
        try {
            const Filesystem = this.getFilesystem();
            if (!Filesystem) return;
            
            // Only cache if we have logos
            if (this.logoCache.size === 0) return;
            
            // Получаем правильную директорию
            const directory = window.StorageManager ? window.StorageManager.getDirectory() : 'Documents';
            
            const cacheIndex = {
                version: '1.0',
                savedAt: new Date().toISOString(),
                logos: Object.fromEntries(this.logoCache)
            };
            
            await Filesystem.writeFile({
                path: 'FootLogic/data/logo_cache_index.json',
                data: JSON.stringify(cacheIndex),
                directory: directory,
                encoding: 'utf8'
            });
            
            console.log('LogoManager: Saved', this.logoCache.size, 'logos to local cache');
        } catch (e) {
            console.warn('LogoManager: Failed to save local cache:', e);
        }
    },
    
    // Get the logo path for a team based on nation and division
    getTeamLogoPath(team) {
        if (!team || !team.name) return null;
        
        // Get league info for nation and division
        const leagueInfo = STATE.leaguesMap.get(String(team.leagueId));
        const nation = leagueInfo?.nation || 'INT';
        const division = leagueInfo?.division || 1;
        
        // Construct path: logos/{nation}_{division}/{teamName}.webp
        const teamName = team.name.trim();
        const folderName = `${nation}_${division}`;
        
        // For both Capacitor and web, use the same relative path
        // In Capacitor, this will be served from the app's www folder
        return `logos/${folderName}/${encodeURIComponent(teamName)}.webp`;
    },
    
    // Load a logo and cache it
    async loadLogo(team) {
        if (!team || !team.id) return null;
        
        // Check cache first
        if (this.logoCache.has(team.id)) {
            return this.logoCache.get(team.id);
        }
        
        // Check if already known to be missing
        if (this.missingLogos.has(team.id)) {
            return null;
        }
        
        const logoPath = this.getTeamLogoPath(team);
        if (!logoPath) {
            this.missingLogos.add(team.id);
            return null;
        }
        
        try {
            if (this.isCapacitor()) {
                // In Capacitor, try to load from the app's www folder using fetch
                // Assets in public/ folder are copied to www/ during build
                const response = await fetch(logoPath);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const dataUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                    
                    this.logoCache.set(team.id, dataUrl);
                    console.log('LogoManager: Loaded logo for', team.name);
                    return dataUrl;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } else {
                // For web, just return the path and let the browser handle loading
                const fullPath = '/' + logoPath;
                this.logoCache.set(team.id, fullPath);
                return fullPath;
            }
        } catch (e) {
            // Logo not found - silently add to missing set
            this.missingLogos.add(team.id);
            console.debug('LogoManager: Logo not found for', team.name, ':', e.message);
        }
        
        return null;
    },
    
    // Get cached logo URL (sync version for render functions)
    getCachedLogo(team) {
        if (!team || !team.id) return null;
        if (this.missingLogos.has(team.id)) return null;
        return this.logoCache.get(team.id) || null;
    },
    
    // Preload logos for a list of teams
    async preloadLogos(teams) {
        if (!teams || teams.length === 0) return;
        
        await this.initialize();
        
        // If logos are already cached locally, skip fetching
        const uncachedTeams = teams.filter(t => !this.logoCache.has(t.id));
        
        if (uncachedTeams.length === 0) {
            console.log('LogoManager: All logos already cached');
            return;
        }
        
        console.log('LogoManager: Loading', uncachedTeams.length, 'uncached logos');
        
        const promises = uncachedTeams.map(team => this.loadLogo(team));
        await Promise.allSettled(promises);
        
        // Save cache to local storage after loading
        if (this.isCapacitor() && uncachedTeams.length > 0) {
            await this.saveLocalCache();
        }
    },

    // Get the correct path for UI icons (Capacitor vs Web)
    getUIIconPath(path) {
        if (!path) return '';
        if (this.isCapacitor()) {
            // In Capacitor, paths are relative to the www folder
            return path;
        }
        // For web preview, add leading slash if not present
        return path.startsWith('/') ? path : '/' + path;
    }
};

// Render team logo with fallback to colored circle with initials
// Sizes: 'xs' (16px), 'sm' (24px), 'md' (32px), 'lg' (48px), 'xl' (64px), '2xl' (80px)
function renderTeamLogo(team, size = 'sm', extraClasses = '') {
    if (!team) {
        return `<div class="w-6 h-6 rounded-full bg-slate-700"></div>`;
    }
    
    const sizeMap = {
        'xs': { px: 16, text: 'text-[8px]', ring: 'ring-1' },
        'sm': { px: 24, text: 'text-[10px]', ring: 'ring-1' },
        'md': { px: 32, text: 'text-xs', ring: 'ring-2' },
        'lg': { px: 48, text: 'text-sm', ring: 'ring-2' },
        'xl': { px: 64, text: 'text-base', ring: 'ring-2' },
        '2xl': { px: 80, text: 'text-lg', ring: 'ring-4' }
    };
    
    const s = sizeMap[size] || sizeMap['sm'];
    const initials = team.name.substring(0, 2).toUpperCase();
    const teamColor = team.color || '#4caf50';
    const logoUrl = LogoManager.getCachedLogo(team);
    const logoPath = LogoManager.getTeamLogoPath(team);
    
    // Generate unique ID for this logo instance
    const logoId = `logo-${team.id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    if (logoUrl || logoPath) {
        // Construct the full src - for web add leading slash, for cached URLs use as-is
        const logoSrc = logoUrl ? logoUrl : (logoPath.startsWith('/') || logoPath.startsWith('data:') ? logoPath : '/' + logoPath);
        // Try to show logo with fallback
        return `
            <div class="relative flex-shrink-0 ${extraClasses}" style="width: ${s.px}px; height: ${s.px}px;">
                <img 
                    id="${logoId}"
                    src="${logoSrc}"
                    alt="${team.name}" 
                    class="w-full h-full object-contain rounded-full ${s.ring} ring-slate-700/50 shadow-sm bg-slate-800/50"
                    style="width: ${s.px}px; height: ${s.px}px;"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    onload="this.style.display='block'; if(this.nextElementSibling) this.nextElementSibling.style.display='none';"
                >
                <div 
                    class="absolute inset-0 rounded-full flex items-center justify-center font-black ${s.text} shadow-lg ${s.ring} ring-slate-700/50"
                    style="background-color: ${teamColor}; color: white; display: none;"
                >
                    ${initials}
                </div>
            </div>
        `;
    }
    
    // Fallback: colored circle with initials
    return `
        <div 
            class="flex-shrink-0 rounded-full flex items-center justify-center font-black ${s.text} shadow-lg ${s.ring} ring-slate-700/50 ${extraClasses}"
            style="width: ${s.px}px; height: ${s.px}px; background-color: ${teamColor}; color: white;"
        >
            ${initials}
        </div>
    `;
}

// Shorthand for inline logo (returns HTML string)
function teamLogo(team, size = 'sm') {
    return renderTeamLogo(team, size);
}

// Получение информации о слоте (поддержка v1.x, v2.0 и v2.1 форматов) - ИСПРАВЛЕНО
async function getSlotInfo(slotId) {
    // Сначала пробуем новый формат StorageManager
    const newFormatData = await StorageManager.loadSlot(slotId, true);
    if (newFormatData && newFormatData.meta) {
        const meta = newFormatData.meta;
        return {
            exists: true,
            team: meta.teamName || 'Unknown Team',
            teamId: meta.teamId || null,
            season: meta.season || 1,
            week: meta.week || 1,
            totalWeeks: meta.totalWeeks || 38,
            league: meta.leagueName || 'Unknown League',
            leagueId: meta.leagueId || null,
            leagueCountry: meta.leagueCountry || null,
            date: meta.savedAt || null,
            version: meta.version || '2.1.0',
            teamRating: meta.teamRating || null,
            budget: meta.budget || null,
            position: meta.position || null,
            points: meta.points || null
        };
    }
    
    // Fallback на старый формат
    const saveData = await StorageManager.get(`savegame_slot_${slotId}`);
    if (saveData) {
        let teamName = 'Unknown Team';
        let season = 1;
        let week = 1;
        let leagueName = 'Unknown League';
        let savedDate = null;
        let leagueId = null;
        
        // Определяем версию формата
        const isV2 = saveData.v === '2.0' || saveData.sn !== undefined;
        
        if (isV2) {
            // Формат v2.0
            season = saveData.sn || 1;
            week = (saveData.cal?.currentWeek || 0) + 1;
            savedDate = saveData.ts ? new Date(saveData.ts).toISOString() : null;
            const userTeamId = saveData.ut;
            leagueId = saveData.ul;
            
            if (saveData.clubs && userTeamId) {
                const team = saveData.clubs.find(t => String(t.id) === String(userTeamId));
                if (team) {
                    teamName = team.name;
                    leagueId = team.leagueId;
                }
            }
            
            // Получаем название лиги
            if (saveData.lm && leagueId) {
                const leagueMap = new Map(saveData.lm);
                const leagueInfo = leagueMap.get(String(leagueId));
                if (leagueInfo) leagueName = leagueInfo.name || leagueName;
            }
        } else {
            // Формат v1.x
            season = saveData.season || 1;
            week = (saveData.calendar?.currentWeek || 0) + 1;
            savedDate = saveData.savedAt || null;
            
            if (saveData.clubs && saveData.userTeamId) {
                const team = saveData.clubs.find(t => String(t.id) === String(saveData.userTeamId));
                if (team) {
                    teamName = team.name;
                    leagueId = team.leagueId;
                }
            } else if (saveData.allTeams && saveData.userTeamId) {
                const team = saveData.allTeams.find(t => String(t.id) === String(saveData.userTeamId));
                if (team) {
                    teamName = team.name;
                    leagueId = team.leagueId;
                }
            }
            
            // Получаем название лиги из leaguesMap
            if (saveData.leaguesMap && leagueId) {
                const leagueMap = new Map(saveData.leaguesMap);
                const leagueInfo = leagueMap.get(String(leagueId));
                if (leagueInfo) leagueName = leagueInfo.name || leagueName;
            }
        }
        
        return {
            exists: true,
            team: teamName,
            season: season,
            week: week,
            league: leagueName,
            leagueId: leagueId,
            date: savedDate,
            version: isV2 ? '2.0' : '1.x'
        };
    }
    return { exists: false };
}

// Сбор данных для сохранения - FIXED v2.2: Complete career save with all data
// Goal: Reliable save of all career data including salaries
function collectSaveData() {
    // FIXED: Save ALL important player fields including salary
    const optimizePlayer = (p) => {
        return {
            // ID и базовая инфо
            id: p.id,
            internalId: p.internalId,
            name: p.name,
            pos: p.pos,
            nation: p.nation,
            age: p.age,
            
            // Рейтинги и атрибуты
            rating: p.rating,
            pot: p.pot,
            potential: p.potential,
            speed: p.speed,
            shot: p.shot,
            pass: p.pass,
            dribble: p.dribble,
            def: p.def,
            phys: p.phys,
            
            // Контракт и финансы - FIXED: Always include salary
            value: p.value,
            price: p.price,
            wage: p.wage,
            salary: p.salary || calculatePlayerSalary(p), // FIXED: Ensure salary is always saved
            endContract: p.endContract,
            contractEnd: p.contractEnd,
            clubId: p.clubId,
            
            // Статистика сезона
            goals: p.goals || 0,
            assists: p.assists || 0,
            appearances: p.appearances || 0,
            seasonGoals: p.seasonGoals || 0,
            seasonAssists: p.seasonAssists || 0,
            seasonRating: p.seasonRating || 0,
            careerGoals: p.careerGoals || 0,
            yellowCards: p.yellowCards || 0,
            redCards: p.redCards || 0,
            
            // Состояние
            injured: p.injured || false,
            injuryWeeks: p.injuryWeeks || 0,
            isSuspended: p.isSuspended || false,
            energy: p.energy ?? 100,
            morale: p.morale ?? 50,
            isStarter: p.isStarter || false,
            
            // Аренда и трансферы
            onLoan: p.onLoan || false,
            loanFromId: p.loanFromId,
            loanEndSeason: p.loanEndSeason,
            loanParentClub: p.loanParentClub,
            transferListed: p.transferListed || false,
            isFreeAgent: p.isFreeAgent || false
        };
    };
    
    // Оптимизируем матч - только необходимые поля
    const optimizeMatch = (m) => ({
        id: m.id,
        week: m.week,
        homeId: m.homeId,
        awayId: m.awayId,
        leagueId: m.leagueId,
        played: m.played || false,
        // Результаты только для сыгранных матчей
        ...(m.played ? {
            homeGoals: m.homeGoals,
            awayGoals: m.awayGoals
        } : {})
    });
    
    // FIXED: Save all important club fields including stadium name
    const optimizeClub = (t) => ({
        id: t.id,
        name: t.name,
        abbr: t.abbr,
        leagueId: t.leagueId,
        leagueName: t.leagueName,
        stadiumName: t.stadiumName,
        budget: t.budget || 0,
        reputation: t.reputation || 70,
        teamRating: t.teamRating || 0,
        color: t.color,
        logo: t.logo,
        
        // Турнирная таблица
        pts: t.pts || t.points || 0,
        points: t.points || t.pts || 0,
        won: t.won || t.wins || 0,
        drawn: t.drawn || t.draws || 0,
        lost: t.lost || t.losses || 0,
        gf: t.gf || 0,
        ga: t.ga || 0,
        gd: t.gd || 0,
        played: t.played || 0,
        wins: t.wins || t.won || 0,
        draws: t.draws || t.drawn || 0,
        losses: t.losses || t.lost || 0,
        
        // Тактика (только для команды игрока)
        ...(t.id === STATE.userTeamId ? {
            formation: t.formation,
            tactic: t.tactic
        } : {})
    });
    
    // News feed - last 20 entries
    const optimizedNewsFeed = (STATE.newsFeed || []).slice(-20).map(n => ({
        t: n.title || n.t,
        x: n.text || n.msg || n.x,
        w: n.week || n.w,
        tp: n.type || n.tp
    }));
    
    // История - последние 30 записей
    const optimizedHistory = (STATE.history || []).slice(-30);
    
    // Schedule - FIXED: save ALL matches (not just recent) for proper loading
    const optimizedSchedule = (STATE.schedule || []).map(optimizeMatch);
    
    // Календарь - FIXED: save complete calendar
    const optimizedCalendar = STATE.calendar ? {
        currentWeek: STATE.calendar.currentWeek || 0,
        totalWeeks: STATE.calendar.totalWeeks || 38,
        weeks: STATE.calendar.weeks || []
    } : { currentWeek: 0, totalWeeks: 38, weeks: [] };
    
    // Cups - complete information
    const optimizedCups = STATE.cups || {};
    
    // Get user team info for meta
    const userTeam = getTeam(STATE.userTeamId);
    const leagueInfo = STATE.leaguesMap?.get(String(userTeam?.leagueId));
    
    return {
        // FIXED: Complete meta information
        v: '2.2', // Updated version format
        ts: Date.now(),
        savedAt: new Date().toISOString(),
        
        // Main data
        sn: STATE.season,
        season: STATE.season, // Keep both for compatibility
        ut: STATE.userTeamId,
        userTeamId: STATE.userTeamId, // Keep both for compatibility
        ul: STATE.userLeagueId,
        userLeagueId: STATE.userLeagueId,
        
        // Team name for meta display
        teamName: userTeam?.name || 'Unknown',
        leagueName: leagueInfo?.name || userTeam?.leagueName || 'Unknown League',
        
        // Optimized data
        nf: optimizedNewsFeed,
        newsFeed: optimizedNewsFeed, // Keep both
        hs: optimizedHistory,
        history: optimizedHistory,
        sch: optimizedSchedule,
        schedule: optimizedSchedule,
        cal: optimizedCalendar,
        calendar: optimizedCalendar,
        
        // Players and clubs
        clubs: STATE.allTeams.map(optimizeClub),
        allTeams: STATE.allTeams.map(optimizeClub), // Keep for v1 compatibility
        players: STATE.allTeams.flatMap(t => t.squad).map(optimizePlayer),
        fa: (STATE.freeAgents || []).map(optimizePlayer),
        freeAgents: (STATE.freeAgents || []).map(optimizePlayer),
        
        // Leagues
        lm: Array.from(STATE.leaguesMap.entries()),
        leaguesMap: Array.from(STATE.leaguesMap.entries()),
        
        // User lineup
        ls: STATE.userLineupSlots,
        userLineupSlots: STATE.userLineupSlots,
        
        // Red cards
        rc: Array.from(STATE.matchRedCards.entries()),
        matchRedCards: Array.from(STATE.matchRedCards.entries()),
        
        // Cups
        cups: optimizedCups,
        
        // European cups (if present)
        eu: STATE.europe,
        europe: STATE.europe,
        
        // Settings
        tac: STATE.currentTactic,
        currentTactic: STATE.currentTactic,
        gp: STATE.gamePlan,
        gamePlan: STATE.gamePlan,
        pr: STATE.pressure,
        pressure: STATE.pressure,
        
        // Wishlist
        wl: (STATE.wishlist || []).slice(0, 20).map(p => ({ id: p.id, n: p.name, internalId: p.internalId })),
        wishlist: STATE.wishlist || [],
        
        // Current slot
        sl: STATE.currentSlotId,
        currentSlotId: STATE.currentSlotId,
        
        // League stats
        leagueStats: STATE.leagueStats || { topScorers: [], topAssists: [], bestPlayers: [], awardsHistory: [] },
        
        // View settings
        tableView: STATE.tableView,
        selectedEuroGroup: STATE.selectedEuroGroup,
        marketTab: STATE.marketTab,
        benchTab: STATE.benchTab
    };
}

// FIXED v2.2: Load career data - supports v1.x, v2.0, and v2.2 formats
function loadSaveData(saveData) {
    if (!saveData) return false;
    
    try {
        STATE.loaded = true;
        
        // Determine format version (v2.2 has both short and long keys, v2.0 only short, v1.x only long)
        const isV22 = saveData.v === '2.2';
        const isV2 = saveData.v === '2.0' || saveData.v === '2.2' || saveData.sn !== undefined;
        
        console.log('Loading save format:', isV22 ? 'v2.2' : (isV2 ? 'v2.0' : 'v1.x'));
        
        // ============ UNIFIED LOADING (works for all versions) ============
        
        // Season
        STATE.season = saveData.sn || saveData.season || 1;
        
        // User team and league
        STATE.userTeamId = saveData.ut || saveData.userTeamId;
        STATE.userLeagueId = saveData.ul || saveData.userLeagueId;
        STATE.currentSlotId = saveData.sl || saveData.currentSlotId;
        
        // News feed - handle both compressed and full formats
        const rawNewsFeed = saveData.nf || saveData.newsFeed || [];
        STATE.newsFeed = rawNewsFeed.map(n => ({
            title: n.t || n.title,
            text: n.x || n.text || n.msg,
            msg: n.x || n.text || n.msg,
            week: n.w || n.week,
            type: n.tp || n.type
        }));
        
        // History
        STATE.history = saveData.hs || saveData.history || [];
        
        // Schedule
        STATE.schedule = saveData.sch || saveData.schedule || [];
        
        // Calendar - FIXED: restore complete calendar
        const rawCalendar = saveData.cal || saveData.calendar || { currentWeek: 0, weeks: [] };
        STATE.calendar = {
            currentWeek: rawCalendar.currentWeek || 0,
            totalWeeks: rawCalendar.totalWeeks || 38,
            weeks: rawCalendar.weeks || []
        };
        
        // Free agents
        STATE.freeAgents = saveData.fa || saveData.freeAgents || [];
        
        // Leagues
        const rawLeaguesMap = saveData.lm || saveData.leaguesMap || [];
        STATE.leaguesMap = new Map(rawLeaguesMap);
        
        // User lineup slots
        STATE.userLineupSlots = saveData.ls || saveData.userLineupSlots || Array(11).fill(null);
        
        // Red cards
        const rawRedCards = saveData.rc || saveData.matchRedCards || [];
        STATE.matchRedCards = new Map(rawRedCards);
        
        // Cups
        STATE.cups = saveData.cups || {};
        
        // European cups - FIXED: handle both formats
        const rawEurope = saveData.eu || saveData.europe;
        if (rawEurope) {
            if (rawEurope.comp !== undefined) {
                // v2.0 compressed format
                STATE.europe = {
                    competition: rawEurope.comp,
                    group: rawEurope.group,
                    stage: rawEurope.stage,
                    ...rawEurope
                };
            } else {
                // Full format
                STATE.europe = rawEurope;
            }
        } else {
            STATE.europe = null;
        }
        
        // Settings
        STATE.currentTactic = saveData.tac || saveData.currentTactic || '4-3-3';
        STATE.gamePlan = saveData.gp || saveData.gamePlan || 'balanced';
        STATE.pressure = saveData.pr || saveData.pressure || 'normal';
        STATE.benchTab = saveData.benchTab || 'subs';
        STATE.tableView = saveData.tableView || 'LEAGUE';
        STATE.selectedEuroGroup = saveData.selectedEuroGroup || 'A';
        STATE.marketTab = saveData.marketTab || 'market';
        STATE.view = saveData.view || 'next-match';
        
        // Wishlist - handle both compressed and full formats
        const rawWishlist = saveData.wl || saveData.wishlist || [];
        STATE.wishlist = rawWishlist.map(p => ({
            id: p.id,
            name: p.n || p.name,
            internalId: p.internalId
        }));
        
        // League stats
        STATE.leagueStats = saveData.leagueStats || { topScorers: [], topAssists: [], bestPlayers: [], awardsHistory: [] };
        
        // ============ CLUBS AND PLAYERS ============
        const rawClubs = saveData.clubs || saveData.allTeams || [];
        const rawPlayers = saveData.players || [];
        
        if (rawClubs.length > 0) {
            STATE.allTeams = rawClubs.map(club => {
                const c = { ...club };
                c.id = String(c.id);
                c.leagueId = String(c.leagueId || c.league || '');
                c.squad = [];
                // FIXED: Restore all team properties
                c.pts = c.pts || c.points || 0;
                c.points = c.points || c.pts || 0;
                c.won = c.won || c.wins || 0;
                c.wins = c.wins || c.won || 0;
                c.drawn = c.drawn || c.draws || 0;
                c.draws = c.draws || c.drawn || 0;
                c.lost = c.lost || c.losses || 0;
                c.losses = c.losses || c.lost || 0;
                c.gf = c.gf || 0;
                c.ga = c.ga || 0;
                c.gd = c.gd || (c.gf - c.ga);
                c.played = c.played || 0;
                c.budget = c.budget || 0;
                c.teamRating = c.teamRating || 0;
                return c;
            });
            
            // Assign players to teams - FIXED: ensure salary is preserved
            rawPlayers.forEach(player => {
                const p = { ...player };
                p.clubId = p.clubId ? String(p.clubId) : null;
                
                // FIXED: Ensure salary exists on loaded players
                if (!p.salary && p.rating) {
                    p.salary = calculatePlayerSalary(p);
                }
                
                if (p.clubId && p.clubId !== 'null') {
                    const team = STATE.allTeams.find(t => t.id === p.clubId);
                    if (team) {
                        team.squad.push(p);
                    }
                }
            });
        }
        
        // Восстанавливаем activeLeagueTeams
        const userTeam = getTeam(STATE.userTeamId);
        if (userTeam) {
            STATE.userLeagueId = String(userTeam.leagueId);
            STATE.activeLeagueTeams = STATE.allTeams.filter(t => String(t.leagueId) === STATE.userLeagueId);
        }
        
        // Пересчитываем рейтинги команд
        STATE.allTeams.forEach(team => {
            if (team.id === STATE.userTeamId) {
                updateTeamStartersFromSlots(team);
            } else {
                if (!team.squad.some(p => p.isStarter)) autoSelectStarters(team);
            }
            calculateTeamRating(team);
        });
        
        // Проверяем календарь
        if (!STATE.calendar.weeks || STATE.calendar.weeks.length === 0) {
            console.log("Calendar empty, rebuilding...");
            if (!STATE.schedule || STATE.schedule.length === 0) initSchedule();
            if (!STATE.cups.leagueCup) initLeagueCup();
            initCalendar();
        }
        
        // Проверяем расписание
        if (!STATE.schedule || STATE.schedule.length === 0) {
            console.log("Schedule empty, rebuilding...");
            initSchedule();
        }
        
        console.log('Save loaded successfully, teams:', STATE.allTeams.length);

        // FIXED: Активируем режим карьеры и уведомляем моды о загрузке игры
        if (window.ModAPI) {
            // Устанавливаем режим карьеры СРАЗУ при загрузке сохранения
            window.ModAPI.setCareerMode(true);
            
            // Даём модам время на инициализацию перед вызовом gameLoad
            setTimeout(() => {
                window.ModAPI.trigger('gameLoad', { state: STATE });
                // Рендерим пункты меню модов
                window.ModAPI._renderCustomMenuItems();
            }, 150);
        }

        return true;
    } catch (e) {
        console.error('Error loading save data:', e);
        return false;
    }
}

// Сохранение в конкретный слот
async function saveToSlot(slotId) {
    try {
        const saveData = collectSaveData();
        saveData.currentSlotId = slotId;
        STATE.currentSlotId = slotId;
        
        const success = await StorageManager.set(`savegame_slot_${slotId}`, saveData);
        
        if (success) {
            closeSaveModal();
            addNews('Game Saved', `Game saved to Slot ${slotId}`, 'info');
            // Показываем уведомление
            showToast(`✅ Game saved to Slot ${slotId}`);
        } else {
            showToast(`❌ Error saving to Slot ${slotId}`, 'error');
        }
    } catch (e) {
        console.error('Save error:', e);
        showToast(`❌ Error: ${e.message}`, 'error');
    }
}

// Загрузка из конкретного слота
async function loadFromSlot(slotId) {
    try {
        const saveData = await StorageManager.get(`savegame_slot_${slotId}`);
        
        if (!saveData) {
            showToast(`❌ Slot ${slotId} is empty`, 'error');
            return;
        }
        
        const success = loadSaveData(saveData);
        
        if (success) {
            closeLoadModal();
            STATE.currentSlotId = slotId;
            
            // Show loading screen
            showLoadingScreen('Loading Career...');
            
            setTimeout(() => {
                // ИСПРАВЛЕНИЕ: Принудительно пересобираем календарь если нужно
                ensureCalendarReady();
                
                // ИСПРАВЛЕНИЕ: Preload logos после загрузки
                LogoManager.preloadLogos(STATE.allTeams).catch(e => console.warn('Logo preload failed:', e));
                
                setTimeout(() => {
                    hideLoadingScreen();
                    showToast(`✅ Game loaded from Slot ${slotId}`);
                    updateMobileMenuInfo();
                    renderDashboard();
                }, 500);
            }, 100);
        } else {
            showToast(`❌ Error loading from Slot ${slotId}`, 'error');
        }
    } catch (e) {
        console.error('Load error:', e);
        showToast(`❌ Error: ${e.message}`, 'error');
    }
}

// Удаление слота
        async function deleteSlot(slotId) {
    if (!confirm(`Are you sure you want to delete Slot ${slotId}?`)) return;
    
    try {
        await StorageManager.remove(`savegame_slot_${slotId}`);
        showToast(`🗑️ Slot ${slotId} deleted`);
        // Обновляем модалки если открыты
        closeSaveModal();
        closeLoadModal();
    } catch (e) {
        console.error('Delete error:', e);
        showToast(`❌ Error deleting slot`, 'error');
    }
}

// Быстрое сохранение (в последний использованный слот или слот 1)
async function saveGame() {
    const slotId = STATE.currentSlotId || 1;
    await saveToSlot(slotId);
}

// ========== MODS MENU v4.0 ==========
// Opens a full-screen menu for managing mods
function openModsMenu() {
    const mods = window.ModAPI?.mods || [];
    
    const modsList = mods.length > 0 ? mods.map(mod => `
        <div class="flex items-center justify-between p-4 rounded-xl bg-slate-800/60 border ${mod.enabled ? 'border-purple-500/30' : 'border-slate-700/50'} mb-3">
            <div class="flex items-center gap-3 flex-1 min-w-0">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center ${mod.enabled ? 'bg-purple-600' : 'bg-slate-700'} text-white font-black text-lg flex-shrink-0">
                    ${mod.modType === 'menu' ? '🏠' : '🎮'}
                </div>
                <div class="min-w-0">
                    <div class="text-white font-bold truncate">${mod.name || mod.id}</div>
                    <div class="text-slate-400 text-xs truncate">v${mod.version || '1.0.0'} by ${mod.author || 'Unknown'}</div>
                    <div class="text-slate-500 text-xs mt-1 truncate">${mod.description || 'No description'}</div>
                    <div class="text-xs mt-1 ${mod.modType === 'menu' ? 'text-cyan-400' : 'text-purple-400'}">
                        ${mod.modType === 'menu' ? '📱 Menu mod (active everywhere)' : '🎮 Career mod (active in career only)'}
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0 ml-4">
                <button onclick="toggleModFromMenu('${mod.id}', ${!mod.enabled})" 
                    class="px-4 py-2 rounded-lg ${mod.enabled ? 'bg-red-600/20 text-red-400 hover:bg-red-600/40' : 'bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600/40'} font-bold text-sm transition-colors">
                    ${mod.enabled ? 'Disable' : 'Enable'}
                </button>
                <button onclick="deleteModFromMenu('${mod.id}')" 
                    class="px-3 py-2 rounded-lg bg-slate-700/50 text-slate-400 hover:bg-red-600/30 hover:text-red-400 font-bold text-sm transition-colors">
                    🗑️
                </button>
            </div>
        </div>
    `).join('') : `
        <div class="text-center py-12">
            <div class="w-20 h-20 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <span class="text-4xl">🧩</span>
            </div>
            <h3 class="text-xl font-bold text-slate-400 mb-2">No Mods Installed</h3>
            <p class="text-sm text-slate-500 mb-6">Import a mod to extend the game!</p>
        </div>
    `;
    
    const modalHtml = `
    <div id="mods-menu-overlay" class="fixed inset-0 bg-black/95 z-[300] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 w-full max-w-2xl max-h-[90vh] overflow-hidden rounded-3xl border border-purple-500/30 shadow-2xl">
            <div class="sticky top-0 bg-gradient-to-r from-purple-900/50 to-slate-900 p-5 border-b border-purple-500/30 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-black text-white uppercase tracking-tight flex items-center gap-3">
                        <span class="text-purple-400">🧩</span> Mods Manager
                    </h2>
                    <p class="text-xs text-slate-400 mt-1">${mods.length} mod${mods.length !== 1 ? 's' : ''} installed</p>
                </div>
                <button onclick="closeModsMenu()" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-red-500/30 hover:text-red-400 flex items-center justify-center transition-all text-lg">✕</button>
            </div>
            
            <div class="p-4 overflow-y-auto max-h-[60vh]" id="mods-list-container">
                ${modsList}
            </div>
            
            <div class="p-4 border-t border-slate-700/50 bg-slate-900/50">
                <div class="flex gap-3">
                    <button onclick="importModDialog()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl transition-all">
                        📥 Import Mod
                    </button>
                    <button onclick="openModDocumentation()" class="px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl transition-all">
                        📖 API Docs
                    </button>
                </div>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeModsMenu() {
    const overlay = document.getElementById('mods-menu-overlay');
    if (overlay) overlay.remove();
}

function toggleModFromMenu(modId, enabled) {
    if (window.ModAPI) {
        window.ModAPI.toggleMod(modId, enabled);
        closeModsMenu();
        openModsMenu(); // Refresh
        showToast(enabled ? `✅ Mod enabled: ${modId}` : `❌ Mod disabled: ${modId}`);
    }
}

function deleteModFromMenu(modId) {
    if (!confirm(`Delete mod "${modId}"? This cannot be undone.`)) return;
    
    if (window.ModAPI) {
        window.ModAPI.unregisterMod(modId);
        window.ModAPI.saveMods();
        closeModsMenu();
        openModsMenu(); // Refresh
        showToast(`🗑️ Mod deleted: ${modId}`);
    }
}

function importModDialog() {
    const dialogHtml = `
    <div id="import-mod-dialog" class="fixed inset-0 bg-black/95 z-[400] flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-xl rounded-2xl border border-purple-500/30 shadow-2xl">
            <div class="p-5 border-b border-slate-700">
                <h3 class="text-xl font-black text-white">📥 Import Mod</h3>
                <p class="text-xs text-slate-400 mt-1">Paste mod code below or import from file</p>
            </div>
            <div class="p-4">
                <textarea id="mod-code-input" 
                    class="w-full h-64 bg-slate-800 text-white text-sm font-mono p-4 rounded-xl border border-slate-700 focus:border-purple-500 outline-none resize-none"
                    placeholder="// Paste mod code here...&#10;&#10;ModAPI.registerMod({&#10;  id: 'my-mod',&#10;  name: 'My Mod',&#10;  version: '1.0.0',&#10;  modType: 'career', // or 'menu'&#10;  init: function(api) {&#10;    // Your code here&#10;  }&#10;});"></textarea>
            </div>
            <div class="p-4 border-t border-slate-700 flex gap-3">
                <button onclick="submitModImport()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl transition-all">
                    Import Code
                </button>
                <button onclick="importModFromFile()" class="px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl transition-all">
                    📁 From File
                </button>
                <button onclick="closeImportDialog()" class="px-4 py-3 bg-slate-800 hover:bg-red-600/30 text-slate-400 hover:text-red-400 font-bold rounded-xl transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHtml);
}

function closeImportDialog() {
    const dialog = document.getElementById('import-mod-dialog');
    if (dialog) dialog.remove();
}

function submitModImport() {
    const codeInput = document.getElementById('mod-code-input');
    if (!codeInput) return;
    
    const code = codeInput.value.trim();
    if (!code) {
        showToast('❌ No code to import', 'error');
        return;
    }
    
    if (window.ModAPI && window.ModAPI.importMod(code)) {
        closeImportDialog();
        closeModsMenu();
        openModsMenu(); // Refresh
    }
}

function importModFromFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.js,.txt';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            const code = ev.target.result;
            if (window.ModAPI && window.ModAPI.importMod(code)) {
                closeImportDialog();
                closeModsMenu();
                openModsMenu(); // Refresh
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function openModDocumentation() {
    const docHtml = `
    <div id="mod-docs-dialog" class="fixed inset-0 bg-black/95 z-[400] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-slate-900 w-full max-w-3xl rounded-2xl border border-cyan-500/30 shadow-2xl my-4">
            <div class="p-5 border-b border-slate-700 flex justify-between items-center sticky top-0 bg-slate-900 rounded-t-2xl">
                <h3 class="text-xl font-black text-white">📖 ModAPI Documentation</h3>
                <button onclick="document.getElementById('mod-docs-dialog').remove()" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-red-500/30 hover:text-red-400 flex items-center justify-center">✕</button>
            </div>
            <div class="p-4 text-slate-300 text-sm max-h-[70vh] overflow-y-auto">
                <h4 class="font-bold text-white mb-2">Basic Mod Structure</h4>
                <pre class="bg-slate-800 p-3 rounded-lg text-xs mb-4 overflow-x-auto"><code>ModAPI.registerMod({
  id: 'my-unique-mod-id',
  name: 'My Mod Name',
  version: '1.0.0',
  author: 'Your Name',
  description: 'What your mod does',
  modType: 'career', // 'career' = active only in career, 'menu' = active everywhere
  
  init: function(api) {
    // Called when mod is first loaded
    console.log('Mod initialized!');
  },
  
  onEnable: function(api) {
    // Called when mod is enabled
  },
  
  onDisable: function(api) {
    // Called when mod is disabled
  }
});</code></pre>

                <h4 class="font-bold text-white mb-2">Adding Menu Items (creates sidebar button)</h4>
                <pre class="bg-slate-800 p-3 rounded-lg text-xs mb-4 overflow-x-auto"><code>api.addMenuItem({
  id: 'my-menu-btn',
  label: 'My Feature',
  icon: '🔧',
  onClick: function(api) {
    // Do something when clicked
  }
});</code></pre>

                <h4 class="font-bold text-white mb-2">Creating Custom Screens</h4>
                <pre class="bg-slate-800 p-3 rounded-lg text-xs mb-4 overflow-x-auto"><code>api.registerScreen('my-screen', {
  title: 'My Custom Screen',
  render: function(api) {
    return '&lt;h1&gt;Hello World!&lt;/h1&gt;';
  },
  onOpen: function(api) {},
  onClose: function(api) {}
});

// Then add a menu item to open it
api.addMenuItem({
  id: 'open-my-screen',
  label: 'Open Screen',
  screenId: 'my-screen'
});</code></pre>

                <h4 class="font-bold text-white mb-2">Useful API Methods</h4>
                <pre class="bg-slate-800 p-3 rounded-lg text-xs mb-4 overflow-x-auto"><code>// Get user's team
const team = api.getUserTeam();

// Get all teams
const allTeams = api.getAllTeams();

// Get players
const players = api.getAllPlayers();

// Show notification
api.showNotification('Hello!', 3000, 'success');

// Modify player stats
api.modifyPlayer(playerId, { rating: 90 });

// Add money to team
api.addBudget(teamId, 1000000);

// Listen to game events
api.on('matchEnd', function(data) {
  console.log('Match ended!', data);
});</code></pre>
            </div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', docHtml);
}

// ========== END MODS MENU ==========

// closeLoadModal is defined at the top of the script

// Закрыть модальное окно сохранения
function closeSaveModal() {
    const modal = document.getElementById('save-modal');
    if (modal) modal.remove();
}

// Открыть модальное окно загрузки
// Register this as the full implementation - УЛУЧШЕНО v2.1
_openLoadModalImpl = async function openLoadModalFull() {
    // Сначала закрываем старое окно если есть
    closeLoadModal();
    const modalHtml = `
    <div id="load-modal" class="fixed inset-0 bg-black/90 z-[300] flex items-center justify-center p-4 backdrop-blur-md animate-fadeIn">
        <div class="glass-panel bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 w-full max-w-lg max-h-[85vh] overflow-hidden rounded-3xl border border-slate-600/50 shadow-2xl">
            <div class="sticky top-0 bg-gradient-to-r from-slate-900 to-slate-800 p-5 border-b border-slate-700/50 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-black text-white uppercase tracking-tight">Load Career</h2>
                    <p class="text-xs text-slate-500 mt-1">Select a save slot to continue</p>
                </div>
                <button onclick="closeLoadModal()" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-red-500/30 hover:text-red-400 flex items-center justify-center transition-all text-lg">✕</button>
            </div>
            <div class="p-4 space-y-3 overflow-y-auto max-h-[60vh]" id="load-slots-list">
                <div class="text-center text-slate-400 py-8">
                    <div class="animate-spin w-8 h-8 border-2 border-slate-600 border-t-[#4caf50] rounded-full mx-auto mb-3"></div>
                    Loading save slots...
                </div>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const list = document.getElementById('load-slots-list');
    let html = '';
    let hasAnySave = false;

    for (let i = 1; i <= 15; i++) {
        const info = await getSlotInfo(i);
        const isCurrent = (STATE.currentSlotId === i) ? 'ring-2 ring-cyan-500 border-cyan-500/50' : 'border-slate-700/50';
        
        if (info.exists) {
            hasAnySave = true;
            const savedDate = info.date ? new Date(info.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Unknown';
            const savedTime = info.date ? new Date(info.date).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
            const weekProgress = info.totalWeeks ? Math.round((info.week / info.totalWeeks) * 100) : 0;
            const positionBadge = info.position ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold ${info.position <= 4 ? 'bg-emerald-500/20 text-emerald-400' : info.position <= 6 ? 'bg-blue-500/20 text-blue-400' : info.position >= 18 ? 'bg-red-500/20 text-red-400' : 'bg-slate-600/50 text-slate-400'}">#${info.position}</span>` : '';
            
            html += `
            <div class="group p-4 rounded-2xl border ${isCurrent} bg-slate-800/60 hover:bg-slate-700/60 transition-all cursor-pointer" onclick="loadFromSlot(${i})">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-slate-500 text-xs font-bold">SLOT ${i}</span>
                            ${STATE.currentSlotId === i ? '<span class="px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-[10px] font-bold rounded">CURRENT</span>' : ''}
                        </div>
                        <h3 class="text-lg font-black text-white truncate">${info.team}</h3>
                        <div class="flex items-center gap-2 mt-1 flex-wrap">
                            <span class="text-xs text-slate-400">${info.league || 'Unknown League'}</span>
                            ${positionBadge}
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <div class="text-2xl font-black text-[#4caf50]">S${info.season}</div>
                        <div class="text-xs text-slate-500">Week ${info.week || 1}</div>
                    </div>
                </div>
                
                <!-- Progress bar -->
                <div class="mt-3 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-[#4caf50] to-emerald-400 transition-all" style="width: ${weekProgress}%"></div>
                </div>
                
                <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-700/50">
                    <div class="text-[10px] text-slate-500">
                        <span>${savedDate}</span>
                        ${savedTime ? `<span class="mx-1">•</span><span>${savedTime}</span>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="event.stopPropagation(); loadFromSlot(${i})" class="text-xs bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-2 px-4 rounded-lg transition-all shadow-lg shadow-[#4caf50]/20">
                            LOAD
                        </button>
                        <button onclick="event.stopPropagation(); deleteSlot(${i}); openLoadModal();" class="text-xs bg-slate-700 hover:bg-red-600 text-slate-400 hover:text-white font-bold py-2 px-3 rounded-lg transition-all">
                            🗑️
                        </button>
                    </div>
                </div>
            </div>`;
        } else {
            html += `
            <div class="p-4 rounded-2xl border border-slate-800/50 bg-slate-800/30 opacity-60">
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-slate-600 text-xs font-bold">SLOT ${i}</span>
                        <div class="text-slate-600 text-sm mt-1">Empty</div>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center">
                        <span class="text-slate-600">—</span>
                    </div>
                </div>
            </div>`;
        }
    }
    
    if (!hasAnySave) {
        html = `
        <div class="text-center py-12">
            <div class="w-20 h-20 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <span class="text-4xl">📂</span>
            </div>
            <h3 class="text-xl font-bold text-slate-400 mb-2">No Saved Careers</h3>
            <p class="text-sm text-slate-500 mb-6">Start a new career to create your first save</p>
            <button onclick="closeLoadModal(); startNewGameFromMenu();" class="bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 px-6 rounded-xl transition-all">
                Start New Career
            </button>
        </div>`;
    }
    
    list.innerHTML = html;
};
_openLoadModalReady = true;

// Экспорт сохранения в файл (для бэкапа)
async function exportSave(slotId) {
    const saveData = await StorageManager.get(`savegame_slot_${slotId}`);
    if (!saveData) {
        showToast('Slot is empty', 'error');
        return;
    }
    
    const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `profm_save_slot${slotId}_s${saveData.season}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast(`📁 Save exported to file`);
}

// Импорт сохранения из файла
async function importSave(slotId, file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const saveData = JSON.parse(e.target.result);
                saveData.currentSlotId = slotId;
                
                const success = await StorageManager.set(`savegame_slot_${slotId}`, saveData);
                if (success) {
                    showToast(`📥 Save imported to Slot ${slotId}`);
                    resolve(true);
                } else {
                    reject(new Error('Failed to save imported data'));
                }
            } catch (err) {
                reject(err);
            }
        };
        reader.onerror = () => reject(reader.error);
        reader.readAsText(file);
    });
}

// Простое уведомление Toast
function showToast(message, type = 'success') {
    // Удаляем старый toast если есть
    const existingToast = document.getElementById('game-toast');
    if (existingToast) existingToast.remove();
    
    const bgColor = type === 'error' ? 'bg-red-600' : 'bg-[#4caf50]';
    const toastHtml = `
    <div id="game-toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-[200] font-bold text-sm transition-all animate-pulse">
        ${message}
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    
    setTimeout(() => {
        const toast = document.getElementById('game-toast');
        if (toast) toast.remove();
    }, 3000);
}

// Автосохранение (опционально, можно вызывать периодически)
let autoSaveInterval = null;

function enableAutoSave(intervalMinutes = 5) {
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    
    autoSaveInterval = setInterval(async () => {
        if (STATE.loaded && STATE.currentSlotId) {
            await saveToSlot(STATE.currentSlotId);
            console.log('Auto-saved to slot', STATE.currentSlotId);
        }
    }, intervalMinutes * 60 * 1000);
}

function disableAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
    }
}

// ========== END SAVE/LOAD SYSTEM ==========

        // Расчёт репутации клуба (0-100)
        function getClubReputation(team) {
            if (!team) return 30;
            
            const { division } = getLeagueInfo(team);
            const clubStrength = getClubStrength(team);
            const clubBudget = getClubBudget(team);
            
            // Базовая репутация от дивизиона
            let baseRep = 70; // div 1
            if (division === 2) baseRep = 55;
            else if (division === 3) baseRep = 40;
            else if (division === 4) baseRep = 30;
            else if (division >= 5) baseRep = 25;
            
            // Бонус от силы состава
            const strengthBonus = (clubStrength - 70) * 1.2;
            
            // Бонус от бюджета (логарифмический)
            const budgetBonus = Math.log10(Math.max(1, clubBudget)) * 4;
            
            // Финальная репутация
            let reputation = baseRep + strengthBonus + budgetBonus;
            
            // Clamp 0-100
            return Math.max(0, Math.min(100, Math.round(reputation)));
        }
        
        // Минимальная репутация для привлечения игрока определённого рейтинга
        function getRequiredReputation(playerRating) {
            if (playerRating >= 90) return 85;
            if (playerRating >= 85) return 75;
            if (playerRating >= 80) return 60;
            if (playerRating >= 75) return 45;
            return 0;
        }
        
        // Calculate player salary based on rating, age, position and other factors
        function calculatePlayerSalary(player) {
            // Base salary from rating (exponential growth)
            const base = Math.pow(player.rating, 2.5) * 15;
            
            // Age factor: young talents and prime age get more
            let ageFactor = 1.0;
            if (player.age < 21) ageFactor = 0.7; // Youth players earn less
            else if (player.age < 24) ageFactor = 1.1; // Rising stars
            else if (player.age >= 24 && player.age <= 28) ageFactor = 1.3; // Prime years
            else if (player.age > 28 && player.age <= 32) ageFactor = 1.1; // Experienced
            else if (player.age > 32) ageFactor = 0.7; // Veterans earn less
            
            // Position factor: attackers earn more
            const posFactor = (player.pos === 'ST' || player.pos === 'CF' || player.pos === 'LW' || player.pos === 'RW') ? 1.2 :
                            (player.pos === 'CAM' || player.pos === 'CM') ? 1.1 :
                            (player.pos === 'GK') ? 1.05 : 1.0;
            
            return Math.round(base * ageFactor * posFactor);
        }

        // Check transfer feasibility
        function checkTransferFeasibility(player, buyingTeam) {
            const result = {
                canBuy: true,
                reasons: [],
                upsetChance: 0
            };
            
            const playerRating = player.rating || 50;
            const playerValue = player.price || 0;
            const clubBudget = getClubBudget(buyingTeam);
            const clubReputation = getClubReputation(buyingTeam);
            const requiredRep = getRequiredReputation(playerRating);
            const clubStrength = getClubStrength(buyingTeam);
            
            // Board check: Player value vs budget
            if (playerValue > clubBudget) {
                result.canBuy = false;
                result.reasons.push({ type: 'FINANCIAL', message: "Not enough budget for transfer fee." });
            }

            // Sporting check
            if (playerRating > clubStrength + 10) {
                result.canBuy = false;
                result.reasons.push({ type: 'SPORTING', message: "Club level too low for player's ambition." });
            }
            
            // Reputation check
            if (clubReputation < requiredRep - 10) {
                result.canBuy = false;
                result.reasons.push({ type: 'REPUTATION', message: "Club reputation is too low." });
            }
            
            return result;
        }

        // New Transfer System: Club & Player Negotiation
        let negotiationState = {
            step: 'club', // 'club' or 'player'
            player: null,
            fromTeam: null,
            userTeam: null,
            offerFee: 0,
            offerSalary: 0
        };

        function startNegotiation(internalId) {
            let player = null;
            let fromTeam = null;
            
            for(const t of STATE.allTeams) {
                const p = t.squad.find(pl => pl.internalId === internalId);
                if (p) { player = p; fromTeam = t; break; }
            }
            
            if (!player || fromTeam.id === STATE.userTeamId) return;
            
            const userTeam = getTeam(STATE.userTeamId);
            const feasibility = checkTransferFeasibility(player, userTeam);
            
            if (!feasibility.canBuy) {
                alert(feasibility.reasons.map(r => r.message).join('\n'));
                return;
            }

            negotiationState = {
                step: 'club',
                player: player,
                fromTeam: fromTeam,
                userTeam: userTeam,
                offerFee: player.price,
                offerSalary: calculatePlayerSalary(player)
            };
            
            renderNegotiationModal();
        }

        function renderNegotiationModal() {
            const modal = document.getElementById('transfer-confirm-overlay');
            const contentContainer = document.getElementById('tc-transfer-info'); // Use existing info container
            const p = negotiationState.player;
            const club = negotiationState.fromTeam;
            
            // Clear existing buttons and set up our custom UI
            document.getElementById('tc-player-name').textContent = p.name;
            document.getElementById('tc-player-pos').textContent = p.pos;
            document.getElementById('tc-player-rating').textContent = p.rating;
            document.getElementById('tc-transfer-fee').textContent = '- ' + formatMoney(p.price);
            
            let content = '';
            if (negotiationState.step === 'club') {
                content = `
                    <div class="negotiation-step active mt-4 p-4 bg-slate-800/30 rounded-xl border border-white/5">
                        <h3 class="text-sm font-black text-white mb-3 uppercase tracking-wider">Club Negotiation</h3>
                        <div class="flex items-center gap-3 mb-4">
                            ${renderTeamLogo(club, 'sm')}
                            <div class="text-xs text-slate-300 font-bold">${club.name}</div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase font-bold mb-1 block">Offer Fee</label>
                                <div class="flex items-center gap-3">
                                    <input type="range" min="${Math.round(p.price * 0.7)}" max="${Math.round(p.price * 1.5)}" step="100000" 
                                        value="${negotiationState.offerFee}" 
                                        oninput="updateNegotiationFee(this.value)"
                                        class="flex-1 accent-emerald-500 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                    <span class="text-emerald-400 font-bold text-xs w-20 text-right fee-display">${formatMoney(negotiationState.offerFee)}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="submitClubOffer()" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-500 text-white font-black py-2 rounded-lg uppercase tracking-wider text-xs">Submit Offer to Club</button>
                    </div>
                `;
            } else {
                content = `
                    <div class="negotiation-step active mt-4 p-4 bg-slate-800/30 rounded-xl border border-white/5">
                        <h3 class="text-sm font-black text-white mb-3 uppercase tracking-wider">Player Contract</h3>
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 rounded-full overflow-hidden bg-slate-700">
                                <img src="Datapack/Face/default.png" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150'">
                            </div>
                            <div class="text-xs text-slate-300 font-bold">${p.name}</div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase font-bold mb-1 block">Weekly Salary</label>
                                <div class="flex items-center gap-3">
                                    <input type="range" min="${Math.round(negotiationState.offerSalary * 0.8)}" max="${Math.round(negotiationState.offerSalary * 2)}" step="500" 
                                        value="${negotiationState.offerSalary}" 
                                        oninput="updateNegotiationSalary(this.value)"
                                        class="flex-1 accent-blue-500 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                    <span class="text-blue-400 font-bold text-xs w-20 text-right salary-display">${formatMoney(negotiationState.offerSalary)}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="submitPlayerOffer()" class="w-full mt-4 bg-blue-600 hover:bg-blue-500 text-white font-black py-2 rounded-lg uppercase tracking-wider text-xs">Sign Contract</button>
                    </div>
                `;
            }
            
            contentContainer.innerHTML = content;
            // Hide the default confirm button since we use our own steps
            const defaultConfirmBtn = document.getElementById('btn-confirm-transfer');
            if (defaultConfirmBtn) defaultConfirmBtn.style.display = 'none';
            
            modal.classList.remove('hidden');
        }

        function updateNegotiationFee(val) {
            negotiationState.offerFee = parseInt(val);
            const el = document.querySelector('.fee-display');
            if (el) el.textContent = formatMoney(negotiationState.offerFee);
        }

        function updateNegotiationSalary(val) {
            negotiationState.offerSalary = parseInt(val);
            const el = document.querySelector('.salary-display');
            if (el) el.textContent = formatMoney(negotiationState.offerSalary);
        }



        function submitClubOffer() {
            const p = negotiationState.player;
            const chance = negotiationState.offerFee >= p.price ? 0.9 : (negotiationState.offerFee / p.price);
            
            if (Math.random() < chance) {
                negotiationState.step = 'player';
                renderNegotiationModal();
            } else {
                alert(`${negotiationState.fromTeam.name} rejected your offer!`);
                closeTransferModal();
            }
        }

        function submitPlayerOffer() {
            const p = negotiationState.player;
            const expectedSalary = calculatePlayerSalary(p);
            const chance = negotiationState.offerSalary >= expectedSalary ? 0.95 : (negotiationState.offerSalary / expectedSalary);
            
            if (Math.random() < chance) {
                completeNegotiation();
            } else {
                alert(`${p.name} is not happy with the terms and rejected the contract!`);
                closeTransferModal();
            }
        }

        function completeNegotiation() {
            const { player, fromTeam, userTeam, offerFee, offerSalary } = negotiationState;
            
            // Deduct fee and transfer player
            transferPlayer(player, fromTeam, userTeam, offerFee);
            
            // Update player's new contract details
            player.salary = offerSalary;
            player.endContract = STATE.season + 3; // 3 year contract
            
            addNews('Transfer News', `${player.name} joined ${userTeam.name} from ${fromTeam.name} for ${formatMoney(offerFee)}`, 'transfer');
            closeTransferModal();
            showSigningReveal(player);
            renderDashboard();
            saveGame();
        }

        // ========== ENHANCED TRANSFER SYSTEM ==========
        
        // Transfer negotiation state
        let contactClubState = {
            player: null,
            fromTeam: null,
            userTeam: null,
            transferType: null, // 'permanent' or 'loan'
            offerFee: 0,
            offerSalary: 0,
            loanDuration: 1, // years
            loanSalaryPercent: 50, // percentage of salary paid by loaning club
            clubAskingPrice: 0,
            clubMinPrice: 0,
            clubMaxPrice: 0,
            playerMinSalary: 0,
            playerImportance: 0, // 0-1, how important player is to selling club
            teamPrestigeDiff: 0 // difference in team ratings
        };
        
        // Calculate player importance to their club
        function calculatePlayerImportance(player, team) {
            const squadRatings = team.squad.map(p => p.rating).sort((a, b) => b - a);
            const avgTopPlayers = squadRatings.slice(0, 11).reduce((a, b) => a + b, 0) / 11;
            
            // How much better is this player than team average?
            const relativeQuality = player.rating / avgTopPlayers;
            
            // Is player a starter?
            const isStarter = player.isStarter ? 1.5 : 1.0;
            
            // Age factor - young talents are more valuable
            const ageFactor = player.age < 24 ? 1.3 : (player.age > 30 ? 0.7 : 1.0);
            
            // Position importance - attackers and GK are harder to replace
            const posFactor = (player.pos === 'ST' || player.pos === 'GK') ? 1.2 : 1.0;
            
            const importance = Math.min(1.0, (relativeQuality * isStarter * ageFactor * posFactor - 0.8) / 0.5);
            return Math.max(0, importance);
        }
        
        // Open contact club menu
        window.openContactClubMenu = function(internalId) {
            let player = null;
            let fromTeam = null;
            
            for(const t of STATE.allTeams) {
                const p = t.squad.find(pl => pl.internalId === internalId);
                if (p) { player = p; fromTeam = t; break; }
            }
            
            if (!player || fromTeam.id === STATE.userTeamId) return;
            
            const userTeam = getTeam(STATE.userTeamId);
            const feasibility = checkTransferFeasibility(player, userTeam);
            
            if (!feasibility.canBuy) {
                alert(feasibility.reasons.map(r => r.message).join('\n'));
                return;
            }
            
            // Calculate player importance
            const importance = calculatePlayerImportance(player, fromTeam);
            
            // Calculate asking price based on importance
            const basePrice = player.price;
            const importanceFactor = 1 + (importance * 0.8); // 0-80% markup for important players
            const clubAskingPrice = Math.round(basePrice * importanceFactor);
            const clubMinPrice = Math.round(basePrice * 0.6); // Will accept 60% minimum
            const clubMaxPrice = Math.round(basePrice * 1.8); // Can ask up to 180%
            
            // Team prestige difference
            const prestigeDiff = userTeam.teamRating - fromTeam.teamRating;
            
            contactClubState = {
                player: player,
                fromTeam: fromTeam,
                userTeam: userTeam,
                transferType: null,
                offerFee: clubAskingPrice,
                offerSalary: calculatePlayerSalary(player),
                loanDuration: 1,
                loanSalaryPercent: 50,
                clubAskingPrice: clubAskingPrice,
                clubMinPrice: clubMinPrice,
                clubMaxPrice: clubMaxPrice,
                playerMinSalary: calculatePlayerSalary(player),
                playerImportance: importance,
                teamPrestigeDiff: prestigeDiff
            };
            
            renderContactClubMenu();
        }
        
        // Render the contact club menu
        // ИСПРАВЛЕНО: Реализация функции renderContactClubMenu
        function renderContactClubMenu() {
            const overlay = document.getElementById('contact-club-overlay');
            const playerCard = document.getElementById('ccm-player-card');
            const p = contactClubState.player;
            const club = contactClubState.fromTeam;
            const userTeam = contactClubState.userTeam;
            
            if (!p || !club || !userTeam) {
                console.error('Contact Club: Missing data!', {p, club, userTeam});
                return;
            }
            
            // Показываем overlay
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';
            
            // Рендерим карточку игрока
            playerCard.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <div class="w-20 h-20 rounded-full bg-slate-700 overflow-hidden border-2 border-white/10">
                            ${window.getPlayerFaceHTML(p.internalId || p.id, 'w-full h-full object-cover')}
                        </div>
                        <div class="absolute -bottom-1 -right-1 bg-[#4caf50] text-white text-xs font-black px-2 py-1 rounded-full shadow-lg">
                            ${p.rating}
                        </div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-white font-black text-xl mb-1">${p.name}</h3>
                        <div class="text-slate-400 text-sm flex items-center gap-3">
                            <span class="px-2 py-1 bg-slate-800 rounded text-xs">${p.pos}</span>
                            <span>${p.age} лет</span>
                            <span>•</span>
                            <span>${p.nation || 'INT'}</span>
                        </div>
                        <div class="mt-2 flex items-center gap-2">
                            ${renderTeamLogo(club, 'xs')}
                            <span class="text-slate-300 text-sm">${club.name}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-slate-500 text-xs">Стоимость</div>
                        <div class="text-white font-black text-lg">${formatMoney(p.price || p.value || 1000000)}</div>
                    </div>
                </div>
            `;
            
            // Показываем только первый шаг
            document.getElementById('ccm-step-type').classList.remove('hidden');
            document.getElementById('ccm-step-type').style.display = 'block';
            document.getElementById('ccm-step-club').classList.add('hidden');
            document.getElementById('ccm-step-club').style.display = 'none';
            document.getElementById('ccm-step-player').classList.add('hidden');
            document.getElementById('ccm-step-player').style.display = 'none';
            document.getElementById('ccm-step-summary').classList.add('hidden');
            document.getElementById('ccm-step-summary').style.display = 'none';
            
            console.log('Contact Club menu rendered');
        }

        // ИСПРАВЛЕНО: Функция для рендера переговоров с клубом
        function renderClubNegotiation() {
            const container = document.getElementById('ccm-club-negotiation-box');
            const p = contactClubState.player;
            const club = contactClubState.fromTeam;
            const type = contactClubState.transferType;
            
            if (!container || !p || !club) {
                console.error('Club negotiation: missing elements or data');
                return;
            }
            
            if (type === 'permanent') {
                container.innerHTML = `
                    <div class="bg-slate-900/50 rounded-lg p-4 mb-4 border border-slate-700">
                        <div class="flex items-center justify-between mb-3">
                            ${renderTeamLogo(club, 'sm')}
                            <div class="text-right">
                                <div class="text-slate-400 text-xs">Переговоры</div>
                                <div class="text-white font-bold">Постоянный трансфер</div>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Стоимость игрока</span>
                                <span class="text-white font-bold">${formatMoney(p.price || p.value)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Ваш бюджет</span>
                                <span class="text-blue-400 font-bold">${formatMoney(contactClubState.userTeam.budget)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-slate-400 text-sm font-bold mb-2 block">Ваше предложение</label>
                            <div class="flex items-center gap-4">
                                <input type="range" 
                                    min="${Math.round((p.price || p.value) * 0.7)}" 
                                    max="${Math.min(Math.round((p.price || p.value) * 1.5), contactClubState.userTeam.budget)}" 
                                    step="100000" 
                                    value="${contactClubState.offerFee}" 
                                    oninput="updateClubOffer(this.value)"
                                    class="flex-1 accent-emerald-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                <span id="club-offer-display" class="text-emerald-400 font-black text-xl w-32 text-right">${formatMoney(contactClubState.offerFee)}</span>
                            </div>
                            <div class="mt-2 flex justify-between text-xs text-slate-500">
                                <span>Мин: ${formatMoney(Math.round((p.price || p.value) * 0.7))}</span>
                                <span>Макс: ${formatMoney(Math.min(Math.round((p.price || p.value) * 1.5), contactClubState.userTeam.budget))}</span>
                            </div>
                        </div>
                        
                        <div id="club-response" class="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                            <div class="text-slate-400 text-sm">Настройте предложение и отправьте клубу</div>
                        </div>
                        
                        <button onclick="submitClubOfferNew()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black py-3 rounded-lg uppercase tracking-wider text-sm transition-all">
                            Отправить предложение в ${club.name}
                        </button>
                    </div>
                `;
            } else {
                // Код для аренды
                container.innerHTML = `
                    <div class="bg-slate-900/50 rounded-lg p-4 mb-4 border border-slate-700">
                        <div class="flex items-center justify-between mb-3">
                            ${renderTeamLogo(club, 'sm')}
                            <div class="text-right">
                                <div class="text-slate-400 text-xs">Переговоры</div>
                                <div class="text-white font-bold">Аренда</div>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Зарплата игрока</span>
                                <span class="text-white font-bold">${formatMoney(contactClubState.playerMinSalary)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-slate-400 text-sm font-bold mb-2 block">Срок аренды</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="setLoanDuration(1)" class="loan-dur-btn py-3 rounded-lg font-bold transition-all ${contactClubState.loanDuration === 1 ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}">
                                    1 год
                                </button>
                                <button onclick="setLoanDuration(2)" class="loan-dur-btn py-3 rounded-lg font-bold transition-all ${contactClubState.loanDuration === 2 ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}">
                                    2 года
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-slate-400 text-sm font-bold mb-2 block">Процент зарплаты (%)</label>
                            <div class="flex items-center gap-4">
                                <input type="range" 
                                    min="30" 
                                    max="100" 
                                    step="10" 
                                    value="${contactClubState.loanSalaryPercent}" 
                                    oninput="updateLoanSalary(this.value)"
                                    class="flex-1 accent-blue-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                <span id="loan-salary-display" class="text-blue-400 font-black text-xl w-24 text-right">${contactClubState.loanSalaryPercent}%</span>
                            </div>
                            <div class="mt-2 text-xs text-slate-400">
                                Вы платите: ${formatMoney(Math.round(contactClubState.playerMinSalary * contactClubState.loanSalaryPercent / 100))} в неделю
                            </div>
                        </div>
                        
                        <div id="loan-response" class="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                            <div class="text-slate-400 text-sm">Настройте условия аренды</div>
                        </div>
                        
                        <button onclick="submitLoanOffer()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-3 rounded-lg uppercase tracking-wider text-sm transition-all">
                            Предложить аренду в ${club.name}
                        </button>
                    </div>
                `;
            }
        }

        // ИСПРАВЛЕНО: Функция для рендера переговоров с игроком
        function renderPlayerNegotiation() {
            const container = document.getElementById('ccm-player-negotiation-box');
            const p = contactClubState.player;
            
            if (!container || !p) {
                console.error('Player negotiation: missing elements or data');
                return;
            }
            
            container.innerHTML = `
                <div class="bg-slate-900/50 rounded-lg p-4 mb-4 border border-slate-700">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-white font-bold text-xl">
                            ${p.rating}
                        </div>
                        <div>
                            <div class="text-white font-bold">${p.name}</div>
                            <div class="text-slate-400 text-xs">${p.pos} • ${p.age} лет</div>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Текущая зарплата</span>
                            <span class="text-white font-bold">${formatMoney(p.salary || contactClubState.playerMinSalary)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-slate-400 text-sm font-bold mb-2 block">Предложите зарплату</label>
                        <div class="flex items-center gap-4">
                            <input type="range" 
                                min="${Math.round(contactClubState.playerMinSalary * 0.8)}" 
                                max="${Math.round(contactClubState.playerMinSalary * 2)}" 
                                step="1000" 
                                value="${contactClubState.offerSalary}" 
                                oninput="updatePlayerSalary(this.value)"
                                class="flex-1 accent-blue-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            <span id="player-salary-display" class="text-blue-400 font-black text-xl w-32 text-right">${formatMoney(contactClubState.offerSalary)}</span>
                        </div>
                        <div class="mt-2 flex justify-between text-xs text-slate-500">
                            <span>Мин: ${formatMoney(Math.round(contactClubState.playerMinSalary * 0.8))}</span>
                            <span>Ожидает: ${formatMoney(contactClubState.playerMinSalary)}</span>
                        </div>
                    </div>
                    
                    <div id="player-response" class="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                        <div class="text-slate-400 text-sm">Настройте зарплату и предложите контракт</div>
                    </div>
                    
                    <button onclick="submitPlayerContract()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-3 rounded-lg uppercase tracking-wider text-sm transition-all">
                        Предложить контракт ${p.name}
                    </button>
                </div>
            `;
        }
        function renderContactClubMenu() {
            const overlay = document.getElementById('contact-club-overlay');
            const playerCard = document.getElementById('ccm-player-card');
            const p = contactClubState.player;
            const club = contactClubState.fromTeam;
            
            // Render player card
            const getRatingBg = (r) => r >= 85 ? 'bg-gradient-to-br from-yellow-500 to-yellow-600' : 
                                       r >= 75 ? 'bg-gradient-to-br from-emerald-500 to-emerald-600' : 
                                       'bg-gradient-to-br from-slate-500 to-slate-600';
            
            playerCard.innerHTML = `
                <div class="flex items-center gap-6">
                    <div class="relative">
                        <div class="w-24 h-24 rounded-full ${getRatingBg(p.rating)} flex items-center justify-center text-white font-black shadow-2xl overflow-hidden">
                            ${window.getPlayerFaceHTML(p.internalId || p.id, 'w-full h-full object-cover')}
                        </div>
                        <div class="absolute -bottom-1 -right-1 ${getRatingBg(p.rating)} text-white text-xs font-black px-2 py-0.5 rounded-full shadow-lg border-2 border-slate-900">${p.rating}</div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-white font-black text-3xl mb-1">${p.name}</h3>
                        <div class="flex items-center gap-4 text-slate-400 text-sm">
                            <span>${p.pos}</span>
                            <span>•</span>
                            <span>${p.age} years old</span>
                            <span>•</span>
                            <span>${p.nation || 'INT'}</span>
                        </div>
                        <div class="mt-3 flex items-center gap-3">
                            ${renderTeamLogo(club, 'sm')}
                            <span class="text-slate-300 font-bold">${club.name}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-slate-500 text-xs uppercase mb-1">Market Value</div>
                        <div class="text-white font-black text-2xl">${formatMoney(p.price)}</div>
                        ${contactClubState.playerImportance > 0.5 ? `
                            <div class="mt-2 bg-red-500/20 border border-red-500/50 rounded px-2 py-1">
                                <span class="text-red-400 text-xs font-bold">⭐ Key Player</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Show step 1 (transfer type selection)
            document.getElementById('ccm-step-type').classList.remove('hidden');
            document.getElementById('ccm-step-type').style.display = 'block';
            document.getElementById('ccm-step-club').classList.add('hidden');
            document.getElementById('ccm-step-club').style.display = 'none';
            document.getElementById('ccm-step-player').classList.add('hidden');
            document.getElementById('ccm-step-player').style.display = 'none';
            document.getElementById('ccm-step-summary').classList.add('hidden');
            document.getElementById('ccm-step-summary').style.display = 'none';
            
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';
        }
        
        // Select transfer type - ИСПРАВЛЕНО: добавлен window. для глобального доступа
        window.selectTransferType = function(type) {
            contactClubState.transferType = type;
            
            // Hide step 1, show step 2
            document.getElementById('ccm-step-type').classList.add('hidden');
            document.getElementById('ccm-step-type').style.display = 'none';
            document.getElementById('ccm-step-club').classList.remove('hidden');
            document.getElementById('ccm-step-club').style.display = 'block';
            
            renderClubNegotiation();
        }
        
        // Render club negotiation step
        function renderClubNegotiation() {
            const container = document.getElementById('ccm-club-negotiation-box');
            const p = contactClubState.player;
            const club = contactClubState.fromTeam;
            const type = contactClubState.transferType;
            
            if (type === 'permanent') {
                const importance = contactClubState.playerImportance;
                const importanceText = importance > 0.7 ? 'Very Important - They will demand a premium!' :
                                      importance > 0.4 ? 'Important - They may ask for more than market value' :
                                      'Not Essential - They might accept a lower offer';
                
                container.innerHTML = `
                    <div class="bg-slate-900/50 rounded-lg p-4 mb-4 border border-slate-700">
                        <div class="flex items-center justify-between mb-3">
                            ${renderTeamLogo(club, 'sm')}
                            <div class="text-right">
                                <div class="text-slate-400 text-xs">Player Importance</div>
                                <div class="text-white font-bold">${importanceText}</div>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Market Value</span>
                                <span class="text-white font-bold">${formatMoney(p.price)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Club Asking Price</span>
                                <span class="text-emerald-400 font-bold">${formatMoney(contactClubState.clubAskingPrice)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Your Budget</span>
                                <span class="text-blue-400 font-bold">${formatMoney(contactClubState.userTeam.budget)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-slate-400 text-sm font-bold mb-2 block">Your Offer</label>
                            <div class="flex items-center gap-4">
                                <input type="range" 
                                    min="${contactClubState.clubMinPrice}" 
                                    max="${Math.min(contactClubState.clubMaxPrice, contactClubState.userTeam.budget)}" 
                                    step="50000" 
                                    value="${contactClubState.offerFee}" 
                                    oninput="updateClubOffer(this.value)"
                                    class="flex-1 accent-emerald-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                <span id="club-offer-display" class="text-emerald-400 font-black text-xl w-32 text-right">${formatMoney(contactClubState.offerFee)}</span>
                            </div>
                            <div class="mt-2 flex justify-between text-xs text-slate-500">
                                <span>Min: ${formatMoney(contactClubState.clubMinPrice)}</span>
                                <span>Max: ${formatMoney(Math.min(contactClubState.clubMaxPrice, contactClubState.userTeam.budget))}</span>
                            </div>
                        </div>
                        
                        <div id="club-response" class="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                            <div class="text-slate-400 text-sm">Adjust your offer and submit to see the club's response...</div>
                        </div>
                        
                        <button onclick="submitClubOfferNew()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 rounded-lg uppercase tracking-wider shadow-lg transform hover:scale-105 transition-all">
                            Submit Offer to ${club.name}
                        </button>
                    </div>
                `;
            } else { // loan
                container.innerHTML = `
                    <div class="bg-slate-900/50 rounded-lg p-4 mb-4 border border-slate-700">
                        <div class="flex items-center justify-between mb-3">
                            ${renderTeamLogo(club, 'sm')}
                            <div class="text-right">
                                <div class="text-slate-400 text-xs">Loan Deal</div>
                                <div class="text-white font-bold">Temporary Transfer</div>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Player Salary</span>
                                <span class="text-white font-bold">${formatMoney(p.salary || contactClubState.playerMinSalary)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-slate-400 text-sm font-bold mb-2 block">Loan Duration</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="setLoanDuration(1)" class="loan-duration-btn py-3 rounded-lg font-bold transition-all ${contactClubState.loanDuration === 1 ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}">
                                    1 Year
                                </button>
                                <button onclick="setLoanDuration(2)" class="loan-duration-btn py-3 rounded-lg font-bold transition-all ${contactClubState.loanDuration === 2 ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}">
                                    2 Years
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-slate-400 text-sm font-bold mb-2 block">Salary Contribution (%)</label>
                            <div class="flex items-center gap-4">
                                <input type="range" 
                                    min="30" 
                                    max="100" 
                                    step="10" 
                                    value="${contactClubState.loanSalaryPercent}" 
                                    oninput="updateLoanSalary(this.value)"
                                    class="flex-1 accent-blue-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                <span id="loan-salary-display" class="text-blue-400 font-black text-xl w-24 text-right">${contactClubState.loanSalaryPercent}%</span>
                            </div>
                            <div class="mt-2 text-xs text-slate-400">
                                You pay: ${formatMoney(Math.round((p.salary || contactClubState.playerMinSalary) * contactClubState.loanSalaryPercent / 100))} per week
                            </div>
                        </div>
                        
                        <div id="loan-response" class="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                            <div class="text-slate-400 text-sm">Configure loan terms and submit...</div>
                        </div>
                        
                        <button onclick="submitLoanOffer()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-lg uppercase tracking-wider shadow-lg transform hover:scale-105 transition-all">
                            Propose Loan to ${club.name}
                        </button>
                    </div>
                `;
            }
        }
        
        // Update club offer display - ИСПРАВЛЕНО: добавлен window.
        window.updateClubOffer = function(val) {
            contactClubState.offerFee = parseInt(val);
            const el = document.getElementById('club-offer-display');
            if (el) el.textContent = formatMoney(contactClubState.offerFee);
        }
        
        // Update loan salary display - ИСПРАВЛЕНО: добавлен window.
        window.updateLoanSalary = function(val) {
            contactClubState.loanSalaryPercent = parseInt(val);
            const el = document.getElementById('loan-salary-display');
            if (el) el.textContent = val + '%';
            
            const p = contactClubState.player;
            const salary = p.salary || contactClubState.playerMinSalary;
            const cost = Math.round(salary * val / 100);
            
            // Update cost display
            const costText = document.querySelector('#ccm-club-content .text-xs.text-slate-400');
            if (costText) costText.textContent = `You pay: ${formatMoney(cost)} per week`;
        }
        
        // Set loan duration - ИСПРАВЛЕНО: добавлен window.
        window.setLoanDuration = function(years) {
            contactClubState.loanDuration = years;
            renderClubNegotiation();
        }
        
        // Submit club offer (permanent transfer) - ИСПРАВЛЕНО: добавлен window.
        window.submitClubOfferNew = function() {
            const p = contactClubState.player;
            const club = contactClubState.fromTeam;
            const offer = contactClubState.offerFee;
            const asking = contactClubState.clubAskingPrice;
            const importance = contactClubState.playerImportance;
            
            // Calculate acceptance chance
            let baseChance = offer / asking;
            
            // Important players are harder to buy
            if (importance > 0.7) {
                baseChance *= 0.7;
            } else if (importance > 0.4) {
                baseChance *= 0.85;
            }
            
            // Random factor
            const roll = Math.random();
            const accepted = roll < baseChance;
            
            const responseDiv = document.getElementById('club-response');
            
            if (accepted) {
                responseDiv.innerHTML = `
                    <div class="text-emerald-400 font-bold text-center mb-2">✅ ${club.name} accepted your offer!</div>
                    <div class="text-slate-300 text-sm text-center">You can now negotiate contract terms with ${p.name}</div>
                `;
                
                // Move to player negotiation
                setTimeout(() => {
                    document.getElementById('ccm-step-club').classList.add('hidden');
                    document.getElementById('ccm-step-player').classList.remove('hidden');
                    document.getElementById('ccm-step-player').style.display = 'block';
                    renderPlayerNegotiation();
                }, 1500);
            } else {
                const diff = asking - offer;
                const diffPercent = Math.round((diff / asking) * 100);
                
                responseDiv.innerHTML = `
                    <div class="text-red-400 font-bold text-center mb-2">❌ ${club.name} rejected your offer!</div>
                    <div class="text-slate-300 text-sm text-center">
                        ${importance > 0.7 ? `${p.name} is crucial to their squad. They want at least ${formatMoney(Math.round(asking * 0.95))}.` :
                          importance > 0.4 ? `They're asking for ${formatMoney(asking)}. Your offer is ${diffPercent}% too low.` :
                          `Try offering closer to ${formatMoney(Math.round(asking * 0.85))}.`}
                    </div>
                `;
            }
        }
        
        // Submit loan offer - ИСПРАВЛЕНО: добавлен window.
        window.submitLoanOffer = function() {
            const p = contactClubState.player;
            const club = contactClubState.fromTeam;
            const salaryPercent = contactClubState.loanSalaryPercent;
            const duration = contactClubState.loanDuration;
            const importance = contactClubState.playerImportance;
            
            // Calculate acceptance chance
            let baseChance = salaryPercent / 100;
            
            // Important players are less likely to be loaned
            if (importance > 0.6) {
                baseChance *= 0.5; // Very hard to loan key players
            } else if (importance > 0.3) {
                baseChance *= 0.75;
            } else {
                baseChance *= 1.1; // More willing to loan fringe players
            }
            
            // Longer loans are more attractive
            if (duration === 2) baseChance *= 1.2;
            
            const accepted = Math.random() < baseChance;
            
            const responseDiv = document.getElementById('loan-response');
            
            if (accepted) {
                responseDiv.innerHTML = `
                    <div class="text-blue-400 font-bold text-center mb-2">✅ ${club.name} accepted the loan deal!</div>
                    <div class="text-slate-300 text-sm text-center">You can now negotiate contract terms with ${p.name}</div>
                `;
                
                // Move to player negotiation
                setTimeout(() => {
                    document.getElementById('ccm-step-club').classList.add('hidden');
                    document.getElementById('ccm-step-player').classList.remove('hidden');
                    document.getElementById('ccm-step-player').style.display = 'block';
                    renderPlayerNegotiation();
                }, 1500);
            } else {
                responseDiv.innerHTML = `
                    <div class="text-red-400 font-bold text-center mb-2">❌ ${club.name} rejected the loan!</div>
                    <div class="text-slate-300 text-sm text-center">
                        ${importance > 0.6 ? `${p.name} is too important to loan out.` :
                          salaryPercent < 70 ? `They want you to cover at least 70% of the salary.` :
                          `Try offering a longer loan period or higher salary contribution.`}
                    </div>
                `;
            }
        }
        
        // Render player negotiation step
        function renderPlayerNegotiation() {
            const container = document.getElementById('ccm-player-negotiation-box');
            const p = contactClubState.player;
            const userTeam = contactClubState.userTeam;
            const type = contactClubState.transferType;
            
            // Team prestige affects player willingness
            const prestigeDiff = contactClubState.teamPrestigeDiff;
            const prestigeText = prestigeDiff > 15 ? 'Your club is much stronger - player is eager to join!' :
                                prestigeDiff > 5 ? 'Your club has good reputation' :
                                prestigeDiff > -5 ? 'Similar level clubs' :
                                prestigeDiff > -15 ? 'Your club is weaker - player may be reluctant' :
                                'Your club is much weaker - player needs convincing!';
            
            const minSalary = contactClubState.playerMinSalary;
            const maxSalary = Math.round(minSalary * 2.5);
            
            container.innerHTML = `
                <div class="bg-slate-900/50 rounded-lg p-4 mb-4 border border-slate-700">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-white font-bold text-xl">
                            ${p.rating}
                        </div>
                        <div>
                            <div class="text-white font-bold">${p.name}</div>
                            <div class="text-slate-400 text-xs">${p.pos} • ${p.age} years</div>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Team Prestige</span>
                            <span class="text-white font-bold">${prestigeText}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Current Salary</span>
                            <span class="text-white font-bold">${formatMoney(p.salary || minSalary)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-slate-400 text-sm font-bold mb-2 block">Weekly Salary Offer</label>
                        <div class="flex items-center gap-4">
                            <input type="range" 
                                min="${Math.round(minSalary * 0.8)}" 
                                max="${maxSalary}" 
                                step="1000" 
                                value="${contactClubState.offerSalary}" 
                                oninput="updatePlayerSalary(this.value)"
                                class="flex-1 accent-blue-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            <span id="player-salary-display" class="text-blue-400 font-black text-xl w-32 text-right">${formatMoney(contactClubState.offerSalary)}</span>
                        </div>
                        <div class="mt-2 flex justify-between text-xs text-slate-500">
                            <span>Min: ${formatMoney(Math.round(minSalary * 0.8))}</span>
                            <span>Expected: ${formatMoney(minSalary)}</span>
                        </div>
                    </div>
                    
                    ${type === 'permanent' ? `
                        <div>
                            <label class="text-slate-400 text-sm font-bold mb-2 block">Contract Length</label>
                            <div class="grid grid-cols-3 gap-3">
                                <button onclick="setContractLength(2)" class="contract-length-btn py-3 rounded-lg font-bold transition-all bg-slate-700 text-slate-400 hover:bg-slate-600">
                                    2 Years
                                </button>
                                <button onclick="setContractLength(3)" class="contract-length-btn py-3 rounded-lg font-bold transition-all bg-blue-600 text-white">
                                    3 Years
                                </button>
                                <button onclick="setContractLength(4)" class="contract-length-btn py-3 rounded-lg font-bold transition-all bg-slate-700 text-slate-400 hover:bg-slate-600">
                                    4 Years
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div id="player-response" class="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                        <div class="text-slate-400 text-sm">Adjust your offer and submit to see the player's response...</div>
                    </div>
                    
                    <button onclick="submitPlayerContract()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-lg uppercase tracking-wider shadow-lg transform hover:scale-105 transition-all">
                        Offer Contract to ${p.name}
                    </button>
                </div>
            `;
        }
        
        // Update player salary display - ИСПРАВЛЕНО: добавлен window.
        window.updatePlayerSalary = function(val) {
            contactClubState.offerSalary = parseInt(val);
            const el = document.getElementById('player-salary-display');
            if (el) el.textContent = formatMoney(contactClubState.offerSalary);
        }
        
        // Set contract length - ИСПРАВЛЕНО: добавлен window.
        let selectedContractLength = 3;
        window.setContractLength = function(years) {
            selectedContractLength = years;
            // Update button styles
            const buttons = document.querySelectorAll('.contract-length-btn');
            buttons.forEach((btn, idx) => {
                const y = [2, 3, 4][idx];
                if (y === years) {
                    btn.className = 'contract-length-btn py-3 rounded-lg font-bold transition-all bg-blue-600 text-white';
                } else {
                    btn.className = 'contract-length-btn py-3 rounded-lg font-bold transition-all bg-slate-700 text-slate-400 hover:bg-slate-600';
                }
            });
        }
        
        // Submit player contract - ИСПРАВЛЕНО: добавлен window.
        window.submitPlayerContract = function() {
            const p = contactClubState.player;
            const offer = contactClubState.offerSalary;
            const expected = contactClubState.playerMinSalary;
            const prestigeDiff = contactClubState.teamPrestigeDiff;
            
            // Calculate acceptance chance
            let baseChance = offer / expected;
            
            // Prestige heavily influences acceptance
            if (prestigeDiff < -15) {
                // Much weaker team - player very reluctant
                baseChance *= 0.4;
            } else if (prestigeDiff < -5) {
                // Weaker team - player reluctant
                baseChance *= 0.7;
            } else if (prestigeDiff > 15) {
                // Much stronger team - player eager
                baseChance *= 1.3;
            } else if (prestigeDiff > 5) {
                // Stronger team - player interested
                baseChance *= 1.1;
            }
            
            // Age factor - young players more ambitious
            if (p.age < 24 && prestigeDiff < 0) {
                baseChance *= 0.8; // Young players want to play for better teams
            }
            
            const accepted = Math.random() < baseChance;
            
            const responseDiv = document.getElementById('player-response');
            
            if (accepted) {
                responseDiv.innerHTML = `
                    <div class="text-emerald-400 font-bold text-center mb-2">✅ ${p.name} accepted your contract offer!</div>
                    <div class="text-slate-300 text-sm text-center">Transfer complete!</div>
                `;
                
                // Complete the transfer
                setTimeout(() => {
                    completeContactClubTransfer();
                }, 1500);
            } else {
                let reason = '';
                if (prestigeDiff < -15) {
                    reason = `${p.name} wants to play for a stronger club. Money alone isn't enough.`;
                } else if (prestigeDiff < -5) {
                    reason = `${p.name} is not convinced by your club's level. Try offering significantly more.`;
                } else if (offer < expected * 0.9) {
                    reason = `Your salary offer is too low. ${p.name} expects at least ${formatMoney(Math.round(expected * 0.95))}.`;
                } else {
                    reason = `${p.name} rejected the offer. Try improving the terms.`;
                }
                
                responseDiv.innerHTML = `
                    <div class="text-red-400 font-bold text-center mb-2">❌ ${p.name} rejected your offer!</div>
                    <div class="text-slate-300 text-sm text-center">${reason}</div>
                `;
            }
        }
        
        // Complete the transfer
        function completeContactClubTransfer() {
            const { player, fromTeam, userTeam, transferType, offerFee, offerSalary, loanDuration, loanSalaryPercent } = contactClubState;
            
            if (transferType === 'permanent') {
                // Permanent transfer
                transferPlayer(player, fromTeam, userTeam, offerFee);
                player.salary = offerSalary;
                player.endContract = STATE.season + selectedContractLength;
                
                addNews('Transfer News', `${player.name} joined ${userTeam.name} from ${fromTeam.name} for ${formatMoney(offerFee)}`, 'transfer');
                
                // Show summary
                document.getElementById('ccm-step-player').classList.add('hidden');
                document.getElementById('ccm-step-summary').classList.remove('hidden');
                
                document.getElementById('ccm-summary-content').innerHTML = `
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">🎉</div>
                        <div class="text-white font-black text-2xl mb-2">${player.name}</div>
                        <div class="text-emerald-400 font-bold">Signed for ${userTeam.name}!</div>
                    </div>
                    <div class="bg-slate-900/50 rounded-lg p-4 space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Transfer Fee</span>
                            <span class="text-white font-bold">${formatMoney(offerFee)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Weekly Salary</span>
                            <span class="text-white font-bold">${formatMoney(offerSalary)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Contract Length</span>
                            <span class="text-white font-bold">${selectedContractLength} Years</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Contract Until</span>
                            <span class="text-white font-bold">${STATE.season + selectedContractLength}</span>
                        </div>
                    </div>
                `;
                
                showSigningReveal(player);
            } else {
                // Loan transfer
                const weeklyCost = Math.round((player.salary || offerSalary) * loanSalaryPercent / 100);
                
                // Mark player as on loan
                player.onLoan = true;
                player.loanParentClub = fromTeam.id;
                player.loanEndSeason = STATE.season + loanDuration;
                player.loanSalaryCost = weeklyCost;
                
                // Transfer player temporarily
                fromTeam.squad = fromTeam.squad.filter(p => p.internalId !== player.internalId);
                player.clubId = userTeam.id;
                player.isStarter = false;
                userTeam.squad.push(player);
                
                addNews('Transfer News', `${player.name} joined ${userTeam.name} on loan from ${fromTeam.name} (${loanDuration} year${loanDuration > 1 ? 's' : ''})`, 'transfer');
                
                // Show summary
                document.getElementById('ccm-step-player').classList.add('hidden');
                document.getElementById('ccm-step-summary').classList.remove('hidden');
                
                document.getElementById('ccm-summary-content').innerHTML = `
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">🤝</div>
                        <div class="text-white font-black text-2xl mb-2">${player.name}</div>
                        <div class="text-blue-400 font-bold">Joined on Loan!</div>
                    </div>
                    <div class="bg-slate-900/50 rounded-lg p-4 space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Loan Duration</span>
                            <span class="text-white font-bold">${loanDuration} Year${loanDuration > 1 ? 's' : ''}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Weekly Cost</span>
                            <span class="text-white font-bold">${formatMoney(weeklyCost)} (${loanSalaryPercent}%)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Loan Ends</span>
                            <span class="text-white font-bold">Season ${STATE.season + loanDuration}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Parent Club</span>
                            <span class="text-white font-bold">${fromTeam.name}</span>
                        </div>
                    </div>
                `;
            }
            
            saveGame();
        }
        
        // Close contact club menu
        window.closeContactClubMenu = function() {
            document.getElementById('contact-club-overlay').classList.add('hidden');
            contactClubState = {
                player: null,
                fromTeam: null,
                userTeam: null,
                transferType: null,
                offerFee: 0,
                offerSalary: 0,
                loanDuration: 1,
                loanSalaryPercent: 50,
                clubAskingPrice: 0,
                clubMinPrice: 0,
                clubMaxPrice: 0,
                playerMinSalary: 0,
                playerImportance: 0,
                teamPrestigeDiff: 0
            };
        }

        let pendingTransfer = null;
        let pendingTransferCheck = null; // Результат проверки трансфера

        const POS_PRIORITY = {
            'GK': 1,
            'LB': 2, 'RB': 2, 'CB': 2, 'DF': 2, 'DEF': 2, 'LWB': 2, 'RWB': 2,
            'CDM': 3, 'CM': 3, 'CAM': 3, 'LM': 3, 'RM': 3, 'MF': 3, 'MID': 3,
            'LW': 4, 'RW': 4, 'ST': 4, 'CF': 4, 'FW': 4, 'FWD': 4
        };

        const POS_SCORING_WEIGHT = {
            4: 15,
            3: 4,
            2: 1,
            1: 0
        };

        const BASE_INJURY_CHANCE = 0.02;
        const INJURY_REDUCTION = 0.05;
        const INJURY_CHANCE = Math.max(0, BASE_INJURY_CHANCE - INJURY_REDUCTION);

        // УДАЛЕНО: PRICE_GROWTH_PER_RATING - цены больше не растут экспоненциально

        // НОВОЕ: Функция расчёта бюджета из teamValue - делим на 10, минимум 50000
        function calculateBudget(teamValue) {
            const raw = Math.round(Number(teamValue || 500000) / 10);
            return Math.max(raw, 50000);
        }

        const RED_CARD_TEAM_PENALTY = 0.80;
        const RED_CARD_OPPONENT_BOOST = 1.10;

        const POTENTIAL_SYSTEM = {
            YOUNG_MAX_BOOST: 12,
            PRIME_MAX_BOOST: 6,
            MATURE_MAX_BOOST: 3,
            OLD_MAX_BOOST: 1,
            SUPERSTAR_THRESHOLD: 97,
            STAR_THRESHOLD: 95,
            GOOD_THRESHOLD: 90,
            REGULAR_THRESHOLD: 85,
            SUPERSTAR_CHANCE: 0.005,
            STAR_CHANCE: 0.02,
            GOOD_CHANCE: 0.1,
            YOUNG_GROWTH_RATE: 0.8,
            PRIME_GROWTH_RATE: 0.3,
            MATURE_GROWTH_RATE: 0.1,
            OLD_DECLINE_RATE: -0.3,
            VET_DECLINE_RATE: -0.8,
            STARTER_BOOST: 1.5,
            BENCH_PENALTY: 0.5,
            INJURY_DECLINE: -0.5,
            MIN_RATING: 40,
            MAX_RATING: 99,
            MIN_POTENTIAL: 50,
            OLD_DECLINE_CHANCE: 0.1,
            VET_DECLINE_CHANCE: 0.3
        };

        // ========== ПОЗИЦИИ: НОРМАЛИЗАЦИЯ И ГРУППЫ ==========
        function normalizePos(pos) {
            if (!pos) return "UNK";
            const normalized = pos.toUpperCase();
            // Нормализация только кодов
            if (normalized === "CD") return "CB";
            if (normalized === "DM") return "CDM";
            return normalized;
        }

        function posGroup(pos) {
            const normalized = normalizePos(pos);
            // GK группа
            if (normalized === "GK") return "GK";
            // DEF группа
            if (["CB", "LB", "RB", "LWB", "RWB", "DF", "DEF"].includes(normalized)) return "DEF";
            // MID группа
            if (["CDM", "CM", "CAM", "LM", "RM", "MF", "MID"].includes(normalized)) return "MID";
            // FWD группа
            if (["ST", "CF", "LW", "RW", "FW", "FWD"].includes(normalized)) return "FWD";
            return "UNK";
        }

        function getPosCategory(pos) {
            const group = posGroup(pos);
            const priorityMap = {
                'GK': 1,
                'DEF': 2,
                'MID': 3,
                'FWD': 4
            };
            return priorityMap[group] || 5;
        }

        function getPosColor(pos) {
            const cat = getPosCategory(pos);
            if (cat === 1) return 'text-yellow-500 bg-yellow-500';
            if (cat === 2) return 'text-blue-400 bg-blue-400';
            if (cat === 3) return 'text-emerald-400 bg-emerald-400';
            return 'text-red-400 bg-red-400';
        }

        // НОВАЯ ФУНКЦИЯ: Инициализация Кубка лиги
        function initLeagueCup() {
            if (!STATE.activeLeagueTeams || STATE.activeLeagueTeams.length < 2) return;
            
            const teams = [...STATE.activeLeagueTeams];
            // Перемешиваем команды
            for (let i = teams.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [teams[i], teams[j]] = [teams[j], teams[i]];
            }
            
            // Если нечетное количество, одна команда проходит автоматически
            let firstRoundFixtures = [];
            let byeTeam = null;
            
            if (teams.length % 2 !== 0) {
                byeTeam = teams.pop();
            }
            
            // Создаем пары для первого раунда
            for (let i = 0; i < teams.length; i += 2) {
                if (i + 1 < teams.length) {
                    firstRoundFixtures.push({
                        homeId: teams[i].id,
                        awayId: teams[i + 1].id,
                        played: false,
                        homeGoals: 0,
                        awayGoals: 0,
                        winnerId: null,
                        pensHome: 0,
                        pensAway: 0,
                        wentToPens: false
                    });
                }
            }
            
            STATE.cups.leagueCup = {
                id: "LEAGUE_CUP",
                name: "League Cup",
                season: STATE.season,
                status: "ongoing",
                currentRound: 0,
                rounds: [
                    {
                        name: "First Round",
                        fixtures: firstRoundFixtures,
                        byeTeam: byeTeam,
                        played: false
                    }
                ],
                championTeamId: null
            };
            
            // Если есть команда, проходящая автоматически, добавляем ее в следующий раунд
            if (byeTeam) {
                addNews('League Cup', `${byeTeam.name} receives a bye in the First Round`, 'info');
            }
        }

        // Функция для определения названия раунда кубка
        function getRoundName(teamsRemaining) {
            if (teamsRemaining <= 2) return "Final";
            if (teamsRemaining <= 4) return "Semi-Finals";
            if (teamsRemaining <= 8) return "Quarter-Finals";
            if (teamsRemaining <= 16) return "Round of 16";
            if (teamsRemaining <= 32) return "Round of 32";
            return "Round of " + teamsRemaining;
        }

        // ========== ЕВРОКУБКИ: ФУНКЦИИ ==========
        
        // НОВОЕ: Проверка на резервную ко��анду по названию
        function isReserveTeamName(name) {
            if (!name) return false;
            const lowerName = name.toLowerCase().trim();
            const suffixes = [' 2', ' ii', ' iii', ' b', ' u23', ' u-23', ' reserves', ' reserve', ' youth'];
            return suffixes.some(suffix => lowerName.endsWith(suffix));
        }
        
        // НОВОЕ: Получение базового имени команды (без суффикса резерва)
        function baseName(name) {
            if (!name) return '';
            let result = name.trim();
            const suffixes = [' 2', ' II', ' III', ' B', ' U23', ' U-23', ' Reserves', ' Reserve', ' Youth', 
                             ' ii', ' iii', ' b', ' u23', ' u-23', ' reserves', ' reserve', ' youth'];
            for (const suffix of suffixes) {
                if (result.endsWith(suffix)) {
                    result = result.slice(0, -suffix.length).trim();
                    break;
                }
            }
            return result;
        }
        
        // НОВОЕ: Дедупликация команд - оставляем только основные (по baseName + nation, выбираем с максимальным teamValue)
        function deduplicateTeams(teamsArray) {
            const grouped = new Map(); // key: baseName|nation -> array of teams
            
            teamsArray.forEach(team => {
                const league = STATE.leaguesMap.get(team.leagueId);
                const nation = league?.nation || 'INT';
                const base = baseName(team.name);
                const key = `${base.toLowerCase()}|${nation.toLowerCase()}`;
                
                if (!grouped.has(key)) {
                    grouped.set(key, []);
                }
                grouped.get(key).push(team);
            });
            
            const result = [];
            grouped.forEach(teams => {
                // Сортируем по teamValue (или teamRating если нет teamValue), выбираем первую (основную)
                teams.sort((a, b) => {
                    const valA = a.teamValue || a.teamRating || 0;
                    const valB = b.teamValue || b.teamRating || 0;
                    return valB - valA;
                });
                result.push(teams[0]);
            });
            
            return result;
        }
        
        // НОВОЕ: Фильтрация резервных команд из списка
        function filterReserveTeams(teamsArray) {
            return teamsArray.filter(t => !isReserveTeamName(t.name));
        }
        
        // Инициализация еврокубков (вызывается в конце сезона)
        function initEuropeanCompetitions() {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) return;
            
            const userNation = STATE.leaguesMap.get(userTeam.leagueId)?.nation || 'INT';
            
            // Собираем команды только из страны пользователя и дивизии 1
            const eligibleLeagues = [];
            STATE.leaguesMap.forEach((league, leagueId) => {
                if (league.nation === userNation && league.division === 1) {
                    eligibleLeagues.push(leagueId);
                }
            });
            
            // Получаем отсортированные команды из этих лиг
            let teamsFromDiv1 = STATE.allTeams
                .filter(t => eligibleLeagues.includes(t.leagueId))
                .sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
            
            // НОВОЕ: Фильтруем резервные команды и дедуплицируем
            teamsFromDiv1 = filterReserveTeams(teamsFromDiv1);
            teamsFromDiv1 = deduplicateTeams(teamsFromDiv1);
            // Пересортируем после дедупликации
            teamsFromDiv1.sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
            
            if (teamsFromDiv1.length < 7) {
                console.log("Not enough teams for European competitions");
                STATE.europe = null;
                return;
            }
            
            // Распределяем слоты
            const uclTeams = teamsFromDiv1.slice(0, EURO_SLOTS.UCL);
            const uelTeams = teamsFromDiv1.slice(EURO_SLOTS.UCL, EURO_SLOTS.UCL + EURO_SLOTS.UEL);
            const ueclTeams = teamsFromDiv1.slice(EURO_SLOTS.UCL + EURO_SLOTS.UEL, EURO_SLOTS.UCL + EURO_SLOTS.UEL + EURO_SLOTS.UECL);
            
            STATE.europe = {
                season: STATE.season,
                UCL: createEuroCompetition('UCL', uclTeams),
                UEL: createEuroCompetition('UEL', uelTeams),
                UECL: createEuroCompetition('UECL', ueclTeams)
            };
            
            // Новости о квалификации
            ['UCL', 'UEL', 'UECL'].forEach(comp => {
                const euroComp = STATE.europe[comp];
                if (euroComp && euroComp.participants.length > 0) {
                    const teamNames = euroComp.participants.map(id => getTeam(id)?.name).filter(Boolean);
                    addNews(EURO_COMP_NAMES[comp], `Qualified: ${teamNames.join(', ')}`, 'info');
                }
            });
            
            // Проверяем участие пользователя
            const userInUCL = STATE.europe.UCL.participants.includes(STATE.userTeamId);
            const userInUEL = STATE.europe.UEL.participants.includes(STATE.userTeamId);
            const userInUECL = STATE.europe.UECL.participants.includes(STATE.userTeamId);
            
            if (userInUCL) {
                addNews('Champions League', `${userTeam.name} qualified for the Champions League!`, 'award');
                STATE.history.push({ year: STATE.season, title: "Champions League Qualification" });
            } else if (userInUEL) {
                addNews('Europa League', `${userTeam.name} qualified for the Europa League!`, 'award');
                STATE.history.push({ year: STATE.season, title: "Europa League Qualification" });
            } else if (userInUECL) {
                addNews('Conference League', `${userTeam.name} qualified for the Conference League!`, 'award');
                STATE.history.push({ year: STATE.season, title: "Conference League Qualification" });
            }
        }
        
        // Создание структуры соревнования - Классический формат 25/26
        // 32 команды, 8 групп по 4 команды
        function createEuroCompetition(compId, qualifiedTeamsList) {
            const teamIds = qualifiedTeamsList.map(t => t.id);
            
            // Дополняем реальными европейскими командами для 32 участников (8 групп по 4)
            const targetTeams = 32;
            const fillerTeams = generateFillerTeams(compId, Math.max(0, targetTeams - teamIds.length));
            const allParticipants = [...teamIds, ...fillerTeams].slice(0, targetTeams);
            
            return {
                status: 'GROUP',
                stage: 'GROUP',
                matchday: 0, // 0-5 (6 matchdays)
                participants: allParticipants,
                groups: {},
                groupTables: {},
                schedule: {},
                qualified: [],
                knockout: null, // Плейофф стадия
                champion: null
            };
        }
        
        // ========== РЕАЛЬНЫЕ КОМАНДЫ ЕВРОКУБКОВ 25/26 ==========
        // Классический формат: 32 команды, 8 групп по 4
        
        // UCL 25/26 реальные команды
        // ДЛЯ ВСТАВКИ СВОИХ ID КОМАНД:
        // Добавь поле teamId к любой команде, например:
        // { name: 'Real Madrid', nation: 'ESP', rating: 89, teamId: 'ВАШ_ID_КОМАНДЫ' }
        // Если teamId указан, игра будет использовать команду из вашего датапака вместо генерации
        
        const EURO_TEAMS_2526 = {
            UCL: [
                // ===== POT 1 (Чемпионы + титулованные) =====
                { name: 'Real Madrid', nation: 'ESP', rating: 89, teamId: null }, // <-- Вставь ID здесь
                { name: 'Manchester City', nation: 'ENG', rating: 89, teamId: null },
                { name: 'Bayern Munich', nation: 'GER', rating: 87, teamId: null },
                { name: 'Paris Saint-Germain', nation: 'FRA', rating: 86, teamId: null },
                { name: 'Liverpool', nation: 'ENG', rating: 86, teamId: null },
                { name: 'Inter Milan', nation: 'ITA', rating: 85, teamId: null },
                { name: 'Borussia Dortmund', nation: 'GER', rating: 83, teamId: null },
                { name: 'Barcelona', nation: 'ESP', rating: 85, teamId: null },
                // Pot 2
                { name: 'Atletico Madrid', nation: 'ESP', rating: 83 },
                { name: 'Juventus', nation: 'ITA', rating: 82 },
                { name: 'Arsenal', nation: 'ENG', rating: 85 },
                { name: 'Benfica', nation: 'POR', rating: 80 },
                { name: 'Club Brugge', nation: 'BEL', rating: 75 },
                { name: 'Shakhtar Donetsk', nation: 'UKR', rating: 75 },
                { name: 'RB Leipzig', nation: 'GER', rating: 81 },
                { name: 'Sporting CP', nation: 'POR', rating: 79 },
                // Pot 3
                { name: 'PSV Eindhoven', nation: 'NED', rating: 78 },
                { name: 'Celtic', nation: 'SCO', rating: 76 },
                { name: 'AC Milan', nation: 'ITA', rating: 82 },
                { name: 'Atalanta', nation: 'ITA', rating: 81 },
                { name: 'Feyenoord', nation: 'NED', rating: 77 },
                { name: 'Monaco', nation: 'FRA', rating: 78 },
                { name: 'Aston Villa', nation: 'ENG', rating: 80 },
                { name: 'Bayer Leverkusen', nation: 'GER', rating: 84 },
                // Pot 4
                { name: 'Red Star Belgrade', nation: 'SRB', rating: 72 },
                { name: 'Young Boys', nation: 'SUI', rating: 71 },
                { name: 'Lille', nation: 'FRA', rating: 77 },
                { name: 'Bologna', nation: 'ITA', rating: 76 },
                { name: 'Girona', nation: 'ESP', rating: 76 },
                { name: 'Stuttgart', nation: 'GER', rating: 77 },
                { name: 'Sturm Graz', nation: 'AUT', rating: 70 },
                { name: 'Brest', nation: 'FRA', rating: 72 }
            ],
            UEL: [
                // Pot 1
                { name: 'AS Roma', nation: 'ITA', rating: 80 },
                { name: 'Manchester United', nation: 'ENG', rating: 82 },
                { name: 'Lazio', nation: 'ITA', rating: 79 },
                { name: 'Porto', nation: 'POR', rating: 80 },
                { name: 'Ajax', nation: 'NED', rating: 78 },
                { name: 'Rangers', nation: 'SCO', rating: 74 },
                { name: 'Eintracht Frankfurt', nation: 'GER', rating: 78 },
                { name: 'Tottenham', nation: 'ENG', rating: 81 },
                // Pot 2
                { name: 'Lyon', nation: 'FRA', rating: 78 },
                { name: 'Real Sociedad', nation: 'ESP', rating: 79 },
                { name: 'Nice', nation: 'FRA', rating: 76 },
                { name: 'Olympiacos', nation: 'GRE', rating: 74 },
                { name: 'Fenerbahce', nation: 'TUR', rating: 77 },
                { name: 'Union Berlin', nation: 'GER', rating: 74 },
                { name: 'Braga', nation: 'POR', rating: 76 },
                { name: 'Rennes', nation: 'FRA', rating: 75 },
                // Pot 3
                { name: 'Besiktas', nation: 'TUR', rating: 75 },
                { name: 'Athletic Bilbao', nation: 'ESP', rating: 78 },
                { name: 'AZ Alkmaar', nation: 'NED', rating: 74 },
                { name: 'Twente', nation: 'NED', rating: 72 },
                { name: 'Plzen', nation: 'CZE', rating: 71 },
                { name: 'PAOK', nation: 'GRE', rating: 73 },
                { name: 'Hoffenheim', nation: 'GER', rating: 75 },
                { name: 'Anderlecht', nation: 'BEL', rating: 73 },
                // Pot 4
                { name: 'Qarabag', nation: 'AZE', rating: 68 },
                { name: 'Midtjylland', nation: 'DEN', rating: 71 },
                { name: 'Malmo', nation: 'SWE', rating: 70 },
                { name: 'Elfsborg', nation: 'SWE', rating: 68 },
                { name: 'Maccabi Tel Aviv', nation: 'ISR', rating: 69 },
                { name: 'RFS', nation: 'LAT', rating: 64 },
                { name: 'Ludogorets', nation: 'BUL', rating: 70 },
                { name: 'FCSB', nation: 'ROU', rating: 68 }
            ],
            UECL: [
                // Pot 1
                { name: 'Chelsea', nation: 'ENG', rating: 82 },
                { name: 'Fiorentina', nation: 'ITA', rating: 77 },
                { name: 'Betis', nation: 'ESP', rating: 77 },
                { name: 'Istanbul Basaksehir', nation: 'TUR', rating: 72 },
                { name: 'Copenhagen', nation: 'DEN', rating: 74 },
                { name: 'Gent', nation: 'BEL', rating: 73 },
                { name: 'Rapid Wien', nation: 'AUT', rating: 70 },
                { name: 'Heidenheim', nation: 'GER', rating: 71 },
                // Pot 2
                { name: 'APOEL', nation: 'CYP', rating: 67 },
                { name: 'Hearts', nation: 'SCO', rating: 68 },
                { name: 'Vitoria Guimaraes', nation: 'POR', rating: 71 },
                { name: 'Djurgarden', nation: 'SWE', rating: 68 },
                { name: 'Legia Warsaw', nation: 'POL', rating: 70 },
                { name: 'Omonia', nation: 'CYP', rating: 66 },
                { name: 'Panathinaikos', nation: 'GRE', rating: 72 },
                { name: 'Jagiellonia', nation: 'POL', rating: 66 },
                // Pot 3
                { name: 'Celje', nation: 'SLO', rating: 63 },
                { name: 'Molde', nation: 'NOR', rating: 69 },
                { name: 'Shamrock Rovers', nation: 'IRL', rating: 62 },
                { name: 'Lugano', nation: 'SUI', rating: 67 },
                { name: 'Cercle Brugge', nation: 'BEL', rating: 68 },
                { name: 'Petrocub', nation: 'MDA', rating: 58 },
                { name: 'Astana', nation: 'KAZ', rating: 65 },
                { name: 'Noah', nation: 'ARM', rating: 56 },
                // Pot 4
                { name: 'Larne', nation: 'NIR', rating: 55 },
                { name: 'The New Saints', nation: 'WAL', rating: 54 },
                { name: 'Vikingur', nation: 'FRO', rating: 52 },
                { name: 'Borac Banja Luka', nation: 'BIH', rating: 58 },
                { name: 'Backa Topola', nation: 'SRB', rating: 62 },
                { name: 'Paphos', nation: 'CYP', rating: 63 },
                { name: 'SK Drita', nation: 'KOS', rating: 55 },
                { name: 'HJK Helsinki', nation: 'FIN', rating: 64 }
            ]
        };
        
        // Генерация реальных команд еврокубков для заполнения турнира
        // Поддерживает teamId для использования команд из вашего датапака
        function generateFillerTeams(compId, count) {
            const euroTeams = EURO_TEAMS_2526[compId] || [];
            const resultIds = [];
            
            for (let i = 0; i < count && i < euroTeams.length; i++) {
                const teamData = euroTeams[i];
                
                // Если указан teamId, используем команду из датапака
                if (teamData.teamId) {
                    const existingTeam = getTeam(teamData.teamId);
                    if (existingTeam) {
                        resultIds.push(teamData.teamId);
                        continue;
                    }
                }
                
                // Иначе создаём еврокубковую команду
                const euroId = `EURO_${compId}_${i}`;
                
                if (!getTeam(euroId)) {
                    STATE.allTeams.push({
                        id: euroId,
                        name: teamData.name,
                        leagueId: `EURO_${teamData.nation}`,
                        leagueName: `${teamData.nation} League`,
                        stadiumName: `${teamData.name} Stadium`,
                        nation: teamData.nation,
                        teamRating: teamData.rating,
                        points: 0, played: 0, wins: 0, draws: 0, losses: 0, 
                        gf: 0, ga: 0, gd: 0, pts: 0,
                        budget: teamData.rating * 50000,
                        color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0'),
                        squad: generateBasicSquad(teamData.rating)
                    });
                }
                resultIds.push(euroId);
            }
            
            return resultIds;
        }
        
        // Генерация базового состава для еврокубковых команд
        function generateBasicSquad(teamRating) {
            const positions = ['GK', 'CB', 'CB', 'LB', 'RB', 'CDM', 'CM', 'CM', 'LW', 'RW', 'ST'];
            const squad = [];
            
            for (let i = 0; i < 18; i++) {
                const isStarter = i < 11;
                const pos = i < 11 ? positions[i] : positions[Math.floor(Math.random() * positions.length)];
                const ratingVariance = Math.floor(Math.random() * 10) - 5;
                const playerRating = Math.max(50, Math.min(99, teamRating + ratingVariance + (isStarter ? 2 : -3)));
                
                squad.push({
                    id: `euro_player_${Date.now()}_${i}_${Math.random().toString(36).substr(2, 5)}`,
                    internalId: Date.now() + i,
                    name: `Player ${i + 1}`,
                    pos: pos,
                    age: 18 + Math.floor(Math.random() * 17),
                    rating: playerRating,
                    pot: Math.min(99, playerRating + Math.floor(Math.random() * 10)),
                    nation: 'INT',
                    isStarter: isStarter,
                    goals: 0, assists: 0, appearances: 0,
                    energy: 100, morale: 80,
                    salary: playerRating * 1000,
                    price: playerRating * playerRating * 100
                });
            }
            
            return squad;
        }
        
        // Жеребьёвка групп (вызывается перед началом нового сезона)
        function drawEuropeanGroups() {
            if (!STATE.europe) return;
            
            ['UCL', 'UEL', 'UECL'].forEach(compId => {
                const comp = STATE.europe[compId];
                if (!comp || comp.participants.length < 4) return;
                
                // НОВОЕ: Финальная очистка от резервов перед жеребьёвкой
                let validParticipants = comp.participants.filter(teamId => {
                    const team = getTeam(teamId);
                    return team && !isReserveTeamName(team.name);
                });
                
                // Дедупликация по baseName + nation
                const teamsForDedup = validParticipants.map(id => getTeam(id)).filter(Boolean);
                const dedupedTeams = deduplicateTeams(teamsForDedup);
                validParticipants = dedupedTeams.map(t => t.id);
                
                // Обновляем participants
                comp.participants = validParticipants;
                
                // Сортируем по силе команды
                const sortedTeams = [...validParticipants].sort((a, b) => {
                    const teamA = getTeam(a);
                    const teamB = getTeam(b);
                    return (teamB?.teamRating || 0) - (teamA?.teamRating || 0);
                });
                
                // ИСПРАВЛЕНО: Определяем количество групп (4 команды на группу)
                // Если команд меньше - уменьшаем число групп, но ��сегда минимум 1 группа при 4+ командах
                const numGroups = Math.max(1, Math.floor(sortedTeams.length / 4));
                if (numGroups < 1 || sortedTeams.length < 4) {
                    console.log(`${compId}: Not enough valid teams (${sortedTeams.length}) for groups`);
                    return;
                }
                
                // Разбиваем на корзины
                const teamsPerPot = numGroups;
                const pots = [
                    sortedTeams.slice(0, teamsPerPot),
                    sortedTeams.slice(teamsPerPot, teamsPerPot * 2),
                    sortedTeams.slice(teamsPerPot * 2, teamsPerPot * 3),
                    sortedTeams.slice(teamsPerPot * 3, teamsPerPot * 4)
                ];
                
                // Перемешиваем каждую корзину
                pots.forEach(pot => shuffleArray(pot));
                
                // Создаём группы
                comp.groups = {};
                comp.groupTables = {};
                comp.schedule = {};
                
                const groupLetters = 'ABCDEFGH';
                for (let g = 0; g < numGroups; g++) {
                    const groupLetter = groupLetters[g];
                    comp.groups[groupLetter] = [
                        pots[0][g],
                        pots[1][g],
                        pots[2][g],
                        pots[3][g]
                    ];
                    
                    // Инициализируем таблицу группы
                    comp.groupTables[groupLetter] = {};
                    comp.groups[groupLetter].forEach(teamId => {
                        comp.groupTables[groupLetter][teamId] = {
                            P: 0, W: 0, D: 0, L: 0, GF: 0, GA: 0, GD: 0, Pts: 0
                        };
                    });
                    
                    // Генерируем расписание для группы (6 туров)
                    comp.schedule[groupLetter] = generateGroupSchedule(comp.groups[groupLetter]);
                }
                
                // Новость о жеребьёвке
                const groupCount = Object.keys(comp.groups).length;
                addNews(EURO_COMP_NAMES[compId], `Group stage draw complete! ${groupCount} groups formed.`, 'info');
            });
        }
        
        // Генерация расписания для группы из 4 команд (6 матчей)
        function generateGroupSchedule(teamIds) {
            // Фиксированный шаблон для 4 команд (двойной круговой турнир)
            // Matchday 1: 0v3, 1v2
            // Matchday 2: 3v1, 2v0
            // Matchday 3: 0v1, 3v2
            // Matchday 4: 1v3, 0v2
            // Matchday 5: 2v1, 3v0
            // Matchday 6: 1v0, 2v3
            
            const template = [
                [[0,3], [1,2]],
                [[3,1], [2,0]],
                [[0,1], [3,2]],
                [[1,3], [0,2]],
                [[2,1], [3,0]],
                [[1,0], [2,3]]
            ];
            
            const schedule = {};
            for (let md = 0; md < 6; md++) {
                schedule[md] = template[md].map(([h, a]) => ({
                    homeId: teamIds[h],
                    awayId: teamIds[a],
                    played: false,
                    homeGoals: 0,
                    awayGoals: 0
                }));
            }
            
            return schedule;
        }
        
        // Утилита для перемешивания массива
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        
        // Симуляция матчдея еврокубков
        async function playEuroMatchday(compId, matchday) {
            const comp = STATE.europe[compId];
            if (!comp || comp.stage !== 'GROUP') return null;
            
            let userResult = null;
            
            for (const groupLetter of Object.keys(comp.groups)) {
                const matches = comp.schedule[groupLetter][matchday];
                if (!matches) continue;
                
                for (const match of matches) {
                    if (match.played) continue;
                    
                    const home = getTeam(match.homeId);
                    const away = getTeam(match.awayId);
                    
                    if (!home || !away) {
                        match.played = true;
                        match.homeGoals = 0;
                        match.awayGoals = 0;
                        continue;
                    }
                    
                    // Симулируем матч
                    const isUserMatch = match.homeId === STATE.userTeamId || match.awayId === STATE.userTeamId;
                    
                    if (isUserMatch) {
                        // Для пользователя показываем live
                        const result = simulateMatch(match.homeId, match.awayId);
                        match.homeGoals = result.homeGoals;
                        match.awayGoals = result.awayGoals;
                        match.played = true;
                        
                        await renderLiveMatch(result);
                        
                        const isUserHome = match.homeId === STATE.userTeamId;
                        const userGoals = isUserHome ? result.homeGoals : result.awayGoals;
                        const oppGoals = isUserHome ? result.awayGoals : result.homeGoals;
                        let resultType = 'D';
                        if (userGoals > oppGoals) resultType = 'W';
                        else if (userGoals < oppGoals) resultType = 'L';
                        
                        userResult = {
                            type: 'EURO',
                            cup: compId,
                            homeGoals: result.homeGoals,
                            awayGoals: result.awayGoals,
                            result: resultType,
                            isUserHome: isUserHome
                        };
                    } else {
                        // Простая симуляция для AI команд
                        const homeRating = home.teamRating || 60;
                        const awayRating = away.teamRating || 60;
                        const diff = homeRating - awayRating;
                        
                        const lambdaHome = Math.max(0.5, 1.3 + diff * 0.03);
                        const lambdaAway = Math.max(0.5, 1.0 - diff * 0.03);
                        
                        match.homeGoals = Math.floor(Math.random() * 3 * lambdaHome + (Math.random() > 0.6 ? 1 : 0));
                        match.awayGoals = Math.floor(Math.random() * 3 * lambdaAway + (Math.random() > 0.7 ? 1 : 0));
                        match.played = true;
                    }
                    
                    // Обновляем таблицу группы
                    const table = comp.groupTables[groupLetter];
                    if (table) {
                        // Домашняя команда
                        table[match.homeId].P++;
                        table[match.homeId].GF += match.homeGoals;
                        table[match.homeId].GA += match.awayGoals;
                        table[match.homeId].GD = table[match.homeId].GF - table[match.homeId].GA;
                        
                        // Гостевая команда
                        table[match.awayId].P++;
                        table[match.awayId].GF += match.awayGoals;
                        table[match.awayId].GA += match.homeGoals;
                        table[match.awayId].GD = table[match.awayId].GF - table[match.awayId].GA;
                        
                        if (match.homeGoals > match.awayGoals) {
                            table[match.homeId].W++;
                            table[match.homeId].Pts += 3;
                            table[match.awayId].L++;
                        } else if (match.homeGoals < match.awayGoals) {
                            table[match.awayId].W++;
                            table[match.awayId].Pts += 3;
                            table[match.homeId].L++;
                        } else {
                            table[match.homeId].D++;
                            table[match.awayId].D++;
                            table[match.homeId].Pts++;
                            table[match.awayId].Pts++;
                        }
                    }
                }
            }
            
            // После 6 тура определяем квалифицировавшихся
            if (matchday === 5) {
                finalizeGroupStage(compId);
            }
            
            comp.matchday++;
            return userResult;
        }
        
        // Завершение группового этапа
        function finalizeGroupStage(compId) {
            const comp = STATE.europe[compId];
            if (!comp) return;
            
            comp.qualified = [];
            
            for (const groupLetter of Object.keys(comp.groups)) {
                const table = comp.groupTables[groupLetter];
                const sorted = Object.entries(table)
                    .sort((a, b) => {
                        if (b[1].Pts !== a[1].Pts) return b[1].Pts - a[1].Pts;
                        if (b[1].GD !== a[1].GD) return b[1].GD - a[1].GD;
                        return b[1].GF - a[1].GF;
                    });
                
                // Топ 2 проходят
                if (sorted.length >= 2) {
                    comp.qualified.push(sorted[0][0], sorted[1][0]);
                }
            }
            
            comp.stage = 'KO_PENDING';
            addNews(EURO_COMP_NAMES[compId], `Group stage complete! ${comp.qualified.length} teams qualified for knockout round.`, 'info');
            
            // Проверяем пользователя
            if (comp.qualified.includes(STATE.userTeamId)) {
                addNews(EURO_COMP_NAMES[compId], `Congratulations! You've qualified for the knockout stage!`, 'award');
            }
            
            // НОВОЕ: Инициализируем плей-офф раунды
            initEuroKnockoutStage(compId);
        }
        
        // НОВОЕ: Инициализация плей-офф раундов еврокубков
        function initEuroKnockoutStage(compId) {
            const comp = STATE.europe[compId];
            if (!comp || comp.qualified.length < 2) return;
            
            const qualified = [...comp.qualified];
            shuffleArray(qualified);
            
            // Определяем название раунда по количеству команд
            const getKORoundName = (teamsCount) => {
                if (teamsCount <= 2) return 'Final';
                if (teamsCount <= 4) return 'Semi-Finals';
                if (teamsCount <= 8) return 'Quarter-Finals';
                if (teamsCount <= 16) return 'Round of 16';
                return 'Round of ' + teamsCount;
            };
            
            // Создаём первые пары (Round of 16 или меньше)
            const fixtures = [];
            for (let i = 0; i < qualified.length; i += 2) {
                if (qualified[i + 1]) {
                    fixtures.push({
                        homeId: qualified[i],
                        awayId: qualified[i + 1],
                        played: false,
                        leg1: { homeGoals: 0, awayGoals: 0, played: false },
                        leg2: { homeGoals: 0, awayGoals: 0, played: false },
                        winnerId: null
                    });
                }
            }
            
            comp.knockout = {
                currentRound: 0,
                rounds: [{
                    name: getKORoundName(qualified.length),
                    fixtures: fixtures,
                    played: false
                }]
            };
            
            comp.stage = 'KNOCKOUT';
            addNews(EURO_COMP_NAMES[compId], `${getKORoundName(qualified.length)} draw complete!`, 'info');
        }
        
        // НОВОЕ: Симуляция плей-офф матча еврокубка
        async function playEuroKnockoutRound(compId) {
            const comp = STATE.europe?.[compId];
            if (!comp || comp.stage !== 'KNOCKOUT' || !comp.knockout) return null;
            
            const currentRoundIdx = comp.knockout.currentRound;
            const currentRound = comp.knockout.rounds[currentRoundIdx];
            if (!currentRound || currentRound.played) return null;
            
            let userResult = null;
            
            // Играем все матчи раунда
            for (const fixture of currentRound.fixtures) {
                if (fixture.played) continue;
                
                const home = getTeam(fixture.homeId);
                const away = getTeam(fixture.awayId);
                
                if (!home || !away) {
                    fixture.played = true;
                    fixture.winnerId = fixture.homeId;
                    continue;
                }
                
                // Определяем, финал ли это (один матч) или двухматчевое противостояние
                const isFinal = currentRound.name === 'Final';
                
                if (isFinal) {
                    // Финал - один матч
                    const isUserMatch = fixture.homeId === STATE.userTeamId || fixture.awayId === STATE.userTeamId;
                    const result = simulateMatch(fixture.homeId, fixture.awayId);
                    
                    if (isUserMatch) {
                        await renderLiveMatch(result);
                    }
                    
                    if (result.homeGoals === result.awayGoals) {
                        // Пенальти в финале
                        const pens = simulatePenalties(home.teamRating, away.teamRating);
                        fixture.winnerId = pens.pensA > pens.pensB ? fixture.homeId : fixture.awayId;
                        fixture.penalties = pens;
                    } else {
                        fixture.winnerId = result.homeGoals > result.awayGoals ? fixture.homeId : fixture.awayId;
                    }
                    
                    fixture.leg1 = { homeGoals: result.homeGoals, awayGoals: result.awayGoals, played: true };
                    fixture.played = true;
                    
                    if (isUserMatch) {
                        const isUserHome = fixture.homeId === STATE.userTeamId;
                        const userWon = fixture.winnerId === STATE.userTeamId;
                        userResult = {
                            type: 'EURO_KO',
                            cup: compId,
                            roundName: currentRound.name,
                            homeGoals: result.homeGoals,
                            awayGoals: result.awayGoals,
                            result: userWon ? 'W' : 'L',
                            isUserHome
                        };
                    }
                } else {
                    // Два матча
                    const isUserMatch = fixture.homeId === STATE.userTeamId || fixture.awayId === STATE.userTeamId;
                    
                    // Первый матч
                    const leg1Result = simulateMatch(fixture.homeId, fixture.awayId);
                    if (isUserMatch) await renderLiveMatch(leg1Result);
                    fixture.leg1 = { homeGoals: leg1Result.homeGoals, awayGoals: leg1Result.awayGoals, played: true };
                    
                    // Второй матч (дома и гости меняются)
                    const leg2Result = simulateMatch(fixture.awayId, fixture.homeId);
                    if (isUserMatch) await renderLiveMatch(leg2Result);
                    fixture.leg2 = { homeGoals: leg2Result.homeGoals, awayGoals: leg2Result.awayGoals, played: true };
                    
                    // Подсчёт по сумме двух матчей
                    const homeAgg = fixture.leg1.homeGoals + fixture.leg2.awayGoals;
                    const awayAgg = fixture.leg1.awayGoals + fixture.leg2.homeGoals;
                    
                    if (homeAgg === awayAgg) {
                        // Пенальти
                        const pens = simulatePenalties(home.teamRating, away.teamRating);
                        fixture.winnerId = pens.pensA > pens.pensB ? fixture.homeId : fixture.awayId;
                        fixture.penalties = pens;
                    } else {
                        fixture.winnerId = homeAgg > awayAgg ? fixture.homeId : fixture.awayId;
                    }
                    
                    fixture.played = true;
                    
                    if (isUserMatch) {
                        const userWon = fixture.winnerId === STATE.userTeamId;
                        userResult = {
                            type: 'EURO_KO',
                            cup: compId,
                            roundName: currentRound.name,
                            homeGoals: homeAgg,
                            awayGoals: awayAgg,
                            result: userWon ? 'W' : 'L',
                            aggregate: true
                        };
                    }
                }
            }
            
            currentRound.played = true;
            
            // Собираем победителей для следующего раунда
            const winners = currentRound.fixtures.map(f => f.winnerId).filter(Boolean);
            
            if (winners.length >= 2) {
                // Создаём следующий раунд
                const nextFixtures = [];
                for (let i = 0; i < winners.length; i += 2) {
                    if (winners[i + 1]) {
                        nextFixtures.push({
                            homeId: winners[i],
                            awayId: winners[i + 1],
                            played: false,
                            leg1: { homeGoals: 0, awayGoals: 0, played: false },
                            leg2: { homeGoals: 0, awayGoals: 0, played: false },
                            winnerId: null
                        });
                    }
                }
                
                const getKORoundName = (teamsCount) => {
                    if (teamsCount <= 2) return 'Final';
                    if (teamsCount <= 4) return 'Semi-Finals';
                    if (teamsCount <= 8) return 'Quarter-Finals';
                    if (teamsCount <= 16) return 'Round of 16';
                    return 'Round of ' + teamsCount;
                };
                
                comp.knockout.rounds.push({
                    name: getKORoundName(winners.length),
                    fixtures: nextFixtures,
                    played: false
                });
                
                comp.knockout.currentRound++;
            } else if (winners.length === 1) {
                // Турнир закончен
                const winnerTeam = getTeam(winners[0]);
                comp.champion = winners[0];
                comp.stage = 'COMPLETED';
                
                addNews(EURO_COMP_NAMES[compId], `${winnerTeam?.name || 'Unknown'} wins the ${EURO_COMP_NAMES[compId]}!`, 'award');
                
                if (winners[0] === STATE.userTeamId) {
                    STATE.history.push({ year: STATE.season, title: `${EURO_COMP_NAMES[compId]} Winner` });
                    addNews('CHAMPION!', `Congratulations! You've won the ${EURO_COMP_NAMES[compId]}!`, 'award');
                }
            }
            
            return userResult;
        }

        
        // Получение группы пользователя
        function getUserEuroGroup(compId) {
            const comp = STATE.europe?.[compId];
            if (!comp) return null;
            
            for (const [groupLetter, teams] of Object.entries(comp.groups)) {
                if (teams.includes(STATE.userTeamId)) {
                    return groupLetter;
                }
            }
            return null;
        }
        
        // Получение соревнования пользователя
        function getUserEuroCompetition() {
            if (!STATE.europe) return null;
            
            for (const compId of ['UCL', 'UEL', 'UECL']) {
                if (STATE.europe[compId]?.participants.includes(STATE.userTeamId)) {
                    return compId;
                }
            }
            return null;
        }
        
        // Отсортированная таблица группы
        function getSortedGroupTable(compId, groupLetter) {
            const comp = STATE.europe?.[compId];
            if (!comp || !comp.groupTables[groupLetter]) return [];
            
            return Object.entries(comp.groupTables[groupLetter])
                .map(([teamId, stats]) => ({ teamId, ...stats }))
                .sort((a, b) => {
                    if (b.Pts !== a.Pts) return b.Pts - a.Pts;
                    if (b.GD !== a.GD) return b.GD - a.GD;
                    return b.GF - a.GF;
                });
        }

        function simulatePenalties(strengthA, strengthB) {
            let pensA = 0;
            let pensB = 0;
            
            // 5 пенальти для каждой команды
            for (let i = 0; i < 5; i++) {
                const chanceA = 0.7 + (strengthA / 100) * 0.2;
                const chanceB = 0.7 + (strengthB / 100) * 0.2;
                
                if (Math.random() < chanceA) pensA++;
                if (Math.random() < chanceB) pensB++;
                
                // Если после текущей серии одна команда не может догнать
                if ((5 - i - 1) + pensB < pensA) break;
                if ((5 - i - 1) + pensA < pensB) break;
            }
            
            // Если ничья после 5 пенальти, продолжаем до победы
            if (pensA === pensB) {
                while (pensA === pensB) {
                    if (Math.random() < 0.7 + (strengthA / 100) * 0.2) pensA++;
                    if (Math.random() < 0.7 + (strengthB / 100) * 0.2) pensB++;
                }
            }
            
            return { pensA, pensB };
        }

        // ИСПРАВЛЕННАЯ ФУНКЦИЯ: Игра раунда кубка с возвратом результата
        async function playCupRoundWithResult() {
            const cup = STATE.cups.leagueCup;
            if (!cup || cup.status !== "ongoing") return { userResult: null };
            
            // Находим текущий несыгранный раунд
            const currentRoundIndex = cup.rounds.findIndex(r => !r.played);
            if (currentRoundIndex === -1) return { userResult: null };
            
            const currentRound = cup.rounds[currentRoundIndex];
            if (currentRound.played) return { userResult: null };
            
            let userCupResult = null;
            
            // Симулируем все матчи раунда
            for (const fixture of currentRound.fixtures) {
                if (fixture.played) continue;
                
                const home = getTeam(fixture.homeId);
                const away = getTeam(fixture.awayId);
                
                if (!home || !away) continue;
                
                // Авто-выбор состава для CPU команд
                if (home.id !== STATE.userTeamId && home.squad.some(p => p.isStarter && (p.injuryWeeks > 0 || p.isSuspended))) {
                    autoSelectStarters(home);
                }
                if (away.id !== STATE.userTeamId && away.squad.some(p => p.isStarter && (p.injuryWeeks > 0 || p.isSuspended))) {
                    autoSelectStarters(away);
                }
                
                calculateTeamRating(home);
                calculateTeamRating(away);
                
                // Симуляция матча
                const matchResult = simulateMatch(fixture.homeId, fixture.awayId);
                
                // Проверяем на ничью и пенальти
                if (matchResult.homeGoals === matchResult.awayGoals) {
                    const penalties = simulatePenalties(home.teamRating, away.teamRating);
                    fixture.wentToPens = true;
                    fixture.pensHome = penalties.pensA;
                    fixture.pensAway = penalties.pensB;
                    
                    fixture.winnerId = penalties.pensA > penalties.pensB ? fixture.homeId : fixture.awayId;
                    addNews('League Cup', `${home.name} vs ${away.name} goes to penalties! ${penalties.pensA}-${penalties.pensB}`, 'match');
                } else {
                    fixture.winnerId = matchResult.homeGoals > matchResult.awayGoals ? fixture.homeId : fixture.awayId;
                }
                
                fixture.homeGoals = matchResult.homeGoals;
                fixture.awayGoals = matchResult.awayGoals;
                fixture.played = true;
                
                // НОВОЕ: Обновляем энергию и мораль после кубкового матча
                updateEnergyMorale(home, home.id === STATE.userTeamId, matchResult, matchResult.stats.scorersHome);
                updateEnergyMorale(away, away.id === STATE.userTeamId, matchResult, matchResult.stats.scorersAway);
                
                // Если это матч пользователя, показываем live и записываем результат
                if (fixture.homeId === STATE.userTeamId || fixture.awayId === STATE.userTeamId) {
                    await renderLiveMatch(matchResult);
                    
                    const isUserHome = fixture.homeId === STATE.userTeamId;
                    const userWon = fixture.winnerId === STATE.userTeamId;
                    
                    userCupResult = {
                        type: 'CUP',
                        homeGoals: fixture.homeGoals,
                        awayGoals: fixture.awayGoals,
                        result: userWon ? 'W' : 'L', // В кубке нет ничьих (пенальти)
                        isUserHome: isUserHome,
                        wentToPens: fixture.wentToPens,
                        pensHome: fixture.pensHome,
                        pensAway: fixture.pensAway,
                        roundName: currentRound.name
                    };
                }
            }
            
            // Отмечаем раунд как сыгранный
            currentRound.played = true;
            cup.currentRound = currentRoundIndex;
            
            // Собираем победителей
            const winners = [];
            currentRound.fixtures.forEach(f => {
                if (f.winnerId) winners.push(f.winnerId);
            });
            
            // Добавляем команды с BYE (поддержка как массива, так и одиночного значения)
            if (currentRound.byeTeams && Array.isArray(currentRound.byeTeams)) {
                winners.push(...currentRound.byeTeams);
            } else if (currentRound.byeTeam) {
                winners.push(currentRound.byeTeam);
            }
            
            // Создаем следующий раунд, если есть победители
            if (winners.length > 1) {
                const nextRoundFixtures = [];
                
                // Если нечётное количество победителей, один получает bye
                let byeTeamForNext = null;
                let winnersForPairing = [...winners];
                
                if (winnersForPairing.length % 2 !== 0) {
                    // Рандомно выбираем команду для bye
                    const byeIndex = Math.floor(Math.random() * winnersForPairing.length);
                    byeTeamForNext = winnersForPairing.splice(byeIndex, 1)[0];
                }
                
                for (let i = 0; i < winnersForPairing.length; i += 2) {
                    if (i + 1 < winnersForPairing.length) {
                        nextRoundFixtures.push({
                            homeId: winnersForPairing[i],
                            awayId: winnersForPairing[i + 1],
                            played: false,
                            homeGoals: 0,
                            awayGoals: 0,
                            winnerId: null,
                            pensHome: 0,
                            pensAway: 0,
                            wentToPens: false
                        });
                    }
                }
                
                // Определяем название следующего раунда по количеству команд
                const nextRoundName = getRoundName(winners.length);
                
                cup.rounds.push({
                    name: nextRoundName,
                    fixtures: nextRoundFixtures,
                    byeTeams: byeTeamForNext ? [byeTeamForNext] : [],
                    byeTeam: byeTeamForNext, // Для совместимости
                    played: false
                });
                
                cup.roundIndex = cup.rounds.length - 1;
                
                addNews('League Cup', `${nextRoundName} draw completed`, 'info');
                
                // ИСПРАВЛЕНО: Планируем следующий раунд кубка в календарь
                scheduleNextCupRound();
                
            } else if (winners.length === 1) {
                // Финальный победитель
                cup.championTeamId = winners[0];
                cup.status = "finished";
                const champion = getTeam(cup.championTeamId);
                
                addNews('League Cup', `${champion.name} wins the League Cup!`, 'award');
                
                // Добавляем в историю трофеев пользователя
                if (cup.championTeamId === STATE.userTeamId) {
                    STATE.history.push({ year: STATE.season, title: "League Cup Winner" });
                    createConfetti();
                }
            }
            
            return { userResult: userCupResult };
        }
        
        // Оставляем старую функцию для совместимости
        async function playCupRound() {
            await playCupRoundWithResult();
        }

        // FEATURE #3: GLOBAL EUROPEAN CUPS - Schedule multiple competitions on same week
        function initCalendar() {
            STATE.calendar = {
                currentWeek: 0,
                weeks: []
            };
            
            if (!STATE.schedule || STATE.schedule.length === 0) {
                console.warn("initCalendar: schedule is empty, cannot build calendar");
                return;
            }
            
            // Count cup rounds needed
            let cupRoundsNeeded = 0;
            if (STATE.cups.leagueCup && STATE.cups.leagueCup.status === "ongoing") {
                const teamsInCup = STATE.activeLeagueTeams.length;
                cupRoundsNeeded = Math.ceil(Math.log2(teamsInCup));
                if (cupRoundsNeeded < 1) cupRoundsNeeded = 1;
            }
            
            // Check for European competition
            const userEuroComp = getUserEuroCompetition();
            const hasEuroMatches = userEuroComp && STATE.europe && STATE.europe[userEuroComp] && 
                                   Object.keys(STATE.europe[userEuroComp].groups || {}).length > 0;
            
            let cupRoundsScheduled = 0;
            let euroMatchdaysScheduled = 0;
            
            const cupInterval = Math.max(3, Math.floor(STATE.schedule.length / (cupRoundsNeeded + 1)));
            const euroInterval = Math.max(4, Math.floor(STATE.schedule.length / 7));
            
            // Build calendar - GLOBAL scheduling: Euro and Cup matches on same week as league
            for (let i = 0; i < STATE.schedule.length; i++) {
                const weekEvents = [];
                
                // Always add league match as primary event
                weekEvents.push({
                    type: "LEAGUE",
                    matchday: i,
                    played: false
                });
                
                // GLOBAL EURO: Add European match midweek (same week as league match)
                if (hasEuroMatches && euroMatchdaysScheduled < 6) {
                    if ((i + 2) % euroInterval === 0) {
                        weekEvents.push({
                            type: "EURO",
                            cup: userEuroComp,
                            matchday: euroMatchdaysScheduled,
                            played: false
                        });
                        euroMatchdaysScheduled++;
                    }
                }
                
                // Add cup match midweek (can be same week as league)
                if (cupRoundsScheduled < cupRoundsNeeded && (i + 1) % cupInterval === 0) {
                    weekEvents.push({
                        type: "CUP",
                        round: cupRoundsScheduled,
                        played: false
                    });
                    cupRoundsScheduled++;
                }
                
                STATE.calendar.weeks.push({
                    week: i + 1,
                    events: weekEvents,
                    played: false,
                    userResults: []
                });
            }
            
            // Add remaining cup rounds at the end if any
            while (cupRoundsScheduled < cupRoundsNeeded) {
                STATE.calendar.weeks.push({
                    week: STATE.calendar.weeks.length + 1,
                    events: [{
                        type: "CUP",
                        round: cupRoundsScheduled,
                        played: false
                    }],
                    played: false,
                    userResults: []
                });
                cupRoundsScheduled++;
            }
            
            // Add remaining euro matchdays if any
            while (hasEuroMatches && euroMatchdaysScheduled < 6) {
                STATE.calendar.weeks.push({
                    week: STATE.calendar.weeks.length + 1,
                    events: [{
                        type: "EURO",
                        cup: userEuroComp,
                        matchday: euroMatchdaysScheduled,
                        played: false
                    }],
                    played: false,
                    userResults: []
                });
                euroMatchdaysScheduled++;
            }
            
            // Renumber weeks
            STATE.calendar.weeks.forEach((w, idx) => {
                w.week = idx + 1;
            });
        }
        
        // Функция для проверки и пересборки календаря если нужно
        function ensureCalendarReady() {
            if (!STATE.calendar || !STATE.calendar.weeks || STATE.calendar.weeks.length === 0) {
                // Инициализируем расписание если нужно
                if (!STATE.schedule || STATE.schedule.length === 0) {
                    initSchedule();
                }
                // Инициализируем кубок если нужно
                if (!STATE.cups.leagueCup) {
                    initLeagueCup();
                }
                // Строим календарь
                initCalendar();
            }
        }

        // ИСПРАВЛЕННАЯ ФУНКЦИЯ: Добавление раундов кубка в календарь
        function scheduleNextCupRound() {
            const cup = STATE.cups.leagueCup;
            if (!cup || cup.status !== "ongoing") return;
            
            // Находим следующий несыгранный раунд
            const nextUnplayedRound = cup.rounds.findIndex(round => !round.played);
            if (nextUnplayedRound === -1) return;
            
            // Проверяем, что этот раунд ещё не запланирован
            const alreadyScheduled = STATE.calendar.weeks.some(week => 
                week.events.some(event => event.type === "CUP" && event.round === nextUnplayedRound && !event.played)
            );
            if (alreadyScheduled) return;
            
            // Стратегия 1: Ищем неделю с ТОЛЬКО событием LEAGUE (добавим CUP туда же - мидвик матч)
            // Стратегия 2: Ищем пустую неделю без LEAGUE и CUP
            // Стратегия 3: Вставляем новую неделю между турами лиги
            // Стратегия 4: Добавляем в конец календаря
            
            let targetWeekIndex = -1;
            
            // Стратегия 1: Ищем неделю с LEAGUE без CUP (мидвик кубка после ~2 туров от текущего)
            const searchStart = STATE.calendar.currentWeek + 1;
            const preferredGap = 2; // Между кубковыми раундами минимум 2 недели
            
            for (let i = searchStart + preferredGap; i < STATE.calendar.weeks.length; i++) {
                const week = STATE.calendar.weeks[i];
                if (week.played) continue;
                
                const hasCupEvent = week.events.some(event => event.type === "CUP");
                const hasLeagueEvent = week.events.some(event => event.type === "LEAGUE");
                
                // Предпочитаем добавить кубок к неделе лиги (мидвик)
                if (hasLeagueEvent && !hasCupEvent) {
                    targetWeekIndex = i;
                    break;
                }
            }
            
            // Стратегия 2: Ищем пустую неделю
            if (targetWeekIndex === -1) {
                for (let i = searchStart; i < STATE.calendar.weeks.length; i++) {
                    const week = STATE.calendar.weeks[i];
                    if (week.played) continue;
                    
                    const hasCupEvent = week.events.some(event => event.type === "CUP");
                    const hasLeagueEvent = week.events.some(event => event.type === "LEAGUE");
                    
                    if (!hasLeagueEvent && !hasCupEvent) {
                        targetWeekIndex = i;
                        break;
                    }
                }
            }
            
            // Если нашли подходящую неделю, добавляем туда событие кубка
            if (targetWeekIndex !== -1) {
                STATE.calendar.weeks[targetWeekIndex].events.push({
                    type: "CUP",
                    round: nextUnplayedRound,
                    played: false
                });
            } else {
                // Стратегия 4: Вставляем новую неделю или добавляем в конец
                // Ищем место после текущей недели, вставляем между турами
                let insertIndex = STATE.calendar.currentWeek + preferredGap + 1;
                if (insertIndex >= STATE.calendar.weeks.length) {
                    insertIndex = STATE.calendar.weeks.length;
                }
                
                STATE.calendar.weeks.splice(insertIndex, 0, {
                    week: insertIndex + 1,
                    events: [{
                        type: "CUP",
                        round: nextUnplayedRound,
                        played: false
                    }],
                    played: false,
                    userResults: []
                });
                
                // Перенумеровываем недели
                for (let i = insertIndex; i < STATE.calendar.weeks.length; i++) {
                    STATE.calendar.weeks[i].week = i + 1;
                }
            }
        }

        function getUserLineupSlots() {
            return STATE.userLineupSlots;
        }

        function setUserLineupSlot(slotIndex, playerId) {
            STATE.userLineupSlots[slotIndex] = playerId;
        }

        function clearUserLineupSlot(slotIndex) {
            STATE.userLineupSlots[slotIndex] = null;
        }

        function resetUserLineupSlots() {
            STATE.userLineupSlots = Array(11).fill(null);
        }

        function getSlotPositions() {
            // Get formation positions and convert to slot format
            const formationPos = getFormationPositions(STATE.currentTactic || '4-3-3');
            return formationPos.map((fPos, idx) => ({
                position: fPos.pos,
                index: idx
            }));
        }

        function getPlayerInSlot(slotIndex) {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) return null;
            
            const slotId = STATE.userLineupSlots[slotIndex];
            if (slotId === null) return null;
            
            return userTeam.squad.find(p => p.internalId === slotId);
        }

        function setPlayerInSlot(slotIndex, playerId) {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) return;
            
            for (let i = 0; i < STATE.userLineupSlots.length; i++) {
                if (STATE.userLineupSlots[i] === playerId) {
                    STATE.userLineupSlots[i] = null;
                }
            }
            
            STATE.userLineupSlots[slotIndex] = playerId;
            
            updateTeamStartersFromSlots(userTeam);
            calculateTeamRating(userTeam);
        }

        function clearSlot(slotIndex) {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) return;
            
            STATE.userLineupSlots[slotIndex] = null;
            updateTeamStartersFromSlots(userTeam);
            calculateTeamRating(userTeam);
        }

        function updateTeamStartersFromSlots(team) {
            team.squad.forEach(p => p.isStarter = false);
            
            STATE.userLineupSlots.forEach(slotId => {
                if (slotId !== null) {
                    const player = team.squad.find(p => p.internalId === slotId);
                    if (player) {
                        player.isStarter = true;
                    }
                }
            });
        }

        function getBenchPlayers(team) {
            const lineupIds = new Set(STATE.userLineupSlots.filter(id => id !== null));
            return team.squad.filter(p => !lineupIds.has(p.internalId));
        }

        // ИСПРАВЛЕНО: autoSelectBestXI учитывает энергию и мораль
        function getEffectiveRating(player) {
            const energy = player.energy ?? 100;
            const morale = player.morale ?? 50;
            
            // energyFactor: 0.7..1.0 (низкая энергия сильно снижает)
            let energyFactor = 0.7 + 0.3 * (energy / 100);
            // Дополнительный штраф при очень низкой энергии (<55)
            if (energy < 55) {
                energyFactor *= 0.9;
            }
            
            // moraleFactor: 0.85..1.15
            const moraleFactor = 0.85 + 0.3 * (morale / 100);
            
            return player.rating * energyFactor * moraleFactor;
        }
        
        function autoSelectBestXI(team) {
            const backupSlots = [...STATE.userLineupSlots];
            
            try {
                const newSlots = Array(11).fill(null);
                
                const available = team.squad.filter(p => p.injuryWeeks === 0 && !p.isSuspended);
                
                // ИСПРАВЛЕНО: Сортировка по effective rating вместо чистого rating
                const gks = available.filter(p => posGroup(p.pos) === 'GK');
                const defs = available.filter(p => posGroup(p.pos) === 'DEF');
                const mids = available.filter(p => posGroup(p.pos) === 'MID');
                const fwds = available.filter(p => posGroup(p.pos) === 'FWD');
                
                const selectedPlayers = [];
                
                if (gks.length > 0) {
                    const bestGK = gks.sort((a, b) => getEffectiveRating(b) - getEffectiveRating(a))[0];
                    selectedPlayers.push(bestGK);
                }
                
                const bestDefs = defs.sort((a, b) => getEffectiveRating(b) - getEffectiveRating(a)).slice(0, 4);
                selectedPlayers.push(...bestDefs);
                
                const bestMids = mids.sort((a, b) => getEffectiveRating(b) - getEffectiveRating(a)).slice(0, 3);
                selectedPlayers.push(...bestMids);
                
                const bestFwds = fwds.sort((a, b) => getEffectiveRating(b) - getEffectiveRating(a)).slice(0, 3);
                selectedPlayers.push(...bestFwds);
                
                if (selectedPlayers.length < 11) {
                    const remainingNeeded = 11 - selectedPlayers.length;
                    const selectedIds = new Set(selectedPlayers.map(p => p.internalId));
                    const sortedByEffective = [...available].sort((a, b) => getEffectiveRating(b) - getEffectiveRating(a));
                    const remainingPlayers = sortedByEffective.filter(p => !selectedIds.has(p.internalId));
                    
                    selectedPlayers.push(...remainingPlayers.slice(0, remainingNeeded));
                }
                
                selectedPlayers.forEach((player, index) => {
                    if (index < 11) {
                        newSlots[index] = player.internalId;
                    }
                });
                
                for (let i = 0; i < 11; i++) {
                    STATE.userLineupSlots[i] = newSlots[i];
                }
                
                updateTeamStartersFromSlots(team);
                calculateTeamRating(team);
                
                return true;
            } catch (error) {
                for (let i = 0; i < 11; i++) {
                    STATE.userLineupSlots[i] = backupSlots[i];
                }
                updateTeamStartersFromSlots(team);
                calculateTeamRating(team);
                console.error("Auto-select failed:", error);
                return false;
            }
        }

        // ИСПРАВЛЕНО: autoSelectStarters для AI команд тоже учитывает энергию/мораль
        function autoSelectStarters(team) {
            if (team.id === STATE.userTeamId) {
                return;
            }
            
            const available = team.squad.filter(p => p.injuryWeeks === 0 && !p.isSuspended);
            
            // ИСПРАВЛЕНО: Сортировка по effective rating
            const gks = available.filter(p => posGroup(p.pos) === 'GK');
            const defs = available.filter(p => posGroup(p.pos) === 'DEF');
            const mids = available.filter(p => posGroup(p.pos) === 'MID');
            const fwds = available.filter(p => posGroup(p.pos) === 'FWD');
            
            team.squad.forEach(p => p.isStarter = false);
            
            if (gks.length > 0) {
                const bestGK = gks.sort((a, b) => getEffectiveRating(b) - getEffectiveRating(a))[0];
                bestGK.isStarter = true;
            }
            
            defs.sort((a, b) => getEffectiveRating(b) - getEffectiveRating(a)).slice(0, 4).forEach(p => p.isStarter = true);
            mids.sort((a, b) => getEffectiveRating(b) - getEffectiveRating(a)).slice(0, 3).forEach(p => p.isStarter = true);
            fwds.sort((a, b) => getEffectiveRating(b) - getEffectiveRating(a)).slice(0, 3).forEach(p => p.isStarter = true);
            
            calculateTeamRating(team);
        }

        // ========== MARKET VALUE CONSTANTS ==========
        const MARKET_VALUE_MIN = 50000;       // Минимальная цена игрока
        const MARKET_VALUE_MAX = 224000000;   // Максимальная цена игрока
        
        // Clamp для marketValue - применять ВЕЗДЕ при изменении цены
        function clampMarketValue(value) {
            return Math.max(MARKET_VALUE_MIN, Math.min(MARKET_VALUE_MAX, value));
        }
        
        function formatMoney(amount) {
            // Только форматирование, БЕЗ изменения значения
            return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(amount);
        }

        function generateColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        function addNews(title, msg, type) {
            STATE.newsFeed.unshift({ title, msg, type, week: STATE.calendar.currentWeek + 1, season: STATE.season });
            if (STATE.newsFeed.length > 50) STATE.newsFeed.pop();
        }

        function tableToObjects(tbl){
            if(!tbl || !Array.isArray(tbl.colonne) || !Array.isArray(tbl.dati)) return [];
            return tbl.dati.map(row => Object.fromEntries(tbl.colonne.map((c,i)=>[c,row[i]])));
        }

        function handleFileUpload(event) {
    const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            if (file.name.endsWith('.db') || file.name.endsWith('.sqlite')) {
                alert("SQLite database support has been removed. Please use JSON format.");
                //Screen();
            } else {
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.leagues && data.teams && data.players) {
                            processNewTableFormat(data);
                        } else if (data.clubs || data.teams) {
                            processNewJsonFormat(data);
                        } else {
                            alert("Unknown JSON format");
                            // ИСПРАВЛЕНО: Fail-safe - показываем стартовый экран
                            //Screen();
                        }
                    } catch (err) {
                        alert("Error parsing JSON: " + err.message);
                        console.error(err);
                        // ИСПРАВЛЕНО: Fail-safe - показываем стартовый экран
                       // renderUploadScreen();
                    }
                };
                reader.readAsText(file);
            }
        }

        function processNewTableFormat(db) {
            console.log("Processing new table format", db);
            
            const leaguesArr = tableToObjects(db.leagues);
            const teamsArray = tableToObjects(db.teams);
            const playersArr = tableToObjects(db.players);
            
            if (teamsArray.length === 0) {
                alert("No clubs found in database");
                return;
            }
            
            STATE.leaguesMap.clear();
            
            const leagueMap = new Map();
            leaguesArr.forEach(l => {
                const id = String(l.id);
                leagueMap.set(id, {
                    name: l.name || `League ${id}`,
                    division: l.division || 1,
                    nation: l.nation || l.country || 'INT',
                    promotions: l.promotions || 3,
                    directPromotions: l.directPromotions || 3,
                    relegations: l.relegations || 3
                });
                STATE.leaguesMap.set(id, leagueMap.get(id));
            });
            
            STATE.allTeams = teamsArray.map((team, index) => {
                const teamId = Number(team.id);
                const leagueId = String(team.leagueId || 'OTHER');
                const leagueInfo = leagueMap.get(leagueId) || { 
                    name: `League ${leagueId}`,
                    division: 1,
                    nation: 'INT',
                    promotions: 3,
                    directPromotions: 3,
                    relegations: 3
                };
                
                return {
                    id: String(teamId),
                    name: team.name || `Team ${teamId}`,
                    leagueId: leagueId,
                    leagueName: leagueInfo.name,
                    stadiumName: team.stadiumName || "Municipal Stadium",
                    teamRating: 0,
                    points: 0,
                    played: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    gf: 0,
                    ga: 0,
                    gd: 0,
                    budget: calculateBudget(team.teamValue || team.budget),
                    color: team.color || generateColor(team.name || `Team ${teamId}`),
                    squad: []
                };
            });
            
            const teamById = new Map();
            STATE.allTeams.forEach(t => {
                teamById.set(Number(t.id), t);
            });
            
            let playerIndex = 0;
            playersArr.forEach((player, index) => {
                const rawTeamId = player.teamId;
                // ИСПРАВЛЕНО: Строгая проверка teamId - null, undefined, 0 -> free agent
                const teamIdNum = Number(rawTeamId);
                const isValidTeamId = rawTeamId !== null && rawTeamId !== undefined && rawTeamId !== 0 && !isNaN(teamIdNum) && teamIdNum > 0;
                const team = isValidTeamId ? teamById.get(teamIdNum) : null;
                
                let roles = [];
                try {
                    if (player.roles) {
                        roles = typeof player.roles === 'string' ? JSON.parse(player.roles) : player.roles;
                    }
                } catch(e) {
                    console.warn("Could not parse roles for player", player.name, e);
                }
                
                const rating = Math.round(parseFloat(player.overall || 50));
                // ИСПРАВЛЕНО: Берём marketValue напрямую из БД, применяем clamp
                const rawPrice = Number(player.marketValue);
                const isFreeAgent = !team || !isValidTeamId;
                const price = isFreeAgent ? 0 : clampMarketValue(isNaN(rawPrice) || rawPrice <= 0 ? rating * 100000 : rawPrice);
                let age = 20;
                
                if (player.birthdate) {
                    const birthYear = parseInt(player.birthdate.substring(0, 4));
                    if (!isNaN(birthYear)) {
                        age = 2024 - birthYear;
                    }
                }
                
                const speed = Math.floor(rating * 0.9);
                const shot = Math.floor(rating * 0.8);
                const pass = Math.floor(rating * 0.85);
                const dribble = Math.floor(rating * 0.88);
                
                // ЕДИНСТВЕННЫЙ ИСТОЧНИК ИСТИНЫ: позиция из БД
                let pos = "MID";
                if (roles[0] && roles[0].role) {
                    pos = normalizePos(roles[0].role);
                }
                
                const playerObj = {
                    internalId: playerIndex++,
                    name: (player.name || "") + " " + (player.surname || ""),
                    pos: pos, // Используем нормализованную позицию
                    rating: rating,
                    potential: rating + Math.floor(Math.random() * 10),
                    price: price,
                    clubId: isFreeAgent ? null : String(teamIdNum),
                    speed: speed,
                    shot: shot,
                    pass: pass,
                    dribble: dribble,
                    age: age,
                    nation: player.nationality || player.nation || "INT",
                    isStarter: false,
                    transferListed: false,
                    seasonGoals: 0,
                    seasonAssists: 0,
                    seasonRating: rating,
                    careerGoals: 0,
                    injuryWeeks: 0,
                    isSuspended: false,
                    suspensionPending: false,
                    energy: 100,
                    morale: 50,
                    isFreeAgent: isFreeAgent,
                    endContract: 2025 + Math.floor(Math.random() * 5),
                    // FIXED: Generate salary for all players during career initialization
                    salary: calculatePlayerSalary({rating: rating, age: age, pos: pos})
                };
                
                if (isFreeAgent) {
                    // Добавляем в список свободных агентов
                    STATE.freeAgents.push(playerObj);
                } else if (team) {
                    team.squad.push(playerObj);
                }
            });
            
            if (db.gameState && STATE.userTeamId) {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        if (!team.squad.some(p => p.isStarter)) autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                LogoManager.preloadLogos(STATE.allTeams).catch(e => console.warn('Logo preload failed:', e));
                const userTeam = getTeam(STATE.userTeamId);
                if (userTeam) {
                    STATE.activeLeagueTeams = STATE.allTeams.filter(t => t.leagueId === userTeam.leagueId);
                }
                
                // Инициализируем кубок и календарь при загрузке сохранения
                if (db.gameState.cups) {
                    STATE.cups = db.gameState.cups;
                }
                if (db.gameState.calendar) {
                    STATE.calendar = db.gameState.calendar;
                } else {
                    initLeagueCup();
                    initCalendar();
                }
                
                renderDashboard();
            } else {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                
                // Preload team logos
                LogoManager.preloadLogos(STATE.allTeams).catch(e => console.warn('Logo preload failed:', e));
                
                renderTeamSelection();
            }
        }

        function processSqlDb(db) {
            alert("SQLite database support has been removed. Please use JSON format.");
            //Screen();
            return;
            // The following code is unreachable but kept for structural reference if needed
            const resultToJson = (res) => {
                if (!res || !res.values) return [];
                const cols = res.columns.map(c => c.toLowerCase());
                return res.values.map(row => {
                    const obj = {};
                    cols.forEach((col, i) => obj[col] = row[i]);
                    return obj;
                });
            };

            const getVal = (row, keys) => {
                for(const k of keys) {
                    if (row[k] !== undefined) return row[k];
                    if (row[k.toLowerCase()] !== undefined) return row[k.toLowerCase()];
                    if (row[k.toUpperCase()] !== undefined) return row[k.toUpperCase()];
                }
                return null;
            };

            const getTable = (possibleNames) => {
                try {
                    const tables = resultToJson(db.exec("SELECT name FROM sqlite_master WHERE type='table'")[0]);
                    const tableNames = tables.map(t => t.name.toLowerCase());
                    const match = tableNames.find(n => possibleNames.includes(n));
                    if (match) return resultToJson(db.exec(`SELECT * FROM ${match}`)[0]);
                } catch(e) { console.warn("Table not found:", possibleNames); }
                return [];
            };

            const clubs = getTable(['club', 'clubs', 'team', 'teams']);
            const players = getTable(['player', 'players']);
            const competitions = getTable(['competition', 'competitions', 'league', 'leagues']);
            const stages = getTable(['competitionstage', 'competition_stage', 'stage']);
            const stageClubs = getTable(['competitionstageclub', 'competition_stage_club', 'competition_clubs']);
            const stadiums = getTable(['stadium', 'stadiums', 'grounds']);

            competitions.forEach(c => {
                const id = getVal(c, ['id', 'competitionid', 'leagueid']);
                const name = getVal(c, ['name', 'display_name', 'leaguename']);
                const division = getVal(c, ['division', 'level', 'tier']) || 1;
                const promotions = getVal(c, ['promotions', 'promotion_spots']) || 3;
                const directPromotions = getVal(c, ['direct_promotions', 'auto_promotions']) || promotions;
                const relegations = getVal(c, ['relegations', 'relegation_spots']) || 3;
                
                if (id) {
                    STATE.leaguesMap.set(String(id), {
                        name: name || `League ${id}`,
                        division: division,
                        nation: getVal(c, ['nation', 'country', 'countrycode']) || 'INT',
                        promotions: promotions,
                        directPromotions: directPromotions,
                        relegations: relegations
                    });
                }
            });

            const compMap = {};
            competitions.forEach(c => {
                const id = getVal(c, ['id', 'competitionid', 'leagueid']);
                const name = getVal(c, ['name', 'display_name', 'leaguename']);
                if (id) compMap[id] = name || `League ${id}`;
            });

            const stageToCompMap = {};
            stages.forEach(s => {
                const id = getVal(s, ['id', 'stageid']);
                const compId = getVal(s, ['competitionid', 'competition_id', 'leagueid']);
                if (id) stageToCompMap[id] = compId;
            });

            const stadiumMap = {};
            stadiums.forEach(s => {
                const id = getVal(s, ['id', 'stadiumid']);
                const name = getVal(s, ['name', 'stadiumname']);
                if (id) stadiumMap[id] = name;
            });

            const clubLeagueMap = {};
            stageClubs.forEach(sc => {
                const clubId = getVal(sc, ['clubid', 'club_id']);
                const stageId = getVal(sc, ['competitionstageid', 'competition_stage_id', 'stageid']);
                if (clubId && stageId) {
                    const compId = stageToCompMap[stageId];
                    if (compId && compMap[compId]) {
                        clubLeagueMap[clubId] = {
                            id: compId,
                            name: compMap[compId]
                        };
                    }
                }
            });

            const normalizedClubs = clubs.map(c => {
                const id = String(getVal(c, ['id', 'clubid']));
                const name = getVal(c, ['name', 'shortname', 'longname']) || "Unknown Club";
                
                const rDF = getVal(c, ['ratingdf', 'rating_df', 'def']) || 50;
                const rMF = getVal(c, ['ratingmf', 'rating_mf', 'mid']) || 50;
                const rFW = getVal(c, ['ratingfw', 'rating_fw', 'att']) || 50;
                
                const avgRating = Math.round((rDF + rMF + rFW) / 3);
                
                const leagueInfo = clubLeagueMap[id] || { id: 'OTHER', name: "Rest of World" };
                
                let stadiumId = getVal(c, ['stadiumid', 'stadium_id', 'groundid']);
                const stadiumName = stadiumMap[stadiumId] || "Municipal Stadium";

                return {
                    id: id,
                    name: name,
                    leagueId: leagueInfo.id,
                    leagueName: leagueInfo.name,
                    stadiumName: stadiumName,
                    teamRating: avgRating,
                    budget: calculateBudget(getVal(c, ['budget', 'money', 'teamvalue', 'team_value']))
                };
            });

            const clubIdSet = new Set(normalizedClubs.map(c => c.id));
            const normalizedPlayers = [];

            players.forEach((p, index) => {
                const cid = String(getVal(p, ['clubid', 'club_id', 'current_club_id']));
                
                if (clubIdSet.has(cid)) {
                    let rating = getVal(p, ['rating', 'overall', 'ca', 'current_ability']);
                    if (!rating) {
                        const rDF = getVal(p, ['ratingdf']) || 50;
                        const rMF = getVal(p, ['ratingmf']) || 50;
                        const rFW = getVal(p, ['ratingfw']) || 50;
                        rating = Math.max(rDF, rMF, rFW);
                    }

                    let speed = getVal(p, ['speed', 'pace', 'acceleration']) || Math.floor(rating * 0.9);
                    let shot = getVal(p, ['shot', 'shooting', 'finishing']) || Math.floor(rating * 0.8);
                    let pass = getVal(p, ['pass', 'passing']) || Math.floor(rating * 0.85);
                    let dribble = getVal(p, ['dribble', 'dribbling']) || Math.floor(rating * 0.88);

                    let age = getVal(p, ['age', 'birthyear']);
                    if (age > 1900) age = 2024 - age;
                    if (!age) age = Math.floor(Math.random() * 15) + 18;

                    let nation = getVal(p, ['nationality', 'nation', 'countrycode', 'nationname']);

                    // ЕДИНСТВЕННЫЙ ИСТОЧНИК ИСТИНЫ: позиция из БД
                    let pos = getVal(p, ['pos', 'position', 'best_position']) || "MID";
                    pos = normalizePos(pos);

                    // ИСПРАВЛЕНО: Берём цену напрямую из БД
                    const rawPriceVal = getVal(p, ['price', 'value', 'marketvalue', 'market_value']);
                    const priceFromDb = clampMarketValue(rawPriceVal && rawPriceVal > 0 ? Number(rawPriceVal) : rating * 100000);
                    
                    normalizedPlayers.push({
                        internalId: index,
                        name: getVal(p, ['name', 'common_name', 'firstname', 'lastname']) || "Unknown Player",
                        pos: pos, // Используем нормализованную позицию
                        rating: rating,
                        potential: rating + Math.floor(Math.random() * 10),
                        price: priceFromDb,
                        clubId: cid,
                        speed: speed, 
                        shot: shot,
                        pass: pass,
                        dribble: dribble,
                        age: age,
                        nation: nation,
                        isStarter: false,
                        transferListed: false,
                        seasonGoals: 0,
                        seasonAssists: 0,
                        seasonRating: rating,
                        careerGoals: 0,
                        injuryWeeks: 0,
                        isSuspended: false,
                        suspensionPending: false,
                        energy: 100,
                        morale: 50
                    });
                }
            });

            processData({
                clubs: normalizedClubs,
                players: normalizedPlayers
            });
        }

        function processNewJsonFormat(data) {
            console.log("Processing new JSON format", data);
            
            if (data.leagues && Array.isArray(data.leagues)) {
                data.leagues.forEach(league => {
                    const id = league.id || league.leagueId;
                    if (id) {
                        STATE.leaguesMap.set(String(id), {
                            name: league.name || league.leagueName || `League ${id}`,
                            division: league.division || league.level || 1,
                            nation: league.nation || league.country || league.countryCode || 'INT',
                            promotions: league.promotions || league.promotionSpots || 3,
                            directPromotions: league.directPromotions || league.autoPromotions || league.promotions || 3,
                            relegations: league.relegations || league.relegationSpots || 3
                        });
                    }
                });
            }
            
            let teamsArray = [];
            let playersArray = [];
            
            if (Array.isArray(data)) {
                playersArray = data;
                const teamMap = new Map();
                data.forEach(player => {
                    if (player.teamId) {
                        const teamId = String(player.teamId);
                        if (!teamMap.has(teamId)) {
                            const leagueId = player.leagueId || teamId;
                            const leagueInfo = STATE.leaguesMap.get(String(leagueId)) || {
                                name: player.leagueName || `League ${leagueId}`,
                                division: 1,
                                promotions: 3,
                                directPromotions: 3,
                                relegations: 3
                            };
                            
                            teamMap.set(teamId, {
                                id: teamId,
                                name: player.teamName || `Team ${teamId}`,
                                leagueId: leagueId,
                                leagueName: leagueInfo.name,
                                budget: calculateBudget(player.teamValue)
                            });
                        }
                    }
                });
                teamsArray = Array.from(teamMap.values());
            } else if (data.teams && data.players) {
                teamsArray = data.teams;
                playersArray = data.players;
            } else if (data.clubs && data.players) {
                teamsArray = data.clubs;
                playersArray = data.players;
            } else {
                for (const key in data) {
                    if (Array.isArray(data[key])) {
                        const firstItem = data[key][0];
                        if (firstItem && firstItem.teamId !== undefined) {
                            playersArray = data[key];
                        } else if (firstItem && firstItem.id !== undefined) {
                            teamsArray = data[key];
                        }
                    }
                }
            }
            
            if (teamsArray.length === 0 || playersArray.length === 0) {
                alert("Invalid JSON format: Could not find teams and players data");
                return;
            }
            
            if (data.gameState) {
                STATE.season = data.gameState.season || 1;
                STATE.history = data.gameState.history || [];
                STATE.newsFeed = data.gameState.newsFeed || [];
                STATE.schedule = data.gameState.schedule;
                STATE.userTeamId = data.gameState.userTeamId ? String(data.gameState.userTeamId) : null;
                STATE.leagueStats = data.gameState.leagueStats || { topScorers: [], topAssists: [], bestPlayers: [], awardsHistory: [] };
                STATE.userLineupSlots = data.gameState.userLineupSlots || Array(11).fill(null);
                
                // Загружаем кубок и календарь если есть
                if (data.gameState.cups) {
                    STATE.cups = data.gameState.cups;
                }
                if (data.gameState.calendar) {
                    STATE.calendar = data.gameState.calendar;
                }
                // НОВОЕ: Загружаем userLeagueId
                if (data.gameState.userLeagueId) {
                    STATE.userLeagueId = data.gameState.userLeagueId;
                }
                
                // ИСПРАВЛЕНО: Загружаем freeAgents если есть в сейве (внутри блока gameState)
                if (data.freeAgents && Array.isArray(data.freeAgents)) {
                    STATE.freeAgents = data.freeAgents;
                } else {
                    STATE.freeAgents = [];
                }
            } else {
                // Нет gameState - инициализируем всё с нуля
                STATE.season = 1;
                STATE.history = [];
                STATE.newsFeed = [];
                STATE.userTeamId = null;
                STATE.userLeagueId = null;
                STATE.leagueStats = { topScorers: [], topAssists: [], bestPlayers: [], awardsHistory: [] };
                STATE.userLineupSlots = Array(11).fill(null);
                STATE.cups = {};
                STATE.calendar = { currentWeek: 0, weeks: [] };
                STATE.freeAgents = [];
            }

            STATE.allTeams = teamsArray.map((team, index) => {
                const teamId = String(team.id || team.teamId || index);
                const teamName = team.name || team.teamName || `Team ${teamId}`;
                
                const leagueId = team.leagueId || team.league || teamId;
                const leagueInfo = STATE.leaguesMap.get(String(leagueId)) || {
                    name: team.leagueName || team.league || `League ${leagueId}`,
                    division: 1,
                    promotions: 3,
                    directPromotions: 3,
                    relegations: 3
                };
                
                const budget = calculateBudget(team.budget || team.teamValue);
                
                return {
                    id: teamId,
                    name: teamName,
                    leagueId: leagueId,
                    leagueName: leagueInfo.name,
                    stadiumName: team.stadiumName || "Municipal Stadium",
                    teamRating: 0,
                    points: 0,
                    played: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    gf: 0,
                    ga: 0,
                    gd: 0,
                    budget: budget,
                    color: team.color || generateColor(teamName),
                    squad: []
                };
            });

            let playerIndex = 0;
            playersArray.forEach((player, index) => {
                const playerName = (player.name || "") + " " + (player.surname || "");
                const cleanName = playerName.trim() || `Player ${index}`;
                
                // ЕДИНСТВЕННЫЙ ИСТОЧНИК ИСТИНЫ: позиция из БД
                let position = "MID";
                if (player.roles && Array.isArray(player.roles) && player.roles.length > 0) {
                    position = normalizePos(player.roles[0].role || "MID");
                } else if (player.position) {
                    position = normalizePos(player.position);
                }
                
                let rating = 50;
                if (player.overall) {
                    rating = Math.round(parseFloat(player.overall));
                } else if (player.rating) {
                    rating = Math.round(parseFloat(player.rating));
                }
                
                // ИСПРАВЛЕНО: Берём marketValue напрямую из БД строго
                let rawPrice = 0;
                if (player.marketValue !== undefined && player.marketValue !== null) {
                    rawPrice = Number(player.marketValue);
                } else if (player.price !== undefined && player.price !== null) {
                    rawPrice = Number(player.price);
                }
                
                // НОВОЕ: Проверка на free agent - если marketValue <= 0 или не число
                const isFreeAgent = !Number.isFinite(rawPrice) || rawPrice <= 0;
                
                // Для free agents цена = 0, иначе применяем clamp
                const price = isFreeAgent ? 0 : clampMarketValue(rawPrice);
                
                let age = 20;
                if (player.birthdate) {
                    const birthYear = parseInt(player.birthdate.substring(0, 4));
                    if (!isNaN(birthYear)) {
                        age = 2024 - birthYear;
                    }
                } else if (player.age) {
                    age = parseInt(player.age);
                }
                
                const teamId = String(player.teamId);
                const team = STATE.allTeams.find(t => t.id === teamId);
                
                const playerData = {
                    internalId: player.internalId !== undefined ? player.internalId : playerIndex++,
                    name: cleanName,
                    pos: position, // Используем нормализованную позицию
                    rating: player.rating || rating,
                    potential: player.potential || (rating + Math.floor(Math.random() * 10)),
                    price: price,
                    clubId: isFreeAgent ? null : teamId, // НОВОЕ: free agents не привязаны к клубу
                    speed: player.speed || Math.floor(rating * 0.9),
                    shot: player.shot || Math.floor(rating * 0.8),
                    pass: player.pass || Math.floor(rating * 0.85),
                    dribble: player.dribble || Math.floor(rating * 0.88),
                    age: player.age || age,
                    nation: player.nation || player.nationality || "INT",
                    isStarter: false, // Free agents не стартеры
                    transferListed: player.transferListed || false,
                    seasonGoals: player.seasonGoals || 0,
                    seasonAssists: player.seasonAssists || 0,
                    seasonRating: player.seasonRating || rating,
                    careerGoals: player.careerGoals || 0,
                    injuryWeeks: player.injuryWeeks || 0,
                    isSuspended: player.isSuspended || false,
                    suspensionPending: player.suspensionPending || false,
                    energy: player.energy !== undefined ? player.energy : 100,
                    morale: player.morale !== undefined ? player.morale : 50,
                    isFreeAgent: player.isFreeAgent !== undefined ? player.isFreeAgent : isFreeAgent,
                    endContract: player.endContract || (2025 + Math.floor(Math.random() * 5)), // Adapted endContract
                    salary: player.salary || calculatePlayerSalary({rating: rating, age: age})
                };
                
                if (isFreeAgent) {
                    // НОВОЕ: Добавляем в список свободных агентов
                    STATE.freeAgents.push(playerData);
                } else if (team) {
                    team.squad.push(playerData);
                }
            });

            if (data.gameState && STATE.userTeamId) {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        if (!team.squad.some(p => p.isStarter)) autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                const userTeam = getTeam(STATE.userTeamId);
                if (userTeam) {
                    STATE.activeLeagueTeams = STATE.allTeams.filter(t => t.leagueId === userTeam.leagueId);
                    // НОВОЕ: Устанавливаем userLeagueId если не был загружен
                    if (!STATE.userLeagueId) {
                        STATE.userLeagueId = userTeam.leagueId;
                    }
                }
                
                // Если нет календаря, инициализируем его
                if (!STATE.calendar.weeks.length) {
                    initLeagueCup();
                    initCalendar();
                }
                
                renderDashboard();
            } else {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                LogoManager.preloadLogos(STATE.allTeams).catch(e => console.warn('Logo preload failed:', e));
                renderTeamSelection();
            }
        }

        function processData(data) {
            if ((!data.clubs || !Array.isArray(data.clubs) || !data.players || !Array.isArray(data.players)) && !data.gameState) {
                alert("Invalid Data format.");
                return;
            }

            if (data.gameState) {
                STATE.season = data.gameState.season || 1;
                STATE.history = data.gameState.history || [];
                STATE.newsFeed = data.gameState.newsFeed || [];
                STATE.schedule = data.gameState.schedule;
                STATE.userTeamId = data.gameState.userTeamId ? String(data.gameState.userTeamId) : null;
                STATE.leagueStats = data.gameState.leagueStats || { topScorers: [], topAssists: [], bestPlayers: [], awardsHistory: [] };
                STATE.userLineupSlots = data.gameState.userLineupSlots || Array(11).fill(null);
                
                // Загружаем кубок и календарь если есть
                if (data.gameState.cups) {
                    STATE.cups = data.gameState.cups;
                }
                if (data.gameState.calendar) {
                    STATE.calendar = data.gameState.calendar;
                }
                // НОВОЕ: Загружаем еврокубки
                if (data.gameState.europe) {
                    STATE.europe = data.gameState.europe;
                }
                if (data.gameState.tableView) {
                    STATE.tableView = data.gameState.tableView;
                }
                if (data.gameState.selectedEuroGroup) {
                    STATE.selectedEuroGroup = data.gameState.selectedEuroGroup;
                }
            } else {
                STATE.season = 1;
                STATE.history = [];
                STATE.newsFeed = [];
                STATE.userTeamId = null;
                STATE.leagueStats = { topScorers: [], topAssists: [], bestPlayers: [], awardsHistory: [] };
                STATE.userLineupSlots = Array(11).fill(null);
                STATE.cups = {};
                STATE.calendar = { currentWeek: 0, weeks: [] };
                STATE.europe = null;
            }

            STATE.allTeams = data.clubs.map(club => ({
                id: String(club.id),
                name: club.name || "Unknown Club",
                leagueId: club.leagueId || club.leagueName || "GLOBAL",
                leagueName: club.leagueName || "Global League",
                stadiumName: club.stadiumName || "Municipal Stadium",
                teamRating: club.teamRating || 0,
                points: club.points || 0,
                played: club.played || 0,
                wins: club.wins || 0,
                draws: club.draws || 0,
                losses: club.losses || 0,
                gf: club.gf || 0,
                ga: club.ga || 0,
                gd: club.gd || 0,
                budget: calculateBudget(club.budget || club.teamValue),
                color: club.color || generateColor(club.name || "Unknown"),
                squad: []
            }));

            data.players.forEach((player, index) => {
                // ИСПРАВЛЕНО: Строгая проверка clubId - null, undefined, '', '0', 0 -> free agent
                const rawClubId = player.clubId;
                const isValidClubId = rawClubId !== null && rawClubId !== undefined && rawClubId !== '' && rawClubId !== 0 && rawClubId !== '0' && String(rawClubId).trim() !== '';
                const team = isValidClubId ? STATE.allTeams.find(t => t.id === String(rawClubId)) : null;
                const isFreeAgent = !team || !isValidClubId || player.isFreeAgent === true;
                
                player.internalId = index;
                player.isStarter = isFreeAgent ? false : (player.isStarter || false);
                player.transferListed = player.transferListed || false;
                player.seasonGoals = player.seasonGoals || 0;
                player.seasonAssists = player.seasonAssists || 0;
                player.seasonRating = player.rating || 50;
                player.age = player.age || Math.floor(Math.random() * 15) + 18;
                player.careerGoals = player.careerGoals || 0;
                player.injuryWeeks = player.injuryWeeks || 0;
                player.isSuspended = player.isSuspended || false;
                player.suspensionPending = player.suspensionPending || false;
                player.speed = player.speed || 50;
                player.shot = player.shot || 50;
                player.pass = player.pass || 50;
                player.dribble = player.dribble || 50;
                player.clubId = isFreeAgent ? null : String(rawClubId);
                player.isFreeAgent = isFreeAgent;
                player.energy = player.energy !== undefined ? player.energy : 100;
                player.morale = player.morale !== undefined ? player.morale : 50;
                
                // Нормализация позиции при загрузке
                if (player.pos) {
                    player.pos = normalizePos(player.pos);
                } else {
                    player.pos = "MID";
                }
                
                if (player.potential === undefined) {
                    player.potential = player.rating + Math.floor(Math.random() * 10);
                }
                
                // ИСПРАВЛЕНО: Применяем clamp к цене при загрузке сейва (free agents - цена 0)
                if (isFreeAgent) {
                    player.price = 0;
                } else if (player.price !== undefined) {
                    player.price = clampMarketValue(Number(player.price) || MARKET_VALUE_MIN);
                } else {
                    player.price = clampMarketValue((player.rating || 50) * 100000);
                }

                if (isFreeAgent) {
                    // Добавляем в список свободных агентов
                    STATE.freeAgents.push(player);
                } else if (team) {
                    team.squad.push(player);
                }
            });

            if (data.gameState && STATE.userTeamId) {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        if (!team.squad.some(p => p.isStarter)) autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                const userTeam = getTeam(STATE.userTeamId);
                if (userTeam) {
                    STATE.activeLeagueTeams = STATE.allTeams.filter(t => t.leagueId === userTeam.leagueId);
                }
                
                // Если нет календаря, инициализируем его
                if (!STATE.calendar.weeks.length) {
                    initLeagueCup();
                    initCalendar();
                }
                
                renderDashboard();
            } else {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                LogoManager.preloadLogos(STATE.allTeams).catch(e => console.warn('Logo preload failed:', e));
                renderTeamSelection();
            }
        }


        // Подготовка данных для сохранения
        function prepareSaveData() {
            return {
                gameState: {
                    season: STATE.season,
                    history: STATE.history,
                    newsFeed: STATE.newsFeed,
                    schedule: STATE.schedule,
                    userTeamId: STATE.userTeamId,
                    userLeagueId: STATE.userLeagueId,
                    leagueStats: STATE.leagueStats,
                    userLineupSlots: STATE.userLineupSlots,
                    cups: STATE.cups,
                    calendar: STATE.calendar,
                    europe: STATE.europe,
                    tableView: STATE.tableView,
                    selectedEuroGroup: STATE.selectedEuroGroup
                },
                clubs: STATE.allTeams.map(t => {
                    const { squad, ...rest } = t;
                    return rest;
                }),
                players: STATE.allTeams.flatMap(t => t.squad).map(p => ({
                    ...p,
                    endContract: p.endContract,
                    salary: p.salary
                })),
                freeAgents: STATE.freeAgents,
                leagues: Array.from(STATE.leaguesMap.entries()).map(([id, league]) => ({
                    id: id,
                    name: league.name,
                    division: league.division,
                    nation: league.nation,
                    promotions: league.promotions,
                    directPromotions: league.directPromotions,
                    relegations: league.relegations
                }))
            };
        }

        // Старая функция saveGame - теперь открывает меню слотов
        function saveGame() {
            showSaveLoadMenu('save');
        }
        
        // Быстрое автосохранение в слот 1 (для автосохранения)
        async function quickSave() {
            const saveData = prepareSaveData();
            const success = await window.StorageManager.saveToSlot(1, saveData);
            if (success) {
                window.ModAPI?.showNotification('💾 Auto-saved successfully', 2000, 'success');
            }
        }
        
        // Сохранение в конкретный слот
        async function saveToSlot(slotNumber) {
            const saveData = prepareSaveData();
            const success = await window.StorageManager.saveToSlot(slotNumber, saveData);
            
            if (success) {
                window.ModAPI?.showNotification(`💾 Saved to slot ${slotNumber}`, 2000, 'success');
                closeSaveLoadMenu();
            } else {
                window.ModAPI?.showNotification('❌ Save error', 3000, 'error');
            }
        }
        
        // Загрузка из слота
        async function loadFromSlot(slotNumber) {
            const slotData = await window.StorageManager.loadSlot(slotNumber);
            
            if (!slotData || !slotData.data) {
                window.ModAPI?.showNotification('❌ Slot is empty', 2000, 'error');
                return;
            }
            
            // Загружаем данные через существующую функцию
            try {
                processNewJsonFormat(slotData.data);
                closeSaveLoadMenu();
                window.ModAPI?.showNotification('✅ Game loaded', 2000, 'success');
            } catch (e) {
                console.error('Load error:', e);
                window.ModAPI?.showNotification('❌ Load error: ' + e.message, 3000, 'error');
            }
        }
        
        // Delete slot
        async function deleteSlot(slotNumber) {
            if (!confirm(`Delete save from slot ${slotNumber}?`)) return;
            
            await window.StorageManager.deleteSlot(slotNumber);
            window.ModAPI?.showNotification('🗑️ Slot cleared', 2000, 'info');
            refreshSaveLoadMenu();
        }
        
        // Show save/load menu
        async function showSaveLoadMenu(mode = 'save') {
            const overlay = document.getElementById('save-load-overlay');
            if (!overlay) {
                // Create overlay if it doesn't exist
                createSaveLoadOverlay();
            }
            
            const slots = await window.StorageManager.getSaveSlots();
            
            const slotsContainer = document.getElementById('save-slots-container');
            const titleEl = document.getElementById('save-load-title');
            
            titleEl.textContent = mode === 'save' ? '💾 SAVE GAME' : '📂 LOAD GAME';
            document.getElementById('save-load-overlay').dataset.mode = mode;
            
            slotsContainer.innerHTML = slots.map(slot => {
                const isEmpty = slot.isEmpty;
                const dateStr = slot.savedAt ? new Date(slot.savedAt).toLocaleString('en-US') : '';
                
                return `
                    <div class="flex items-center justify-between p-4 rounded-xl ${isEmpty ? 'bg-slate-800/30 border border-slate-700/50' : 'bg-gradient-to-r from-slate-800/80 to-slate-700/80 border border-emerald-500/30'}">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center ${isEmpty ? 'bg-slate-700' : 'bg-emerald-600'} text-white font-black text-lg">
                                ${slot.slot}
                            </div>
                            <div>
                                ${isEmpty ? `
                                    <div class="text-slate-500 font-bold">Empty slot</div>
                                ` : `
                                    <div class="text-white font-bold">${slot.teamName}</div>
                                    <div class="text-slate-400 text-sm">Season ${slot.season} • Week ${slot.week}</div>
                                    <div class="text-slate-500 text-xs">${slot.leagueName} • ${dateStr}</div>
                                `}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${mode === 'save' ? `
                                <button onclick="saveToSlot(${slot.slot})" class="px-4 py-2 rounded-lg ${isEmpty ? 'bg-emerald-600 hover:bg-emerald-500' : 'bg-amber-600 hover:bg-amber-500'} text-white font-bold text-sm transition-colors">
                                    ${isEmpty ? 'Save' : 'Overwrite'}
                                </button>
                            ` : `
                                ${!isEmpty ? `
                                    <button onclick="loadFromSlot(${slot.slot})" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-sm transition-colors">
                                        Load
                                    </button>
                                ` : ''}
                            `}
                            ${!isEmpty ? `
                                <button onclick="deleteSlot(${slot.slot})" class="px-3 py-2 rounded-lg bg-red-600/20 hover:bg-red-600/40 text-red-400 font-bold text-sm transition-colors">
                                    🗑️
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('save-load-overlay').classList.remove('hidden');
        }
        
        function closeSaveLoadMenu() {
            document.getElementById('save-load-overlay')?.classList.add('hidden');
        }
        
        async function refreshSaveLoadMenu() {
            const mode = document.getElementById('save-load-overlay')?.dataset?.mode || 'save';
            await showSaveLoadMenu(mode);
        }
        
        function createSaveLoadOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'save-load-overlay';
            overlay.className = 'fixed inset-0 z-[9999] bg-black/90 flex items-center justify-center hidden';
            overlay.innerHTML = `
                <div class="bg-slate-900 rounded-2xl p-6 max-w-xl w-full mx-4 border border-white/10 shadow-2xl max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="save-load-title" class="text-2xl font-black text-white uppercase tracking-wider">💾 SAVE GAME</h2>
                        <button onclick="closeSaveLoadMenu()" class="w-10 h-10 rounded-full bg-slate-800 hover:bg-red-500/20 flex items-center justify-center text-slate-400 hover:text-red-400 transition-colors">
                            ✕
                        </button>
                    </div>
                    <div id="save-slots-container" class="space-y-3">
                        <div class="text-center text-slate-500 py-8">Loading slots...</div>
                    </div>
                    <div class="mt-6 flex justify-between items-center">
                        <button onclick="exportSaveToFile()" class="text-slate-400 hover:text-white text-sm font-bold transition-colors">
                            📤 Export to file
                        </button>
                        <button onclick="importSaveFromFile()" class="text-slate-400 hover:text-white text-sm font-bold transition-colors">
                            📥 Import from file
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        // Export to file
        function exportSaveToFile() {
            const saveData = prepareSaveData();
            const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `fm_save_season${STATE.season}_week${STATE.calendar.currentWeek + 1}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
            window.ModAPI?.showNotification('📤 Save exported', 2000, 'success');
        }
        
        // Import from file
        function importSaveFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        processNewJsonFormat(data);
                        closeSaveLoadMenu();
                        window.ModAPI?.showNotification('✅ Save imported successfully', 2000, 'success');
                    } catch (err) {
                        window.ModAPI?.showNotification('❌ Import error: ' + err.message, 3000, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // Открыть меню загрузки
        function loadGame() {
            showSaveLoadMenu('load');
        }

        function calculateTeamRating(team) {
            let totalRating = 0;
            let count = 0;
            
            if (team.id === STATE.userTeamId) {
                STATE.userLineupSlots.forEach(slotId => {
                    if (slotId !== null) {
                        const player = team.squad.find(p => p.internalId === slotId);
                        if (player) {
                            totalRating += player.rating;
                            count++;
                        }
                    }
                });
            } else {
                const starters = team.squad.filter(p => p.isStarter);
                starters.forEach(p => {
                    totalRating += p.rating;
                    count++;
                });
            }
            
            if (count > 0) {
                team.teamRating = Math.round(totalRating / count);
            } else {
                team.teamRating = 50;
            }
        }

        function calculateLeagueStats() {
            const allPlayers = [];
            
            STATE.activeLeagueTeams.forEach(team => {
                team.squad.forEach(player => {
                    allPlayers.push({
                        ...player,
                        teamName: team.name,
                        teamColor: team.color
                    });
                });
            });
            
            // IMPROVED: Better sorting with tiebreakers
            STATE.leagueStats.topScorers = [...allPlayers]
                .filter(p => p.seasonGoals > 0)
                .sort((a, b) => {
                    if (b.seasonGoals !== a.seasonGoals) return b.seasonGoals - a.seasonGoals;
                    if (b.seasonAssists !== a.seasonAssists) return b.seasonAssists - a.seasonAssists;
                    return (b.seasonRating || 0) - (a.seasonRating || 0);
                })
                .slice(0, 10);
            
            STATE.leagueStats.topAssists = [...allPlayers]
                .filter(p => p.seasonAssists > 0)
                .sort((a, b) => {
                    if (b.seasonAssists !== a.seasonAssists) return b.seasonAssists - a.seasonAssists;
                    if (b.seasonGoals !== a.seasonGoals) return b.seasonGoals - a.seasonGoals;
                    return (b.seasonRating || 0) - (a.seasonRating || 0);
                })
                .slice(0, 10);
            
            // FIXED: Best players - no minimum match requirement at season end
            // Instead, use contribution score that factors in games played
            const maxPlayed = Math.max(...STATE.activeLeagueTeams.map(t => t.played || 1));
            
            STATE.leagueStats.bestPlayers = [...allPlayers]
                .filter(p => (p.seasonRating || 0) > 0 || (p.seasonGoals || 0) > 0)
                .sort((a, b) => {
                    const teamA = getTeam(a.clubId);
                    const teamB = getTeam(b.clubId);
                    const matchesA = teamA?.played || 1;
                    const matchesB = teamB?.played || 1;
                    
                    // Calculate contribution score - weighs consistency and impact
                    const aBase = (a.seasonRating || 60) + (a.seasonGoals || 0) * 3 + (a.seasonAssists || 0) * 2;
                    const bBase = (b.seasonRating || 60) + (b.seasonGoals || 0) * 3 + (b.seasonAssists || 0) * 2;
                    
                    // Small bonus for players whose team played more games
                    const aTotal = aBase * (0.8 + (matchesA / maxPlayed) * 0.2);
                    const bTotal = bBase * (0.8 + (matchesB / maxPlayed) * 0.2);
                    
                    return bTotal - aTotal;
                })
                .slice(0, 10);
        }

        // ИСПРАВЛЕНО: updatePlayerPrice теперь НЕ пересчитывает цену от рейтинга
        // Цена меняется ТОЛЬКО при изменении рейтинга (upgrade/downgrade) - небольшая корректировка
        // Или при сезонной инфляции ≤3%
        function updatePlayerPrice(player, reason = 'rating_change') {
            // НЕ ТРОГАЕМ цену если нет явной причины
            if (reason === 'none') return;
            
            const currentPrice = player.price || MARKET_VALUE_MIN;
            
            if (reason === 'rating_change') {
                // При изменении рейтинга: ±5% за каждую единицу изменения рейтинга
                // Это НЕ вызывается каждый матч, только при реальном изменении overall
                // Сейчас просто оставляем цену как есть - изменения рейтинга минимальны
                return;
            }
            
            if (reason === 'season_inflation') {
                // Сезонная инфляция ≤3%
                const inflationRate = 1 + (Math.random() * 0.03); // 0-3%
                player.price = clampMarketValue(Math.round(currentPrice * inflationRate));
            }
        }

        function showPlayerStats() {
            calculateLeagueStats();
            
            const overlay = document.getElementById('player-stats-overlay');
            const content = document.getElementById('player-stats-content');
            
            content.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl md:text-3xl font-black text-white mb-2">Season ${STATE.season} Statistics</h2>
                    <p class="text-slate-400 text-sm">Top performers in ${STATE.activeLeagueTeams[0]?.leagueName || 'the league'}</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
                    <div class="bg-slate-800/50 rounded-xl p-4 md:p-6 border border-slate-700">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center award-badge">
                                <span class="text-lg">⚽</span>
                            </div>
                            <h3 class="text-lg md:text-xl font-bold text-white">Golden Boot</h3>
                        </div>
                        <div class="space-y-3">
                            ${STATE.leagueStats.topScorers.length > 0 ? 
                                STATE.leagueStats.topScorers.map((player, index) => `
                                    <div class="flex items-center justify-between p-3 rounded-lg ${index === 0 ? 'bg-yellow-500/10 border border-yellow-500/30' : 'bg-slate-900/50 hover:bg-slate-900/80'}">
                                        <div class="flex items-center gap-3">
                                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : 'bg-slate-700'}">
                                                ${index + 1}
                                            </span>
                                            <div>
                                                <div class="font-bold text-slate-200 text-sm">${player.name}</div>
                                                <div class="text-xs text-slate-400">${player.teamName}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg md:text-xl font-black text-white">${player.seasonGoals}</div>
                                            <div class="text-xs text-slate-400">goals</div>
                                        </div>
                                    </div>
                                `).join('') :
                                '<div class="text-center text-slate-500 py-4">No goals scored yet</div>'
                            }
                        </div>
                    </div>
                    
                    <div class="bg-slate-800/50 rounded-xl p-4 md:p-6 border border-slate-700">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center award-badge">
                                <span class="text-lg">🎯</span>
                            </div>
                            <h3 class="text-lg md:text-xl font-bold text-white">Playmaker</h3>
                        </div>
                        <div class="space-y-3">
                            ${STATE.leagueStats.topAssists.length > 0 ? 
                                STATE.leagueStats.topAssists.map((player, index) => `
                                    <div class="flex items-center justify-between p-3 rounded-lg ${index === 0 ? 'bg-yellow-500/10 border border-yellow-500/30' : 'bg-slate-900/50 hover:bg-slate-900/80'}">
                                        <div class="flex items-center gap-3">
                                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : 'bg-slate-700'}">
                                                ${index + 1}
                                            </span>
                                            <div>
                                                <div class="font-bold text-slate-200 text-sm">${player.name}</div>
                                                <div class="text-xs text-slate-400">${player.teamName}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg md:text-xl font-black text-white">${player.seasonAssists}</div>
                                            <div class="text-xs text-slate-400">assists</div>
                                        </div>
                                    </div>
                                `).join('') :
                                '<div class="text-center text-slate-500 py-4">No assists yet</div>'
                            }
                        </div>
                    </div>
                    
                    <div class="bg-slate-800/50 rounded-xl p-4 md:p-6 border border-slate-700">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center award-badge">
                                <span class="text-lg">🏆</span>
                            </div>
                            <h3 class="text-lg md:text-xl font-bold text-white">Best Players</h3>
                        </div>
                        <div class="space-y-3">
                            ${STATE.leagueStats.bestPlayers.length > 0 ? 
                                STATE.leagueStats.bestPlayers.map((player, index) => `
                                    <div class="flex items-center justify-between p-3 rounded-lg ${index === 0 ? 'bg-yellow-500/10 border border-yellow-500/30' : 'bg-slate-900/50 hover:bg-slate-900/80'}">
                                        <div class="flex items-center gap-3">
                                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : 'bg-slate-700'}">
                                                ${index + 1}
                                            </span>
                                            <div>
                                                <div class="font-bold text-slate-200 text-sm">${player.name}</div>
                                                <div class="text-xs text-slate-400">${player.teamName} • ${player.pos}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-black text-white">${Math.round(player.seasonRating)}</div>
                                            <div class="text-xs text-slate-400">rating</div>
                                        </div>
                                    </div>
                                `).join('') :
                                '<div class="text-center text-slate-500 py-4">Not enough matches played</div>'
                            }
                        </div>
                    </div>
                </div>
                
                <div class="bg-slate-800/30 rounded-xl p-4 md:p-6 border border-slate-700">
                    <h3 class="text-lg md:text-xl font-bold text-white mb-4">Previous Awards</h3>
                    <div class="space-y-4">
                        ${STATE.leagueStats.awardsHistory.length > 0 ? 
                            STATE.leagueStats.awardsHistory.map(award => `
                                <div class="bg-slate-900/50 p-3 md:p-4 rounded-lg">
                                    <div class="text-base md:text-lg font-bold text-slate-300 mb-2">Season ${award.season}</div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div class="flex items-center gap-2">
                                            <span class="text-yellow-400">⚽</span>
                                            <span class="text-slate-400">Golden Boot:</span>
                                            <span class="font-bold text-white text-sm">${award.goldenBoot?.player || 'N/A'}</span>
                                            <span class="text-slate-500 text-xs">(${award.goldenBoot?.goals || 0})</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-yellow-400">🎯</span>
                                            <span class="text-slate-400">Playmaker:</span>
                                            <span class="font-bold text-white text-sm">${award.playmaker?.player || 'N/A'}</span>
                                            <span class="text-slate-500 text-xs">(${award.playmaker?.assists || 0})</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-yellow-400">🏆</span>
                                            <span class="text-slate-400">Player of the Season:</span>
                                            <span class="font-bold text-white text-sm">${award.bestPlayer?.player || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('') :
                            '<div class="text-center text-slate-500 py-4">No previous awards</div>'
                        }
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="document.getElementById('player-stats-overlay').classList.add('hidden')" 
                            class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg text-sm">
                        Close
                    </button>
                </div>
            `;
            
            overlay.classList.remove('hidden');
        }

        function giveSeasonAwards() {
            calculateLeagueStats();
            
            const topScorer = STATE.leagueStats.topScorers[0];
            const topAssist = STATE.leagueStats.topAssists[0];
            const bestPlayer = STATE.leagueStats.bestPlayers[0];
            
            const seasonAward = {
                season: STATE.season,
                goldenBoot: topScorer ? {
                    player: topScorer.name,
                    team: getTeam(topScorer.clubId)?.name,
                    goals: topScorer.seasonGoals
                } : null,
                playmaker: topAssist ? {
                    player: topAssist.name,
                    team: getTeam(topAssist.clubId)?.name,
                    assists: topAssist.seasonAssists
                } : null,
                bestPlayer: bestPlayer ? {
                    player: bestPlayer.name,
                    team: getTeam(bestPlayer.clubId)?.name,
                    rating: Math.round(bestPlayer.seasonRating)
                } : null
            };
            
            STATE.leagueStats.awardsHistory.unshift(seasonAward);
            if (STATE.leagueStats.awardsHistory.length > 10) {
                STATE.leagueStats.awardsHistory.pop();
            }
            
            if (topScorer && topScorer.seasonGoals > 0) {
                addNews(
                    'Season Awards',
                    `${topScorer.name} wins the Golden Boot with ${topScorer.seasonGoals} goals!`,
                    'award'
                );
            }
            
            if (topAssist && topAssist.seasonAssists > 0) {
                addNews(
                    'Season Awards',
                    `${topAssist.name} wins the Playmaker award with ${topAssist.seasonAssists} assists!`,
                    'award'
                );
            }
            
            if (bestPlayer) {
                addNews(
                    'Season Awards',
                    `${bestPlayer.name} is the Player of the Season with a ${Math.round(bestPlayer.seasonRating)} rating!`,
                    'award'
                );
            }
            
            if (topScorer) {
                const team = getTeam(topScorer.clubId);
                if (team) {
                    const bonus = 1000000 * Math.max(1, Math.floor(topScorer.seasonGoals / 5));
                    team.budget += bonus;
                    addNews(
                        'Player Bonus',
                        `${topScorer.name} receives ${formatMoney(bonus)} bonus for winning the Golden Boot!`,
                        'info'
                    );
                }
            }
            
            if (topAssist) {
                const team = getTeam(topAssist.clubId);
                if (team) {
                    const bonus = 500000 * Math.max(1, Math.floor(topAssist.seasonAssists / 3));
                    team.budget += bonus;
                    addNews(
                        'Player Bonus',
                        `${topAssist.name} receives ${formatMoney(bonus)} bonus for winning the Playmaker award!`,
                        'info'
                    );
                }
            }
            
            if (bestPlayer) {
                const team = getTeam(bestPlayer.clubId);
                if (team) {
                    const bonus = 2000000;
                    team.budget += bonus;
                    addNews(
                        'Player Bonus',
                        `${bestPlayer.name} receives ${formatMoney(bonus)} bonus for being Player of the Season!`,
                        'info'
                    );
                }
            }
        }

        function initSchedule() {
            const teamIds = STATE.activeLeagueTeams.map(t => t.id);
            if (teamIds.length < 2) return;
            STATE.schedule = generateFixtures(teamIds);
        }

        function generateFixtures(teamIds) {
            const fixtures = [];
            const teams = [...teamIds]; 
            if (teams.length % 2 !== 0) teams.push(null);
            
            const half = teams.length / 2;
            const home = teams.slice(0, half);
            const away = teams.slice(half).reverse();

            for (let round = 0; round < teams.length - 1; round++) {
                const weekMatches = [];
                for (let i = 0; i < home.length; i++) {
                    if (home[i] !== null && away[i] !== null) {
                        weekMatches.push({ home: home[i], away: away[i] });
                    }
                }
                fixtures.push(weekMatches);
                const lastHome = home.pop();
                const firstAway = away.shift();
                home.splice(1, 0, firstAway);
                away.push(lastHome);
            }
            
            const secondHalf = fixtures.map(week => week.map(m => ({ home: m.away, away: m.home })));
            return [...fixtures, ...secondHalf];
        }

        function getTeam(id) { 
            if (!id && id !== 0) return null;
            const idStr = String(id);
            return STATE.allTeams.find(t => String(t.id) === idStr); 
        }

        function processPromotionRelegation() {
            // Loan Return Logic: Return loaned players to parent clubs
            STATE.allTeams.forEach(team => {
                const loanedPlayers = team.squad.filter(p => p.onLoan && p.loanEndSeason <= STATE.season);
                
                loanedPlayers.forEach(player => {
                    const parentClub = getTeam(player.loanParentClub);
                    if (parentClub) {
                        // Remove from current team
                        team.squad = team.squad.filter(p => p.internalId !== player.internalId);
                        
                        // Return to parent club
                        player.clubId = parentClub.id;
                        player.onLoan = false;
                        player.loanParentClub = null;
                        player.loanEndSeason = null;
                        player.loanSalaryCost = null;
                        player.isStarter = false;
                        parentClub.squad.push(player);
                        
                        if (team.id === STATE.userTeamId) {
                            addNews('Loan Ended', `${player.name} returned to ${parentClub.name} after loan spell.`, 'info');
                        }
                    }
                });
            });
            
            // Contract Expiry Logic: Players with expired contracts become free agents
            STATE.allTeams.forEach(team => {
                const expiredPlayers = [];
                team.squad = team.squad.filter(player => {
                    if (player.endContract && player.endContract <= STATE.season) {
                        expiredPlayers.push(player);
                        return false;
                    }
                    return true;
                });

                expiredPlayers.forEach(p => {
                    p.clubId = null;
                    p.isFreeAgent = true;
                    p.transferListed = false;
                    STATE.freeAgents.push(p);
                    
                    if (team.id === STATE.userTeamId) {
                        addNews('Contract Expired', `${p.name}'s contract has expired. He is now a free agent.`, 'info');
                    }
                });
            });

            console.log("Processing promotion/relegation...");
            
            const userTeam = getTeam(STATE.userTeamId);
            const oldLeagueId = userTeam.leagueId;
            const oldLeagueInfo = STATE.leaguesMap.get(oldLeagueId) || { 
                name: userTeam.leagueName, 
                division: 1,
                promotions: 3,
                directPromotions: 3,
                relegations: 3
            };
            
            const leaguesByNation = {};
            
            STATE.leaguesMap.forEach((league, leagueId) => {
                if (!leaguesByNation[league.nation]) {
                    leaguesByNation[league.nation] = [];
                }
                leaguesByNation[league.nation].push({
                    id: leagueId,
                    ...league
                });
            });
            
            const promotedTeams = [];
            const relegatedTeams = [];
            
            for (const nation in leaguesByNation) {
                const leagues = leaguesByNation[nation];
                leagues.sort((a, b) => a.division - b.division);
                
                for (let i = 0; i < leagues.length - 1; i++) {
                    const upperLeague = leagues[i];
                    const lowerLeague = leagues[i + 1];
                    
                    const upperTeams = STATE.allTeams.filter(t => t.leagueId === upperLeague.id);
                    const lowerTeams = STATE.allTeams.filter(t => t.leagueId === lowerLeague.id);
                    
                    if (upperTeams.length === 0 || lowerTeams.length === 0) continue;
                    
                    const sortedUpperTeams = [...upperTeams].sort((a, b) => 
                        b.points - a.points || b.gd - a.gd || b.gf - a.gf
                    );
                    
                    const sortedLowerTeams = [...lowerTeams].sort((a, b) => 
                        b.points - a.points || b.gd - a.gd || b.gf - a.gf
                    );
                    
                    const relegationSpots = upperLeague.relegations || 3;
                    const promotionSpots = lowerLeague.promotions || 3;
                    const directPromotionSpots = lowerLeague.directPromotions || promotionSpots;
                    
                    const relegated = sortedUpperTeams.slice(-relegationSpots);
                    const promoted = sortedLowerTeams.slice(0, promotionSpots);
                    
                    relegated.forEach(team => {
                        console.log(`${team.name} relegated from ${upperLeague.name} to ${lowerLeague.name}`);
                        team.leagueId = lowerLeague.id;
                        team.leagueName = lowerLeague.name;
                        relegatedTeams.push({
                            team: team.name,
                            from: upperLeague.name,
                            to: lowerLeague.name,
                            divisionFrom: upperLeague.division,
                            divisionTo: lowerLeague.division
                        });
                    });
                    
                    promoted.forEach(team => {
                        console.log(`${team.name} promoted from ${lowerLeague.name} to ${upperLeague.name}`);
                        team.leagueId = upperLeague.id;
                        team.leagueName = upperLeague.name;
                        promotedTeams.push({
                            team: team.name,
                            from: lowerLeague.name,
                            to: upperLeague.name,
                            divisionFrom: lowerLeague.division,
                            divisionTo: upperLeague.division
                        });
                    });
                }
            }
            
            let userStatus = 'REMAIN';
            let userNewLeague = null;
            let userDivisionChange = null;
            
            const userPromoted = promotedTeams.find(p => p.team === userTeam.name);
            if (userPromoted) {
                userStatus = 'PROMOTED';
                userNewLeague = userPromoted.to;
                userDivisionChange = { from: userPromoted.divisionFrom, to: userPromoted.divisionTo };
                
                addNews(
                    'Promotion!',
                    `${userTeam.name} promoted from ${userPromoted.from} to ${userPromoted.to}!`,
                    'info'
                );
            }
            
            const userRelegated = relegatedTeams.find(r => r.team === userTeam.name);
            if (userRelegated) {
                userStatus = 'RELEGATED';
                userNewLeague = userRelegated.to;
                userDivisionChange = { from: userRelegated.divisionFrom, to: userRelegated.divisionTo };
                
                addNews(
                    'Relegation',
                    `${userTeam.name} relegated from ${userRelegated.from} to ${userRelegated.to}.`,
                    'info'
                );
            }
            
            if (userStatus === 'REMAIN') {
                userNewLeague = oldLeagueInfo.name;
                userDivisionChange = { from: oldLeagueInfo.division, to: oldLeagueInfo.division };
            }
            
            const otherPromoted = promotedTeams.filter(p => p.team !== userTeam.name);
            const otherRelegated = relegatedTeams.filter(r => r.team !== userTeam.name);
            
            if (otherPromoted.length > 0) {
                addNews(
                    'Promotions',
                    `${otherPromoted.length} team(s) promoted: ${otherPromoted.map(p => p.team).join(', ')}`,
                    'info'
                );
            }
            
            if (otherRelegated.length > 0) {
                addNews(
                    'Relegations',
                    `${otherRelegated.length} team(s) relegated: ${otherRelegated.map(r => r.team).join(', ')}`,
                    'info'
                );
            }
            
            updateLeagueGroups();
            
            return { 
                userStatus, 
                userNewLeague, 
                userDivisionChange,
                promotedTeams, 
                relegatedTeams 
            };
        }

        function updateLeagueGroups() {
            const userTeam = getTeam(STATE.userTeamId);
            if (userTeam) {
                const oldLeagueId = STATE.userLeagueId;
                const newLeagueId = userTeam.leagueId;
                
                // НОВОЕ: Если лига изменилась, удаляем старые LEAGUE события и пересобираем календарь
                if (oldLeagueId && oldLeagueId !== newLeagueId) {
                    console.log(`League changed from ${oldLeagueId} to ${newLeagueId}, rebuilding calendar...`);
                    removeOldLeagueEvents(oldLeagueId);
                }
                
                // Обновляем userLeagueId как источник истины
                STATE.userLeagueId = newLeagueId;
                STATE.activeLeagueTeams = STATE.allTeams.filter(t => t.leagueId === userTeam.leagueId);
            }
            
            STATE.allTeams.forEach(team => {
                team.points = 0;
                team.played = 0;
                team.wins = 0;
                team.draws = 0;
                team.losses = 0;
                team.gf = 0;
                team.ga = 0;
                team.gd = 0;
            });
            
            if (STATE.activeLeagueTeams.length >= 2) {
                initSchedule();
                initLeagueCup();
                initCalendar();
            }
        }
        
        // НОВОЕ: Удаление старых LEAGUE событий из календаря при смене лиги
        function removeOldLeagueEvents(oldLeagueId) {
            if (!STATE.calendar || !STATE.calendar.weeks) return;
            
            const currentWeekIndex = STATE.calendar.currentWeek;
            
            // Удаляем LEAGUE события из будущих недель (>= текущей)
            for (let i = currentWeekIndex; i < STATE.calendar.weeks.length; i++) {
                const week = STATE.calendar.weeks[i];
                if (!week.events) continue;
                
                // Фильтруем события, оставляя только CUP (удаляем LEAGUE)
                week.events = week.events.filter(event => event.type !== 'LEAGUE');
                
                // Если неделя без событий, можно её удалить или пометить
                // Оставляем пока, чтобы не ломать индексы
            }
            
            // Очищаем связанные результаты пользователя если есть
            for (let i = currentWeekIndex; i < STATE.calendar.weeks.length; i++) {
                const week = STATE.calendar.weeks[i];
                if (week.userResults) {
                    week.userResults = week.userResults.filter(r => r.type !== 'LEAGUE');
                }
            }
            
            console.log(`Removed old LEAGUE events from weeks ${currentWeekIndex} onwards`);
        }

        function simulateMatch(homeId, awayId) {
            const home = getTeam(homeId);
            const away = getTeam(awayId);

            // ModAPI: Trigger match start event
            if (window.ModAPI) {
                window.ModAPI.trigger('onMatchStart', { home, away });
            }

            if (home.id !== STATE.userTeamId) {
                if (home.squad.some(p => p.isStarter && (p.injuryWeeks > 0 || p.isSuspended))) {
                    autoSelectStarters(home);
                }
            }
            if (away.id !== STATE.userTeamId) {
                if (away.squad.some(p => p.isStarter && (p.injuryWeeks > 0 || p.isSuspended))) {
                    autoSelectStarters(away);
                }
            }

            calculateTeamRating(home);
            calculateTeamRating(away);

            // Рассчитываем факторы энергии и морали для обеих команд
            const homeFactors = calculateTeamFactors(home);
            const awayFactors = calculateTeamFactors(away);
            
            // Применяем факторы к рейтингам команд
            const adjustedHomeRating = home.teamRating * homeFactors.energyFactor * homeFactors.moraleFactor;
            const adjustedAwayRating = away.teamRating * awayFactors.energyFactor * awayFactors.moraleFactor;

            STATE.matchRedCards.clear();
            STATE.matchRedCards.set(homeId, { count: 0, minute: null });
            STATE.matchRedCards.set(awayId, { count: 0, minute: null });

            const ratingDiff = adjustedHomeRating - adjustedAwayRating;
            const homeAdvantage = 6; // Увеличенное преимущество дома

            // УЛУЧШЕНО: Более реалистичная модель голов на основе распределения Пуассона
            // Базовые лямбды для Пуассона (среднее число голов)
            const baseLambdaHome = 1.45; // Средние голы для дома
            const baseLambdaAway = 1.15; // Средние голы для гостей
            
            // Модификатор на основе разницы рейтингов (-30 до +30 => 0.5x - 2x)
            const ratingModifier = 1 + (ratingDiff + homeAdvantage) * 0.015;
            
            let lambdaHome = Math.max(0.3, baseLambdaHome * Math.max(0.5, Math.min(2.0, ratingModifier)));
            let lambdaAway = Math.max(0.3, baseLambdaAway * Math.max(0.5, Math.min(2.0, 2 - ratingModifier)));

            // Функция генерации числа по Пуассону
            const poissonRandom = (lambda) => {
                let L = Math.exp(-lambda);
                let k = 0;
                let p = 1;
                do {
                    k++;
                    p *= Math.random();
                } while (p > L);
                return k - 1;
            };

            // Генерируем голы по Пуассону с ограничением (реалистичные результаты)
            let scoreHome = Math.min(7, poissonRandom(lambdaHome));
            let scoreAway = Math.min(6, poissonRandom(lambdaAway));
            
            // НОВОЕ: Редкие события (сенсации)
            // 3% шанс на сенсацию если аутсайдер
            if (ratingDiff > 15 && Math.random() < 0.03) {
                // Аутсайдер забивает больше
                scoreAway = Math.min(5, scoreAway + 1 + Math.floor(Math.random() * 2));
            } else if (ratingDiff < -15 && Math.random() < 0.03) {
                // Фаворит проигрывает
                scoreHome = Math.min(5, scoreHome + 1 + Math.floor(Math.random() * 2));
            }

            // Владение мячом
            let possHome = 50 + (ratingDiff + homeAdvantage) * 0.5;
            possHome = Math.floor(Math.max(30, Math.min(70, possHome + (Math.random() * 10 - 5))));
            const possAway = 100 - possHome;

            // Удары (зависят от голов и рейтинга)
            const shotsHome = Math.floor(scoreHome * 2.5 + (adjustedHomeRating/12) + Math.random() * 6);
            const shotsAway = Math.floor(scoreAway * 2.5 + (adjustedAwayRating/12) + Math.random() * 6);

            const matchEvents = [];
            const scorersHome = processGoals(home, scoreHome, matchEvents);
            const scorersAway = processGoals(away, scoreAway, matchEvents);

            // Передаём средние энергии для возможного увеличения травм
            processIncidents(home, matchEvents, homeFactors.avgEnergy);
            processIncidents(away, matchEvents, awayFactors.avgEnergy);

            const homeRedCards = STATE.matchRedCards.get(homeId)?.count || 0;
            const awayRedCards = STATE.matchRedCards.get(awayId)?.count || 0;

            // Счёт НЕ модифицируется красными карточками!
            const finalScoreHome = scoreHome;
            const finalScoreAway = scoreAway;
            
            // Только владение и удары могут меняться (для статистики)
            let adjustedShotsHome = shotsHome;
            let adjustedShotsAway = shotsAway;
            let adjustedPossHome = possHome;
            let adjustedPossAway = possAway;

            if (homeRedCards > 0) {
                const penalty = Math.pow(RED_CARD_TEAM_PENALTY, homeRedCards);
                adjustedShotsHome = Math.floor(adjustedShotsHome * penalty);
                adjustedPossHome = Math.floor(adjustedPossHome * penalty);
                
                const boost = Math.pow(RED_CARD_OPPONENT_BOOST, homeRedCards);
                adjustedShotsAway = Math.floor(adjustedShotsAway * boost);
                adjustedPossAway = 100 - adjustedPossHome;
            }

            if (awayRedCards > 0) {
                const penalty = Math.pow(RED_CARD_TEAM_PENALTY, awayRedCards);
                adjustedShotsAway = Math.floor(adjustedShotsAway * penalty);
                adjustedPossAway = Math.floor(adjustedPossAway * penalty);
                
                const boost = Math.pow(RED_CARD_OPPONENT_BOOST, awayRedCards);
                adjustedShotsHome = Math.floor(adjustedShotsHome * boost);
                adjustedPossHome = 100 - adjustedPossAway;
            }

            adjustedShotsHome = Math.max(0, adjustedShotsHome);
            adjustedShotsAway = Math.max(0, adjustedShotsAway);
            adjustedPossHome = Math.max(20, Math.min(80, adjustedPossHome));
            adjustedPossAway = 100 - adjustedPossHome;

            if (home.id === STATE.userTeamId || away.id === STATE.userTeamId) {
                matchEvents.push(...generateCommentary(home, away, finalScoreHome, finalScoreAway, scorersHome, scorersAway, homeRedCards, awayRedCards));
            }

            updatePlayerRatings(home, away, finalScoreHome, finalScoreAway);

            const matchResult = { 
                homeId, awayId, 
                homeGoals: finalScoreHome, 
                awayGoals: finalScoreAway,
                stats: { 
                    possHome: adjustedPossHome, 
                    possAway: adjustedPossAway, 
                    shotsHome: adjustedShotsHome, 
                    shotsAway: adjustedShotsAway, 
                    scorersHome, 
                    scorersAway,
                    redCardsHome: homeRedCards,
                    redCardsAway: awayRedCards
                },
                events: matchEvents.sort(() => Math.random() - 0.5) 
            };

            STATE.matchRedCards.clear();

            // ModAPI: Trigger match end event
            if (window.ModAPI) {
                window.ModAPI.trigger('onMatchEnd', matchResult);
            }

            return matchResult;
        }

        // НОВОЕ: Расчёт факторов энергии и морали команды
        function calculateTeamFactors(team) {
            const starters = team.squad.filter(p => p.isStarter);
            if (starters.length === 0) return { energyFactor: 1, moraleFactor: 1, avgEnergy: 100, avgMorale: 50 };
            
            const totalEnergy = starters.reduce((sum, p) => sum + (p.energy ?? 100), 0);
            const totalMorale = starters.reduce((sum, p) => sum + (p.morale ?? 50), 0);
            
            const avgEnergy = totalEnergy / starters.length;
            const avgMorale = totalMorale / starters.length;
            
            // energyFactor: 0.75 + 0.25*(avgEnergy/100) => (0.75..1.0)
            const energyFactor = 0.75 + 0.25 * (avgEnergy / 100);
            // moraleFactor: 0.85 + 0.30*(avgMorale/100) => (0.85..1.15)
            const moraleFactor = 0.85 + 0.30 * (avgMorale / 100);
            
            return { energyFactor, moraleFactor, avgEnergy, avgMorale };
        }

        // НОВОЕ: Обновление энергии и морали после матча
        function updateEnergyMorale(team, isUserTeam, matchResult, scorers) {
            const starters = team.squad.filter(p => p.isStarter);
            const bench = team.squad.filter(p => !p.isStarter);
            
            // Определяем результат для команды
            const isHome = matchResult.homeId === team.id;
            const teamGoals = isHome ? matchResult.homeGoals : matchResult.awayGoals;
            const oppGoals = isHome ? matchResult.awayGoals : matchResult.homeGoals;
            
            let resultType = 'draw';
            if (teamGoals > oppGoals) resultType = 'win';
            else if (teamGoals < oppGoals) resultType = 'loss';
            
            // Обновляем стартеров
            starters.forEach(p => {
                // Энергия: стартеры теряют 10-18
                const energyLoss = Math.floor(Math.random() * 9) + 10;
                p.energy = Math.max(0, Math.min(100, (p.energy ?? 100) - energyLoss));
                
                // Мораль по результату
                if (resultType === 'win') {
                    p.morale = Math.max(0, Math.min(100, (p.morale ?? 50) + 4));
                } else if (resultType === 'draw') {
                    p.morale = Math.max(0, Math.min(100, (p.morale ?? 50) + 1));
                } else {
                    p.morale = Math.max(0, Math.min(100, (p.morale ?? 50) - 4));
                }
            });
            
            // Обновляем скамейку
            bench.forEach(p => {
                // Энергия: не игравшие восстанавливают 8-14
                const energyGain = Math.floor(Math.random() * 7) + 8;
                p.energy = Math.max(0, Math.min(100, (p.energy ?? 100) + energyGain));
                
                // Мораль скамейки меньше зависит от результата
                if (resultType === 'win') {
                    p.morale = Math.max(0, Math.min(100, (p.morale ?? 50) + 2));
                } else if (resultType === 'draw') {
                    p.morale = Math.max(0, Math.min(100, (p.morale ?? 50) + 1));
                } else {
                    p.morale = Math.max(0, Math.min(100, (p.morale ?? 50) - 2));
                }
            });
            
            // Персональные бонусы за голы/ассисты
            if (scorers && scorers.length > 0) {
                scorers.forEach(scorer => {
                    const player = team.squad.find(p => p.internalId === scorer.internalId);
                    if (player) {
                        if (scorer.isAssist) {
                            player.morale = Math.max(0, Math.min(100, (player.morale ?? 50) + 1));
                        } else {
                            player.morale = Math.max(0, Math.min(100, (player.morale ?? 50) + 2));
                        }
                    }
                });
            }
            
            // Красные карточки
            team.squad.forEach(p => {
                if (p.suspensionPending || p.isSuspended) {
                    p.morale = Math.max(0, Math.min(100, (p.morale ?? 50) - 8));
                }
            });
        }

        function processIncidents(team, events, avgEnergy) {
            const starters = team.squad.filter(p => p.isStarter);
            
            // НОВОЕ: увеличенный шанс травм при низкой энергии
            let injuryChanceModifier = 1.0;
            if (avgEnergy !== undefined && avgEnergy < 55) {
                // Повышаем шанс травм при низкой энергии (до +50% при 0 энергии)
                injuryChanceModifier = 1 + (0.5 * (1 - avgEnergy / 55));
            }
            
            const adjustedInjuryChance = INJURY_CHANCE * injuryChanceModifier;
            
            starters.forEach(p => {
                if (Math.random() < adjustedInjuryChance) {
                    p.injuryWeeks = Math.floor(Math.random() * 5) + 1;
                    events.push(`INJURY: ${p.name} (${team.name}) limps off! Out for ${p.injuryWeeks} weeks.`);
                    if (team.id === STATE.userTeamId) {
                        addNews('Medical Report', `${p.name} injured for ${p.injuryWeeks} weeks`, 'injury');
                    }
                }
                else if (Math.random() < 0.005) {
                    p.suspensionPending = true;
                    const redCardData = STATE.matchRedCards.get(team.id) || { count: 0, minute: Math.floor(Math.random() * 90) };
                    redCardData.count++;
                    redCardData.minute = redCardData.minute || Math.floor(Math.random() * 90);
                    STATE.matchRedCards.set(team.id, redCardData);
                    
                    events.push(`RED CARD! ${p.name} (${team.name}) is sent off in minute ${redCardData.minute}! Team down to ${10 - redCardData.count} players.`);
                    if (team.id === STATE.userTeamId) {
                        addNews('Disciplinary', `${p.name} received a Red Card. Suspended for 1 match.`, 'injury');
                    }
                }
            });
        }

        function generateCommentary(home, away, sHome, sAway, scHome, scAway, homeRedCards, awayRedCards) {
            const lines = [];
            lines.push(`KICK OFF at ${home.stadiumName}!`);
            
            if (homeRedCards > 0) {
                lines.push(`${home.name} playing with ${11 - homeRedCards} men due to red card(s)!`);
            }
            if (awayRedCards > 0) {
                lines.push(`${away.name} playing with ${11 - awayRedCards} men due to red card(s)!`);
            }
            
            // Collect all goal events with their minutes and sort by minute
            const goalEvents = [];
            scHome.forEach(p => {
                if (!p.isAssist && p.minute) {
                    goalEvents.push({ minute: p.minute, text: `${p.minute}' ⚽ GOAL! ${p.name} scores for ${home.name}!` });
                }
            });
            scAway.forEach(p => {
                if (!p.isAssist && p.minute) {
                    goalEvents.push({ minute: p.minute, text: `${p.minute}' ⚽ GOAL! ${p.name} scores for ${away.name}!` });
                }
            });
            
            // Sort by minute and add to lines
            goalEvents.sort((a, b) => a.minute - b.minute);
            goalEvents.forEach(e => lines.push(e.text));
            
            const keepers = [...home.squad.filter(p=>p.isStarter && posGroup(p.pos) === 'GK'), ...away.squad.filter(p=>p.isStarter && posGroup(p.pos) === 'GK')];
            if(keepers.length > 0) lines.push(`Great save by ${keepers[Math.floor(Math.random()*keepers.length)].name}!`);
            lines.push("End to end stuff here!");
            lines.push("The manager is shouting instructions from the touchline.");
            
            if (homeRedCards > 0 && sHome < sAway) {
                lines.push(`${home.name} struggling with a man down!`);
            }
            if (awayRedCards > 0 && sAway < sHome) {
                lines.push(`${away.name} struggling with a man down!`);
            }
            
            return lines;
        }

        // FIX #6: Goals are now properly sorted by minute to avoid timeline bugs
        function processGoals(team, goalCount, events) {
            const scorers = [];
            const starters = team.squad.filter(p => p.isStarter);
            if (starters.length === 0) return scorers;

            // More realistic goal minutes (not uniform random):
            // - fewer in first 15
            // - more around 30-45 and especially 60-90
            // - still sorted for timeline correctness
            const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const sampleGoalMinute = () => {
                const r = Math.random();
                // Segment weights: 1-15 (10%), 16-45 (30%), 46-75 (35%), 76-90 (25%)
                if (r < 0.10) return randInt(1, 15);
                if (r < 0.40) return randInt(16, 45);
                if (r < 0.75) return randInt(46, 75);
                return randInt(76, 90);
            };

            const goalMinutes = Array.from({ length: goalCount }, () => sampleGoalMinute())
                .sort((a, b) => a - b);

            // Reduce unrealistic stacking on the same minute
            for (let i = 1; i < goalMinutes.length; i++) {
                if (goalMinutes[i] <= goalMinutes[i - 1]) goalMinutes[i] = goalMinutes[i - 1] + 1;
                if (goalMinutes[i] - goalMinutes[i - 1] < 2 && Math.random() < 0.7) {
                    goalMinutes[i] = goalMinutes[i - 1] + 2;
                }
                goalMinutes[i] = Math.min(90, goalMinutes[i]);
            }

            for (let i = 0; i < goalCount; i++) {
                const weightedPool = [];
                starters.forEach(p => {
                    const weight = POS_SCORING_WEIGHT[getPosCategory(p.pos)] || 1;
                    for(let k=0; k<weight; k++) weightedPool.push(p);
                });

                if (weightedPool.length > 0) {
                    const scorer = weightedPool[Math.floor(Math.random() * weightedPool.length)];
                    scorer.seasonGoals++;
                    scorer.careerGoals++;
                    const minute = goalMinutes[i];
                    // Store the goal with properly sorted minute
                    scorers.push({...scorer, minute: minute, goalIndex: i});

                    if (Math.random() > 0.3) {
                        const teammates = starters.filter(p => p !== scorer);
                        if (teammates.length > 0) {
                            const assister = teammates[Math.floor(Math.random() * teammates.length)];
                            assister.seasonAssists++;
                            scorers.push({...assister, isAssist: true, minute: minute, goalIndex: i});
                        }
                    }
                }
            }
            // Return scorers sorted by minute to ensure proper display order
            return scorers.sort((a, b) => a.minute - b.minute);
        }

        function updatePlayerRatings(home, away, homeGoals, awayGoals) {
            const starters = [...home.squad.filter(p => p.isStarter), ...away.squad.filter(p => p.isStarter)];
            starters.forEach(p => {
                const baseChange = Math.random() * 0.5 - 0.25;
                const matchRating = p.seasonRating + baseChange;
                p.seasonRating = Math.max(30, Math.min(99, matchRating));
            });
        }

        function validateStartingXI(team) {
            const emptySlots = STATE.userLineupSlots.filter(slot => slot === null);
            
            if (emptySlots.length > 0) {
                const slotPositions = getSlotPositions();
                const emptyPositions = [];
                
                slotPositions.forEach((pos, index) => {
                    if (STATE.userLineupSlots[index] === null) {
                        const posName = pos.position === 'GK' ? 'Goalkeeper' :
                                      pos.position === 'DEF' ? 'Defender' :
                                      pos.position === 'MID' ? 'Midfielder' : 'Forward';
                        if (!emptyPositions.includes(posName)) {
                            emptyPositions.push(posName);
                        }
                    }
                });
                
                return {
                    valid: false,
                    message: `Starting XI not complete! Missing: ${emptyPositions.join(', ')} (${emptySlots.length} empty slot${emptySlots.length > 1 ? 's' : ''})`
                };
            }
            
            const unavailableStarters = [];
            STATE.userLineupSlots.forEach(slotId => {
                if (slotId !== null) {
                    const player = team.squad.find(p => p.internalId === slotId);
                    if (player && (player.injuryWeeks > 0 || player.isSuspended)) {
                        unavailableStarters.push(player.name);
                    }
                }
            });
            
            if (unavailableStarters.length > 0) {
                const names = unavailableStarters.join(', ');
                return {
                    valid: false,
                    message: `Cannot play with unavailable players in Starting XI: ${names}`
                };
            }
            
            return { valid: true, message: "Starting XI is ready!" };
        }

        function openSlotSelection(slotIndex) {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) return;
            
            STATE.slotSelection = slotIndex;
            
            const slotPositions = getSlotPositions();
            const slotPosition = slotPositions[slotIndex];
            
            const availablePlayers = userTeam.squad.filter(player => {
                const isInLineup = STATE.userLineupSlots.includes(player.internalId);
                if (isInLineup) return false;
                
                const playerGroup = posGroup(player.pos);
                const slotGroup = slotPosition.position;
                
                return playerGroup === slotGroup;
            });
            
            availablePlayers.sort((a, b) => b.rating - a.rating);
            
            const overlay = document.getElementById('slot-select-overlay');
            const title = document.getElementById('slot-select-title');
            const subtitle = document.getElementById('slot-select-subtitle');
            const playersContainer = document.getElementById('slot-select-players');
            const countElement = document.getElementById('slot-select-count');
            
            const positionName = slotPosition.position === 'GK' ? 'Goalkeeper' :
                               slotPosition.position === 'DEF' ? 'Defender' :
                               slotPosition.position === 'MID' ? 'Midfielder' : 'Forward';
            
            title.textContent = `Select ${positionName}`;
            subtitle.textContent = `Choose a player for ${positionName} slot #${slotPosition.index + 1}:`;
            
            if (availablePlayers.length === 0) {
                playersContainer.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <div class="text-4xl mb-2">😕</div>
                        <p>No available ${positionName.toLowerCase()} players on the bench</p>
                        <p class="text-sm mt-2">You may need to sign new players or move players between positions</p>
                    </div>
                `;
            } else {
                playersContainer.innerHTML = availablePlayers.map(player => `
                    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-700/30 hover:bg-slate-700/50 cursor-pointer transition-colors"
                         onclick="selectPlayerForSlot(${player.internalId})">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center bg-slate-800 text-xs md:text-sm font-bold">
                                ${player.rating}
                            </div>
                            <div>
                                <div class="font-bold text-slate-200 text-sm">${player.name}</div>
                                <div class="text-xs text-slate-400">${player.pos} • Age: ${player.age}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono text-emerald-400 text-sm">${formatMoney(player.price)}</div>
                            <div class="text-xs text-slate-400">Rating: ${player.rating}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            countElement.textContent = `${availablePlayers.length} player${availablePlayers.length !== 1 ? 's' : ''} available`;
            overlay.classList.remove('hidden');
        }

        function selectPlayerForSlot(playerId) {
            if (STATE.slotSelection === null) return;
            
            const userTeam = getTeam(STATE.userTeamId);
            const player = userTeam.squad.find(p => p.internalId === playerId);
            
            if (!player) return;
            
            if (player.injuryWeeks > 0 || player.isSuspended) {
                alert(`Cannot select ${player.name} - ${player.injuryWeeks > 0 ? 'Injured' : 'Suspended'}!`);
                return;
            }
            
            setPlayerInSlot(STATE.slotSelection, playerId);
            
            document.getElementById('slot-select-overlay').classList.add('hidden');
            STATE.slotSelection = null;
            renderDashboard();
        }

        // НОВАЯ ФУНКЦИЯ: выбор слота для замены
        function selectSlotForSwap(slotIndex) {
            // Если этот слот уже активен, снимаем выделение
            if (STATE.activeSwapSlot === slotIndex) {
                STATE.activeSwapSlot = null;
            } else {
                // Иначе делаем его активным
                STATE.activeSwapSlot = slotIndex;
            }
            renderDashboard();
        }

        // НОВАЯ ФУНКЦИЯ: мгновенная замена
        function instantSwapWithBench(playerInternalId) {
            // Если нет активного слота, ничего не делаем
            if (STATE.activeSwapSlot === null) return;
            
            const userTeam = getTeam(STATE.userTeamId);
            const benchPlayer = userTeam.squad.find(p => p.internalId === playerInternalId);
            const slotPlayer = getPlayerInSlot(STATE.activeSwapSlot);
            
            if (!benchPlayer) return;
            
            // Проверяем соответств��е позиций
            const slotPositions = getSlotPositions();
            const slotPosition = slotPositions[STATE.activeSwapSlot];
            const benchPlayerGroup = posGroup(benchPlayer.pos);
            
            if (benchPlayerGroup !== slotPosition.position) {
                alert(`Cannot place ${benchPlayer.pos} in ${slotPosition.position} position!`);
                return;
            }
            
            // Проверяем, что игрок со скамейки не травмирован и не дисквалифицирован
            if (benchPlayer.injuryWeeks > 0 || benchPlayer.isSuspended) {
                alert(`Cannot place ${benchPlayer.name} in starting XI - ${benchPlayer.injuryWeeks > 0 ? 'Injured' : 'Suspended'}!`);
                return;
            }
            
            // Если в слоте уже есть игрок, перемещаем его на скамейку
            if (slotPlayer) {
                slotPlayer.isStarter = false;
            }
            
            // Ставим игрока со скамейки в слот
            benchPlayer.isStarter = true;
            setPlayerInSlot(STATE.activeSwapSlot, benchPlayer.internalId);
            
            // Сбрасываем активный слот
            STATE.activeSwapSlot = null;
            
            // Перерисовываем
            renderDashboard();
        }

        // ИСПРАВЛЕННАЯ ФУНКЦИЯ: игра недели по календарю
        async function playWeek() {
            const userTeam = getTeam(STATE.userTeamId);
            
            const validation = validateStartingXI(userTeam);
            if (!validation.valid) {
                alert(validation.message);
                return;
            }
            
            // Проверяем и пересобираем календарь если нужно
            ensureCalendarReady();
            
            if (STATE.calendar.currentWeek >= STATE.calendar.weeks.length) {
                endSeason();
                return;
            }

            const currentWeek = STATE.calendar.weeks[STATE.calendar.currentWeek];
            
            // ModAPI: Trigger week start event
            if (window.ModAPI && currentWeek) {
                window.ModAPI.trigger('onWeekStart', currentWeek);
            }

            if (!currentWeek) {
                console.error("playWeek: currentWeek is undefined at index", STATE.calendar.currentWeek);
                endSeason();
                return;
            }
            
            const results = [];
            
            // Инициализируем userResults если нет
            if (!currentWeek.userResults) {
                currentWeek.userResults = [];
            }
            
            // Проходим по всем событиям недели
            for (const event of currentWeek.events) {
                if (event.played) continue;
                
                if (event.type === "LEAGUE") {
                    // Проверяем что matchday существует
                    if (event.matchday === undefined || event.matchday >= STATE.schedule.length) {
                        console.error("playWeek: invalid matchday", event.matchday);
                        event.played = true;
                        continue;
                    }
                    
                    // Играем тур лиги
                    const weekMatches = STATE.schedule[event.matchday];
                    if (!weekMatches || weekMatches.length === 0) {
                        console.error("playWeek: no matches for matchday", event.matchday);
                        event.played = true;
                        continue;
                    }
                    
                    const leagueResults = [];
                    
                    weekMatches.forEach(match => {
                        // ИСПРАВЛЕНО: Проверяем, есть ли сохранённый результат 2D симуляции для этого матча
                        let res;
                        // Use loose equality for IDs to handle potential string/number mismatches
                        if (window._sim2DResult && 
                            ((match.home == window._sim2DHomeId && match.away == window._sim2DAwayId) ||
                             (match.home == window._sim2DAwayId && match.away == window._sim2DHomeId))) {
                            // Используем результат из 2D симуляции
                            res = window._sim2DResult;
                        } else {
                            // Симулируем матч как обычно
                            res = simulateMatch(match.home, match.away);
                        }
                        leagueResults.push(res);
                        
                        const home = getTeam(res.homeId);
                        const away = getTeam(res.awayId);

                        // НОВОЕ: Обновляем энергию и мораль после матча
                        updateEnergyMorale(home, home.id === STATE.userTeamId, res, res.stats.scorersHome);
                        updateEnergyMorale(away, away.id === STATE.userTeamId, res, res.stats.scorersAway);

                        home.gf += res.homeGoals; 
                        home.ga += res.awayGoals; 
                        home.gd = home.gf - home.ga; 
                        home.played++;
                        
                        away.gf += res.awayGoals; 
                        away.ga += res.homeGoals; 
                        away.gd = away.gf - away.ga; 
                        away.played++;

                        if (res.homeGoals > res.awayGoals) { 
                            home.points += 3; 
                            home.wins++; 
                            away.losses++; 
                        }
                        else if (res.homeGoals < res.awayGoals) { 
                            away.points += 3; 
                            away.wins++; 
                            home.losses++; 
                        }
                        else { 
                            home.points += 1; 
                            away.points += 1; 
                            home.draws++; 
                            away.draws++; 
                        }
                        
                        // Триггер события matchEnd для модов
                        if (window.ModAPI) {
                            window.ModAPI.trigger('matchEnd', {
                                homeId: res.homeId,
                                awayId: res.awayId,
                                homeScore: res.homeGoals,
                                awayScore: res.awayGoals,
                                stats: res.stats
                            });
                        }
                    });
                    
                    const userMatch = leagueResults.find(r => r.homeId === STATE.userTeamId || r.awayId === STATE.userTeamId);
                    if (userMatch) {
                        // ИСПРАВЛЕНО: Пропускаем renderLiveMatch если результат пришёл из 2D симуляции
                        const wasFrom2DSim = window._sim2DResult && 
                            ((userMatch.homeId == window._sim2DHomeId && userMatch.awayId == window._sim2DAwayId) ||
                             (userMatch.homeId == window._sim2DAwayId && userMatch.awayId == window._sim2DHomeId));
                        
                        if (!wasFrom2DSim) {
                            await renderLiveMatch(userMatch);
                        }
                        
                        // Записываем результат пользователя
                        const isUserHome = userMatch.homeId === STATE.userTeamId;
                        const userGoals = isUserHome ? userMatch.homeGoals : userMatch.awayGoals;
                        const oppGoals = isUserHome ? userMatch.awayGoals : userMatch.homeGoals;
                        let resultType = 'D';
                        if (userGoals > oppGoals) resultType = 'W';
                        else if (userGoals < oppGoals) resultType = 'L';
                        
                        currentWeek.userResults.push({
                            type: 'LEAGUE',
                            homeGoals: userMatch.homeGoals,
                            awayGoals: userMatch.awayGoals,
                            result: resultType,
                            isUserHome: isUserHome
                        });
                    }
                    
                    results.push(...leagueResults);
                    event.played = true;
                    
                } else if (event.type === "CUP") {
                    // Играем раунд кубка
                    const cupResult = await playCupRoundWithResult();
                    event.played = true;
                    
                    // Записываем результат кубка пользователя если был
                    if (cupResult && cupResult.userResult) {
                        currentWeek.userResults.push(cupResult.userResult);
                    }
                } else if (event.type === "EURO") {
                    // Играем матчдей еврокубков
                    const euroResult = await playEuroMatchday(event.cup, event.matchday);
                    event.played = true;
                    
                    // Записываем результат евро пользователя если был
                    if (euroResult) {
                        currentWeek.userResults.push(euroResult);
                    }
                }
            }
            
            // Помечаем неделю как сыгранную
            currentWeek.played = true;
            
            updateRecovery();
            
            // ========== ВЫЗОВ ХУКОВ МОДОВ: onWeekEnd ==========
            if (window.ModAPI) {
                window.ModAPI.trigger('weekEnd', { week: STATE.calendar.currentWeek });
                window.ModAPI.trigger('onWeekEnd', { week: STATE.calendar.currentWeek });
            }
            // ================================================
            
            const offer = await processTransferMarket();
            
            STATE.calendar.currentWeek++;
            renderDashboard();
            
            // Auto-save disabled - only save at season end

            if (STATE.calendar.currentWeek >= STATE.calendar.weeks.length) {
                if (offer) {
                    showOfferModal(offer, () => {
                         showResultsModal(results, () => endSeason());
                    });
                } else {
                    showResultsModal(results, () => endSeason());
                }
            } else {
                if (offer) {
                    showOfferModal(offer, () => showResultsModal(results));
                } else {
                    showResultsModal(results);
                }
            }
        }

        function endSeason() {
            // ========== ВЫЗОВ ХУКОВ МОДОВ: onSeasonEnd ==========
            if (window.ModAPI) {
                window.ModAPI.trigger('seasonEnd', { season: STATE.season });
                window.ModAPI.trigger('onSeasonEnd', { season: STATE.season });
            }
            // ================================================
            
            giveSeasonAwards();
            
            const promotionRelegationResult = processPromotionRelegation();
            showPromotionRelegationNotification(promotionRelegationResult);
            
            // Auto-save at season end
            quickSave();
            
            showSeasonEndSummary(promotionRelegationResult);
        }

        function showPromotionRelegationNotification(prResult) {
            const { userStatus, userNewLeague, userDivisionChange } = prResult;
            
            if (userStatus === 'REMAIN') {
                return;
            }
            
            const overlay = document.getElementById('promo-relegation-overlay');
            const title = document.getElementById('pr-title');
            const message = document.getElementById('pr-message');
            const details = document.getElementById('pr-details');
            const btnContinue = document.getElementById('btn-pr-continue');
            
            const userTeam = getTeam(STATE.userTeamId);
            
            if (userStatus === 'PROMOTED') {
                title.textContent = 'PROMOTION!';
                title.className = 'text-emerald-400 font-black text-xl mb-4 uppercase tracking-widest border-b border-slate-700 pb-2';
                
                message.innerHTML = `
                    <div class="text-lg font-bold text-emerald-300 mb-2">Congratulations!</div>
                    <div class="text-slate-300">Your team has been promoted to a higher division.</div>
                `;
                
                details.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">From:</span>
                        <span class="text-slate-300">${userTeam.leagueName} (Div ${userDivisionChange.from})</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">To:</span>
                        <span class="text-emerald-300 font-bold">${userNewLeague} (Div ${userDivisionChange.to})</span>
                    </div>
                    <div class="h-px bg-slate-700 my-3"></div>
                    <div class="text-center text-xs text-slate-500">
                        Your team will compete in the new division next season
                    </div>
                `;
                
                message.innerHTML += `<div class="text-4xl mt-4">🎉🏆</div>`;
            }
            else if (userStatus === 'RELEGATED') {
                title.textContent = 'RELEGATION';
                title.className = 'text-red-400 font-black text-xl mb-4 uppercase tracking-widest border-b border-slate-700 pb-2';
                
                message.innerHTML = `
                    <div class="text-lg font-bold text-red-300 mb-2">Bad luck...</div>
                    <div class="text-slate-300">Your team has been relegated to a lower division.</div>
                `;
                
                details.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">From:</span>
                        <span class="text-slate-300">${userTeam.leagueName} (Div ${userDivisionChange.from})</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">To:</span>
                        <span class="text-red-300 font-bold">${userNewLeague} (Div ${userDivisionChange.to})</span>
                    </div>
                    <div class="h-px bg-slate-700 my-3"></div>
                    <div class="text-center text-xs text-slate-500">
                        Your team will compete in the new division next season
                    </div>
                `;
                
                message.innerHTML += `<div class="text-4xl mt-4">💪📉</div>`;
            }
            
            btnContinue.onclick = () => {
                overlay.classList.add('hidden');
            };
            
            overlay.classList.remove('hidden');
        }

        function showSeasonEndSummary(prResult) {
            const overlay = document.getElementById('season-end-overlay');
            const content = document.getElementById('season-end-content');
            
            const sorted = [...STATE.activeLeagueTeams].sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
            const winner = sorted[0];
            const isUserWinner = winner.id === STATE.userTeamId;

            if (isUserWinner) {
                STATE.history.push({ year: STATE.season, title: `${winner.leagueName} Champion` });
                createConfetti();
            }

            addNews('Season Update', `Season ${STATE.season} has ended. Champion: ${winner.name}`, 'info');

            calculateLeagueStats();
            
            // FIXED: Ensure arrays exist and provide safe defaults
            const topScorers = STATE.leagueStats.topScorers || [];
            const topAssists = STATE.leagueStats.topAssists || [];
            const bestPlayers = STATE.leagueStats.bestPlayers || [];
            
            const topScorer = topScorers[0] || null;
            const topAssist = topAssists[0] || null;
            const bestPlayer = bestPlayers[0] || null;

            content.innerHTML = `
                <div class="glass-panel p-6 md:p-10 rounded-2xl border ${isUserWinner ? 'border-yellow-400' : 'border-slate-700'} shadow-2xl relative overflow-hidden">
                    ${isUserWinner ? '<div class="absolute inset-0 bg-yellow-400/10 animate-pulse"></div>' : ''}
                    
                    <h1 class="text-3xl md:text-5xl font-black mb-4 text-white uppercase tracking-widest relative z-10">Season ${STATE.season} Finished</h1>
                    <div class="text-xl md:text-2xl font-bold mb-8 relative z-10">
                        Champion: <span class="${isUserWinner ? 'text-yellow-400' : 'text-white'}">${winner.name}</span>
                    </div>

                    <div class="mb-8 relative z-10">
                        ${isUserWinner 
                            ? `<div class="text-6xl mb-4">🏆</div><p class="text-yellow-400 font-bold text-lg md:text-xl">CONGRATULATIONS MANAGER!</p>` 
                            : `<div class="text-6xl mb-4">🏁</div><p class="text-slate-400">Better luck next season!</p>`}
                    </div>
                    
                    <!-- FULLSCREEN AWARDS CAROUSEL -->
                    <div class="mb-8 bg-slate-900/50 rounded-xl p-4 md:p-6 border border-slate-700 relative z-10 overflow-hidden">
                        <h3 class="text-lg md:text-xl font-bold text-white mb-4 text-center">Season Awards</h3>
                        
                        <!-- Carousel Container -->
                        <div id="awards-carousel" class="relative w-full" style="min-height: 180px;">
                            <!-- Slide 1: Golden Boot -->
                            <div class="awards-slide active" data-slide="0">
                                <div class="flex flex-col items-center justify-center py-4 px-2 bg-gradient-to-br from-yellow-900/30 to-amber-800/20 rounded-xl border border-yellow-500/20 min-h-[150px]">
                                    <div class="text-5xl md:text-7xl mb-3 animate-bounce" style="animation-duration: 2s;">⚽</div>
                                    <div class="font-black text-yellow-400 text-lg md:text-2xl uppercase tracking-wider mb-2">Golden Boot</div>
                                    ${topScorer ? `
                                        <div class="text-white font-bold text-lg md:text-2xl mt-1" style="text-shadow: 0 0 20px rgba(250, 204, 21, 0.5);">${topScorer.name}</div>
                                        <div class="text-yellow-400 text-3xl md:text-5xl font-black my-2">${topScorer.seasonGoals} <span class="text-base md:text-lg font-normal">goals</span></div>
                                        <div class="text-slate-400 text-sm md:text-base">${getTeam(topScorer.clubId)?.name || 'Unknown'}</div>
                                    ` : '<div class="text-slate-500 mt-2">No top scorer this season</div>'}
                                </div>
                            </div>
                            
                            <!-- Slide 2: Playmaker -->
                            <div class="awards-slide" data-slide="1">
                                <div class="flex flex-col items-center justify-center py-4 px-2 bg-gradient-to-br from-blue-900/30 to-cyan-800/20 rounded-xl border border-blue-500/20 min-h-[150px]">
                                    <div class="text-5xl md:text-7xl mb-3 animate-pulse">🎯</div>
                                    <div class="font-black text-blue-400 text-lg md:text-2xl uppercase tracking-wider mb-2">Playmaker</div>
                                    ${topAssist ? `
                                        <div class="text-white font-bold text-lg md:text-2xl mt-1" style="text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);">${topAssist.name}</div>
                                        <div class="text-blue-400 text-3xl md:text-5xl font-black my-2">${topAssist.seasonAssists} <span class="text-base md:text-lg font-normal">assists</span></div>
                                        <div class="text-slate-400 text-sm md:text-base">${getTeam(topAssist.clubId)?.name || 'Unknown'}</div>
                                    ` : '<div class="text-slate-500 mt-2">No top assister this season</div>'}
                                </div>
                            </div>
                            
                            <!-- Slide 3: Player of the Season -->
                            <div class="awards-slide" data-slide="2">
                                <div class="flex flex-col items-center justify-center py-4 px-2 bg-gradient-to-br from-purple-900/30 to-pink-800/20 rounded-xl border border-purple-500/20 min-h-[150px]">
                                    <div class="text-5xl md:text-7xl mb-3" style="animation: spin-slow 3s linear infinite;">🏆</div>
                                    <div class="font-black text-purple-400 text-lg md:text-2xl uppercase tracking-wider mb-2">Player of the Season</div>
                                    ${bestPlayer ? `
                                        <div class="text-white font-bold text-lg md:text-2xl mt-1" style="text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);">${bestPlayer.name}</div>
                                        <div class="text-purple-400 text-3xl md:text-5xl font-black my-2">${Math.round(bestPlayer.seasonRating)} <span class="text-base md:text-lg font-normal">rating</span></div>
                                        <div class="text-slate-400 text-sm md:text-base">${getTeam(bestPlayer.clubId)?.name || 'Unknown'}</div>
                                    ` : '<div class="text-slate-500 mt-2">No player of the season</div>'}
                                </div>
                            </div>
                            
                            <!-- Navigation Arrows -->
                            <button onclick="changeAwardsSlide(-1)" class="absolute left-1 top-1/2 -translate-y-1/2 w-10 h-10 md:w-12 md:h-12 bg-slate-800/80 hover:bg-slate-700 rounded-full flex items-center justify-center text-white text-xl font-bold z-10 transition-all shadow-lg border border-slate-600">
                                ‹
                            </button>
                            <button onclick="changeAwardsSlide(1)" class="absolute right-1 top-1/2 -translate-y-1/2 w-10 h-10 md:w-12 md:h-12 bg-slate-800/80 hover:bg-slate-700 rounded-full flex items-center justify-center text-white text-xl font-bold z-10 transition-all shadow-lg border border-slate-600">
                                ›
                            </button>
                        </div>
                        
                        <!-- Slide Indicators -->
                        <div class="flex justify-center gap-2 mt-4">
                            <button onclick="goToAwardsSlide(0)" class="awards-dot active w-3 h-3 rounded-full bg-slate-600 transition-all" data-dot="0"></button>
                            <button onclick="goToAwardsSlide(1)" class="awards-dot w-3 h-3 rounded-full bg-slate-600 transition-all" data-dot="1"></button>
                            <button onclick="goToAwardsSlide(2)" class="awards-dot w-3 h-3 rounded-full bg-slate-600 transition-all" data-dot="2"></button>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button onclick="showPlayerStats()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 md:px-6 rounded-lg text-sm">
                                View Full Statistics
                            </button>
                        </div>
                    </div>

                    <button onclick="startNextSeason()" class="mt-8 bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 md:py-4 px-6 md:px-10 rounded-xl uppercase tracking-wider text-base md:text-lg shadow-xl shadow-green-900/30 relative z-10 transform transition hover:scale-105">
                        Start Season ${STATE.season + 1}
                    </button>
                </div>
            `;
            
            overlay.classList.remove('hidden');
            
            // Initialize awards carousel after rendering
            setTimeout(() => {
                initAwardsCarousel();
            }, 100);
        }

        function createConfetti() {
            for (let i = 0; i < 100; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.backgroundColor = ['#ff0', '#f00', '#0f0', '#00f', '#f0f'][Math.floor(Math.random() * 5)];
                conf.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 5000);
            }
        }

        // ========== AWARDS CAROUSEL FUNCTIONS ==========
        let currentAwardsSlide = 0;
        const totalAwardsSlides = 3;
        let awardsAutoplayInterval = null;

        function changeAwardsSlide(direction) {
            const newSlide = (currentAwardsSlide + direction + totalAwardsSlides) % totalAwardsSlides;
            goToAwardsSlide(newSlide);
        }

        function goToAwardsSlide(slideIndex) {
            const slides = document.querySelectorAll('.awards-slide');
            const dots = document.querySelectorAll('.awards-dot');
            
            if (!slides.length) return;
            
            // Hide current slide
            slides.forEach((slide, i) => {
                slide.classList.remove('active', 'slide-out-left', 'slide-out-right');
                if (i === currentAwardsSlide) {
                    slide.classList.add(slideIndex > currentAwardsSlide ? 'slide-out-left' : 'slide-out-right');
                }
            });
            
            // Update dots
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === slideIndex);
            });
            
            // Show new slide after brief delay
            setTimeout(() => {
                slides.forEach((slide, i) => {
                    slide.classList.remove('slide-out-left', 'slide-out-right');
                    slide.classList.toggle('active', i === slideIndex);
                });
            }, 50);
            
            currentAwardsSlide = slideIndex;
            
            // Reset autoplay timer
            resetAwardsAutoplay();
        }

        function resetAwardsAutoplay() {
            if (awardsAutoplayInterval) {
                clearInterval(awardsAutoplayInterval);
            }
            awardsAutoplayInterval = setInterval(() => {
                changeAwardsSlide(1);
            }, 5000);
        }

        // Touch support for awards carousel
        function initAwardsCarouselTouch() {
            const carousel = document.getElementById('awards-carousel');
            if (!carousel) return;
            
            let startX = 0;
            let endX = 0;
            
            carousel.addEventListener('touchstart', (e) => {
                startX = e.changedTouches[0].screenX;
            }, { passive: true });
            
            carousel.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].screenX;
                const diff = startX - endX;
                
                if (Math.abs(diff) > 50) {
                    if (diff > 0) {
                        changeAwardsSlide(1); // Swipe left = next
                    } else {
                        changeAwardsSlide(-1); // Swipe right = prev
                    }
                }
            }, { passive: true });
        }

        // Initialize carousel when season end overlay opens
        function initAwardsCarousel() {
            currentAwardsSlide = 0;
            const slides = document.querySelectorAll('.awards-slide');
            const dots = document.querySelectorAll('.awards-dot');
            
            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === 0);
            });
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === 0);
            });
            
            initAwardsCarouselTouch();
            resetAwardsAutoplay();
        }

        function startNextSeason() {
            // Stop awards autoplay
            if (awardsAutoplayInterval) {
                clearInterval(awardsAutoplayInterval);
                awardsAutoplayInterval = null;
            }
            
            document.getElementById('season-end-overlay').classList.add('hidden');
            
            // НОВОЕ: Инициализация еврокубков ПЕРЕД началом нового сезона (на основе текущей таблицы)
            initEuropeanCompetitions();
            
            STATE.season++;
            STATE.calendar.currentWeek = 0;
            STATE.tableView = 'LEAGUE'; // Сброс вью таблицы

            const sorted = [...STATE.activeLeagueTeams].sort((a, b) => b.points - a.points);
            
            STATE.allTeams.forEach(team => {
                const rank = sorted.findIndex(t => t.id === team.id);
                if (rank !== -1) {
                    const prize = Math.max(5000000, 50000000 - (rank * 2000000));
                    team.budget += prize;
                }
                
                team.points = 0; team.played = 0; team.wins = 0; 
                team.draws = 0; team.losses = 0; team.gf = 0; 
                team.ga = 0; team.gd = 0;

                team.squad.forEach((p, idx) => {
                    p.careerGoals += p.seasonGoals;
                    p.seasonGoals = 0;
                    p.seasonAssists = 0;
                    p.seasonRating = p.rating;
                    p.age++;
                    
                    // НОВОЕ: Сброс энергии и морали в начале сезона
                    p.energy = 100;
                    p.morale = 50;

                    // ИСПРАВЛЕНО: Применяем только небольшую сезонную инфляцию
                    updatePlayerPrice(p, 'season_inflation');
                });
                
                if (team.id === STATE.userTeamId) {
                    updateTeamStartersFromSlots(team);
                } else {
                    autoSelectStarters(team);
                }
                calculateTeamRating(team);
            });

            initSchedule();
            initLeagueCup();
            
            // НОВОЕ: Жеребьёвка групп еврокубков
            if (STATE.europe) {
                drawEuropeanGroups();
            }
            
            initCalendar();
            
            // ========== ВЫЗОВ ХУКОВ МОДОВ: onSeasonStart ==========
            if (window.ModAPI) {
                window.ModAPI.trigger('seasonStart', { season: STATE.season });
                window.ModAPI.trigger('onSeasonStart', { season: STATE.season });
            }
            // ================================================
            
            // Auto-save disabled at season start - only save at season end
            renderDashboard();
        }

        function updateRecovery() {
            STATE.allTeams.forEach(t => {
                t.squad.forEach(p => {
                    if (p.injuryWeeks > 0) p.injuryWeeks--;
                    if (p.isSuspended) p.isSuspended = false; 
                    if (p.suspensionPending) {
                        p.isSuspended = true; 
                        p.suspensionPending = false;
                    }
                    
                    // НОВОЕ: Небольшое восстановление энергии за неделю (для всех)
                    if (!p.isStarter) {
                        // Неигравшие уже получили восстановление в updateEnergyMorale
                        // Здесь дополнительно не нужно
                    }
                    // Мораль естественно стабилизируется к 50
                    if ((p.morale ?? 50) > 50) {
                        p.morale = Math.max(50, (p.morale ?? 50) - 1);
                    } else if ((p.morale ?? 50) < 50) {
                        p.morale = Math.min(50, (p.morale ?? 50) + 1);
                    }
                });
            });
        }

        function renderLiveMatch(match) {
            return new Promise(resolve => {
                const modal = document.getElementById('live-match-overlay');
                const feed = document.getElementById('live-feed');
                const btn = document.getElementById('btn-live-continue');
                const timer = document.getElementById('live-timer');
                const hName = document.getElementById('live-home-name');
                const aName = document.getElementById('live-away-name');
                const hScore = document.getElementById('live-score-home');
                const aScore = document.getElementById('live-score-away');
                const stadium = document.getElementById('live-stadium');

                const home = getTeam(match.homeId);
                const away = getTeam(match.awayId);

                // Set logos - use 'sm' size for compact view
                const hLogo = document.getElementById('live-home-logo');
                const aLogo = document.getElementById('live-away-logo');
                if (hLogo) hLogo.innerHTML = renderTeamLogo(home, 'sm');
                if (aLogo) aLogo.innerHTML = renderTeamLogo(away, 'sm');

                hName.textContent = home.name;
                aName.textContent = away.name;
                stadium.textContent = "Live from " + home.stadiumName;
                hScore.textContent = '0';
                aScore.textContent = '0';
                feed.innerHTML = '';
                btn.classList.add('hidden');
                modal.classList.remove('hidden');
                
                // Scorers displays
                const hScorers = document.getElementById('live-home-scorers');
                const aScorers = document.getElementById('live-away-scorers');
                if (hScorers) hScorers.innerHTML = '';
                if (aScorers) aScorers.innerHTML = '';
                
                // Track scorers for display
                const homeScorersDisplay = [];
                const awayScorersDisplay = [];

                const events = [...match.events];
                let step = 0;
                
                let currentHomeGoals = 0;
                let currentAwayGoals = 0;
                
                const goalEvents = [];
                const otherEvents = [];
                
                events.forEach(event => {
                    if (event.includes('GOAL!')) {
                        goalEvents.push(event);
                    } else {
                        otherEvents.push(event);
                    }
                });
                
                const allEvents = [...goalEvents, ...otherEvents].sort(() => Math.random() - 0.5);
                
                const interval = setInterval(() => {
                    step++;
                    const currentMinute = Math.min(90, Math.floor((step / (allEvents.length + 10)) * 90));
                    timer.textContent = currentMinute + "'";

                    if (allEvents.length > 0 && Math.random() > 0.4) {
                        const event = allEvents.shift();
                        const line = document.createElement('div');
                        line.className = 'ticker-line text-slate-300 border-l-2 border-[#4caf50] pl-2';
                        line.textContent = event;
                        feed.prepend(line);
                        
                        if (event.includes('GOAL!') || event.includes('⚽')) {
                            // Extract minute if present (format: "XX' ⚽ GOAL!")
                            const minuteMatch = event.match(/^(\d+)'/);
                            const minute = minuteMatch ? minuteMatch[1] : currentMinute;
                            
                            // Extract player name
                            const nameMatch = event.match(/GOAL!\s*(.+?)\s*scores/i);
                            const playerName = nameMatch ? nameMatch[1] : '';
                            
                            if (event.includes(home.name)) {
                                currentHomeGoals++;
                                hScore.textContent = currentHomeGoals;
                                hScore.classList.add('score-pulse');
                                setTimeout(() => hScore.classList.remove('score-pulse'), 500);
                                line.className = 'ticker-line font-bold text-[#4caf50] border-l-4 border-white pl-2 py-1';
                                
                                // Add to scorers display
                                if (hScorers && playerName) {
                                    homeScorersDisplay.push(`⚽ ${playerName} ${minute}'`);
                                    hScorers.innerHTML = homeScorersDisplay.map(s => `<div>${s}</div>`).join('');
                                }
                            }
                            else if (event.includes(away.name)) {
                                currentAwayGoals++;
                                aScore.textContent = currentAwayGoals;
                                aScore.classList.add('score-pulse');
                                setTimeout(() => aScore.classList.remove('score-pulse'), 500);
                                line.className = 'ticker-line font-bold text-[#4caf50] border-l-4 border-white pl-2 py-1';
                                
                                // Add to scorers display
                                if (aScorers && playerName) {
                                    awayScorersDisplay.push(`⚽ ${playerName} ${minute}'`);
                                    aScorers.innerHTML = awayScorersDisplay.map(s => `<div>${s}</div>`).join('');
                                }
                            }
                        }
                        else if (event.includes('RED CARD')) {
                            line.className = 'ticker-line font-bold text-red-500 border-l-4 border-red-500 pl-2 py-1';
                            
                            if (event.includes(home.name)) {
                                hName.parentElement.classList.add('red-card-indicator');
                                setTimeout(() => hName.parentElement.classList.remove('red-card-indicator'), 1000);
                            } else if (event.includes(away.name)) {
                                aName.parentElement.classList.add('red-card-indicator');
                                setTimeout(() => aName.parentElement.classList.remove('red-card-indicator'), 1000);
                            }
                        }
                        else if (event.includes('INJURY')) {
                            line.className = 'ticker-line font-bold text-yellow-500 border-l-4 border-yellow-500 pl-2 py-1';
                        }
                        
                        if (feed.firstChild) {
                            feed.scrollTop = 0;
                        }
                    }

                    if (allEvents.length === 0 && step > 8) {
                        clearInterval(interval);
                        
                        // Исправлено: показываем все оставшиеся голы в конце матча
                        const finalHomeGoals = match.homeGoals;
                        const finalAwayGoals = match.awayGoals;
                        
                        // Функция для постепенного показа оставшихся голов
                        const showRemainingGoals = () => {
                            let goalsShown = false;
                            
                            // Проверяем голы домашней команды
                            while (currentHomeGoals < finalHomeGoals) {
                                currentHomeGoals++;
                                setTimeout(() => {
                                    hScore.textContent = currentHomeGoals;
                                    hScore.classList.add('score-pulse');
                                    setTimeout(() => hScore.classList.remove('score-pulse'), 300);
                                    
                                    const goalLine = document.createElement('div');
                                    goalLine.className = 'ticker-line font-bold text-[#4caf50] border-l-4 border-white pl-2';
                                    goalLine.textContent = `LATE GOAL! ${home.name} scores!`;
                                    feed.prepend(goalLine);
                                }, 400 * (currentHomeGoals - 1));
                                goalsShown = true;
                            }
                            
                            // Проверяем голы гостевой команды
                            while (currentAwayGoals < finalAwayGoals) {
                                currentAwayGoals++;
                                setTimeout(() => {
                                    aScore.textContent = currentAwayGoals;
                                    aScore.classList.add('score-pulse');
                                    setTimeout(() => aScore.classList.remove('score-pulse'), 300);
                                    
                                    const goalLine = document.createElement('div');
                                    goalLine.className = 'ticker-line font-bold text-[#4caf50] border-l-4 border-white pl-2';
                                    goalLine.textContent = `LATE GOAL! ${away.name} scores!`;
                                    feed.prepend(goalLine);
                                }, 400 * (currentAwayGoals - 1));
                                goalsShown = true;
                            }
                            
                            if (goalsShown) {
                                setTimeout(() => {
                                    timer.textContent = "FT";
                                    hScore.textContent = match.homeGoals;
                                    aScore.textContent = match.awayGoals;
                                    
                                    feed.prepend(Object.assign(document.createElement('div'), {
                                        className: 'ticker-line text-white font-bold text-center mt-2 uppercase tracking-widest',
                                        textContent: '--- FULL TIME ---'
                                    }));
                                    
                                    btn.classList.remove('hidden');
                                }, 800);
                            } else {
                                timer.textContent = "FT";
                                hScore.textContent = match.homeGoals;
                                aScore.textContent = match.awayGoals;
                                
                                feed.prepend(Object.assign(document.createElement('div'), {
                                    className: 'ticker-line text-white font-bold text-center mt-2 uppercase tracking-widest',
                                    textContent: '--- FULL TIME ---'
                                }));
                                
                                btn.classList.remove('hidden');
                            }
                        };
                        
                        showRemainingGoals();
                    }
                }, 350);

                btn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve();
                };
            });
        }

        function processTransferMarket() {
            return new Promise(resolve => {
                if (Math.random() > 0.5) {
                    const cpuTeams = STATE.allTeams.filter(t => t.id !== STATE.userTeamId);
                    if (cpuTeams.length >= 2) {
                        const t1 = cpuTeams[Math.floor(Math.random() * cpuTeams.length)];
                        const t2 = cpuTeams[Math.floor(Math.random() * cpuTeams.length)];
                        if (t1 !== t2 && t1.squad.length > 15 && t2.squad.length > 15) {
                            const p = t1.squad[Math.floor(Math.random() * t1.squad.length)];
                            transferPlayer(p, t1, t2, p.price);
                            addNews('Transfer Market', `${t2.name} signed ${p.name} from ${t1.name}`, 'transfer');
                        }
                    }
                }

                if (Math.random() < 0.3) {
                    const userTeam = getTeam(STATE.userTeamId);
                    const listed = userTeam.squad.filter(p => p.transferListed);
                    if (listed.length > 0) {
                        const player = listed[Math.floor(Math.random() * listed.length)];
                        const cpuTeams = STATE.allTeams.filter(t => t.id !== STATE.userTeamId);
                        const buyer = cpuTeams[Math.floor(Math.random() * cpuTeams.length)];
                        const variance = 0.9 + Math.random() * 0.3; 
                        const offerPrice = Math.floor(player.price * variance);

                        resolve({ player, buyer, price: offerPrice });
                        return;
                    }
                }
                resolve(null);
            });
        }

        function transferPlayer(player, fromTeam, toTeam, price) {
            fromTeam.squad = fromTeam.squad.filter(p => p.internalId !== player.internalId);
            fromTeam.budget += price;
            player.clubId = toTeam.id;
            player.isStarter = false;
            player.transferListed = false;
            toTeam.squad.push(player);
            toTeam.budget -= price;
            
            if (fromTeam.id === STATE.userTeamId) {
                for (let i = 0; i < STATE.userLineupSlots.length; i++) {
                    if (STATE.userLineupSlots[i] === player.internalId) {
                        STATE.userLineupSlots[i] = null;
                    }
                }
                updateTeamStartersFromSlots(fromTeam);
            }
            
            calculateTeamRating(fromTeam);
            
            if (toTeam.id === STATE.userTeamId) {
            } else {
                if (!toTeam.squad.some(p => p.isStarter)) autoSelectStarters(toTeam);
            }
            calculateTeamRating(toTeam);

            // ModAPI: Trigger transfer event for mods
            if (window.ModAPI) {
                window.ModAPI.trigger('transfer', {
                    player: player,
                    fromTeamId: fromTeam.id,
                    toTeamId: toTeam.id,
                    fee: price,
                    fromTeam: fromTeam,
                    toTeam: toTeam
                });
                window.ModAPI.trigger('onTransfer', {
                    player: player,
                    fromTeamId: fromTeam.id,
                    toTeamId: toTeam.id,
                    fee: price,
                    fromTeam: fromTeam,
                    toTeam: toTeam
                });
            }
        }

        // НОВОЕ: Подписание свободного агента
        function signFreeAgent(internalId) {
            const player = STATE.freeAgents.find(p => p.internalId === internalId);
            if (!player) {
                alert("Player not found!");
                return;
            }
            
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) {
                alert("User team not found!");
                return;
            }
            
            // Удаляем из списка свободных агентов
            STATE.freeAgents = STATE.freeAgents.filter(p => p.internalId !== internalId);
            
            // Добавляем в состав пользователя
            player.isFreeAgent = false;
            player.clubId = userTeam.id;
            player.isStarter = false;
            player.transferListed = false;
            player.energy = 100;
            player.morale = 50;
            
            userTeam.squad.push(player);
            
            // Пересчитываем рейтинг команды
            calculateTeamRating(userTeam);
            
            // Добавляем новость
            addNews('Free Agent Signing', `${player.name} signed as a free agent!`, 'transfer');
            
            // Показываем reveal карточку
            showSigningReveal(player);
            
            // Сохраняем игру
            saveGame();
        }

        function toggleTransferList(internalId) {
            const userTeam = getTeam(STATE.userTeamId);
            const player = userTeam.squad.find(p => p.internalId === internalId);
            if (player) {
                player.transferListed = !player.transferListed;
                const btn = document.getElementById('transfer-list-btn');
                if(btn) {
                    btn.innerText = player.transferListed ? "Remove from List" : "Add to Transfer List";
                    btn.className = `w-full font-bold py-3 rounded-lg uppercase tracking-wider mb-2 ${player.transferListed ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}`;
                }
                if(STATE.view === 'squad') renderDashboard();
            }
        }

        function openTransferConfirm(internalId) {
            let player = null;
            let fromTeam = null;
            
            // ИСПРАВЛЕНИЕ: Более надёжный поиск игрока
            for (const t of STATE.allTeams) {
                const p = t.squad.find(x => x.internalId === internalId);
                if (p) { 
                    player = p; 
                    fromTeam = t; 
                    break; 
                }
            }
            
            // ИСПРАВЛЕНИЕ: Проверяем также среди свободных агентов
            if (!player) {
                const freeAgent = STATE.freeAgents.find(p => p.internalId === internalId);
                if (freeAgent) {
                    // Это свободный агент - используем signFreeAgent
                    signFreeAgent(internalId);
                    return;
                }
            }
            
            if (!player || !fromTeam) {
                console.error("Player not found with internalId:", internalId);
                alert("Player not found! Try refreshing the market.");
                return;
            }

            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) {
                alert("User team not found!");
                return;
            }
            
            if (userTeam.budget < player.price) {
                alert("Insufficient Funds!");
                return;
            }

            // НОВОЕ: Проверка ограничений трансфера
            const transferCheck = checkTransferFeasibility(player, userTeam);
            pendingTransferCheck = transferCheck;

            pendingTransfer = { player, fromTeam, userTeam };

            document.getElementById('tc-player-name').textContent = player.name;
            document.getElementById('tc-club-name').textContent = fromTeam.name;
            document.getElementById('tc-current-budget').textContent = formatMoney(userTeam.budget);
            document.getElementById('tc-transfer-fee').textContent = '- ' + formatMoney(player.price);
            
            const remaining = userTeam.budget - player.price;
            const remEl = document.getElementById('tc-remaining');
            remEl.textContent = formatMoney(remaining);
            remEl.className = remaining < 5000000 ? 'font-bold text-yellow-500' : 'font-bold text-emerald-400';

            // НОВОЕ: Показываем инфо о репутации и проверках
            const infoContainer = document.getElementById('tc-transfer-info');
            const confirmBtn = document.getElementById('btn-confirm-transfer');
            
            if (infoContainer) {
                const clubRep = getClubReputation(userTeam);
                const clubStrength = getClubStrength(userTeam);
                const requiredRep = getRequiredReputation(player.rating);
                
                let infoHtml = `
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <div class="grid grid-cols-2 gap-2 text-xs mb-3">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Your Club Rep:</span>
                                <span class="${clubRep >= requiredRep ? 'text-emerald-400' : 'text-red-400'} font-bold">${clubRep}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Required Rep:</span>
                                <span class="text-slate-300 font-bold">${requiredRep}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Your Team Strength:</span>
                                <span class="${clubStrength + 7 >= player.rating ? 'text-emerald-400' : 'text-red-400'} font-bold">${clubStrength}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Player Rating:</span>
                                <span class="text-slate-300 font-bold">${player.rating}</span>
                            </div>
                        </div>
                `;
                
                if (!transferCheck.canBuy) {
                    infoHtml += `
                        <div class="bg-red-900/30 border border-red-500/50 rounded-lg p-3 mt-3">
                            <div class="text-red-400 font-bold text-sm mb-2">⚠️ Transfer Blocked</div>
                            ${transferCheck.reasons.map(r => `
                                <div class="text-red-300 text-xs mb-1">
                                    <span class="font-bold">${r.type}:</span> ${r.message}
                                </div>
                            `).join('')}
                            ${transferCheck.upsetChance > 0 ? `
                                <div class="text-yellow-400 text-xs mt-2 italic">
                                    💫 Small chance (${Math.round(transferCheck.upsetChance * 100)}%) player might still be interested...
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else if (transferCheck.isUpset) {
                    infoHtml += `
                        <div class="bg-yellow-900/30 border border-yellow-500/50 rounded-lg p-3 mt-3">
                            <div class="text-yellow-400 font-bold text-sm">💫 Surprise Interest!</div>
                            <div class="text-yellow-300 text-xs">Against the odds, the player is willing to join your project!</div>
                        </div>
                    `;
                } else {
                    infoHtml += `
                        <div class="bg-emerald-900/30 border border-emerald-500/50 rounded-lg p-3 mt-3">
                            <div class="text-emerald-400 font-bold text-sm">✓ Transfer Approved</div>
                            <div class="text-emerald-300 text-xs">Board and player are happy to proceed.</div>
                        </div>
                    `;
                }
                
                infoHtml += '</div>';
                infoContainer.innerHTML = infoHtml;
            }
            
            // НОВОЕ: Блокируем кнопку если трансфер невозможен
            if (transferCheck.canBuy) {
                confirmBtn.onclick = executeTransfer;
                confirmBtn.disabled = false;
                confirmBtn.className = 'bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 rounded-lg uppercase tracking-wider text-xs shadow-lg shadow-green-900/20';
            } else {
                confirmBtn.onclick = null;
                confirmBtn.disabled = true;
                confirmBtn.className = 'bg-slate-600 text-slate-400 font-bold py-3 rounded-lg uppercase tracking-wider text-xs cursor-not-allowed';
            }
            
            document.getElementById('transfer-confirm-overlay').classList.remove('hidden');
        }

        function closeTransferModal() {
            document.getElementById('transfer-confirm-overlay').classList.add('hidden');
            pendingTransfer = null;
            pendingTransferCheck = null;
            
            // Restore default confirm button visibility
            const defaultConfirmBtn = document.getElementById('btn-confirm-transfer');
            if (defaultConfirmBtn) defaultConfirmBtn.style.display = 'block';
            
            // Clear info container
            const infoContainer = document.getElementById('tc-transfer-info');
            if (infoContainer) infoContainer.innerHTML = '';
        }

        function executeTransfer() {
            if (!pendingTransfer) return;
            if (pendingTransferCheck && !pendingTransferCheck.canBuy) {
                alert("Transfer not possible!");
                return;
            }
            const { player, fromTeam, userTeam } = pendingTransfer;
            transferPlayer(player, fromTeam, userTeam, player.price);
            closeTransferModal();
            
            // НОВОЕ: Разные сообщения для обычного трансфера и "апсета"
            if (pendingTransferCheck && pendingTransferCheck.isUpset) {
                addNews('Transfer News', `SURPRISE! ${player.name} joins from ${fromTeam.name} despite bigger offers! Fee: ${formatMoney(player.price)}`, 'transfer');
            } else {
                addNews('Transfer News', `You signed ${player.name} from ${fromTeam.name} for ${formatMoney(player.price)}`, 'transfer');
            }
            showSigningReveal(player);
            renderDashboard();
        }

        function showSigningReveal(player) {
            const overlay = document.getElementById('signing-overlay');
            const card = document.getElementById('reveal-card');
            const club = getTeam(STATE.userTeamId);

            card.innerHTML = `
                <div class="flex justify-between items-start mb-6 relative z-10">
                    <div class="flex flex-col">
                        <span class="text-3xl md:text-4xl font-black ${player.rating >= 90 ? 'text-[#fbbf24]' : 'text-white'}">${player.rating}</span>
                        <span class="text-base md:text-lg font-bold opacity-80 text-white">${player.pos}</span>
                        <span class="text-xs text-slate-400 mt-1">Potential: ${player.potential || 'N/A'}</span>
                    </div>
                </div>
                <div class="text-center mb-6 relative z-10">
                    <h2 class="text-2xl md:text-3xl font-black uppercase tracking-wider truncate text-transparent bg-clip-text bg-gradient-to-b from-white to-slate-400 mb-2">
                        ${player.name}
                    </h2>
                    <div class="w-16 h-1 bg-[#4caf50] mx-auto rounded-full"></div>
                </div>
                <div class="grid grid-cols-2 gap-y-2 gap-x-4 text-sm font-bold relative z-10 border-t border-white/10 py-4 text-white">
                    <div class="flex justify-between"> <span class="opacity-70">PAC</span> <span>${player.speed}</span> </div>
                    <div class="flex justify-between"> <span class="opacity-70">DRI</span> <span>${player.dribble}</span> </div>
                    <div class="flex justify-between"> <span class="opacity-70">SHO</span> <span>${player.shot}</span> </div>
                    <div class="flex justify-between"> <span class="opacity-70">PAS</span> <span>${player.pass}</span> </div>
                </div>
            `;
            
            overlay.classList.remove('hidden');
        }

        function closeSigningReveal() {
            document.getElementById('signing-overlay').classList.add('hidden');
        }

        function openClubInfo(teamId, event) {
            if(event) event.stopPropagation();
            const team = getTeam(teamId);
            if (!team) return;

            const overlay = document.getElementById('club-info-overlay');
            const nameDiv = document.getElementById('club-info-name');
            const leagueDiv = document.getElementById('club-info-league');
            const logoDiv = document.getElementById('club-info-logo');
            const statsDiv = document.getElementById('club-info-stats');
            const squadDiv = document.getElementById('club-info-squad');
            
            nameDiv.textContent = team.name;
            leagueDiv.textContent = team.leagueName || 'League';
            logoDiv.innerHTML = renderTeamLogo(team, 'sm');
            
            statsDiv.innerHTML = `
                <div class="text-center"><div class="text-xs font-black text-[#4caf50]">${team.teamRating}</div><div class="text-[8px] text-slate-500 uppercase">Rating</div></div>
                <div class="text-center"><div class="text-xs font-black text-white">${team.points}</div><div class="text-[8px] text-slate-500 uppercase">Points</div></div>
                <div class="text-center"><div class="text-xs font-black text-blue-400">${team.wins}-${team.draws}-${team.losses}</div><div class="text-[8px] text-slate-500 uppercase">W-D-L</div></div>
                <div class="text-center"><div class="text-xs font-black text-emerald-400">${team.gf}-${team.ga}</div><div class="text-[8px] text-slate-500 uppercase">GF-GA</div></div>
                <div class="text-center"><div class="text-xs font-black text-yellow-400">${team.gd > 0 ? '+' : ''}${team.gd}</div><div class="text-[8px] text-slate-500 uppercase">GD</div></div>
            `;
            
            const sortedSquad = [...team.squad].sort((a, b) => b.rating - a.rating);
            
            squadDiv.innerHTML = `
                <div class="flex-shrink-0 p-2 border-b border-slate-700 flex items-center justify-between bg-slate-800/50">
                    <div class="flex items-center gap-2">
                        ${renderTeamLogo(team, 'sm')}
                        <div>
                            <h2 class="text-base font-black text-white leading-tight">${team.name}</h2>
                            <p class="text-[9px] text-slate-400 uppercase tracking-wider">${team.leagueName || 'League'}</p>
                        </div>
                    </div>
                    <button onclick="closeClubInfo()" class="w-7 h-7 flex items-center justify-center rounded-full bg-slate-700 hover:bg-slate-600 text-white transition-colors text-sm">✕</button>
                </div>
                
                <div class="p-2 grid grid-cols-4 gap-2 bg-slate-800/30 border-b border-slate-700">
                    <div class="text-center">
                        <div class="text-base font-black text-[#4caf50]">${team.teamRating}</div>
                        <div class="text-[7px] text-slate-500 uppercase">Rating</div>
                    </div>
                    <div class="text-center border-x border-slate-700">
                        <div class="text-base font-black text-white">${team.points}</div>
                        <div class="text-[7px] text-slate-500 uppercase">Points</div>
                    </div>
                    <div class="text-center border-r border-slate-700">
                        <div class="text-base font-black text-blue-400">${team.wins}-${team.draws}-${team.losses}</div>
                        <div class="text-[7px] text-slate-500 uppercase">W-D-L</div>
                    </div>
                    <div class="text-center">
                        <div class="text-base font-black text-emerald-400">${team.gf}-${team.ga}</div>
                        <div class="text-[7px] text-slate-500 uppercase">GF-GA</div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-2">
                    <h3 class="text-[9px] font-bold text-slate-500 uppercase px-1 mb-1 tracking-widest">Squad (${team.squad.length})</h3>
                    <div class="grid grid-cols-1 gap-1">
                        ${sortedSquad.map(p => `
                            <div onclick="openPlayerProfile(${p.internalId})" class="flex items-center justify-between p-1.5 rounded bg-slate-800/40 hover:bg-slate-700/50 cursor-pointer transition-all">
                                <div class="flex items-center gap-2">
                                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-[9px] font-bold ${getRatingBg(p.rating)}">${p.rating}</span>
                                    <div class="min-w-0">
                                        <div class="text-[11px] font-bold text-slate-200 truncate">${p.name}</div>
                                        <div class="text-[8px] ${getPosColor(p.pos).split(' ')[0]} font-medium">${p.pos} • ${p.age}y</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[9px] font-bold text-white">${formatMoney(p.price)}</div>
                                    ${p.injuryWeeks > 0 ? '<span class="text-[7px] text-red-400 font-bold uppercase">Injured</span>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="p-2 bg-slate-800/80 border-t border-slate-700">
                    <button onclick="closeClubInfo()" class="w-full py-1.5 rounded bg-slate-700 hover:bg-slate-600 text-white text-[10px] font-bold uppercase tracking-widest transition-all">Close</button>
                </div>
            `;

            overlay.classList.remove('hidden');
        }

        function closeClubInfo() {
            document.getElementById('club-info-overlay').classList.add('hidden');
        }

        function openPlayerProfile(internalId, event) {
            if(event) event.stopPropagation();
            
            let player = null;
            let club = null;
            let isFreeAgentPlayer = false;

            for(const t of STATE.allTeams) {
                const p = t.squad.find(pl => pl.internalId === internalId);
                if (p) { player = p; club = t; break; }
            }
            
            if (!player) {
                player = STATE.freeAgents.find(p => p.internalId === internalId);
                if (player) {
                    isFreeAgentPlayer = true;
                    club = { name: 'Free Agent', color: '#10b981', id: null };
                }
            }
            
            if (!player) return;

            const overlay = document.getElementById('profile-overlay');
            const content = document.getElementById('profile-content');
            
            const getAttrClass = (val) => val >= 90 ? 'gold' : (val >= 80 ? 'text-emerald-400' : 'text-slate-300');
            const isUserPlayer = club.id === STATE.userTeamId;
            
            let actionButton = '';
            if (isFreeAgentPlayer) {
                actionButton = `<button onclick="signFreeAgent(${player.internalId}); closeProfile();" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg uppercase tracking-wider mb-2">Sign Free Agent</button>`;
            } else if (isUserPlayer) {
                actionButton = `<button id="transfer-list-btn" onclick="toggleTransferList(${player.internalId})" class="w-full ${player.transferListed ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'} font-bold py-3 rounded-lg uppercase tracking-wider mb-2">${player.transferListed ? 'Remove from List' : 'Add to Transfer List'}</button>`;
            } else {
                const isInWishlist = STATE.wishlist.some(w => w.internalId === player.internalId);
                actionButton = `<button onclick="event.stopPropagation(); toggleWishlist(${player.internalId}); closeProfile();" class="w-full ${isInWishlist ? 'bg-red-600 hover:bg-red-500' : 'bg-amber-600 hover:bg-amber-500'} text-white font-bold py-3 rounded-lg uppercase tracking-wider mb-2">${isInWishlist ? '💔 Remove from Wishlist' : '⭐ Add to Wishlist'}</button>`;
            }
            
            let statusBadge = '';
            if (player.injuryWeeks > 0) statusBadge = `<div class="bg-red-600 text-white px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest shadow-lg">🩹 ${player.injuryWeeks} Wks</div>`;
            else if (player.isSuspended) statusBadge = `<div class="bg-red-600 text-white px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest shadow-lg">🟥 Suspended</div>`;
            else if (player.onLoan) {
                const parentClub = getTeam(player.loanParentClub);
                statusBadge = `<div class="bg-blue-600 text-white px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest shadow-lg">🤝 On Loan${parentClub ? ' from ' + parentClub.name : ''}</div>`;
            }

            let contractDisplay = '';
            if (player.onLoan) {
                const loanYearsLeft = (player.loanEndSeason || STATE.season) - STATE.season;
                contractDisplay = loanYearsLeft <= 0 ? '<span class="text-blue-400 font-bold">LOAN ENDS THIS SEASON</span>' : `<span class="text-blue-400 font-bold">Loan: ${loanYearsLeft} Year${loanYearsLeft > 1 ? 's' : ''} Left</span>`;
            } else {
                const yearsLeft = (player.endContract || STATE.season) - STATE.season;
                contractDisplay = yearsLeft <= 0 ? '<span class="text-red-400 font-bold">EXPIRES THIS SEASON</span>' : `${yearsLeft} Year${yearsLeft > 1 ? 's' : ''} Left (${player.endContract})`;
            }

            content.innerHTML = `
                <div class="w-full h-full bg-slate-950 text-white select-none flex flex-row overflow-hidden relative">
                    <!-- Close Button -->
                    <button onclick="closeProfile()" class="absolute top-4 right-4 z-50 w-10 h-10 flex items-center justify-center rounded-full bg-slate-800 hover:bg-slate-700 text-white transition-colors">✕</button>

                    <!-- Left Sidebar: Player Identity -->
                    <div class="w-64 bg-gradient-to-b from-slate-800 to-slate-950 p-8 flex flex-col items-center justify-between border-r border-white/10 shadow-2xl">
                        <div class="text-center">
                            <div class="text-6xl font-black ${getAttrClass(player.rating)} mb-1">${player.rating}</div>
                            <div class="text-xl font-bold opacity-40 uppercase tracking-widest">${player.pos}</div>
                            <div class="mt-2 px-3 py-1 bg-white/5 rounded-full text-[10px] font-bold text-slate-400 uppercase tracking-widest">Potential: ${player.potential || 'N/A'}</div>
                        </div>

                        <div class="relative w-48 h-48 my-8">
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-950 to-transparent rounded-full opacity-50"></div>
                            <img src="Datapack/Face/default.png" class="w-full h-full object-contain player-face-img relative z-10" onerror="this.src='https://via.placeholder.com/150'">
                        </div>

                        <div class="w-full space-y-4">
                            <div class="flex justify-center">
                                ${isFreeAgentPlayer ? renderTeamLogo({id: 'free-agent', name: 'FA', color: '#10b981'}, 'lg') : renderTeamLogo(club, 'lg')}
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-1">Current Club</div>
                                <div class="text-sm font-bold text-white">${club.name}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Content Section -->
                    <div class="flex-1 flex flex-col p-10 overflow-y-auto">
                        <!-- Header: Name & Market Info -->
                        <div class="flex justify-between items-end mb-10">
                            <div>
                                <div class="flex items-center gap-3 mb-2">
                                    <h2 class="text-5xl font-black uppercase tracking-tighter text-white">${player.name}</h2>
                                    ${statusBadge}
                                </div>
                                <div class="flex gap-6 text-sm font-bold text-slate-500 uppercase tracking-widest">
                                    <span>${player.nation || 'International'}</span>
                                    <span>Age: ${player.age}</span>
                                    <span>Foot: ${player.foot || 'Right'}</span>
                                </div>
                            </div>
                            <div class="text-right max-w-[180px]">
                                <div class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-1">Market Value</div>
                                <div class="text-emerald-400 font-black text-2xl md:text-3xl truncate">${isFreeAgentPlayer ? 'FREE' : formatMoney(player.price)}</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-10">
                            <!-- Left Column: Attributes & Stats -->
                            <div class="space-y-8">
                                <div>
                                    <h3 class="text-xs font-black text-slate-600 uppercase tracking-[0.2em] mb-4">Technical Attributes</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center">
                                            <span class="text-xs font-bold text-slate-400">Pace</span>
                                            <span class="text-xl font-black ${getAttrClass(player.speed)}">${player.speed}</span>
                                        </div>
                                        <div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center">
                                            <span class="text-xs font-bold text-slate-400">Shooting</span>
                                            <span class="text-xl font-black ${getAttrClass(player.shot)}">${player.shot}</span>
                                        </div>
                                        <div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center">
                                            <span class="text-xs font-bold text-slate-400">Passing</span>
                                            <span class="text-xl font-black ${getAttrClass(player.pass)}">${player.pass}</span>
                                        </div>
                                        <div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center">
                                            <span class="text-xs font-bold text-slate-400">Dribbling</span>
                                            <span class="text-xl font-black ${getAttrClass(player.dribble)}">${player.dribble}</span>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-xs font-black text-slate-600 uppercase tracking-[0.2em] mb-4">Season Performance</h3>
                                    <div class="grid grid-cols-4 gap-4">
                                        <div class="text-center">
                                            <div class="text-2xl font-black text-white">${player.seasonGoals || 0}</div>
                                            <div class="text-[9px] font-bold text-slate-500 uppercase">Goals</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-black text-white">${player.seasonAssists || 0}</div>
                                            <div class="text-[9px] font-bold text-slate-500 uppercase">Assists</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-black text-yellow-500">${player.seasonRating || 0}</div>
                                            <div class="text-[9px] font-bold text-slate-500 uppercase">Rating</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-black text-slate-400">${player.careerGoals || 0}</div>
                                            <div class="text-[9px] font-bold text-slate-500 uppercase">Career</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Contract & Actions -->
                            <div class="space-y-8">
                                <div class="bg-white/5 rounded-3xl p-8 border border-white/5">
                                    <h3 class="text-xs font-black text-slate-600 uppercase tracking-[0.2em] mb-6">Contract Status</h3>
                                    <div class="space-y-6">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-bold text-slate-400">Expiry</span>
                                            <span class="text-sm font-black text-white">${contractDisplay}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-bold text-slate-400">Weekly Wage</span>
                                            <span class="text-sm font-black text-emerald-400">${formatMoney(player.salary || 0)}</span>
                                        </div>
                                        <div class="pt-4 border-t border-white/5">
                                            <div class="flex justify-between text-[10px] font-bold text-slate-500 uppercase mb-2">
                                                <span>Match Fitness</span>
                                                <span>${player.energy || 100}%</span>
                                            </div>
                                            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                                <div class="h-full bg-emerald-500" style="width: ${player.energy || 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-4">
                                    ${actionButton.replace('w-full', 'w-full py-4 text-sm font-black')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            overlay.classList.remove('hidden');
        }

        function closeProfile(event) {
            document.getElementById('profile-overlay').classList.add('hidden');
        }

        function renderUploadScreen() {
            document.getElementById('app').innerHTML = `
                <div class="w-full h-full flex flex-col items-center justify-center p-4 md:p-6 bg-slate-900">
                    <div class="glass-panel p-6 md:p-10 rounded-2xl max-w-md w-full text-center shadow-2xl">
                        <h1 class="text-2xl md:text-3xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-[#4caf50] to-cyan-400">FootGreat</h1>
                        <p class="text-slate-500 mb-6 text-xs">Welcome To Real Football</p>
                        
                        <!-- New Game Section -->
                        <div class="mb-6">
                            <label class="cursor-pointer block w-full border-2 border-dashed border-slate-600 hover:border-[#4caf50] rounded-xl p-6 transition-all hover:bg-slate-800/50">
                                <div class="flex flex-col items-center gap-2">
                                    <span class="text-3xl">📂</span>
                                    <span class="text-sm font-bold text-white">Load Database</span>
                                    <span class="text-[10px] text-slate-500">Select JSON or SQLite file to start new game</span>
                                </div>
                                <input type="file" accept=".json,.db,.sqlite" class="hidden" onchange="handleFileUpload(event)">
                            </label>
                        </div>
                        
                        <div class="text-slate-600 text-xs mb-4">— or —</div>
                        
                        <!-- Load Save Section -->
                        <button onclick="openLoadModal().catch(console.error)" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-xl p-4 transition-all flex items-center justify-center gap-3">
                            <span class="text-2xl">💾</span>
                            <div class="text-left">
                                <div class="text-sm font-bold text-white">Load Save</div>
                                <div class="text-[10px] text-slate-500">Continue from saved game</div>
                            </div>
                        </button>
                    </div>
            `;
        }

        function renderTeamSelection() {
            const leagues = {};
            STATE.allTeams.forEach(t => {
                const leagueId = t.leagueId;
                const leagueInfo = STATE.leaguesMap.get(leagueId) || { 
                    name: t.leagueName || 'Other League',
                    division: 1,
                    nation: 'INT',
                    promotions: 3,
                    directPromotions: 3,
                    relegations: 3
                };
                
                let displayName = leagueInfo.name;
                if (leagueInfo.division && leagueInfo.nation) {
                    displayName += ` (Div ${leagueInfo.division}, ${leagueInfo.nation})`;
                } else if (leagueInfo.division) {
                    displayName += ` (Div ${leagueInfo.division})`;
                }
                
                if (!leagues[displayName]) {
                    leagues[displayName] = {
                        teams: [],
                        leagueId: leagueId,
                        leagueInfo: leagueInfo
                    };
                }
                leagues[displayName].teams.push(t);
            });

            const sortedLeagues = Object.keys(leagues).sort((a, b) => {
                const leagueA = leagues[a].leagueInfo;
                const leagueB = leagues[b].leagueInfo;
                
                if (leagueA.nation !== leagueB.nation) {
                    return (leagueA.nation || '').localeCompare(leagueB.nation || '');
                }
                if (leagueA.division !== leagueB.division) {
                    return (leagueA.division || 99) - (leagueB.division || 99);
                }
                return (leagueA.name || '').localeCompare(leagueB.name || '');
            });

            let html = `
                <div class="w-full h-full overflow-y-auto bg-[#0f0f0f]">
                    <div class="max-w-6xl mx-auto p-2 md:p-4">
                        <h2 class="text-lg md:text-xl font-black mb-3 text-white text-center">SELECT CLUB</h2>
                        <div class="space-y-2">
            `;

            sortedLeagues.forEach((displayName, i) => {
                const leagueData = leagues[displayName];
                // Split teams into left and right columns (6 per side for 12 total visible)
                const teamsPerColumn = 6;
                const leftTeams = leagueData.teams.slice(0, teamsPerColumn);
                const rightTeams = leagueData.teams.slice(teamsPerColumn, teamsPerColumn * 2);
                const remainingTeams = leagueData.teams.slice(teamsPerColumn * 2);
                
                html += `
                    <div class="bg-slate-800/80 rounded-lg overflow-hidden border border-slate-700/50">
                        <button onclick="toggleLeague('l-${i}')" class="w-full px-3 py-2 flex justify-between items-center hover:bg-slate-700/50 transition-colors">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-sm text-white">${displayName}</span>
                                <span class="text-[10px] text-slate-500 bg-slate-700/50 px-1.5 py-0.5 rounded">${leagueData.teams.length} teams</span>
                            </div>
                            <span class="text-slate-500 text-xs">▼</span>
                        </button>
                        <div id="l-${i}" class="accordion-content bg-[#0a0a0a]">
                            <div class="p-2">
                                <!-- Two-column layout: 6 teams per side = 12 visible -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-1">
                                    <!-- Left Column (6 teams) -->
                                    <div class="space-y-1">
                                        ${leftTeams.map(t => `
                                            <div onclick="selectTeam('${t.id}')" class="cursor-pointer bg-slate-800/60 hover:bg-[#4caf50]/20 border border-slate-700/40 hover:border-[#4caf50] px-2 py-1.5 rounded flex justify-between items-center group transition-all">
                                                <div class="flex items-center gap-2 min-w-0">
                                                    ${renderTeamLogo(t, 'xs')}
                                                    <span class="font-medium text-slate-300 group-hover:text-white text-xs truncate">${t.name}</span>
                                                </div>
                                                <span class="text-[10px] text-slate-500 font-mono ml-2">${t.teamRating}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <!-- Right Column (6 teams) -->
                                    <div class="space-y-1">
                                        ${rightTeams.map(t => `
                                            <div onclick="selectTeam('${t.id}')" class="cursor-pointer bg-slate-800/60 hover:bg-[#4caf50]/20 border border-slate-700/40 hover:border-[#4caf50] px-2 py-1.5 rounded flex justify-between items-center group transition-all">
                                                <div class="flex items-center gap-2 min-w-0">
                                                    ${renderTeamLogo(t, 'xs')}
                                                    <span class="font-medium text-slate-300 group-hover:text-white text-xs truncate">${t.name}</span>
                                                </div>
                                                <span class="text-[10px] text-slate-500 font-mono ml-2">${t.teamRating}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ${remainingTeams.length > 0 ? `
                                    <!-- Additional teams in compact grid -->
                                    <div class="mt-2 pt-2 border-t border-slate-700/30">
                                        <div class="grid grid-cols-3 gap-1">
                                            ${remainingTeams.map(t => `
                                                <div onclick="selectTeam('${t.id}')" class="cursor-pointer bg-slate-800/40 hover:bg-[#4caf50]/20 border border-slate-700/30 hover:border-[#4caf50] px-1.5 py-1 rounded flex items-center gap-1 group transition-all">
                                                    ${renderTeamLogo(t, 'xs')}
                                                    <span class="font-medium text-slate-400 group-hover:text-white text-[10px] truncate">${t.name}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div></div></div>`;
            document.getElementById('app').innerHTML = html;
        }

        function toggleLeague(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('open')) el.classList.remove('open');
            else el.classList.add('open');
        }

        // NEW: Show loading screen
        function showLoadingScreen(message = 'Loading...') {
            const loadingHtml = `
                <div id="loading-screen" class="loading-screen">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">${message}</div>
                    <div class="loading-progress">
                        <div class="loading-progress-bar"></div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingHtml);
        }
        
        // NEW: Hide loading screen
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => loadingScreen.remove(), 300);
            }
        }
        
        function selectTeam(id) {
            console.log("Selecting team with id:", id);
            STATE.userTeamId = id;
            const t = getTeam(id);
            
            if (!t) {
                console.error("Team not found with id:", id);
                alert("Error: Team not found!");
                return;
            }
            
            console.log("Selected team:", t.name);
            
            // Show loading screen
            showLoadingScreen('Initializing Career Mode...');
            
            // Use setTimeout to allow loading screen to render
            setTimeout(() => {
                // НОВОЕ: Сохраняем userLeagueId как источник истины
                STATE.userLeagueId = t.leagueId;
                STATE.activeLeagueTeams = STATE.allTeams.filter(x => x.leagueId === t.leagueId);
                initSchedule();
                initLeagueCup();
                initCalendar();
                
                // Preload logos
                LogoManager.preloadLogos(STATE.allTeams).catch(e => console.warn('Logo preload failed:', e));
                
                // Hide loading screen and render dashboard
                setTimeout(() => {
                    hideLoadingScreen();
                    renderDashboard();
                }, 500);
            }, 100);
        }

        function renderDashboard() {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) {
                console.error("User team not found!");
                renderTeamSelection();
                return;
            }
            
            // Set career mode for ModAPI - activates career mods
            if (window.ModAPI) {
                window.ModAPI.setCareerMode(true);
                window.ModAPI._renderCustomMenuItems();
            }
            
            updateMobileMenuInfo();
            const isFinished = STATE.calendar.currentWeek >= STATE.calendar.weeks.length;
            
            // ModAPI: Season end is handled in endSeason() function, not here
            // (removed duplicate trigger that fired on every dashboard render)

            // LANDSCAPE LAYOUT - Always horizontal with left nav - MORE COMPACT
            document.getElementById('app').innerHTML = `
                <div class="flex h-full w-full overflow-hidden bg-[#0a0a0a]">
                    <!-- Left Navigation Rail - Compact -->
                    <nav class="landscape-nav flex-shrink-0">
                        <div class="mb-1 text-[#4caf50] font-black text-[10px]">FM</div>
                        ${landscapeNavBtn('next-match', '⚽', 'Match')}
                        ${landscapeNavBtn('tactics', '📋', 'Team')}
                        ${landscapeNavBtn('table', '📊', 'Table')}
                        ${landscapeNavBtn('squad', '👥', 'Squad')}
                        ${landscapeNavBtn('market', '💰', 'Market')}
                        ${landscapeNavBtn('stats', '📈', 'Stats')}
                        ${landscapeNavBtn('trophy', '🏆', 'Trophy')}
                        ${landscapeNavBtn('news', '📰', 'News')}
                        ${landscapeNavBtn('calendar', '📅', 'Cal')}
                        <div id="mod-nav-items"></div>
                        <div class="flex-grow"></div>
                        <button onclick="openModsMenu()" class="landscape-nav-btn text-purple-400 hover:text-purple-300" title="Mods">🧩</button>
                        <button onclick="saveGame()" class="landscape-nav-btn text-slate-400 hover:text-white" title="Save"><img src="${LogoManager.getUIIconPath('ui/icons/save_game.png')}" alt="Save" style="width: 18px; height: 18px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><span style="display:none;">💾</span></button>
                      
                    </nav>
                    
                    <!-- Main Content Area -->
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <!-- Top Header Bar - Compact -->
                        <header class="landscape-header flex-shrink-0">
                            <div class="flex items-center gap-2">
                                ${renderTeamLogo(userTeam, 'xs')}
                                <span class="font-bold text-white text-xs leading-tight truncate max-w-[120px]">${userTeam.name}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-1 text-[10px]">
                                    <span class="text-slate-500">£</span>
                                    <span class="font-bold text-emerald-400">${formatMoney(userTeam.budget).replace('£', '')}</span>
                                </div>
                                <div class="flex items-center gap-1 text-[10px]">
                                    <span class="text-slate-500">W:</span>
                                    <span class="font-bold text-white">${STATE.calendar.currentWeek + 1}/${STATE.calendar.weeks.length}</span>
                                </div>
                                <div class="flex items-center gap-1 text-[10px]">
                                    <span class="text-slate-500">S:</span>
                                    <span class="font-bold text-white">${STATE.season}</span>
                                </div>
                                <button id="playWeekBtn" ${isFinished ? 'disabled' : ''} 
                                    class="bg-[#4caf50] hover:bg-[#43a047] disabled:opacity-50 disabled:cursor-not-allowed text-white px-3 py-1 rounded font-bold shadow-lg text-[10px] uppercase tracking-wide transition-all">
                                    ${isFinished ? 'End' : 'Play'}
                                </button>
                            </div>
                        </header>
                        
                        <!-- Content Area - Compact padding -->
                        <div class="flex-1 overflow-hidden p-2">
                            ${getLandscapeContent(userTeam, isFinished)}
                        </div>
                    </div>
                </div>
            `;
            
            // ИСПРАВЛЕНИЕ: Вызываем событие dashboardRender для модов после перерисовки
            // Это позволяет модам пересоздать свои UI-элементы
            if (window.ModAPI) {
                setTimeout(() => {
                    window.ModAPI._refreshModWindows();
                }, 50);
            }
        }
        
        // Icon mapping for navigation buttons
        const navIconMap = {
            'next-match': 'ui/icons/match.png',
            'tactics': 'ui/icons/tactics.png',
            'table': 'ui/icons/league_table.png',
            'squad': 'ui/icons/tactics.png',
            'market': 'ui/icons/transfers.png',
            'stats': 'ui/icons/league_table.png',
            'trophy': 'ui/icons/trophy_room.png',
            'news': 'ui/icons/news.png',
            'calendar': 'ui/icons/calendar.png',
            'save': 'ui/icons/save_game.png',
            
            'settings': 'ui/icons/settings.png'
        };
        
        function landscapeNavBtn(view, icon, label) {
            const active = STATE.view === view ? 'active' : '';
            const iconPath = navIconMap[view] || '';
            const iconHtml = iconPath 
                ? `<img src="${LogoManager.getUIIconPath(iconPath)}" alt="${label}" style="width: 18px; height: 18px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><span style="display:none;">${icon}</span>`
                : icon;
            return `<button onclick="STATE.view='${view}'; STATE.activeSwapSlot=null; renderDashboard()" class="landscape-nav-btn ${active}" title="${label}">${iconHtml}</button>`;
        }
        
        function navBtn(view, label) {
            const active = STATE.view === view ? 'bg-[#4caf50]/10 text-[#4caf50] border-r-4 border-[#4caf50]' : 'text-slate-400 hover:text-white hover:bg-slate-700/50';
            return `<button onclick="STATE.view='${view}'; STATE.activeSwapSlot=null; renderDashboard()" class="w-full text-left px-4 py-2 font-bold transition-all text-sm ${active}">${label}</button>`;
        }
        
        // LANDSCAPE-OPTIMIZED CONTENT FUNCTION
        function getLandscapeContent(userTeam, isFinished) {
            if (STATE.view === 'news') {
                return `
                    <div class="h-full overflow-y-auto glass-panel rounded-lg p-3">
                        <h3 class="text-sm font-bold text-white mb-3 border-b border-slate-700 pb-2">Latest News</h3>
                        <div class="space-y-2">
                            ${STATE.newsFeed.length === 0 ? '<div class="text-slate-500 text-sm text-center py-4">No news yet.</div>' :
                            STATE.newsFeed.slice(0, 20).map(item => `
                                <div class="bg-slate-800/50 p-2 rounded type-${item.type}">
                                    <div class="flex justify-between items-start">
                                        <span class="font-bold text-white text-xs">${item.title}</span>
                                        <span class="text-[10px] text-slate-500">S${item.season}W${item.week}</span>
                                    </div>
                                    <p class="text-slate-300 text-xs mt-0.5">${item.msg}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }
            
            if (STATE.view === 'stats') {
                calculateLeagueStats();
                const userTeamForStats = getTeam(STATE.userTeamId);
                return `
                    <div class="h-full flex flex-col overflow-hidden">
                        <!-- Header with Your Team Stats -->
                        <div class="flex-shrink-0 glass-panel rounded-lg p-3 mb-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    ${renderTeamLogo(userTeamForStats, 'sm')}
                                    <div>
                                        <h3 class="text-sm font-bold text-white">League Statistics - Season ${STATE.season}</h3>
                                        <p class="text-[10px] text-slate-400">${userTeamForStats.leagueName || 'League'}</p>
                                    </div>
                                </div>
                                <div class="flex gap-6">
                                    <div class="text-center">
                                        <div class="text-lg font-black text-[#4caf50]">${userTeamForStats.points}</div>
                                        <div class="text-[9px] text-slate-400 uppercase">Points</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-black text-white">${userTeamForStats.gf}</div>
                                        <div class="text-[9px] text-slate-400 uppercase">Goals</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-black ${userTeamForStats.gd >= 0 ? 'text-emerald-400' : 'text-red-400'}">${userTeamForStats.gd >= 0 ? '+' : ''}${userTeamForStats.gd}</div>
                                        <div class="text-[9px] text-slate-400 uppercase">GD</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Stats Columns -->
                        <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 min-h-0 overflow-y-auto">
                            ${renderLandscapeStatsColumn('⚽ Golden Boot', STATE.leagueStats.topScorers, 'seasonGoals', 'goals', 'golden')}
                            ${renderLandscapeStatsColumn('🎯 Playmaker Award', STATE.leagueStats.topAssists, 'seasonAssists', 'assists', 'playmaker')}
                            ${renderLandscapeStatsColumn('⭐ Player of the Season', STATE.leagueStats.bestPlayers, 'seasonRating', 'rating', 'mvp')}
                        </div>
                    </div>`;
            }
            
            // Handle other views by calling helper functions
            if (STATE.view === 'calendar') {
                return renderLandscapeCalendar();
            }
            
            if (STATE.view === 'squad') {
                return renderLandscapeSquad(userTeam);
            }
            
            if (STATE.view === 'market') {
                return renderLandscapeMarket(userTeam);
            }
            
            if (STATE.view === 'table') {
                return renderLandscapeTable();
            }
            
            if (STATE.view === 'next-match') {
                return renderLandscapeNextMatch(userTeam);
            }
            
            if (STATE.view === 'tactics') {
                return renderLandscapeTactics(userTeam);
            }
            
            if (STATE.view === 'trophy') {
                return renderLandscapeTrophy(userTeam);
            }
            
            // Default fallback - should never reach here
            return `<div class="h-full flex items-center justify-center text-slate-500">Select a menu item</div>`;
        }
        
        
        function renderLandscapeStatsColumn(title, data, field, label, awardType) {
            const awardColors = {
                golden: { bg: 'from-yellow-500/30 to-amber-600/20', border: 'border-yellow-500/40', icon: '⚽', topBg: 'bg-gradient-to-r from-yellow-500 to-amber-500' },
                playmaker: { bg: 'from-cyan-500/30 to-blue-600/20', border: 'border-cyan-500/40', icon: '🎯', topBg: 'bg-gradient-to-r from-cyan-500 to-blue-500' },
                mvp: { bg: 'from-purple-500/30 to-pink-600/20', border: 'border-purple-500/40', icon: '⭐', topBg: 'bg-gradient-to-r from-purple-500 to-pink-500' }
            };
            const colors = awardColors[awardType] || awardColors.golden;
            
            return `
                <div class="glass-panel rounded-lg flex flex-col overflow-hidden h-full">
                    <div class="flex-shrink-0 p-2 bg-gradient-to-r ${colors.bg} border-b ${colors.border}">
                        <h4 class="text-xs font-bold text-white flex items-center gap-2">
                            <span class="text-base">${colors.icon}</span>
                            ${title}
                        </h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2 space-y-1.5">
                        ${data.length === 0 ? '<div class="text-slate-500 text-xs text-center py-4 italic">No data yet</div>' :
                        data.slice(0, 15).map((p, i) => `
                            <div onclick="openPlayerProfile(${p.internalId || 0})" class="flex items-center justify-between p-2 rounded-lg cursor-pointer transition-all hover:scale-[1.02] ${i === 0 ? `bg-gradient-to-r ${colors.bg} border ${colors.border} shadow-lg` : i < 3 ? 'bg-slate-800/70 hover:bg-slate-700/70' : 'bg-slate-800/40 hover:bg-slate-800/60'}">
                                <div class="flex items-center gap-2">
                                    <span class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold ${i === 0 ? colors.topBg + ' text-white shadow-md' : i === 1 ? 'bg-slate-500 text-white' : i === 2 ? 'bg-amber-700 text-white' : 'bg-slate-700 text-slate-400'}">${i+1}</span>
                                    <div class="min-w-0">
                                        <div class="text-xs font-bold text-slate-200 truncate max-w-[90px] flex items-center gap-1">
                                            ${p.name}
                                            ${i === 0 ? '<span class="text-[8px]">👑</span>' : ''}
                                        </div>
                                        <div class="text-[9px] text-slate-400 truncate max-w-[90px]">${p.teamName || ''}</div>
                                    </div>
                                </div>
                                <div class="text-right flex-shrink-0">
                                    <div class="text-base font-black ${i === 0 ? 'text-yellow-400 drop-shadow-glow' : i < 3 ? 'text-white' : 'text-slate-300'}">${label === 'rating' ? Math.round(p[field] || 0) : (p[field] || 0)}</div>
                                    <div class="text-[8px] text-slate-500 uppercase">${label}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }
        
        // FEATURE #6: Redesigned compact calendar with better visual hierarchy
        function renderLandscapeCalendar() {
            const weeks = STATE.calendar.weeks || [];
            const currentWeek = STATE.calendar.currentWeek;
            
            // Get event type icons
            const getEventIcon = (type) => {
                if (type === 'LEAGUE') return 'L';
                if (type === 'CUP') return '🏆';
                if (type === 'EURO') return '⭐';
                if (type === 'EURO_KO') return '🌟';
                return '?';
            };
            
            const getEventColors = (events) => {
                let hasLeague = events.some(e => e.type === 'LEAGUE');
                let hasCup = events.some(e => e.type === 'CUP');
                let hasEuro = events.some(e => e.type === 'EURO' || e.type === 'EURO_KO');
                
                if (hasEuro) return 'border-l-2 border-blue-400';
                if (hasCup) return 'border-l-2 border-purple-400';
                return '';
            };
            
            return `
                <div class="h-full overflow-y-auto glass-panel rounded-lg p-2">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-bold text-white">Season ${STATE.season} Calendar</h3>
                        <div class="flex gap-2 text-[9px] text-slate-400">
                            <span>L=League</span>
                            <span>🏆=Cup</span>
                            <span>⭐=Euro</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-10 gap-1">
                        ${weeks.slice(0, 50).map((w, i) => {
                            const isPlayed = w.played;
                            const isCurrent = i === currentWeek;
                            const events = w.events.map(e => getEventIcon(e.type)).join('');
                            const eventCount = w.events.length;
                            const colorClass = getEventColors(w.events);
                            
                            return `
                                <div class="p-1 rounded text-center text-[9px] ${colorClass} ${isCurrent ? 'bg-[#4caf50] text-white ring-1 ring-[#4caf50]' : isPlayed ? 'bg-slate-700/50 text-slate-500' : 'bg-slate-800 text-slate-300'}">
                                    <div class="font-bold text-[10px]">${i + 1}</div>
                                    <div class="text-[8px] truncate" title="${w.events.map(e => e.type).join('+')}">${eventCount > 1 ? '⚡' : events}</div>
                                </div>`;
                        }).join('')}
                    </div>
                    ${weeks.length > 50 ? `<div class="text-[10px] text-slate-500 text-center mt-2">+${weeks.length - 50} more weeks</div>` : ''}
                </div>`;
        }
        
        function renderLandscapeSquad(userTeam) {
            const squad = [...userTeam.squad].sort((a, b) => b.rating - a.rating);
            return `
                <div class="h-full overflow-hidden flex flex-col glass-panel rounded-lg">
                    <div class="flex-shrink-0 p-2 border-b border-slate-700 flex justify-between items-center">
                        <span class="text-xs font-bold text-white">Squad (${squad.length} players)</span>
                        <span class="text-xs text-slate-400">Team Rating: ${userTeam.teamRating}</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2">
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-1">
                            ${squad.map(p => `
                                <div onclick="openPlayerProfile(${p.internalId})" class="bg-slate-800/70 hover:bg-slate-700 p-1.5 rounded cursor-pointer flex items-center gap-2">
                                    <div class="w-7 h-7 rounded-full flex items-center justify-center font-bold text-xs ${getRatingBg(p.rating)}">${p.rating}</div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-xs font-bold text-white truncate">${p.name.split(' ').pop()}</div>
                                        <div class="flex gap-1 text-[10px]">
                                            <span class="${getPosColor(p.pos).split(' ')[0]}">${p.pos}</span>
                                            <span class="text-slate-500">${p.age}y</span>
                                            ${p.injuryWeeks > 0 ? '<span class="text-red-400">🩹</span>' : ''}
                                            ${p.isSuspended ? '<span class="text-red-400">🟥</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        }
        
        function getRatingBg(r) {
            if (r >= 85) return 'bg-gradient-to-b from-yellow-500 to-yellow-600 text-black';
            if (r >= 75) return 'bg-gradient-to-b from-green-500 to-green-600 text-white';
            if (r >= 65) return 'bg-gradient-to-b from-blue-500 to-blue-600 text-white';
            return 'bg-gradient-to-b from-slate-500 to-slate-600 text-white';
        }
        
        function renderLandscapeMarket(userTeam) {
            // Wishlist view for landscape
            if (STATE.marketTab === 'wishlist') {
                const wishlistPlayers = getWishlistPlayers();
                return `
                    <div class="h-full flex flex-col glass-panel rounded-lg overflow-hidden">
                        <div class="flex-shrink-0 p-2 border-b border-slate-700 flex items-center gap-2">
                            <button onclick="STATE.marketTab = 'market'; renderDashboard();" 
                                class="px-2 py-1 rounded text-xs font-bold text-slate-400 hover:text-white">🛒 Market</button>
                            <button onclick="STATE.marketTab = 'wishlist'; renderDashboard();" 
                                class="px-2 py-1 rounded text-xs font-bold bg-amber-600 text-white">⭐ Wishlist (${STATE.wishlist.length})</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2">
                            ${wishlistPlayers.length > 0 ? `
                                <div class="space-y-1">
                                    ${wishlistPlayers.map(p => {
                                        const club = p.clubId ? getTeam(p.clubId) : null;
                                        return `
                                            <div class="bg-slate-800/50 p-2 rounded flex items-center gap-2">
                                                <div class="w-6 h-6 rounded-full flex items-center justify-center font-bold text-[10px] ${getRatingBg(p.rating)}">${p.rating}</div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="text-[11px] font-bold text-white truncate">${p.name}</div>
                                                    <div class="text-[9px] text-slate-400">${p.pos} • ${p.isFreeAgent ? 'FREE' : formatMoney(p.price)}</div>
                                                </div>
                                                ${p.isFreeAgent 
                                                    ? `<button onclick="signFreeAgent(${p.internalId}); removeFromWishlist(${p.internalId});" class="bg-emerald-600 hover:bg-emerald-500 text-white text-[9px] font-bold px-2 py-1 rounded">Sign</button>`
                                                    : `<button onclick="openContactClubMenu(${p.internalId});" class="bg-blue-600 hover:bg-blue-500 text-white text-[9px] font-bold px-2 py-1 rounded">📞</button>`
                                                }
                                                <button onclick="removeFromWishlist(${p.internalId})" class="text-red-400 hover:text-red-300 text-xs">✕</button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `<div class="text-center text-slate-500 py-8 text-xs">No players in wishlist</div>`}
                        </div>
                    </div>`;
            }
            
            // Market view
            const players = getFilteredMarketPlayers();
            const allPositions = new Set();
            STATE.allTeams.forEach(t => t.squad.forEach(p => allPositions.add(p.pos)));
            const sortedPositions = [...allPositions].sort();
            const allNations = new Set();
            STATE.allTeams.forEach(t => t.squad.forEach(p => { if(p.nation) allNations.add(p.nation); }));
            const sortedNations = [...allNations].sort();
            
            return `
                <div class="h-full flex flex-col glass-panel rounded-lg overflow-hidden">
                    <!-- Tabs -->
                    <div class="flex-shrink-0 p-2 border-b border-slate-700 flex items-center gap-2">
                        <button onclick="STATE.marketTab = 'market'; renderDashboard();" 
                            class="px-2 py-1 rounded text-xs font-bold bg-[#4caf50] text-white">🛒 Market</button>
                        <button onclick="STATE.marketTab = 'wishlist'; renderDashboard();" 
                            class="px-2 py-1 rounded text-xs font-bold text-slate-400 hover:text-white">⭐ (${STATE.wishlist.length})</button>
                        <div class="ml-auto flex gap-1">
                            <button onclick="STATE.market.showFreeAgents=false; renderDashboard();" 
                                class="px-1.5 py-0.5 rounded text-[9px] font-bold ${!STATE.market.showFreeAgents ? 'bg-slate-700 text-white' : 'text-slate-400'}">Clubs</button>
                            <button onclick="STATE.market.showFreeAgents=true; renderDashboard();" 
                                class="px-1.5 py-0.5 rounded text-[9px] font-bold ${STATE.market.showFreeAgents ? 'bg-emerald-600 text-white' : 'text-slate-400'}">Free</button>
                        </div>
                    </div>
                    <!-- Filters Row 1: Search + Position -->
                    <div class="flex-shrink-0 p-2 border-b border-slate-700 space-y-2">
                        <div class="flex gap-2 items-center flex-wrap">
                            <input type="text" placeholder="Search name..." value="${STATE.market.search}" 
                                oninput="STATE.market.search=this.value; renderDashboard();"
                                class="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs w-28">
                            <div class="flex gap-1">
                                ${['ALL', 'GK', 'DEF', 'MID', 'FWD'].map(pos => `
                                    <button onclick="STATE.market.posFilter='${pos}'; STATE.market.posExact=''; renderDashboard();" 
                                        class="filter-btn ${STATE.market.posFilter === pos ? 'active' : ''}">${pos}</button>
                                `).join('')}
                            </div>
                            <select onchange="STATE.market.posFilter='EXACT'; STATE.market.posExact=this.value; renderDashboard();" 
                                class="bg-slate-800 border border-slate-600 rounded px-1 py-1 text-[10px] w-14">
                                <option value="">Pos</option>
                                ${sortedPositions.map(p => `<option value="${p}" ${STATE.market.posExact === p ? 'selected' : ''}>${p}</option>`).join('')}
                            </select>
                        </div>
                        <!-- Filters Row 2: Age, Rating, Price, Nation -->
                        <div class="flex gap-2 items-center flex-wrap text-[10px]">
                            <div class="flex items-center gap-1">
                                <span class="text-slate-500">Age:</span>
                                <input type="number" placeholder="Min" min="16" max="45" value="${STATE.market.ageMin}"
                                    onchange="STATE.market.ageMin=this.value; renderDashboard();"
                                    class="bg-slate-800 border border-slate-600 rounded px-1 py-0.5 w-10">
                                <span class="text-slate-600">-</span>
                                <input type="number" placeholder="Max" min="16" max="45" value="${STATE.market.ageMax}"
                                    onchange="STATE.market.ageMax=this.value; renderDashboard();"
                                    class="bg-slate-800 border border-slate-600 rounded px-1 py-0.5 w-10">
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-slate-500">Rtg:</span>
                                <input type="number" placeholder="Min" min="1" max="99" value="${STATE.market.ratingMin}"
                                    onchange="STATE.market.ratingMin=this.value; renderDashboard();"
                                    class="bg-slate-800 border border-slate-600 rounded px-1 py-0.5 w-10">
                                <span class="text-slate-600">-</span>
                                <input type="number" placeholder="Max" min="1" max="99" value="${STATE.market.ratingMax}"
                                    onchange="STATE.market.ratingMax=this.value; renderDashboard();"
                                    class="bg-slate-800 border border-slate-600 rounded px-1 py-0.5 w-10">
                            </div>
                            <select onchange="STATE.market.nation=this.value; renderDashboard();" 
                                class="bg-slate-800 border border-slate-600 rounded px-1 py-0.5 w-16">
                                <option value="">Nation</option>
                                ${sortedNations.map(n => `<option value="${n}" ${STATE.market.nation === n ? 'selected' : ''}>${n}</option>`).join('')}
                            </select>
                            <button onclick="resetMarketFilters();" class="text-red-400 hover:text-red-300 px-1">✕</button>
                            <span class="text-slate-400 ml-auto">${players.length} found</span>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-1">
                            ${players.slice(0, 60).map(p => {
                                const isInWishlist = STATE.wishlist.some(w => w.internalId === p.internalId);
                                return `
                                    <div class="bg-slate-800/50 hover:bg-slate-700 p-1.5 rounded flex items-center gap-2 ${isInWishlist ? 'ring-1 ring-amber-500/50' : ''}">
                                        <div class="w-6 h-6 rounded-full flex items-center justify-center font-bold text-[10px] ${getRatingBg(p.rating)}">${p.rating}</div>
                                        <div class="flex-1 min-w-0 cursor-pointer" onclick="openPlayerProfile(${p.internalId})">
                                            <div class="text-[11px] font-bold text-white truncate">${p.name}</div>
                                            <div class="text-[9px] text-slate-400 truncate">${p.pos} • ${p.age}y • ${p.isFreeAgent ? 'FREE' : formatMoney(p.price)}</div>
                                        </div>
                                        ${p.isFreeAgent 
                                            ? `<button onclick="event.stopPropagation(); signFreeAgent(${p.internalId});" class="bg-emerald-600 text-white text-[8px] font-bold px-1.5 py-0.5 rounded">Sign</button>`
                                            : isInWishlist 
                                                ? `<button onclick="event.stopPropagation(); toggleWishlist(${p.internalId});" class="bg-amber-600 text-white text-[8px] font-bold px-1.5 py-0.5 rounded">⭐</button>`
                                                : `<button onclick="event.stopPropagation(); toggleWishlist(${p.internalId});" class="bg-slate-700 hover:bg-amber-600 text-white text-[8px] font-bold px-1.5 py-0.5 rounded">+</button>`
                                        }
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
        }
        
        function renderLandscapeTable() {
            const sorted = [...STATE.activeLeagueTeams].sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
            return `
                <div class="h-full overflow-y-auto glass-panel rounded-lg">
                    <table class="w-full compact-table">
                        <thead class="bg-slate-800 sticky top-0">
                            <tr class="text-slate-400 text-[10px] uppercase">
                                <th class="text-left p-2">#</th>
                                <th class="text-left p-2">Team</th>
                                <th class="text-center p-2">P</th>
                                <th class="text-center p-2">W</th>
                                <th class="text-center p-2">D</th>
                                <th class="text-center p-2">L</th>
                                <th class="text-center p-2">GF</th>
                                <th class="text-center p-2">GA</th>
                                <th class="text-center p-2">GD</th>
                                <th class="text-center p-2 font-bold text-white">Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sorted.map((t, i) => {
                                const isUser = t.id === STATE.userTeamId;
                                let rowClass = '';
                                if (i < 4) rowClass = 'border-l-2 border-blue-500';
                                else if (i >= sorted.length - 3) rowClass = 'border-l-2 border-red-500';
                                if (isUser) rowClass += ' bg-[#4caf50]/10';
                                return `
                                    <tr class="${rowClass} hover:bg-slate-800/50">
                                        <td class="p-2 text-xs font-bold ${i < 4 ? 'text-blue-400' : i >= sorted.length - 3 ? 'text-red-400' : 'text-slate-500'}">${i + 1}</td>
                                        <td class="p-2 text-xs font-bold ${isUser ? 'text-[#4caf50]' : 'text-white'}">
                                            <div class="flex items-center gap-2 cursor-pointer group" onclick="openClubInfo('${t.id}', event)">
                                                ${renderTeamLogo(t, 'xs')}
                                                <span class="truncate group-hover:underline">${t.name}</span>
                                            </div>
                                        </td>
                                        <td class="p-2 text-xs text-center text-slate-400">${t.played}</td>
                                        <td class="p-2 text-xs text-center text-emerald-400">${t.wins}</td>
                                        <td class="p-2 text-xs text-center text-slate-400">${t.draws}</td>
                                        <td class="p-2 text-xs text-center text-red-400">${t.losses}</td>
                                        <td class="p-2 text-xs text-center text-slate-300">${t.gf}</td>
                                        <td class="p-2 text-xs text-center text-slate-300">${t.ga}</td>
                                        <td class="p-2 text-xs text-center ${t.gd >= 0 ? 'text-emerald-400' : 'text-red-400'}">${t.gd > 0 ? '+' : ''}${t.gd}</td>
                                        <td class="p-2 text-sm text-center font-black text-white">${t.points}</td>
                                    </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
        }
        
        function renderLandscapeNextMatch(userTeam) {
            // Find next match
            let nextMatch = null, opponent = null, matchType = 'League', cupRoundName = '';
            for (let w = STATE.calendar.currentWeek; w < STATE.calendar.weeks.length; w++) {
                const week = STATE.calendar.weeks[w];
                for (const event of week.events) {
                    if (event.played) continue;
                    if (event.type === "LEAGUE" && STATE.schedule[event.matchday]) {
                        const m = STATE.schedule[event.matchday].find(x => x.home === STATE.userTeamId || x.away === STATE.userTeamId);
                        if (m) {
                            nextMatch = m;
                            matchType = 'League';
                            opponent = getTeam(m.home === STATE.userTeamId ? m.away : m.home);
                            break;
                        }
                    } else if (event.type === "CUP" && STATE.cups.leagueCup) {
                        const cupRound = STATE.cups.leagueCup.rounds[event.round];
                        if (cupRound) {
                            const f = cupRound.fixtures.find(x => x.homeId === STATE.userTeamId || x.awayId === STATE.userTeamId);
                            if (f && !f.played) {
                                nextMatch = f;
                                matchType = 'Cup';
                                opponent = getTeam(f.homeId === STATE.userTeamId ? f.awayId : f.homeId);
                                cupRoundName = cupRound.name;
                                break;
                            }
                        }
                    }
                }
                if (nextMatch) break;
            }
            
            if (!nextMatch || !opponent) {
                return `<div class="h-full flex items-center justify-center text-slate-500">No upcoming matches</div>`;
            }
            
            const isHome = (nextMatch.home === STATE.userTeamId) || (nextMatch.homeId === STATE.userTeamId);
            
            return `
                <div class="h-full flex items-center justify-center">
                    <div class="glass-panel rounded-xl p-6 text-center max-w-xl">
                        <div class="text-xs text-[#4caf50] font-bold uppercase tracking-wider mb-4">
                            ${matchType}${cupRoundName ? ' - ' + cupRoundName : ''}
                        </div>
                           <div class="flex items-center justify-center gap-4 sm:gap-8">
                            <div class="text-center cursor-pointer group" onclick="openClubInfo('${userTeam.id}', event)">
                                ${renderTeamLogo(userTeam, 'lg')}
                                <div class="text-sm sm:text-lg font-black text-white mt-2 group-hover:underline truncate max-w-[80px] sm:max-w-none">${userTeam.name}</div>
                                <div class="text-[10px] sm:text-xs text-slate-400">${isHome ? 'HOME' : 'AWAY'}</div>
                            </div>
                            <div class="text-xl sm:text-3xl font-black text-slate-700 italic">VS</div>
                            <div class="text-center cursor-pointer group" onclick="openClubInfo('${opponent.id}', event)">
                                ${renderTeamLogo(opponent, 'lg')}
                                <div class="text-sm sm:text-lg font-black text-white mt-2 group-hover:underline truncate max-w-[80px] sm:max-w-none">${opponent.name}</div>
                                <div class="text-[10px] sm:text-xs text-slate-400">${isHome ? 'AWAY' : 'HOME'}</div>
                            </div>
                        </div>
                        <div class="mt-4 sm:mt-6 flex justify-center gap-6 sm:gap-12">
                            <div class="text-center">
                                <div class="text-xs text-slate-500 uppercase">Rating</div>
                                <div class="text-xl font-black text-white">${userTeam.teamRating}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-slate-500 uppercase">Rating</div>
                                <div class="text-xl font-black text-white">${opponent.teamRating}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        
        function renderLandscapeTactics(userTeam) {
            const validation = validateStartingXI(userTeam);
            const benchPlayers = getBenchPlayers(userTeam);
            const gamePlans = ['balanced', 'attacking', 'defensive', 'counter', 'possession'];
            const tactics = ['4-4-2', '4-3-3', '3-5-2', '4-2-3-1', '5-3-2'];
            
            return `
                <div class="h-full flex gap-3 overflow-hidden">
                    <!-- HORIZONTAL PITCH -->
                    <div class="flex-1 flex flex-col">
                        <div class="flex-shrink-0 flex justify-between items-center mb-2">
                            <div class="flex gap-2 items-center">
                                <select onchange="changeTactic(this.value)" class="bg-slate-800 text-white text-xs rounded px-2 py-1 border border-slate-600">
                                    ${tactics.map(t => `<option value="${t}" ${STATE.currentTactic === t ? 'selected' : ''}>${t}</option>`).join('')}
                                </select>
                                <select onchange="STATE.gamePlan=this.value" class="bg-slate-800 text-white text-xs rounded px-2 py-1 border border-slate-600">
                                    ${gamePlans.map(p => `<option value="${p}" ${STATE.gamePlan === p ? 'selected' : ''}>${p.charAt(0).toUpperCase() + p.slice(1)}</option>`).join('')}
                                </select>
                                <button onclick="autoSelectBestXI(getTeam('${userTeam.id}')); renderDashboard();" 
                                    class="bg-blue-600 hover:bg-blue-500 text-white font-bold text-[10px] px-2 py-1 rounded uppercase">AUTO</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs ${validation.valid ? 'text-emerald-400' : 'text-red-400'}">${validation.message}</span>
                                <span class="bg-[#4caf50]/20 text-[#4caf50] px-2 py-0.5 rounded text-xs font-bold">${userTeam.teamRating}</span>
                            </div>
                        </div>
                        
                        <!-- Horizontal football pitch -->
                        <div class="flex-1 relative bg-gradient-to-r from-green-700 via-green-600 to-green-700 rounded-lg overflow-hidden min-h-[200px]">
                            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 700 400" preserveAspectRatio="xMidYMid meet">
                                <!-- Field outline -->
                                <rect x="10" y="10" width="680" height="380" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                                <!-- Center line -->
                                <line x1="350" y1="10" x2="350" y2="390" stroke="rgba(255,255,255,0.25)" stroke-width="1"/>
                                <!-- Center circle -->
                                <circle cx="350" cy="200" r="50" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1"/>
                                <circle cx="350" cy="200" r="3" fill="rgba(255,255,255,0.25)"/>
                                <!-- Left goal area -->
                                <rect x="10" y="100" width="80" height="200" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1"/>
                                <rect x="10" y="140" width="40" height="120" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1"/>
                                <!-- Right goal area -->
                                <rect x="610" y="100" width="80" height="200" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1"/>
                                <rect x="650" y="140" width="40" height="120" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1"/>
                            </svg>
                            
                            <!-- Players - dynamic formation layout -->
                            ${getFormationPositions(STATE.currentTactic || '4-3-3').map((fPos, idx) => `
                                <div class="pitch-player" style="left: ${fPos.x}%; top: ${fPos.y}%; transform: translate(-50%, -50%);">
                                    ${renderLandscapePitchPlayer(idx, userTeam)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Bench panel (right side) with drag & drop -->
                    <div class="w-32 sm:w-40 md:w-48 flex-shrink-0 glass-panel rounded-lg flex flex-col overflow-hidden" id="bench-panel">
                        <div class="p-2 border-b border-slate-700 text-xs font-bold text-white flex items-center justify-between">
                            <span>Substitutes</span>
                            <span class="text-[9px] text-slate-500 font-normal">Drag to swap</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-1 space-y-1" id="bench-list">
                            ${benchPlayers.slice(0, 12).sort((a,b) => b.rating - a.rating).map(p => `
                                <div draggable="true" 
                                    ondragstart="handleDragStart(event, ${p.internalId})"
                                    ondragend="handleDragEnd(event)"
                                    ondragover="handleDragOver(event)"
                                    ondrop="handleDropOnBench(event, ${p.internalId})"
                                    ondragleave="handleDragLeave(event)"
                                    onclick="selectBenchPlayerForSwap(${p.internalId})" 
                                    data-player-id="${p.internalId}"
                                    class="bench-player-card bg-slate-800/60 hover:bg-slate-700 p-1.5 rounded cursor-grab active:cursor-grabbing flex items-center gap-2 transition-all hover:scale-[1.02] border border-transparent hover:border-slate-600">
                                    <div class="w-6 h-6 rounded-full flex items-center justify-center font-bold text-[10px] ${getRatingBg(p.rating)}">${p.rating}</div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-[10px] font-bold text-white truncate">${p.name.split(' ').pop()}</div>
                                        <div class="text-[9px] ${getPosColor(p.pos).split(' ')[0]}">${p.pos}</div>
                                    </div>
                                    ${p.injuryWeeks > 0 ? '<span class="text-[10px] text-red-400">🩹</span>' : ''}
                                    ${p.isSuspended ? '<span class="text-[10px] text-red-400">🟥</span>' : ''}
                                    <span class="text-[8px] text-slate-600">⋮⋮</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        }
        
        function renderLandscapePitchPlayer(slotIndex, team) {
            const player = getPlayerInSlot(slotIndex);
            const slotPositions = getSlotPositions();
            const slotPos = slotPositions[slotIndex];
            
            if (!player) {
                return `
                    <div onclick="openSlotSelection(${slotIndex})" 
                        ondragover="handleDragOver(event)" 
                        ondrop="handleDropOnSlot(event, ${slotIndex})"
                        ondragleave="handleDragLeave(event)"
                        data-slot="${slotIndex}"
                        class="pitch-slot-empty flex flex-col items-center cursor-pointer group">
                        <div class="pitch-player-circle bg-slate-700/80 border-2 border-dashed border-slate-500 group-hover:border-[#4caf50] transition-all">
                            <span class="text-slate-400 group-hover:text-[#4caf50]">+</span>
                        </div>
                        <span class="pitch-player-name text-slate-500">${slotPos.position}</span>
                    </div>`;
            }
            
            const isActive = STATE.activeSwapSlot === slotIndex;
            const isUnavailable = player.injuryWeeks > 0 || player.isSuspended;
            
            return `
                <div draggable="true"
                    ondragstart="handleDragStartPitch(event, ${slotIndex}, ${player.internalId})"
                    ondragover="handleDragOver(event)" 
                    ondrop="handleDropOnSlot(event, ${slotIndex})"
                    ondragleave="handleDragLeave(event)"
                    ondragend="handleDragEnd(event)"
                    onclick="selectSlotForSwap(${slotIndex})" 
                    data-slot="${slotIndex}"
                    data-player-id="${player.internalId}"
                    class="pitch-slot flex flex-col items-center cursor-grab active:cursor-grabbing transition-transform ${isActive ? 'scale-110' : ''}">
                    <div class="pitch-player-circle ${getRatingBg(player.rating)} ${isActive ? 'ring-2 ring-yellow-400' : ''} ${isUnavailable ? 'opacity-60' : ''} transition-all">
                        ${player.rating}
                        ${isUnavailable ? '<span class="absolute -top-1 -right-1 text-[8px]">' + (player.isSuspended ? '🟥' : '🩹') + '</span>' : ''}
                    </div>
                    <span class="pitch-player-name">${player.name.split(' ').pop()}</span>
                </div>`;
        }
        
        // ========== DRAG & DROP HANDLERS ==========
        let draggedPlayerId = null;
        let draggedFromSlot = null;
        let draggedFromBench = false;
        
        function handleDragStart(event, playerId) {
            draggedPlayerId = playerId;
            draggedFromBench = true;
            draggedFromSlot = null;
            event.target.classList.add('opacity-50', 'scale-95');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', playerId);
            
            // Highlight all pitch slots
            document.querySelectorAll('.pitch-slot, .pitch-slot-empty').forEach(el => {
                el.classList.add('ring-2', 'ring-[#4caf50]/50');
            });
        }
        
        function handleDragStartPitch(event, slotIndex, playerId) {
            draggedPlayerId = playerId;
            draggedFromSlot = slotIndex;
            draggedFromBench = false;
            event.target.classList.add('opacity-50', 'scale-95');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', playerId);
            
            // Highlight bench and other pitch slots
            document.querySelectorAll('.pitch-slot, .pitch-slot-empty, .bench-player-card').forEach(el => {
                el.classList.add('ring-2', 'ring-[#4caf50]/50');
            });
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('ring-2', 'ring-yellow-400', 'scale-105');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('ring-yellow-400', 'scale-105');
        }
        
        function handleDragEnd(event) {
            event.target.classList.remove('opacity-50', 'scale-95');
            
            // Remove all highlights
            document.querySelectorAll('.pitch-slot, .pitch-slot-empty, .bench-player-card').forEach(el => {
                el.classList.remove('ring-2', 'ring-[#4caf50]/50', 'ring-yellow-400', 'scale-105');
            });
            
            draggedPlayerId = null;
            draggedFromSlot = null;
            draggedFromBench = false;
        }
        
        function handleDropOnSlot(event, targetSlotIndex) {
            event.preventDefault();
            event.currentTarget.classList.remove('ring-yellow-400', 'scale-105');
            
            if (draggedPlayerId === null) return;
            
            const userTeam = getTeam(STATE.userTeamId);
            
            if (draggedFromBench) {
                // Dropping from bench to pitch slot
                const currentPlayerInSlot = getPlayerInSlot(targetSlotIndex);
                
                // Put bench player in slot
                STATE.userLineupSlots[targetSlotIndex] = draggedPlayerId;
                
                // If there was a player in the slot, they go to bench (just remove from starters)
                if (currentPlayerInSlot) {
                    // The slot system handles this - player is no longer in a slot = on bench
                }
                
            } else if (draggedFromSlot !== null && draggedFromSlot !== targetSlotIndex) {
                // Swapping two pitch players
                const tempPlayerId = STATE.userLineupSlots[targetSlotIndex];
                STATE.userLineupSlots[targetSlotIndex] = STATE.userLineupSlots[draggedFromSlot];
                STATE.userLineupSlots[draggedFromSlot] = tempPlayerId;
            }
            
            updateTeamStartersFromSlots(userTeam);
            calculateTeamRating(userTeam);
            
            // Clear drag state
            draggedPlayerId = null;
            draggedFromSlot = null;
            draggedFromBench = false;
            
            renderDashboard();
        }
        
        // NEW: Handle drop on bench (for bench-to-bench reordering or pitch-to-bench)
        function handleDropOnBench(event, targetPlayerId) {
            event.preventDefault();
            event.currentTarget.classList.remove('ring-yellow-400', 'scale-105');
            
            if (draggedPlayerId === null || draggedPlayerId === targetPlayerId) return;
            
            const userTeam = getTeam(STATE.userTeamId);
            
            if (draggedFromBench) {
                // Bench-to-bench: just visual feedback, no actual reordering needed
                // Could implement custom bench order if desired
            } else if (draggedFromSlot !== null) {
                // Pitch-to-bench: swap the dragged pitch player with the bench player
                STATE.userLineupSlots[draggedFromSlot] = targetPlayerId;
                updateTeamStartersFromSlots(userTeam);
                calculateTeamRating(userTeam);
            }
            
            // Clear drag state
            draggedPlayerId = null;
            draggedFromSlot = null;
            draggedFromBench = false;
            
            renderDashboard();
        }
        
        function selectBenchPlayerForSwap(internalId) {
            const userTeam = getTeam(STATE.userTeamId);
            if (STATE.activeSwapSlot !== null) {
                const slotIdx = STATE.activeSwapSlot;
                STATE.userLineupSlots[slotIdx] = internalId;
                updateTeamStartersFromSlots(userTeam);
                calculateTeamRating(userTeam);
                STATE.activeSwapSlot = null;
            }
            renderDashboard();
        }

        // Landscape Trophy Room view
        function renderLandscapeTrophy(userTeam) {
            return `
                <div class="h-full overflow-y-auto glass-panel rounded-lg p-3">
                    <h3 class="text-sm font-bold text-white mb-3 border-b border-slate-700 pb-2">Club History</h3>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Trophy Cabinet -->
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <h4 class="text-xs font-bold text-slate-300 mb-2">Trophy Cabinet</h4>
                            ${STATE.history && STATE.history.length > 0 
                                ? `<div class="space-y-2">
                                    ${STATE.history.map(h => `
                                        <div class="bg-slate-900/50 p-2 rounded flex items-center gap-2 border border-yellow-500/20">
                                            <div class="text-xl">🏆</div>
                                            <div>
                                                <div class="font-bold text-yellow-400 text-xs">Season ${h.year || 'N/A'}</div>
                                                <div class="text-[10px] text-slate-300">${h.title || 'Championship'}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                   </div>` 
                                : `<div class="text-center text-slate-500 py-4 text-xs italic">No trophies yet. Win the league!</div>`
                            }
                        </div>
                        
                        <!-- Awards History -->
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <h4 class="text-xs font-bold text-slate-300 mb-2">Awards History</h4>
                            ${STATE.leagueStats && STATE.leagueStats.awardsHistory && STATE.leagueStats.awardsHistory.length > 0 ? 
                                `<div class="space-y-2 max-h-60 overflow-y-auto">
                                    ${STATE.leagueStats.awardsHistory.map(award => `
                                        <div class="bg-slate-900/50 p-2 rounded border border-slate-700">
                                            <div class="font-bold text-slate-300 mb-1 text-[10px]">Season ${award.season || 'N/A'}</div>
                                            <div class="grid grid-cols-3 gap-1 text-center">
                                                <div class="p-1 bg-slate-800/30 rounded">
                                                    <div class="text-sm">⚽</div>
                                                    <div class="text-[8px] text-slate-400">Golden Boot</div>
                                                    <div class="text-[9px] text-white truncate">${award.goldenBoot?.player || 'N/A'}</div>
                                                </div>
                                                <div class="p-1 bg-slate-800/30 rounded">
                                                    <div class="text-sm">🎯</div>
                                                    <div class="text-[8px] text-slate-400">Playmaker</div>
                                                    <div class="text-[9px] text-white truncate">${award.playmaker?.player || 'N/A'}</div>
                                                </div>
                                                <div class="p-1 bg-slate-800/30 rounded">
                                                    <div class="text-sm">⭐</div>
                                                    <div class="text-[8px] text-slate-400">MVP</div>
                                                    <div class="text-[9px] text-white truncate">${award.bestPlayer?.player || 'N/A'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>` :
                                '<div class="text-center text-slate-500 py-4 text-xs italic">No awards yet. Complete a season!</div>'
                            }
                        </div>
                    </div>
                </div>`;
        }


        function getHeaderTitle() {
            if (STATE.view === 'next-match') return 'Matchday Center';
            if (STATE.view === 'tactics') return 'Team Management';
            if (STATE.view === 'table') return 'League Standings';
            if (STATE.view === 'squad') return 'Squad List';
            if (STATE.view === 'market') return 'Transfer Market';
            if (STATE.view === 'stats') return 'League Statistics';
            if (STATE.view === 'trophy') return 'Club History';
            if (STATE.view === 'news') return 'News Center';
            if (STATE.view === 'calendar') return 'Season Calendar';
            return 'Dashboard';
        }

        function getMainContent(userTeam, isFinished) {
            if (STATE.view === 'news') {
                if (STATE.newsFeed.length === 0) {
                    return `<div class="text-center text-slate-500 py-20 italic">No news yet.</div>`;
                }
                return `
                    <div class="glass-panel rounded-xl overflow-hidden p-4 md:p-6 max-w-3xl mx-auto">
                        <h3 class="text-xl md:text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-2">Latest News</h3>
                        <div class="space-y-3">
                            ${STATE.newsFeed.map(item => `
                                <div class="bg-slate-800/50 p-3 md:p-4 rounded-lg flex gap-4 type-${item.type}">
                                    <div class="flex-grow">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-bold text-white text-sm md:text-base">${item.title}</h4>
                                            <span class="text-xs font-mono text-slate-500">S${item.season} W${item.week}</span>
                                        </div>
                                        <p class="text-slate-300 text-xs md:text-sm mt-1">${item.msg}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (STATE.view === 'stats') {
                calculateLeagueStats();
                return `
                    <div class="glass-panel rounded-xl p-4 md:p-6">
                        <h3 class="text-xl md:text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-2">League Statistics - Season ${STATE.season}</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
                            <div class="bg-slate-800/50 rounded-xl p-4 md:p-6 border border-slate-700">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center award-badge">
                                        <span class="text-lg">⚽</span>
                                    </div>
                                    <div>
                                        <h3 class="text-lg md:text-xl font-bold text-white">Top Scorers</h3>
                                        <p class="text-slate-400 text-sm">Golden Boot Race</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${STATE.leagueStats.topScorers.length > 0 ? 
                                        STATE.leagueStats.topScorers.map((player, index) => `
                                            <div class="flex items-center justify-between p-3 rounded-lg ${index < 3 ? 'bg-slate-900/70 hover:bg-slate-900' : 'bg-slate-900/30 hover:bg-slate-900/50'}">
                                                <div class="flex items-center gap-3">
                                                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : index === 1 ? 'bg-slate-600' : index === 2 ? 'bg-amber-800' : 'bg-slate-700'}">
                                                        ${index + 1}
                                                    </span>
                                                    <div>
                                                        <div class="font-bold text-slate-200 text-sm flex items-center gap-2">
                                                            ${player.name}
                                                            ${index === 0 ? '<span class="text-xs award-badge px-2 py-0.5 rounded">🏆</span>' : ''}
                                                        </div>
                                                        <div class="text-xs text-slate-400">${player.teamName} • ${player.pos}</div>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-lg md:text-xl font-black ${index === 0 ? 'text-yellow-400' : 'text-white'}">${player.seasonGoals}</div>
                                                    <div class="text-xs text-slate-400">goals</div>
                                                </div>
                                            </div>
                                        `).join('') :
                                        '<div class="text-center text-slate-500 py-4">No goals scored yet</div>'
                                    }
                                </div>
                            </div>
                            
                            <div class="bg-slate-800/50 rounded-xl p-4 md:p-6 border border-slate-700">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center award-badge">
                                        <span class="text-lg">🎯</span>
                                    </div>
                                    <div>
                                        <h3 class="text-lg md:text-xl font-bold text-white">Top Assists</h3>
                                        <p class="text-slate-400 text-sm">Playmaker Award</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${STATE.leagueStats.topAssists.length > 0 ? 
                                        STATE.leagueStats.topAssists.map((player, index) => `
                                            <div class="flex items-center justify-between p-3 rounded-lg ${index < 3 ? 'bg-slate-900/70 hover:bg-slate-900' : 'bg-slate-900/30 hover:bg-slate-900/50'}">
                                                <div class="flex items-center gap-3">
                                                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : index === 1 ? 'bg-slate-600' : index === 2 ? 'bg-amber-800' : 'bg-slate-700'}">
                                                        ${index + 1}
                                                    </span>
                                                    <div>
                                                        <div class="font-bold text-slate-200 text-sm flex items-center gap-2">
                                                            ${player.name}
                                                            ${index === 0 ? '<span class="text-xs award-badge px-2 py-0.5 rounded">🎯</span>' : ''}
                                                        </div>
                                                        <div class="text-xs text-slate-400">${player.teamName} • ${player.pos}</div>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-lg md:text-xl font-black ${index === 0 ? 'text-yellow-400' : 'text-white'}">${player.seasonAssists}</div>
                                                    <div class="text-xs text-slate-400">assists</div>
                                                </div>
                                            </div>
                                        `).join('') :
                                        '<div class="text-center text-slate-500 py-4">No assists yet</div>'
                                    }
                                </div>
                            </div>
                            
                            <div class="bg-slate-800/50 rounded-xl p-4 md:p-6 border border-slate-700">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center award-badge">
                                        <span class="text-lg">⭐</span>
                                    </div>
                                    <div>
                                        <h3 class="text-lg md:text-xl font-bold text-white">Best Players</h3>
                                        <p class="text-slate-400 text-sm">Season Rating</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${STATE.leagueStats.bestPlayers.length > 0 ? 
                                        STATE.leagueStats.bestPlayers.map((player, index) => `
                                            <div class="flex items-center justify-between p-3 rounded-lg ${index < 3 ? 'bg-slate-900/70 hover:bg-slate-900' : 'bg-slate-900/30 hover:bg-slate-900/50'}">
                                                <div class="flex items-center gap-3">
                                                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : index === 1 ? 'bg-slate-600' : index === 2 ? 'bg-amber-800' : 'bg-slate-700'}">
                                                        ${index + 1}
                                                    </span>
                                                    <div>
                                                        <div class="font-bold text-slate-200 text-sm flex items-center gap-2">
                                                            ${player.name}
                                                            ${index === 0 ? '<span class="text-xs award-badge px-2 py-0.5 rounded">⭐</span>' : ''}
                                                        </div>
                                                        <div class="text-xs text-slate-400">${player.teamName} • ${player.pos}</div>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-lg md:text-xl font-black ${index === 0 ? 'text-yellow-400' : 'text-white'}">${Math.round(player.seasonRating)}</div>
                                                    <div class="text-xs text-slate-400">rating</div>
                                                </div>
                                            </div>
                                        `).join('') :
                                        '<div class="text-center text-slate-500 py-4">Not enough matches played</div>'
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-slate-800/30 rounded-xl p-4 md:p-6 border border-slate-700">
                            <h3 class="text-lg md:text-xl font-bold text-white mb-4">Your Team Performance</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl md:text-3xl font-black text-[#4caf50]">${userTeam.points}</div>
                                    <div class="text-slate-400 text-sm">Points</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl md:text-3xl font-black text-white">${userTeam.gf}</div>
                                    <div class="text-slate-400 text-sm">Goals For</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl md:text-3xl font-black text-white">${userTeam.ga}</div>
                                    <div class="text-slate-400 text-sm">Goals Against</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl md:text-3xl font-black text-white">${userTeam.gd}</div>
                                    <div class="text-slate-400 text-sm">Goal Difference</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (STATE.view === 'trophy') {
                return `
                    <div class="glass-panel rounded-xl p-4 md:p-8 min-h-[50vh]">
                        <h3 class="text-xl md:text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-2">Club History</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
                            <div class="bg-slate-800/50 rounded-xl p-4 md:p-6">
                                <h4 class="text-base md:text-lg font-bold text-slate-300 mb-4">Trophy Cabinet</h4>
                                ${STATE.history.length === 0 
                                    ? `<div class="text-center text-slate-500 py-8 italic">No trophies yet. Win the league to fill this space!</div>` 
                                    : `<div class="space-y-4">
                                        ${STATE.history.map(h => `
                                            <div class="bg-slate-900/50 p-4 rounded-lg flex items-center gap-4 border border-yellow-500/20">
                                                <div class="text-3xl">🏆</div>
                                                <div>
                                                    <div class="font-black text-yellow-400 text-base md:text-lg">Season ${h.year}</div>
                                                    <div class="text-sm text-slate-300">${h.title}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                       </div>`
                                }
                            </div>
                            
                            <div class="bg-slate-800/50 rounded-xl p-4 md:p-6 lg:col-span-2">
                                <h4 class="text-base md:text-lg font-bold text-slate-300 mb-4">Awards History</h4>
                                ${STATE.leagueStats.awardsHistory.length > 0 ? 
                                    `<div class="space-y-4">
                                        ${STATE.leagueStats.awardsHistory.map(award => `
                                            <div class="bg-slate-900/50 p-3 md:p-4 rounded-lg border border-slate-700">
                                                <div class="font-bold text-slate-300 mb-2 text-base md:text-lg">Season ${award.season} Awards</div>
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                    <div class="flex flex-col items-center p-3 bg-slate-800/30 rounded">
                                                        <div class="text-2xl mb-1">⚽</div>
                                                        <div class="text-sm text-slate-400 mb-1">Golden Boot</div>
                                                        <div class="font-bold text-white text-center text-sm">${award.goldenBoot?.player || 'N/A'}</div>
                                                        <div class="text-xs text-slate-500">${award.goldenBoot?.goals || 0} goals</div>
                                                    </div>
                                                    <div class="flex flex-col items-center p-3 bg-slate-800/30 rounded">
                                                        <div class="text-2xl mb-1">🎯</div>
                                                        <div class="text-sm text-slate-400 mb-1">Playmaker</div>
                                                        <div class="font-bold text-white text-center text-sm">${award.playmaker?.player || 'N/A'}</div>
                                                        <div class="text-xs text-slate-500">${award.playmaker?.assists || 0} assists</div>
                                                    </div>
                                                    <div class="flex flex-col items-center p-3 bg-slate-800/30 rounded">
                                                        <div class="text-2xl mb-1">⭐</div>
                                                        <div class="text-sm text-slate-400 mb-1">Player of the Season</div>
                                                        <div class="font-bold text-white text-center text-sm">${award.bestPlayer?.player || 'N/A'}</div>
                                                        <div class="text-xs text-slate-500">Rating: ${award.bestPlayer?.rating || 'N/A'}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>` :
                                    '<div class="text-center text-slate-500 py-8 italic">No awards history yet. Complete a season to see awards!</div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            }

            if (STATE.view === 'calendar') {
                const cup = STATE.cups.leagueCup;
                
                // Хелпер для рендера бейджа результата
                const renderResultBadge = (result) => {
                    if (!result) return '';
                    
                    const resultColors = {
                        'W': 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                        'D': 'bg-slate-500/20 text-slate-400 border-slate-500/30',
                        'L': 'bg-red-500/20 text-red-400 border-red-500/30'
                    };
                    const colorClass = resultColors[result.result] || resultColors['D'];
                    const typeLabel = result.type === 'CUP' ? 'CUP' : 'LGE';
                    
                    let scoreText = result.isUserHome 
                        ? `${result.homeGoals}–${result.awayGoals}` 
                        : `${result.awayGoals}–${result.homeGoals}`;
                    
                    if (result.wentToPens) {
                        const penScore = result.isUserHome 
                            ? `${result.pensHome}–${result.pensAway}` 
                            : `${result.pensAway}–${result.pensHome}`;
                        scoreText += ` (p: ${penScore})`;
                    }
                    
                    return `
                        <div class="flex flex-col items-center gap-0.5 px-2 py-1 rounded border ${colorClass}">
                            <span class="text-[9px] uppercase font-bold opacity-70">${typeLabel}</span>
                            <span class="text-xs font-bold">${scoreText}</span>
                            <span class="text-base font-black">${result.result}</span>
                        </div>
                    `;
                };
                
                return `
                    <div class="glass-panel rounded-xl p-4 md:p-6">
                        <h3 class="text-xl md:text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-2">Season Calendar - Season ${STATE.season}</h3>
                        
                        <div class="overflow-y-auto max-h-[70vh]">
                            <div class="space-y-3">
                                ${STATE.calendar.weeks.map((week, index) => {
                                    const isCurrent = index === STATE.calendar.currentWeek;
                                    const isPlayed = week.played || index < STATE.calendar.currentWeek;
                                    
                                    let userMatch = null;
                                    let opponent = null;
                                    let matchType = '';
                                    let cupRoundName = '';
                                    
                                    // Ищем матч пользователя в этой неделе (для предстоящих матчей)
                                    if (!isPlayed) {
                                        for (const event of week.events) {
                                            if (event.played) continue;
                                            
                                            if (event.type === "LEAGUE") {
                                                const matchday = STATE.schedule[event.matchday];
                                                if (matchday) {
                                                    const userMatchData = matchday.find(m => m.home === STATE.userTeamId || m.away === STATE.userTeamId);
                                                    if (userMatchData) {
                                                        userMatch = userMatchData;
                                                        opponent = getTeam(userMatchData.home === STATE.userTeamId ? userMatchData.away : userMatchData.home);
                                                        matchType = 'League';
                                                        break;
                                                    }
                                                }
                                            } else if (event.type === "CUP" && cup) {
                                                const cupRound = cup.rounds[event.round];
                                                if (cupRound) {
                                                    const userCupMatch = cupRound.fixtures.find(f => f.homeId === STATE.userTeamId || f.awayId === STATE.userTeamId);
                                                    if (userCupMatch && !userCupMatch.played) {
                                                        opponent = getTeam(userCupMatch.homeId === STATE.userTeamId ? userCupMatch.awayId : userCupMatch.homeId);
                                                        matchType = 'Cup';
                                                        cupRoundName = cupRound.name;
                                                        break;
                                                    }
                                                }
                                            } else if (event.type === "EURO" && STATE.europe) {
                                                const euroComp = STATE.europe[event.cup];
                                                if (euroComp && euroComp.stage === 'GROUP') {
                                                    const userGroup = getUserEuroGroup(event.cup);
                                                    if (userGroup && euroComp.schedule[userGroup]) {
                                                        const mdMatches = euroComp.schedule[userGroup][event.matchday];
                                                        if (mdMatches) {
                                                            const euroMatch = mdMatches.find(m => m.homeId === STATE.userTeamId || m.awayId === STATE.userTeamId);
                                                            if (euroMatch && !euroMatch.played) {
                                                                opponent = getTeam(euroMatch.homeId === STATE.userTeamId ? euroMatch.awayId : euroMatch.homeId);
                                                                matchType = EURO_COMP_NAMES[event.cup];
                                                                cupRoundName = `MD${event.matchday + 1}`;
                                                                break;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    
                                    const eventTypes = week.events.map(e => {
                                        if (e.type === "LEAGUE") return "League";
                                        if (e.type === "CUP") return "Cup";
                                        if (e.type === "EURO") return e.cup || "Euro";
                                        return e.type;
                                    }).join(' + ');
                                    
                                    // Получаем результаты пользователя для сыгранных недель
                                    const userResults = week.userResults || [];
                                    
                                    return `
                                        <div class="bg-slate-800/50 rounded-lg p-4 hover:bg-slate-800/70 transition-colors ${isCurrent ? 'border-l-4 border-[#4caf50]' : ''} ${isPlayed ? 'opacity-90' : ''}">
                                            <div class="flex justify-between items-start gap-2">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-3 mb-2">
                                                        <span class="font-bold ${isCurrent ? 'text-[#4caf50]' : 'text-white'}">Week ${week.week}</span>
                                                        <span class="text-xs px-2 py-1 rounded ${week.events.some(e => e.type === "EURO") ? 'bg-blue-600/20 text-blue-300' : week.events.some(e => e.type === "CUP") ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'}">
                                                            ${eventTypes}
                                                        </span>
                                                        ${isCurrent ? '<span class="text-xs bg-[#4caf50] text-white px-2 py-1 rounded">Current</span>' : ''}
                                                        ${isPlayed && !isCurrent ? '<span class="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded">Played</span>' : ''}
                                                    </div>
                                                    
                                                    <div class="text-xs text-slate-400">
                                                        ${week.events.map(event => {
                                                            if (event.type === "LEAGUE") {
                                                                return '<div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-400"></span> League Matchday ' + (event.matchday + 1) + '</div>';
                                                            } else if (event.type === "CUP" && cup) {
                                                                const round = cup.rounds[event.round];
                                                                const roundName = round ? round.name : 'Round ' + (event.round + 1);
                                                                return '<div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-400"></span> ' + roundName + '</div>';
                                                            } else if (event.type === "EURO") {
                                                                const compName = EURO_COMP_NAMES[event.cup] || event.cup;
                                                                return '<div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full ' + 
                                                                    (event.cup === 'UCL' ? 'bg-blue-300' : event.cup === 'UEL' ? 'bg-orange-400' : 'bg-emerald-400') + 
                                                                    '"></span> ' + compName + ' MD' + (event.matchday + 1) + '</div>';
                                                            }
                                                            return '';
                                                        }).join('')}
                                                    </div>
                                                    
                                                    ${!isPlayed && opponent ? `
                                                        <div class="mt-2 flex items-center gap-2">
                                                            ${renderTeamLogo(opponent, 'sm')}
                                                            <div>
                                                                <span class="text-slate-400 text-sm">vs</span>
                                                                <span class="font-bold text-white ml-1">${opponent.name}</span>
                                                                <span class="text-xs text-slate-500 ml-1">(${matchType}${cupRoundName ? ' • ' + cupRoundName : ''})</span>
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                
                                                ${isPlayed && userResults.length > 0 ? `
                                                    <div class="flex flex-wrap gap-2 justify-end">
                                                        ${userResults.map(res => renderResultBadge(res)).join('')}
                                                    </div>
                                                ` : !isPlayed && opponent ? `
                                                    <div class="text-right text-xs text-slate-500">
                                                        Upcoming
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-slate-800/30 rounded-lg border border-slate-700">
                            <h4 class="text-sm font-bold text-slate-300 mb-2">Legend</h4>
                            <div class="flex flex-wrap gap-4">
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-blue-400"></span>
                                    <span class="text-xs text-slate-400">League Match</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-purple-400"></span>
                                    <span class="text-xs text-slate-400">League Cup</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-blue-300"></span>
                                    <span class="text-xs text-slate-400">Champions League</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-orange-400"></span>
                                    <span class="text-xs text-slate-400">Europa League</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-emerald-400"></span>
                                    <span class="text-xs text-slate-400">Conference League</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 border-2 border-[#4caf50]"></span>
                                    <span class="text-xs text-slate-400">Current Week</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-1.5 py-0.5 text-[10px] font-bold rounded bg-emerald-500/20 text-emerald-400">W</span>
                                    <span class="text-xs text-slate-400">Win</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-1.5 py-0.5 text-[10px] font-bold rounded bg-slate-500/20 text-slate-400">D</span>
                                    <span class="text-xs text-slate-400">Draw</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-1.5 py-0.5 text-[10px] font-bold rounded bg-red-500/20 text-red-400">L</span>
                                    <span class="text-xs text-slate-400">Loss</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (STATE.view === 'market') {
                // Проверяем вкладку - Market или Wishlist
                if (STATE.marketTab === 'wishlist') {
                    // WISHLIST VIEW
                    const wishlistPlayers = getWishlistPlayers();
                    
                    return `
                        <div class="glass-panel rounded-xl overflow-hidden flex flex-col h-full">
                            <div class="p-4 bg-slate-800/80 border-b border-slate-700">
                                <!-- Табы Market / Wishlist -->
                                <div class="flex gap-2 items-center mb-3">
                                    <div class="flex bg-slate-900 rounded-lg p-0.5 border border-slate-700">
                                        <button onclick="STATE.marketTab = 'market'; renderDashboard();" 
                                            class="px-4 py-2 rounded-md text-sm font-bold transition-colors text-slate-400 hover:text-white">
                                            🛒 Market
                                        </button>
                                        <button onclick="STATE.marketTab = 'wishlist'; renderDashboard();" 
                                            class="px-4 py-2 rounded-md text-sm font-bold transition-colors bg-amber-600 text-white">
                                            ⭐ Wishlist <span class="ml-1 px-1.5 py-0.5 rounded bg-amber-700 text-[10px]">${STATE.wishlist.length}</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-sm text-slate-400">
                                    Your saved players - ready to contact clubs for transfer
                                </div>
                            </div>
                            
                            <div class="overflow-y-auto flex-grow">
                                ${wishlistPlayers.length > 0 ? `
                                    <div class="divide-y divide-slate-700/50">
                                        ${wishlistPlayers.map(p => {
                                            const club = p.clubId ? getTeam(p.clubId) : null;
                                            const clubName = p.isFreeAgent ? 'Free Agent' : (club?.name || 'Unknown');
                                            
                                            return `
                                                <div class="p-4 hover:bg-slate-800/30 flex items-center gap-4">
                                                    <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-lg ${getRatingBg(p.rating)}">${p.rating}</div>
                                                    <div class="flex-1 min-w-0">
                                                        <div class="flex items-center gap-2">
                                                            <span class="clickable-name font-bold text-white" onclick="openPlayerProfile(${p.internalId})">${p.name}</span>
                                                            <span class="px-2 py-0.5 rounded text-xs font-bold ${getPosColor(p.pos)}">${p.pos}</span>
                                                        </div>
                                                        <div class="flex items-center gap-3 mt-1 text-sm text-slate-400">
                                                            <span>${p.age} yrs</span>
                                                            <span class="${p.isFreeAgent ? 'text-emerald-400 font-bold' : ''}">${clubName}</span>
                                                            <span class="font-mono ${p.isFreeAgent ? 'text-emerald-400' : 'text-white'}">${p.isFreeAgent ? 'FREE' : formatMoney(p.price)}</span>
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-2">
                                                        ${p.isFreeAgent 
                                                            ? `<button onclick="signFreeAgent(${p.internalId}); removeFromWishlist(${p.internalId});" 
                                                                class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold px-4 py-2 rounded-lg uppercase transition-colors">
                                                                ✅ Sign
                                                            </button>`
                                                            : `<button onclick="window.openContactClubMenu(${p.internalId});" 
                                                                class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-4 py-2 rounded-lg uppercase transition-colors">
                                                                📞 Contact Club
                                                            </button>`
                                                        }
                                                        <button onclick="removeFromWishlist(${p.internalId})" 
                                                            class="bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white text-xs font-bold px-3 py-2 rounded-lg transition-colors">
                                                            ✕
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <div class="flex flex-col items-center justify-center h-full py-20 text-slate-500">
                                        <div class="text-6xl mb-4">⭐</div>
                                        <div class="text-lg font-bold mb-2">Your wishlist is empty</div>
                                        <div class="text-sm">Browse the market and add players you're interested in</div>
                                        <button onclick="STATE.marketTab = 'market'; renderDashboard();" 
                                            class="mt-4 bg-[#4caf50] hover:bg-[#45a049] text-white font-bold px-6 py-2 rounded-lg">
                                            Browse Market
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    `;
                }
                
                // MARKET VIEW (default)
                // Используем getFilteredMarketPlayers для получения отфильтрованных игроков
                const players = getFilteredMarketPlayers();
                
                const startIndex = (STATE.market.page - 1) * STATE.market.perPage;
                const paginatedPlayers = players.slice(startIndex, startIndex + STATE.market.perPage);
                const totalPages = Math.ceil(players.length / STATE.market.perPage);

                const btnClass = (active) => `filter-btn ${active ? 'active' : ''}`;
                
                // Собираем все уникальные позиции для dropdown
                const allPositions = new Set();
                STATE.allTeams.forEach(t => {
                    t.squad.forEach(p => allPositions.add(p.pos));
                });
                const sortedPositions = [...allPositions].sort();

                return `
                    <div class="glass-panel rounded-xl overflow-hidden flex flex-col h-full">
                        <div class="p-4 bg-slate-800/80 border-b border-slate-700 flex flex-col gap-3">
                            <!-- Табы Market / Wishlist -->
                            <div class="flex gap-2 items-center">
                                <div class="flex bg-slate-900 rounded-lg p-0.5 border border-slate-700">
                                    <button onclick="STATE.marketTab = 'market'; renderDashboard();" 
                                        class="px-4 py-2 rounded-md text-sm font-bold transition-colors bg-[#4caf50] text-white">
                                        🛒 Market
                                    </button>
                                    <button onclick="STATE.marketTab = 'wishlist'; renderDashboard();" 
                                        class="px-4 py-2 rounded-md text-sm font-bold transition-colors text-slate-400 hover:text-white">
                                        ⭐ Wishlist <span class="ml-1 px-1.5 py-0.5 rounded bg-slate-700 text-[10px]">${STATE.wishlist.length}</span>
                                    </button>
                                </div>
                                
                                <!-- Подтабы Clubs / Free Agents -->
                                <div class="flex bg-slate-900 rounded-lg p-0.5 border border-slate-700 ml-2">
                                    <button onclick="STATE.market.showFreeAgents = false; applyMarketFilters();" 
                                        class="px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${!STATE.market.showFreeAgents ? 'bg-slate-700 text-white' : 'text-slate-400 hover:text-white'}">
                                        Clubs
                                    </button>
                                    <button onclick="STATE.market.showFreeAgents = true; applyMarketFilters();" 
                                        class="px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${STATE.market.showFreeAgents ? 'bg-emerald-600 text-white' : 'text-slate-400 hover:text-white'}">
                                        Free <span class="ml-1 px-1 py-0.5 rounded bg-slate-700 text-[9px]">${STATE.freeAgents.length}</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Строка 1: Поиск -->
                            <div class="flex gap-2 items-center">
                                <div class="relative flex-grow">
                                    <input 
                                        type="text" 
                                        id="market-search" 
                                        placeholder="Search by name..." 
                                        value="${STATE.market.search}"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-[#4caf50]"
                                        oninput="handleMarketSearchDebounced(event)"
                                    >
                                    ${STATE.market.search ? `
                                        <button onclick="STATE.market.search=''; applyMarketFilters();" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white">
                                            ✕
                                        </button>
                                    ` : ''}
                                </div>
                                <button onclick="resetMarketFilters()" class="filter-btn text-xs md:text-sm bg-red-500/20 hover:bg-red-500/40 text-red-300">
                                    Reset All
                                </button>
                            </div>
                            
                            <!-- Строка 2: Фильтры возраст/рейтинг/цена -->
                            <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                                <div class="flex flex-col">
                                    <label class="text-[10px] text-slate-500 uppercase mb-1">Age Min</label>
                                    <input type="number" placeholder="16" min="16" max="45" 
                                        value="${STATE.market.ageMin}"
                                        onchange="STATE.market.ageMin = this.value; applyMarketFilters();"
                                        class="bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-white text-xs focus:outline-none focus:ring-1 focus:ring-[#4caf50]">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-[10px] text-slate-500 uppercase mb-1">Age Max</label>
                                    <input type="number" placeholder="45" min="16" max="45" 
                                        value="${STATE.market.ageMax}"
                                        onchange="STATE.market.ageMax = this.value; applyMarketFilters();"
                                        class="bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-white text-xs focus:outline-none focus:ring-1 focus:ring-[#4caf50]">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-[10px] text-slate-500 uppercase mb-1">Rating Min</label>
                                    <input type="number" placeholder="1" min="1" max="99" 
                                        value="${STATE.market.ratingMin}"
                                        onchange="STATE.market.ratingMin = this.value; applyMarketFilters();"
                                        class="bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-white text-xs focus:outline-none focus:ring-1 focus:ring-[#4caf50]">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-[10px] text-slate-500 uppercase mb-1">Rating Max</label>
                                    <input type="number" placeholder="99" min="1" max="99" 
                                        value="${STATE.market.ratingMax}"
                                        onchange="STATE.market.ratingMax = this.value; applyMarketFilters();"
                                        class="bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-white text-xs focus:outline-none focus:ring-1 focus:ring-[#4caf50]">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-[10px] text-slate-500 uppercase mb-1">Price Min (€)</label>
                                    <input type="number" placeholder="0" min="0" step="100000" 
                                        value="${STATE.market.priceMin}"
                                        onchange="STATE.market.priceMin = this.value; applyMarketFilters();"
                                        class="bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-white text-xs focus:outline-none focus:ring-1 focus:ring-[#4caf50]">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-[10px] text-slate-500 uppercase mb-1">Price Max (€)</label>
                                    <input type="number" placeholder="∞" min="0" step="100000" 
                                        value="${STATE.market.priceMax}"
                                        onchange="STATE.market.priceMax = this.value; applyMarketFilters();"
                                        class="bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-white text-xs focus:outline-none focus:ring-1 focus:ring-[#4caf50]">
                                </div>
                            </div>
                            
                            <!-- Строка 3: Позиция и сортировка -->
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
                                <div class="flex flex-wrap gap-2 items-center">
                                    <button onclick="STATE.market.posFilter='ALL'; STATE.market.posExact=''; applyMarketFilters();" class="${btnClass(STATE.market.posFilter==='ALL')} text-xs">All</button>
                                    <button onclick="STATE.market.posFilter='GK'; STATE.market.posExact=''; applyMarketFilters();" class="${btnClass(STATE.market.posFilter==='GK')} text-xs">GK</button>
                                    <button onclick="STATE.market.posFilter='DEF'; STATE.market.posExact=''; applyMarketFilters();" class="${btnClass(STATE.market.posFilter==='DEF')} text-xs">DEF</button>
                                    <button onclick="STATE.market.posFilter='MID'; STATE.market.posExact=''; applyMarketFilters();" class="${btnClass(STATE.market.posFilter==='MID')} text-xs">MID</button>
                                    <button onclick="STATE.market.posFilter='FWD'; STATE.market.posExact=''; applyMarketFilters();" class="${btnClass(STATE.market.posFilter==='FWD')} text-xs">FWD</button>
                                    
                                    <select onchange="STATE.market.posExact = this.value; STATE.market.posFilter = this.value ? 'EXACT' : 'ALL'; applyMarketFilters();"
                                        class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none">
                                        <option value="">Exact Pos...</option>
                                        ${sortedPositions.map(pos => `<option value="${pos}" ${STATE.market.posExact === pos ? 'selected' : ''}>${pos}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="flex gap-2 items-center">
                                    <span class="text-xs text-slate-500 uppercase hidden md:inline">Sort:</span>
                                    <select onchange="const [sort, dir] = this.value.split('_'); STATE.market.sort = sort; STATE.market.sortDir = dir; applyMarketFilters();"
                                        class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none">
                                        <option value="RATING_DESC" ${STATE.market.sort==='RATING' && STATE.market.sortDir==='DESC' ? 'selected' : ''}>Rating ↓</option>
                                        <option value="RATING_ASC" ${STATE.market.sort==='RATING' && STATE.market.sortDir==='ASC' ? 'selected' : ''}>Rating ↑</option>
                                        <option value="PRICE_DESC" ${STATE.market.sort==='PRICE' && STATE.market.sortDir==='DESC' ? 'selected' : ''}>Price ↓</option>
                                        <option value="PRICE_ASC" ${STATE.market.sort==='PRICE' && STATE.market.sortDir==='ASC' ? 'selected' : ''}>Price ↑</option>
                                        <option value="AGE_ASC" ${STATE.market.sort==='AGE' && STATE.market.sortDir==='ASC' ? 'selected' : ''}>Age ↑</option>
                                        <option value="AGE_DESC" ${STATE.market.sort==='AGE' && STATE.market.sortDir==='DESC' ? 'selected' : ''}>Age ↓</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Статистика -->
                            <div class="text-xs text-slate-500">
                                Found <span class="text-white font-bold">${players.length}</span> players matching filters
                            </div>
                        </div>
                        
                        <div class="overflow-y-auto flex-grow table-responsive">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-900 text-xs uppercase text-slate-400 sticky top-0 z-10 shadow-lg">
                                    <tr>
                                        <th class="px-4 md:px-6 py-4">Player</th>
                                        <th class="px-4 md:px-6 py-4 text-center">Pos</th>
                                        <th class="px-4 md:px-6 py-4 text-center">Age</th>
                                        <th class="px-4 md:px-6 py-4 text-center">OVR</th>
                                        <th class="px-4 md:px-6 py-4 text-center">POT</th>
                                        <th class="px-4 md:px-6 py-4 text-right">Value</th>
                                        <th class="px-4 md:px-6 py-4 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-700/50">
                                    ${paginatedPlayers.length > 0 ? paginatedPlayers.map(p => {
                                        const isFreeAgent = p.isFreeAgent || STATE.market.showFreeAgents;
                                        const clubName = isFreeAgent ? 'Free Agent' : (getTeam(p.clubId)?.name || 'Unknown');
                                        const priceDisplay = isFreeAgent ? '<span class="text-emerald-400 font-black">FREE</span>' : `<span class="truncate max-w-[100px] inline-block">${formatMoney(p.price)}</span>`;
                                        const isInWishlist = STATE.wishlist.some(w => w.internalId === p.internalId);
                                        
                                        let actionBtn;
                                        if (isFreeAgent) {
                                            actionBtn = `<button onclick="signFreeAgent(${p.internalId})" class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold px-2 md:px-3 py-1 md:py-1.5 rounded transition-colors uppercase">Sign</button>`;
                                        } else if (isInWishlist) {
                                            actionBtn = `<button onclick="toggleWishlist(${p.internalId})" class="bg-amber-600 hover:bg-amber-500 text-white text-xs font-bold px-2 md:px-3 py-1 md:py-1.5 rounded transition-colors">⭐ Saved</button>`;
                                        } else {
                                            actionBtn = `<button onclick="toggleWishlist(${p.internalId})" class="bg-slate-700 hover:bg-amber-600 text-white text-xs font-bold px-2 md:px-3 py-1 md:py-1.5 rounded transition-colors">+ Wishlist</button>`;
                                        }
                                        
                                        return `
                                            <tr class="hover:bg-slate-800/30 group ${isFreeAgent ? 'bg-emerald-900/10' : ''} ${isInWishlist ? 'bg-amber-900/10' : ''}">
                                                <td class="px-4 md:px-6 py-3 font-medium text-slate-200">
                                                    <div class="flex items-center gap-3">
                                                        ${isFreeAgent ? renderTeamLogo({id: 'free-agent', name: 'FA', color: '#10b981'}, 'sm') : renderTeamLogo(getTeam(p.clubId), 'sm')}
                                                        <div class="min-w-0">
                                                            <span class="clickable-name text-sm md:text-base" onclick="openPlayerProfile(${p.internalId})">${p.name}</span>
                                                            <div class="flex items-center gap-2 mt-0.5">
                                                                ${p.nation ? `<span class="text-[10px] bg-slate-700 px-1 rounded text-slate-300 font-mono">${p.nation.substring(0,3).toUpperCase()}</span>` : ''}
                                                                <div class="text-[10px] ${isFreeAgent ? 'text-emerald-400 font-bold' : 'text-slate-500'} truncate">${clubName}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 md:px-6 py-3 text-center"><span class="px-2 py-0.5 rounded text-xs font-bold ${getPosColor(p.pos)} bg-opacity-10">${p.pos}</span></td>
                                                <td class="px-4 md:px-6 py-3 text-center text-slate-400">${p.age}</td>
                                                <td class="px-4 md:px-6 py-3 text-center font-bold text-white">${p.rating}</td>
                                                <td class="px-4 md:px-6 py-3 text-center font-bold ${p.potential > p.rating ? 'text-emerald-400' : p.potential === p.rating ? 'text-slate-400' : 'text-red-400'}">${p.potential || p.rating}</td>
                                                <td class="px-4 md:px-6 py-3 text-right font-mono text-xs md:text-sm">${priceDisplay}</td>
                                                <td class="px-4 md:px-6 py-3 text-center">
                                                    ${actionBtn}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('') : `
                                        <tr>
                                            <td colspan="7" class="px-4 md:px-6 py-8 text-center text-slate-500">
                                                ${players.length === 0 ? (STATE.market.showFreeAgents ? 'No free agents available' : 'No players match your filters') : 'No players on this page'}
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                        
                        ${totalPages > 1 ? `
                            <div class="p-4 bg-slate-800/50 border-t border-slate-700 flex flex-col md:flex-row justify-between items-center gap-2">
                                <div class="text-xs md:text-sm text-slate-400">
                                    Showing ${startIndex + 1}-${Math.min(startIndex + STATE.market.perPage, players.length)} of ${players.length} players
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="changeMarketPage(${STATE.market.page - 1})" ${STATE.market.page <= 1 ? 'disabled' : ''} 
                                        class="px-2 md:px-3 py-1 rounded bg-slate-700 text-slate-300 text-xs md:text-sm ${STATE.market.page <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-600'}">
                                        Previous
                                    </button>
                                    <span class="px-2 md:px-3 py-1 text-xs md:text-sm text-slate-300">
                                        Page ${STATE.market.page} of ${totalPages}
                                    </span>
                                    <button onclick="changeMarketPage(${STATE.market.page + 1})" ${STATE.market.page >= totalPages ? 'disabled' : ''} 
                                        class="px-2 md:px-3 py-1 rounded bg-slate-700 text-slate-300 text-xs md:text-sm ${STATE.market.page >= totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-600'}">
                                        Next
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            if (STATE.view === 'next-match') {
                if(isFinished) return `<div class="text-center text-xl md:text-2xl font-bold text-slate-500 mt-10 md:mt-20">Season Completed. Check Results.</div>`;
                
                // Находим следующий матч пользователя в календаре
                let nextMatch = null;
                let matchType = '';
                let opponent = null;
                let cupRoundName = '';
                
                for (let i = STATE.calendar.currentWeek; i < STATE.calendar.weeks.length; i++) {
                    const week = STATE.calendar.weeks[i];
                    for (const event of week.events) {
                        if (event.played) continue;
                        
                        if (event.type === "LEAGUE") {
                            const weekMatches = STATE.schedule[event.matchday];
                            const userLeagueMatch = weekMatches.find(m => m.home === STATE.userTeamId || m.away === STATE.userTeamId);
                            if (userLeagueMatch) {
                                nextMatch = userLeagueMatch;
                                matchType = 'League';
                                opponent = getTeam(nextMatch.home === STATE.userTeamId ? nextMatch.away : nextMatch.home);
                                break;
                            }
                        } else if (event.type === "CUP" && STATE.cups.leagueCup) {
                            const cup = STATE.cups.leagueCup;
                            const cupRound = cup.rounds[event.round];
                            if (cupRound) {
                                const userCupMatch = cupRound.fixtures.find(f => f.homeId === STATE.userTeamId || f.awayId === STATE.userTeamId);
                                if (userCupMatch && !userCupMatch.played) {
                                    nextMatch = userCupMatch;
                                    matchType = 'Cup';
                                    opponent = getTeam(nextMatch.homeId === STATE.userTeamId ? nextMatch.awayId : nextMatch.homeId);
                                    cupRoundName = cupRound.name;
                                    break;
                                }
                            }
                        } else if (event.type === "EURO" && STATE.europe) {
                            // Ищем евроматч пользователя
                            const comp = STATE.europe[event.cup];
                            if (comp && comp.stage === 'GROUP') {
                                const userGroup = getUserEuroGroup(event.cup);
                                if (userGroup && comp.schedule[userGroup]) {
                                    const mdMatches = comp.schedule[userGroup][event.matchday];
                                    if (mdMatches) {
                                        const userEuroMatch = mdMatches.find(m => m.homeId === STATE.userTeamId || m.awayId === STATE.userTeamId);
                                        if (userEuroMatch && !userEuroMatch.played) {
                                            nextMatch = userEuroMatch;
                                            matchType = EURO_COMP_NAMES[event.cup] || 'Euro';
                                            opponent = getTeam(userEuroMatch.homeId === STATE.userTeamId ? userEuroMatch.awayId : userEuroMatch.homeId);
                                            cupRoundName = `Group ${userGroup} - Matchday ${event.matchday + 1}`;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (nextMatch) break;
                }
                
                if (!nextMatch || !opponent) {
                    return `<div class="text-center text-xl md:text-2xl font-bold text-slate-500 mt-10 md:mt-20">No upcoming matches found</div>`;
                }
                
                const isHome = (nextMatch.home === STATE.userTeamId) || (nextMatch.homeId === STATE.userTeamId);

                return `
                    <div class="max-w-4xl mx-auto mt-4 md:mt-10">
                        <div class="glass-panel rounded-xl md:rounded-3xl p-6 md:p-12 text-center relative overflow-hidden group">
                            <div class="absolute inset-0 bg-gradient-to-br from-[#4caf50]/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                            <h3 class="text-[#4caf50] font-bold tracking-[0.2em] text-xs md:text-sm uppercase mb-8 md:mb-12">Upcoming ${matchType} Fixture${cupRoundName ? ` - ${cupRoundName}` : ''}</h3>
                            
                            <div class="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-16">
                                <div class="w-full md:w-1/3 flex flex-col items-center">
                                    ${renderTeamLogo(userTeam, '2xl', 'mb-6')}
                                    <h2 class="text-2xl md:text-3xl font-black text-white">${userTeam.name}</h2>
                                    <span class="text-slate-500 font-mono mt-2 text-sm bg-slate-900 px-3 py-1 rounded border border-slate-700">${isHome ? 'HOME' : 'AWAY'}</span>
                                </div>
                                <div class="text-4xl md:text-6xl font-black text-slate-700 italic opacity-40 my-4 md:my-0">VS</div>
                                <div class="w-full md:w-1/3 flex flex-col items-center">
                                    ${renderTeamLogo(opponent, '2xl', 'mb-6')}
                                    <h2 class="text-2xl md:text-3xl font-black text-white">${opponent.name}</h2>
                                    <span class="text-slate-500 font-mono mt-2 text-sm bg-slate-900 px-3 py-1 rounded border border-slate-700">${!isHome ? 'HOME' : 'AWAY'}</span>
                                </div>
                            </div>
                            
                            <div class="mt-8 md:mt-16 inline-flex gap-px bg-slate-700 rounded-lg overflow-hidden border border-slate-600">
                                <div class="bg-slate-800 px-4 md:px-8 py-4">
                                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Your Rating</div>
                                    <div class="text-xl md:text-2xl font-black text-white">${userTeam.teamRating}</div>
                                </div>
                                <div class="bg-slate-800 px-4 md:px-8 py-4">
                                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Opp Rating</div>
                                    <div class="text-xl md:text-2xl font-black text-white">${opponent.teamRating}</div>
                                </div>
                            </div>
                            
                            <div class="mt-6 text-sm text-slate-400">
                                ${matchType === 'Cup' ? `League Cup - ${cupRoundName} (Penalties if draw)` : 
                                  matchType === 'League' ? 'League Match' :
                                  `${matchType} - ${cupRoundName}`}
                            </div>
                        </div>
                    </div>
                `;
            }

            if (STATE.view === 'tactics') {
                const slotPositions = getSlotPositions();
                const validation = validateStartingXI(userTeam);
                const validationClass = validation.valid ? 'text-emerald-400' : 'text-red-400';
                const benchPlayers = getBenchPlayers(userTeam);
                
                // Доступные тактики
                const availableTactics = [
                    { id: '4-4-2', name: '4-4-2' },
                    { id: '4-3-3', name: '4-3-3' },
                    { id: '3-5-2', name: '3-5-2' },
                    { id: '4-2-3-1', name: '4-2-3-1' },
                    { id: '5-3-2', name: '5-3-2' },
                    { id: '4-1-4-1', name: '4-1-4-1' }
                ];
                
                const currentTactic = STATE.currentTactic || '4-3-3';
                
                // Планы игры
                const gamePlans = [
                    { id: 'balanced', name: 'Balanced' },
                    { id: 'attacking', name: 'Attacking' },
                    { id: 'defensive', name: 'Defensive' },
                    { id: 'counter', name: 'Counter' },
                    { id: 'possession', name: 'Possession' }
                ];
                
                const currentPlan = STATE.gamePlan || 'balanced';
                
                // Давления
                const pressureTypes = [
                    { id: 'low', name: 'Low' },
                    { id: 'normal', name: 'Normal' },
                    { id: 'high', name: 'High' }
                ];
                
                const currentPressure = STATE.pressure || 'normal';
                
                return `
                    <div class="flex flex-col h-full overflow-hidden">
                        <!-- Заголовок с тактикой -->
                        <div class="flex-shrink-0 bg-slate-900/80 border-b border-slate-700 p-2">
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-white font-black text-sm uppercase tracking-wider">Team Management</h2>
                                <div class="flex items-center gap-2">
                                    <span class="bg-[#4caf50]/20 text-[#4caf50] px-2 py-1 rounded text-xs font-bold">${userTeam.teamRating}</span>
                                    <button onclick="autoSelectBestXI(getTeam('${userTeam.id}')); renderDashboard();" 
                                            class="bg-blue-600 hover:bg-blue-500 text-white font-bold text-[10px] px-2 py-1 rounded uppercase">
                                        AUTO
                                    </button>
                                </div>
                            </div>
                            <div class="text-xs ${validationClass}">${validation.message}</div>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto flex flex-col">
                            <!-- Футбольное поле с игроками -->
                            <div class="flex-shrink-0 relative bg-gradient-to-b from-green-800 to-green-700 mx-2 mt-2 rounded-lg overflow-hidden" style="aspect-ratio: 3/4; max-height: 55vh;">
                                <!-- Разметка поля -->
                                <svg class="absolute inset-0 w-full h-full" viewBox="0 0 300 400" preserveAspectRatio="xMidYMid slice">
                                    <!-- Границы поля -->
                                    <rect x="10" y="10" width="280" height="380" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
                                    <!-- Центральная линия -->
                                    <line x1="10" y1="200" x2="290" y2="200" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                                    <!-- Центральный круг -->
                                    <circle cx="150" cy="200" r="40" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                                    <circle cx="150" cy="200" r="3" fill="rgba(255,255,255,0.3)"/>
                                    <!-- Штрафная зона снизу (ворота) -->
                                    <rect x="75" y="330" width="150" height="60" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                                    <rect x="100" y="360" width="100" height="30" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                                    <circle cx="150" cy="350" r="3" fill="rgba(255,255,255,0.3)"/>
                                    <!-- Штрафная зона сверху (атака) -->
                                    <rect x="75" y="10" width="150" height="60" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                                    <rect x="100" y="10" width="100" height="30" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                                    <circle cx="150" cy="50" r="3" fill="rgba(255,255,255,0.3)"/>
                                </svg>
                                
                                <!-- Игроки на поле - PORTRAIT MODE -->
                                <div class="absolute inset-0 p-2">
                                    <!-- Нападающие (ряд 1 - верх) -->
                                    <div class="absolute top-[8%] left-0 right-0 flex justify-center gap-4">
                                        ${[8, 9, 10].map(idx => renderPitchPlayer(idx, userTeam)).join('')}
                                    </div>
                                    
                                    <!-- Полузащитники (ряд 2) -->
                                    <div class="absolute top-[28%] left-0 right-0 flex justify-center gap-3">
                                        ${[5, 6, 7].map(idx => renderPitchPlayer(idx, userTeam)).join('')}
                                    </div>
                                    
                                    <!-- Защитники (ряд 3) -->
                                    <div class="absolute top-[55%] left-0 right-0 flex justify-center gap-2">
                                        ${[1, 2, 3, 4].map(idx => renderPitchPlayer(idx, userTeam)).join('')}
                                    </div>
                                    
                                    <!-- Вратарь (ряд 4 - низ) -->
                                    <div class="absolute bottom-[8%] left-0 right-0 flex justify-center">
                                        ${renderPitchPlayer(0, userTeam)}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Тактические настройки -->
                            <div class="flex-shrink-0 bg-slate-900/60 mx-2 mt-2 rounded-lg p-2">
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div>
                                        <div class="text-[10px] text-slate-400 uppercase mb-1">Game Plan</div>
                                        <select onchange="STATE.gamePlan = this.value" class="w-full bg-slate-800 text-white text-xs rounded px-2 py-1 border border-slate-600">
                                            ${gamePlans.map(p => `<option value="${p.id}" ${currentPlan === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-slate-400 uppercase mb-1">Formation</div>
                                        <select onchange="changeTactic(this.value)" class="w-full bg-slate-800 text-white text-xs rounded px-2 py-1 border border-slate-600">
                                            ${availableTactics.map(t => `<option value="${t.id}" ${currentTactic === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-slate-400 uppercase mb-1">Pressure</div>
                                        <select onchange="STATE.pressure = this.value" class="w-full bg-slate-800 text-white text-xs rounded px-2 py-1 border border-slate-600">
                                            ${pressureTypes.map(p => `<option value="${p.id}" ${currentPressure === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Вкладки: Замены / Резерв -->
                            <div class="flex-shrink-0 flex gap-1 mx-2 mt-2">
                                <button onclick="STATE.benchTab = 'subs'; renderDashboard();" 
                                    class="flex-1 py-1.5 text-xs font-bold uppercase rounded-t ${(STATE.benchTab || 'subs') === 'subs' ? 'bg-slate-800 text-white' : 'bg-slate-900/50 text-slate-400'}">
                                    Substitutes
                                </button>
                                <button onclick="STATE.benchTab = 'reserves'; renderDashboard();" 
                                    class="flex-1 py-1.5 text-xs font-bold uppercase rounded-t ${STATE.benchTab === 'reserves' ? 'bg-slate-800 text-white' : 'bg-slate-900/50 text-slate-400'}">
                                    Reserves
                                </button>
                            </div>
                            
                            <!-- Список запасных -->
                            <div class="flex-1 overflow-y-auto bg-slate-800 mx-2 mb-2 rounded-b-lg p-2 min-h-[120px]">
                                <div class="grid grid-cols-3 gap-2">
                                    ${benchPlayers.slice(0, (STATE.benchTab || 'subs') === 'subs' ? 7 : benchPlayers.length).sort((a,b) => b.rating - a.rating).map(p => renderBenchPlayerCard(p)).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (STATE.view === 'table') {
                const sorted = [...STATE.activeLeagueTeams].sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
                
                // Переключатели соревнований
                const competitionTabs = () => {
                    const hasEurope = STATE.europe && (STATE.europe.UCL || STATE.europe.UEL || STATE.europe.UECL);
                    
                    return `
                        <div class="flex flex-wrap gap-2 mb-4 p-2 bg-slate-800/50 rounded-lg">
                            <button onclick="STATE.tableView = 'LEAGUE'; renderDashboard();" 
                                class="px-3 py-1.5 rounded text-xs font-bold uppercase transition-colors ${STATE.tableView === 'LEAGUE' ? 'bg-[#4caf50] text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}">
                                League
                            </button>
                            ${hasEurope && STATE.europe.UCL && Object.keys(STATE.europe.UCL.groups).length > 0 ? `
                                <button onclick="STATE.tableView = 'UCL'; renderDashboard();" 
                                    class="px-3 py-1.5 rounded text-xs font-bold uppercase transition-colors ${STATE.tableView === 'UCL' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}">
                                    🏆 UCL Groups
                                </button>
                            ` : ''}
                            ${hasEurope && STATE.europe.UEL && Object.keys(STATE.europe.UEL.groups).length > 0 ? `
                                <button onclick="STATE.tableView = 'UEL'; renderDashboard();" 
                                    class="px-3 py-1.5 rounded text-xs font-bold uppercase transition-colors ${STATE.tableView === 'UEL' ? 'bg-orange-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}">
                                    🌟 UEL Groups
                                </button>
                            ` : ''}
                            ${hasEurope && STATE.europe.UECL && Object.keys(STATE.europe.UECL.groups).length > 0 ? `
                                <button onclick="STATE.tableView = 'UECL'; renderDashboard();" 
                                    class="px-3 py-1.5 rounded text-xs font-bold uppercase transition-colors ${STATE.tableView === 'UECL' ? 'bg-emerald-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}">
                                    ⭐ UECL Groups
                                </button>
                            ` : ''}
                        </div>
                    `;
                };
                
                // Если показываем еврокубки
                if (STATE.tableView !== 'LEAGUE' && STATE.europe && STATE.europe[STATE.tableView]) {
                    return renderEuroGroupsView(STATE.tableView, competitionTabs());
                }
                
                // На мобильных показываем как список, на десктопе как таблицу
                if (window.innerWidth <= 768) {
                    return `
                        ${competitionTabs()}
                        <div class="space-y-2">
                            ${sorted.map((t, i) => {
                                let zoneClass = '';
                                let zoneText = '';
                                if (i < 4) {
                                    zoneClass = 'border-emerald-500';
                                    zoneText = '<span class="text-emerald-500 text-xs font-bold">Champions League</span>';
                                } else if (i < 6) {
                                    zoneClass = 'border-blue-500';
                                    zoneText = '<span class="text-blue-500 text-xs font-bold">Europa League</span>';
                                } else if (i >= sorted.length - 3) {
                                    zoneClass = 'border-red-500';
                                    zoneText = '<span class="text-red-500 text-xs font-bold">Relegation Zone</span>';
                                }
                                
                                const isUserTeam = t.id === STATE.userTeamId;
                                const userTeamClass = isUserTeam ? 'bg-[#4caf50]/10 border-l-4 border-[#4caf50]' : `border-l-4 ${zoneClass}`;
                                
                                return `
                                    <div class="${userTeamClass} bg-slate-800/50 p-4 rounded-lg">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex items-center gap-3">
                                                <span class="text-slate-500 font-mono w-6 text-center">${i+1}</span>
                                                ${renderTeamLogo(t, 'sm')}
                                                <div>
                                                    <div class="font-bold text-slate-200 ${isUserTeam ? 'text-[#4caf50]' : ''}">${t.name}</div>
                                                    ${zoneText ? `<div class="mt-1">${zoneText}</div>` : ''}
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-lg font-black text-white">${t.points}</div>
                                                <div class="text-xs text-slate-400">pts</div>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-4 gap-2 text-center text-xs mt-3">
                                            <div>
                                                <div class="text-slate-400">P</div>
                                                <div class="font-bold">${t.played}</div>
                                            </div>
                                            <div>
                                                <div class="text-[#4caf50]">W</div>
                                                <div class="font-bold">${t.wins}</div>
                                            </div>
                                            <div>
                                                <div class="text-slate-400">D</div>
                                                <div class="font-bold">${t.draws}</div>
                                            </div>
                                            <div>
                                                <div class="text-red-400">L</div>
                                                <div class="font-bold">${t.losses}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    return `
                        ${competitionTabs()}
                        <div class="glass-panel rounded-xl overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-800 text-xs uppercase text-slate-400">
                                    <tr>
                                        <th class="px-6 py-4 text-center">#</th>
                                        <th class="px-6 py-4">Club</th>
                                        <th class="px-6 py-4 text-center">P</th>
                                        <th class="px-6 py-4 text-center">W</th>
                                        <th class="px-6 py-4 text-center">D</th>
                                        <th class="px-6 py-4 text-center">L</th>
                                        <th class="px-6 py-4 text-center font-bold text-white">Pts</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-700/50">
                                    ${sorted.map((t, i) => {
                                        let zoneClass = '';
                                        if (i < 4) zoneClass = 'border-l-4 border-emerald-500';
                                        else if (i < 6) zoneClass = 'border-l-4 border-blue-500';
                                        else if (i >= sorted.length - 3) zoneClass = 'border-l-4 border-red-500';
                                        
                                        const rowClass = t.id === STATE.userTeamId ? 'bg-[#4caf50]/10 border-l-4 border-[#4caf50] relative z-10 shadow-lg' : `hover:bg-slate-800/30 ${zoneClass}`;
                                        
                                        return `
                                        <tr class="${rowClass}">
                                            <td class="px-6 py-4 text-center text-slate-500 font-mono">${i+1}</td>
                                            <td class="px-6 py-4 font-bold text-slate-200">
                                                <div class="flex items-center gap-3">
                                                    ${renderTeamLogo(t, 'sm')}
                                                    <span>${t.name}</span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-center text-slate-400">${t.played}</td>
                                            <td class="px-6 py-4 text-center text-[#4caf50]">${t.wins}</td>
                                            <td class="px-6 py-4 text-center text-slate-400">${t.draws}</td>
                                            <td class="px-6 py-4 text-center text-red-400">${t.losses}</td>
                                            <td class="px-6 py-4 text-center font-black text-white text-base">${t.points}</td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }

            if (STATE.view === 'squad') {
                const sortedSquad = [...userTeam.squad].sort((a, b) => {
                    if (b.seasonGoals !== a.seasonGoals) return b.seasonGoals - a.seasonGoals;
                    if (b.seasonAssists !== a.seasonAssists) return b.seasonAssists - a.seasonAssists;
                    return b.rating - a.rating;
                });
                
                // На мобильных показываем как список карточек
                if (window.innerWidth <= 768) {
                    return `
                        <div class="space-y-3">
                            <div class="glass-panel rounded-xl p-4">
                                <h3 class="font-bold text-white mb-4">Squad Statistics</h3>
                                <div class="grid grid-cols-3 gap-4 text-center mb-6">
                                    <div>
                                        <div class="text-xl font-black text-[#4caf50]">${sortedSquad.reduce((sum, p) => sum + p.seasonGoals, 0)}</div>
                                        <div class="text-xs text-slate-400">Team Goals</div>
                                    </div>
                                    <div>
                                        <div class="text-xl font-black text-blue-400">${sortedSquad.reduce((sum, p) => sum + p.seasonAssists, 0)}</div>
                                        <div class="text-xs text-slate-400">Team Assists</div>
                                    </div>
                                    <div>
                                        <div class="text-xl font-black text-yellow-400">${Math.round(sortedSquad.reduce((sum, p) => sum + p.rating, 0) / sortedSquad.length)}</div>
                                        <div class="text-xs text-slate-400">Avg Rating</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${sortedSquad.map(p => `
                                <div class="bg-slate-800/50 rounded-xl p-4 hover:bg-slate-800/70 transition-colors">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <span class="font-bold text-slate-200 clickable-name" onclick="openPlayerProfile(${p.internalId})">${p.name}</span>
                                                ${p.isStarter ? '<span class="text-xs bg-[#4caf50] text-white px-2 py-0.5 rounded">STARTER</span>' : ''}
                                            </div>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="px-2 py-0.5 rounded text-xs font-bold ${getPosColor(p.pos)} bg-opacity-10">${p.pos}</span>
                                                <span class="text-xs text-slate-400">Age: ${p.age}</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold ${p.rating >= 85 ? 'text-yellow-400' : 'text-white'}">${p.rating}</div>
                                            <div class="text-xs text-slate-400">OVR</div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-4 gap-2 text-center text-xs mt-3">
                                        <div>
                                            <div class="text-slate-400">⚽ Goals</div>
                                            <div class="font-bold text-[#4caf50]">${p.seasonGoals}</div>
                                        </div>
                                        <div>
                                            <div class="text-slate-400">🎯 Assists</div>
                                            <div class="font-bold text-blue-400">${p.seasonAssists}</div>
                                        </div>
                                        <div>
                                            <div class="text-slate-400">⭐ Rating</div>
                                            <div class="font-bold text-yellow-400">${Math.round(p.seasonRating)}</div>
                                        </div>
                                        <div>
                                            <div class="text-slate-400">Status</div>
                                            <div class="text-xs">
                                                ${p.injuryWeeks > 0 ? `<span class="text-red-500 font-bold">🩹 ${p.injuryWeeks}w</span>` : 
                                                  p.isSuspended ? '<span class="text-red-500 font-bold">🟥</span>' : 
                                                  p.transferListed ? '<span class="text-red-400 font-bold">Listed</span>' : 
                                                  '<span class="text-emerald-400">✓ Fit</span>'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    return `
                        <div class="glass-panel rounded-xl overflow-hidden">
                            <div class="p-4 bg-slate-800/80 border-b border-slate-700 flex justify-between items-center">
                                <h3 class="font-bold text-white">Squad Statistics</h3>
                                <div class="flex gap-4 text-sm">
                                    <div class="text-center">
                                        <div class="text-xl font-black text-[#4caf50]">${sortedSquad.reduce((sum, p) => sum + p.seasonGoals, 0)}</div>
                                        <div class="text-xs text-slate-400">Team Goals</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xl font-black text-blue-400">${sortedSquad.reduce((sum, p) => sum + p.seasonAssists, 0)}</div>
                                        <div class="text-xs text-slate-400">Team Assists</div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-900 text-xs uppercase text-slate-400">
                                        <tr>
                                            <th class="px-6 py-4">Name</th>
                                            <th class="px-6 py-4 text-center">Pos</th>
                                            <th class="px-6 py-4 text-center">OVR</th>
                                            <th class="px-6 py-4 text-center">POT</th>
                                            <th class="px-6 py-4 text-center">Status</th>
                                            <th class="px-6 py-4 text-center text-[#4caf50]">⚽ Goals</th>
                                            <th class="px-6 py-4 text-center text-blue-400">🎯 Assists</th>
                                            <th class="px-6 py-4 text-center text-yellow-400">⭐ Rating</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-700/50">
                                        ${sortedSquad.map(p => `
                                            <tr class="hover:bg-slate-800/30">
                                                <td class="px-6 py-3 font-medium text-slate-200">
                                                    <span class="clickable-name" onclick="openPlayerProfile(${p.internalId})">${p.name}</span>
                                                    ${p.isStarter ? '<span class="ml-2 text-xs bg-[#4caf50] text-white px-2 py-0.5 rounded">STARTER</span>' : ''}
                                                </td>
                                                <td class="px-6 py-3 text-center"><span class="px-2 py-0.5 rounded text-xs font-bold ${getPosColor(p.pos)} bg-opacity-10">${p.pos}</span></td>
                                                <td class="px-6 py-3 text-center font-bold ${p.rating >= 85 ? 'text-yellow-400' : 'text-white'}">${p.rating}</td>
                                                <td class="px-6 py-3 text-center font-bold ${p.potential > p.rating ? 'text-emerald-400' : p.potential < p.rating ? 'text-red-400' : 'text-slate-400'}">${p.potential || p.rating}</td>
                                                <td class="px-6 py-3 text-center text-xs">
                                                    ${p.transferListed ? '<span class="text-red-400 font-bold uppercase border border-red-500/30 px-2 py-1 rounded">Listed</span>' : ''}
                                                    ${p.injuryWeeks > 0 ? `<span class="text-red-500 font-bold ml-1">🩹 ${p.injuryWeeks}w</span>` : ''}
                                                    ${p.isSuspended ? '<span class="text-red-500 font-bold ml-1">🟥</span>' : ''}
                                                    ${!p.transferListed && p.injuryWeeks === 0 && !p.isSuspended ? '<span class="text-slate-500">-</span>' : ''}
                                                </td>
                                                <td class="px-6 py-3 text-center">
                                                    <div class="font-mono text-[#4caf50] font-bold text-lg">${p.seasonGoals}</div>
                                                    <div class="text-xs text-slate-400">${p.careerGoals} career</div>
                                                </td>
                                                <td class="px-6 py-3 text-center">
                                                    <div class="font-mono text-blue-400 font-bold text-lg">${p.seasonAssists}</div>
                                                    <div class="text-xs text-slate-400">this season</div>
                                                </td>
                                                <td class="px-6 py-3 text-center">
                                                    <div class="font-mono text-yellow-400 font-bold text-lg">${Math.round(p.seasonRating)}</div>
                                                    <div class="text-xs text-slate-400">form</div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Рендер таблиц групп еврокубков - УЛУЧШЕННАЯ ВЕРСИЯ
        function renderEuroGroupsView(compId, tabsHtml) {
            const comp = STATE.europe?.[compId];
            if (!comp) {
                return `
                    ${tabsHtml}
                    <div class="glass-panel rounded-xl p-8 text-center">
                        <div class="text-4xl mb-4">🏆</div>
                        <h3 class="text-xl font-bold text-white mb-2">No European Competition Data</h3>
                        <p class="text-slate-400 text-sm">European competitions will be available next season if you qualify.</p>
                    </div>
                `;
            }
            
            const colors = EURO_COMP_COLORS[compId] || { bg: 'bg-blue-600', text: 'text-blue-400', border: 'border-blue-500' };
            const compName = EURO_COMP_NAMES[compId] || 'European Cup';
            const userGroup = getUserEuroGroup(compId);
            const groups = Object.keys(comp.groups || {}).sort();
            
            if (groups.length === 0) {
                return `
                    ${tabsHtml}
                    <div class="glass-panel rounded-xl p-8 text-center">
                        <div class="text-4xl mb-4">${compId === 'UCL' ? '🏆' : compId === 'UEL' ? '🌟' : '⭐'}</div>
                        <h3 class="text-xl font-bold text-white mb-2">${compName}</h3>
                        <p class="text-slate-400 text-sm">Group stage not yet drawn. Check back after the season starts.</p>
                    </div>
                `;
            }
            
            // Определяем какую группу показывать
            let displayGroup = STATE.selectedEuroGroup;
            if (!groups.includes(displayGroup)) {
                displayGroup = userGroup || groups[0];
            }
            
            // Рендер группы пользователя вверху с улучшенным дизайном
            const renderUserGroupInfo = () => {
                if (!userGroup) {
                    return `
                        <div class="mb-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl opacity-50">📊</span>
                                <div>
                                    <h3 class="font-bold text-slate-400">Spectator Mode</h3>
                                    <span class="text-slate-500 text-sm">Your team is not participating in ${compName}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                const sortedTable = getSortedGroupTable(compId, userGroup);
                const userPosition = sortedTable.findIndex(t => t.teamId === STATE.userTeamId) + 1;
                const userStats = sortedTable.find(t => t.teamId === STATE.userTeamId);
                const qualifies = userPosition <= 2;
                
                return `
                    <div class="mb-6 p-5 bg-gradient-to-br from-slate-800/90 to-slate-900/90 rounded-2xl border-2 ${colors.border} shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 ${colors.bg} opacity-10 rounded-full blur-3xl"></div>
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 ${colors.bg} rounded-xl flex items-center justify-center shadow-lg">
                                        <span class="text-3xl">${compId === 'UCL' ? '🏆' : compId === 'UEL' ? '🌟' : '⭐'}</span>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-white text-lg">${compName}</h3>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="${colors.bg} ${colors.text === 'text-blue-400' ? 'text-white' : ''} text-xs font-bold px-2 py-0.5 rounded">GROUP ${userGroup}</span>
                                            <span class="text-slate-400 text-sm">Position: <span class="${qualifies ? 'text-emerald-400' : 'text-red-400'} font-bold">${userPosition}/4</span></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-black ${colors.text}">${userStats?.Pts || 0}</div>
                                    <div class="text-xs text-slate-400 uppercase">Points</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-7 gap-2 text-center text-sm bg-slate-900/50 rounded-xl p-3">
                                <div class="border-r border-slate-700">
                                    <div class="text-slate-400 text-xs mb-1">Played</div>
                                    <div class="font-bold text-white text-lg">${userStats?.P || 0}</div>
                                </div>
                                <div class="border-r border-slate-700">
                                    <div class="text-emerald-400 text-xs mb-1">Won</div>
                                    <div class="font-bold text-emerald-400 text-lg">${userStats?.W || 0}</div>
                                </div>
                                <div class="border-r border-slate-700">
                                    <div class="text-slate-400 text-xs mb-1">Draw</div>
                                    <div class="font-bold text-slate-300 text-lg">${userStats?.D || 0}</div>
                                </div>
                                <div class="border-r border-slate-700">
                                    <div class="text-red-400 text-xs mb-1">Lost</div>
                                    <div class="font-bold text-red-400 text-lg">${userStats?.L || 0}</div>
                                </div>
                                <div class="border-r border-slate-700">
                                    <div class="text-slate-400 text-xs mb-1">GF</div>
                                    <div class="font-bold text-slate-300 text-lg">${userStats?.GF || 0}</div>
                                </div>
                                <div class="border-r border-slate-700">
                                    <div class="text-slate-400 text-xs mb-1">GA</div>
                                    <div class="font-bold text-slate-300 text-lg">${userStats?.GA || 0}</div>
                                </div>
                                <div>
                                    <div class="text-slate-400 text-xs mb-1">GD</div>
                                    <div class="font-bold ${(userStats?.GD || 0) >= 0 ? 'text-emerald-400' : 'text-red-400'} text-lg">${(userStats?.GD || 0) >= 0 ? '+' : ''}${userStats?.GD || 0}</div>
                                </div>
                            </div>
                            
                            <div class="mt-3 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    ${qualifies 
                                        ? '<span class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></span><span class="text-emerald-400 text-sm font-bold">✓ Qualification zone</span>'
                                        : '<span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span><span class="text-red-400 text-sm font-bold">⚠ Must improve position</span>'
                                    }
                                </div>
                                <span class="text-slate-500 text-xs">Matchday ${comp.matchday || 0}/6</span>
                            </div>
                        </div>
                    </div>
                `;
            };
            
            // Кнопки выбора группы - улучшенный дизайн
            const renderGroupButtons = () => {
                return `
                    <div class="flex flex-wrap gap-2 mb-4 p-3 bg-slate-800/30 rounded-xl">
                        <span class="text-xs text-slate-500 font-bold uppercase mr-2 self-center">Select Group:</span>
                        ${groups.map(g => `
                            <button onclick="STATE.selectedEuroGroup = '${g}'; renderDashboard();" 
                                class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${displayGroup === g 
                                    ? `${colors.bg} text-white shadow-lg scale-105` 
                                    : 'bg-slate-700/50 text-slate-300 hover:bg-slate-600 hover:scale-102'} ${g === userGroup ? 'ring-2 ring-yellow-400 ring-offset-1 ring-offset-slate-900' : ''}">
                                ${g} ${g === userGroup ? '★' : ''}
                            </button>
                        `).join('')}
                    </div>
                `;
            };
            
            // Рендер таблицы выбранной группы - улучшенный дизайн
            const renderGroupTable = () => {
                const sortedTable = getSortedGroupTable(compId, displayGroup);
                
                if (!sortedTable || sortedTable.length === 0) {
                    return `
                        <div class="glass-panel rounded-xl p-6 text-center">
                            <p class="text-slate-400">No standings data available for Group ${displayGroup}</p>
                        </div>
                    `;
                }
                
                return `
                    <div class="glass-panel rounded-2xl overflow-hidden shadow-xl">
                        <div class="p-4 ${colors.bg} flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${compId === 'UCL' ? '🏆' : compId === 'UEL' ? '🌟' : '⭐'}</span>
                                <h4 class="font-black text-white text-lg uppercase tracking-wider">Group ${displayGroup}</h4>
                            </div>
                            <div class="bg-black/20 px-3 py-1 rounded-full">
                                <span class="text-xs text-white/80 font-bold">MD ${comp.matchday || 0}/6</span>
                            </div>
                        </div>
                        <table class="w-full text-left">
                            <thead class="bg-slate-800/80 text-xs uppercase text-slate-400 border-b border-slate-700">
                                <tr>
                                    <th class="px-4 py-3 text-center w-12">#</th>
                                    <th class="px-4 py-3">Team</th>
                                    <th class="px-4 py-3 text-center w-10">P</th>
                                    <th class="px-4 py-3 text-center w-10">W</th>
                                    <th class="px-4 py-3 text-center w-10">D</th>
                                    <th class="px-4 py-3 text-center w-10">L</th>
                                    <th class="px-4 py-3 text-center w-10">GF</th>
                                    <th class="px-4 py-3 text-center w-10">GA</th>
                                    <th class="px-4 py-3 text-center w-12">GD</th>
                                    <th class="px-4 py-3 text-center w-14 font-bold text-white">Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedTable.map((t, i) => {
                                    const team = getTeam(t.teamId);
                                    const isUser = t.teamId === STATE.userTeamId;
                                    const qualifies = i < 2;
                                    
                                    const rowBg = isUser 
                                        ? 'bg-gradient-to-r from-[#4caf50]/20 to-transparent' 
                                        : (i % 2 === 0 ? 'bg-slate-800/30' : 'bg-slate-900/30');
                                    const borderClass = isUser 
                                        ? 'border-l-4 border-[#4caf50]' 
                                        : qualifies 
                                            ? 'border-l-4 border-emerald-500' 
                                            : 'border-l-4 border-transparent';
                                    
                                    return `
                                        <tr class="${rowBg} ${borderClass} hover:bg-slate-700/30 transition-colors">
                                            <td class="px-4 py-4 text-center">
                                                <span class="w-7 h-7 inline-flex items-center justify-center rounded-full font-bold text-sm ${qualifies ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-700 text-slate-400'}">${i + 1}</span>
                                            </td>
                                            <td class="px-4 py-4">
                                                <div class="flex items-center gap-3">
                                                    ${renderTeamLogo(team, 'sm')}
                                                    <span class="font-bold ${isUser ? 'text-[#4caf50]' : 'text-white'}">${team?.name || 'Unknown'}</span>
                                                    ${isUser ? '<span class="text-[10px] bg-[#4caf50] text-white px-1.5 py-0.5 rounded font-bold">YOU</span>' : ''}
                                                </div>
                                            </td>
                                            <td class="px-4 py-4 text-center text-slate-400 font-mono">${t.P}</td>
                                            <td class="px-4 py-4 text-center text-emerald-400 font-bold">${t.W}</td>
                                            <td class="px-4 py-4 text-center text-slate-400">${t.D}</td>
                                            <td class="px-4 py-4 text-center text-red-400">${t.L}</td>
                                            <td class="px-4 py-4 text-center text-slate-300">${t.GF}</td>
                                            <td class="px-4 py-4 text-center text-slate-300">${t.GA}</td>
                                            <td class="px-4 py-4 text-center font-bold ${t.GD >= 0 ? 'text-emerald-400' : 'text-red-400'}">${t.GD >= 0 ? '+' : ''}${t.GD}</td>
                                            <td class="px-4 py-4 text-center">
                                                <span class="text-lg font-black text-white bg-slate-700/50 px-2 py-1 rounded">${t.Pts}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        <div class="p-3 bg-slate-800/50 border-t border-slate-700 flex items-center justify-center gap-4 text-xs">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 bg-emerald-500 rounded-full"></span>
                                <span class="text-slate-400">Knockout qualification (Top 2)</span>
                            </div>
                        </div>
                    </div>
                `;
            };
            
            // Рендер расписания/результатов группы - улучшенный дизайн
            const renderGroupFixtures = () => {
                const schedule = comp.schedule?.[displayGroup];
                if (!schedule) {
                    return `
                        <div class="mt-6 glass-panel rounded-xl p-6 text-center">
                            <p class="text-slate-400">No fixtures available for Group ${displayGroup}</p>
                        </div>
                    `;
                }
                
                return `
                    <div class="mt-6 glass-panel rounded-2xl overflow-hidden">
                        <div class="p-4 bg-slate-800/50 border-b border-slate-700 flex items-center justify-between">
                            <h4 class="font-bold text-white flex items-center gap-2">
                                <span class="text-lg">📅</span>
                                Group ${displayGroup} Fixtures & Results
                            </h4>
                        </div>
                        <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            ${[0,1,2,3,4,5].map(md => {
                                const matches = schedule[md] || [];
                                const isPlayed = matches.length > 0 && matches.every(m => m.played);
                                const isCurrent = md === (comp.matchday || 0);
                                const isFuture = md > (comp.matchday || 0);
                                
                                return `
                                    <div class="bg-slate-800/40 rounded-xl overflow-hidden border ${isCurrent ? colors.border + ' border-2' : 'border-slate-700/50'} ${isPlayed ? 'opacity-90' : ''}">
                                        <div class="px-3 py-2 ${isCurrent ? colors.bg : isPlayed ? 'bg-slate-700/50' : 'bg-slate-800/50'} flex items-center justify-between">
                                            <span class="text-xs font-bold ${isCurrent ? 'text-white' : 'text-slate-400'} uppercase">Matchday ${md + 1}</span>
                                            ${isPlayed ? '<span class="text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded-full font-bold">✓ Played</span>' : 
                                              isCurrent ? `<span class="text-[10px] bg-white/20 text-white px-2 py-0.5 rounded-full font-bold animate-pulse">● Live</span>` : 
                                              isFuture ? '<span class="text-[10px] bg-slate-600/50 text-slate-400 px-2 py-0.5 rounded-full">Upcoming</span>' : ''}
                                        </div>
                                        <div class="p-2 space-y-2">
                                            ${matches.length === 0 
                                                ? '<div class="text-xs text-slate-500 text-center py-2">No matches scheduled</div>'
                                                : matches.map(m => {
                                                    const home = getTeam(m.homeId);
                                                    const away = getTeam(m.awayId);
                                                    const isUserMatch = m.homeId === STATE.userTeamId || m.awayId === STATE.userTeamId;
                                                    
                                                    return `
                                                        <div class="flex items-center justify-between text-xs p-2 rounded-lg ${isUserMatch ? 'bg-[#4caf50]/15 border border-[#4caf50]/30' : 'bg-slate-900/30'} ${m.played ? '' : 'opacity-70'}">
                                                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                                                ${renderTeamLogo(home, 'xs')}
                                                                <span class="truncate ${m.homeId === STATE.userTeamId ? 'text-[#4caf50] font-bold' : 'text-slate-300'}">${home?.name?.split(' ').pop() || 'TBD'}</span>
                                                            </div>
                                                            <div class="px-2 min-w-[50px] text-center">
                                                                ${m.played 
                                                                    ? `<span class="font-black text-white bg-slate-700 px-2 py-1 rounded">${m.homeGoals} - ${m.awayGoals}</span>`
                                                                    : '<span class="text-slate-500 text-[10px]">vs</span>'
                                                                }
                                                            </div>
                                                            <div class="flex items-center gap-2 flex-1 min-w-0 justify-end">
                                                                <span class="truncate text-right ${m.awayId === STATE.userTeamId ? 'text-[#4caf50] font-bold' : 'text-slate-300'}">${away?.name?.split(' ').pop() || 'TBD'}</span>
                                                                ${renderTeamLogo(away, 'xs')}
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')
                                            }
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            };
            
            return `
                ${tabsHtml}
                <div class="space-y-4 overflow-y-auto max-h-[calc(100vh-180px)]">
                    ${renderUserGroupInfo()}
                    ${renderGroupButtons()}
                    ${renderGroupTable()}
                    ${renderGroupFixtures()}
                </div>
            `;
        }

        function renderSlotCard(slotIndex) {
            const slotPositions = getSlotPositions();
            const slotPosition = slotPositions[slotIndex];
            const player = getPlayerInSlot(slotIndex);
            
            if (!player) {
                return `
                    <div class="empty-slot p-3 md:p-4 rounded-lg flex flex-col items-center justify-center text-center min-h-[80px] md:min-h-[100px]"
                         onclick="openSlotSelection(${slotIndex})">
                        <div class="text-2xl md:text-3xl text-slate-600 mb-2">+</div>
                        <div class="slot-placeholder font-bold text-xs md:text-sm">EMPTY ${slotPosition.position}</div>
                        <div class="text-xs text-slate-500 mt-1">Click to select player</div>
                    </div>
                `;
            }
            
            const isUnavailable = player.injuryWeeks > 0 || player.isSuspended;
            const isActive = STATE.activeSwapSlot === slotIndex;
            
            return `
                <div onclick="selectSlotForSwap(${slotIndex})" 
                     class="player-card-select flex items-center justify-between p-3 rounded-lg bg-slate-800/40 ${isUnavailable ? 'unavailable' : ''} ${isActive ? 'waiting-swap' : ''}">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-black w-8 md:w-10 text-center py-1 rounded ${getPosColor(player.pos)} bg-opacity-10 ring-1 ring-inset ring-white/10 uppercase">
                            ${player.pos}
                        </span>
                        <div class="flex flex-col">
                            <span class="font-medium text-slate-200 clickable-name text-sm" onclick="openPlayerProfile(${player.internalId}, event)">${player.name}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">Age: ${player.age}</span>
                                <!-- НОВОЕ: Компактные индикаторы E/M -->
                                <span class="text-[10px] ${(player.energy ?? 100) >= 70 ? 'text-emerald-400' : (player.energy ?? 100) >= 40 ? 'text-yellow-400' : 'text-red-400'}">E${player.energy ?? 100}</span>
                                <span class="text-[10px] ${(player.morale ?? 50) >= 70 ? 'text-blue-400' : (player.morale ?? 50) >= 40 ? 'text-yellow-400' : 'text-red-400'}">M${player.morale ?? 50}</span>
                            </div>
                            ${player.injuryWeeks > 0 ? `<span class="text-[10px] text-red-400 font-bold">🩹 Injured (${player.injuryWeeks} wks)</span>` : ''}
                            ${player.isSuspended ? `<span class="text-[10px] text-red-400 font-bold">🟥 Suspended</span>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${player.seasonGoals > 0 ? `<span class="text-xs font-bold text-[#4caf50]">⚽ ${player.seasonGoals}</span>` : ''}
                        ${player.seasonAssists > 0 ? `<span class="text-xs font-bold text-blue-400">🎯 ${player.seasonAssists}</span>` : ''}
                        <div class="font-bold ${player.rating >= 90 ? 'text-yellow-400' : 'text-slate-500'}">${player.rating}</div>
                        <button onclick="clearSlot(${slotIndex}); event.stopPropagation();" 
                                class="text-slate-500 hover:text-red-400 text-xs ml-2">
                            ✕
                        </button>
                    </div>
                </div>
            `;
        }

        // НОВОЕ: Рендер игрока на футбольном поле (визуальный вид как на скриншоте)
        function renderPitchPlayer(slotIndex, team) {
            const player = getPlayerInSlot(slotIndex);
            const slotPositions = getSlotPositions();
            const slotPos = slotPositions[slotIndex];
            
            if (!player) {
                return `
                    <div onclick="openSlotSelection(${slotIndex})" 
                         class="flex flex-col items-center cursor-pointer group">
                        <div class="w-10 h-10 rounded-full bg-slate-700/80 border-2 border-dashed border-slate-500 flex items-center justify-center group-hover:border-[#4caf50] group-hover:bg-slate-600/80 transition-all">
                            <span class="text-slate-400 text-lg group-hover:text-[#4caf50]">+</span>
                        </div>
                        <span class="text-[8px] text-slate-500 mt-1 font-bold">${slotPos.position}</span>
                    </div>
                `;
            }
            
            const isUnavailable = player.injuryWeeks > 0 || player.isSuspended;
            const isActive = STATE.activeSwapSlot === slotIndex;
            
            // Цвет рейтинга
            const getRatingColor = (rating) => {
                if (rating >= 80) return 'bg-gradient-to-b from-yellow-500 to-yellow-600 text-black';
                if (rating >= 70) return 'bg-gradient-to-b from-green-500 to-green-600 text-white';
                if (rating >= 60) return 'bg-gradient-to-b from-blue-500 to-blue-600 text-white';
                return 'bg-gradient-to-b from-slate-500 to-slate-600 text-white';
            };
            
            // Короткое имя
            const shortName = player.name.split(' ').pop();
            
            return `
                <div onclick="selectSlotForSwap(${slotIndex})" 
                     class="flex flex-col items-center cursor-pointer group ${isActive ? 'scale-110' : ''} transition-transform">
                    <div class="relative">
                        <!-- Позиция над рейтингом -->
                        <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 text-[7px] font-black px-1 py-0.5 rounded bg-slate-900/80 text-slate-300 uppercase tracking-tight z-10">
                            ${player.pos}
                        </div>
                        <!-- Круг с рейтингом -->
                        <div class="w-10 h-10 rounded-full ${getRatingColor(player.rating)} flex items-center justify-center font-black text-sm shadow-lg ${isActive ? 'ring-2 ring-[#4caf50] ring-offset-1 ring-offset-green-800' : ''} ${isUnavailable ? 'opacity-60' : ''} group-hover:scale-105 transition-transform">
                            ${player.rating}
                        </div>
                        ${isUnavailable ? `
                            <div class="absolute -top-1 -right-1 w-4 h-4 rounded-full ${player.isSuspended ? 'bg-red-500' : 'bg-yellow-500'} flex items-center justify-center text-[8px]">
                                ${player.isSuspended ? '🟥' : '🩹'}
                            </div>
                        ` : ''}
                    </div>
                    <span class="text-[9px] text-white font-bold mt-0.5 max-w-[50px] truncate text-center drop-shadow-lg">${shortName}</span>
                </div>
            `;
        }
        
        // НОВОЕ: Рендер карточки игрока на скамейке (компактная версия для grid)
        function renderBenchPlayerCard(p) {
            const isUnavailable = p.injuryWeeks > 0 || p.isSuspended;
            
            const getRatingColor = (rating) => {
                if (rating >= 80) return 'bg-gradient-to-b from-yellow-500 to-yellow-600 text-black';
                if (rating >= 70) return 'bg-gradient-to-b from-green-500 to-green-600 text-white';
                if (rating >= 60) return 'bg-gradient-to-b from-blue-500 to-blue-600 text-white';
                return 'bg-gradient-to-b from-slate-500 to-slate-600 text-white';
            };
            
            const shortName = p.name.split(' ').pop();
            
            return `
                <div onclick="instantSwapWithBench(${p.internalId})" 
                     class="flex flex-col items-center p-2 rounded-lg bg-slate-700/50 hover:bg-slate-600/50 cursor-pointer transition-all ${isUnavailable ? 'opacity-60' : ''}">
                    <div class="relative mb-1">
                        <!-- Позиция -->
                        <div class="absolute -top-1 left-1/2 transform -translate-x-1/2 text-[6px] font-black px-1 py-0.5 rounded bg-slate-900 text-slate-300 uppercase z-10">
                            ${p.pos}
                        </div>
                        <!-- Рейтинг -->
                        <div class="w-9 h-9 rounded-full ${getRatingColor(p.rating)} flex items-center justify-center font-black text-xs shadow-md">
                            ${p.rating}
                        </div>
                        ${isUnavailable ? `
                            <div class="absolute -top-1 -right-1 w-3 h-3 rounded-full ${p.isSuspended ? 'bg-red-500' : 'bg-yellow-500'} flex items-center justify-center text-[6px]">
                                ${p.isSuspended ? '🟥' : '🩹'}
                            </div>
                        ` : ''}
                    </div>
                    <span class="text-[8px] text-slate-300 font-medium truncate w-full text-center">${shortName}</span>
                </div>
            `;
        }
        
        // ENHANCED: Function to change tactics with formation position maps
        function changeTactic(tacticId) {
            STATE.currentTactic = tacticId;
            // Formation positions will be applied during rendering
            renderDashboard();
        }
        
        // NEW: Get formation position map based on current tactic
        function getFormationPositions(formation) {
            const formations = {
                '4-4-2': [
                    { pos: 'GK', x: 5, y: 50 },
                    { pos: 'LB', x: 18, y: 15 }, { pos: 'CB', x: 18, y: 38 }, { pos: 'CB', x: 18, y: 62 }, { pos: 'RB', x: 18, y: 85 },
                    { pos: 'LM', x: 45, y: 15 }, { pos: 'CM', x: 45, y: 38 }, { pos: 'CM', x: 45, y: 62 }, { pos: 'RM', x: 45, y: 85 },
                    { pos: 'ST', x: 75, y: 35 }, { pos: 'ST', x: 75, y: 65 }
                ],
                '4-3-3': [
                    { pos: 'GK', x: 5, y: 50 },
                    { pos: 'LB', x: 18, y: 20 }, { pos: 'CB', x: 18, y: 40 }, { pos: 'CB', x: 18, y: 60 }, { pos: 'RB', x: 18, y: 80 },
                    { pos: 'CM', x: 45, y: 25 }, { pos: 'CM', x: 45, y: 50 }, { pos: 'CM', x: 45, y: 75 },
                    { pos: 'LW', x: 75, y: 25 }, { pos: 'ST', x: 80, y: 50 }, { pos: 'RW', x: 75, y: 75 }
                ],
                '3-5-2': [
                    { pos: 'GK', x: 5, y: 50 },
                    { pos: 'CB', x: 18, y: 25 }, { pos: 'CB', x: 18, y: 50 }, { pos: 'CB', x: 18, y: 75 },
                    { pos: 'LM', x: 40, y: 10 }, { pos: 'CM', x: 45, y: 30 }, { pos: 'CM', x: 45, y: 50 }, { pos: 'CM', x: 45, y: 70 }, { pos: 'RM', x: 40, y: 90 },
                    { pos: 'ST', x: 75, y: 35 }, { pos: 'ST', x: 75, y: 65 }
                ],
                '4-2-3-1': [
                    { pos: 'GK', x: 5, y: 50 },
                    { pos: 'LB', x: 18, y: 15 }, { pos: 'CB', x: 18, y: 38 }, { pos: 'CB', x: 18, y: 62 }, { pos: 'RB', x: 18, y: 85 },
                    { pos: 'CDM', x: 38, y: 35 }, { pos: 'CDM', x: 38, y: 65 },
                    { pos: 'LM', x: 58, y: 20 }, { pos: 'CAM', x: 58, y: 50 }, { pos: 'RM', x: 58, y: 80 },
                    { pos: 'ST', x: 78, y: 50 }
                ],
                '5-3-2': [
                    { pos: 'GK', x: 5, y: 50 },
                    { pos: 'LWB', x: 18, y: 10 }, { pos: 'CB', x: 18, y: 30 }, { pos: 'CB', x: 18, y: 50 }, { pos: 'CB', x: 18, y: 70 }, { pos: 'RWB', x: 18, y: 90 },
                    { pos: 'CM', x: 45, y: 25 }, { pos: 'CM', x: 45, y: 50 }, { pos: 'CM', x: 45, y: 75 },
                    { pos: 'ST', x: 75, y: 35 }, { pos: 'ST', x: 75, y: 65 }
                ]
            };
            
            return formations[formation] || formations['4-3-3'];
        }

        function renderPlayerRow(p) {
            const isUnavailable = p.injuryWeeks > 0 || p.isSuspended;
            
            const potentialColor = p.potential > p.rating ? 'text-emerald-400' : 
                                 p.potential < p.rating ? 'text-red-400' : 'text-slate-400';
            
            return `
                <div onclick="instantSwapWithBench(${p.internalId})" 
                     class="player-card-select flex items-center justify-between p-3 rounded-lg bg-slate-800/40 ${isUnavailable ? 'unavailable' : ''}">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-black w-8 md:w-10 text-center py-1 rounded ${getPosColor(p.pos)} bg-opacity-10 ring-1 ring-inset ring-white/10 uppercase">
                            ${p.pos}
                        </span>
                        <div class="flex flex-col">
                            <span class="font-medium text-slate-200 clickable-name text-sm" onclick="openPlayerProfile(${p.internalId}, event)">${p.name}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">Age: ${p.age}</span>
                                <!-- НОВОЕ: Компактные индикаторы E/M для скамейки -->
                                <span class="text-[10px] ${(p.energy ?? 100) >= 70 ? 'text-emerald-400' : (p.energy ?? 100) >= 40 ? 'text-yellow-400' : 'text-red-400'}">E${p.energy ?? 100}</span>
                                <span class="text-[10px] ${(p.morale ?? 50) >= 70 ? 'text-blue-400' : (p.morale ?? 50) >= 40 ? 'text-yellow-400' : 'text-red-400'}">M${p.morale ?? 50}</span>
                            </div>
                            ${p.injuryWeeks > 0 ? `<span class="text-[10px] text-red-400 font-bold">🩹 Injured (${p.injuryWeeks} wks)</span>` : ''}
                            ${p.isSuspended ? `<span class="text-[10px] text-red-400 font-bold">🟥 Suspended</span>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        ${p.seasonGoals > 0 ? `<span class="text-xs font-bold text-[#4caf50]">⚽ ${p.seasonGoals}</span>` : ''}
                        ${p.seasonAssists > 0 ? `<span class="text-xs font-bold text-blue-400">🎯 ${p.seasonAssists}</span>` : ''}
                        <div class="font-bold ${p.rating >= 90 ? 'text-yellow-400' : 'text-slate-500'}">${p.rating}</div>
                    </div>
                </div>
            `;
        }

        // НОВОЕ: Debounce для поиска
        function handleMarketSearchDebounced(event) {
            const value = event.target.value;
            
            // Очищаем предыдущий таймер
            if (STATE.market.debounceTimer) {
                clearTimeout(STATE.market.debounceTimer);
            }
            
            // Устанавливаем новый таймер (250ms debounce)
            STATE.market.debounceTimer = setTimeout(() => {
                STATE.market.search = value;
                STATE.market.page = 1;
                renderDashboard();
            }, 250);
        }

        function handleMarketSearch(event) {
            STATE.market.search = event.target.value;
            STATE.market.page = 1;
            renderDashboard();
        }

        function clearMarketSearch() {
            STATE.market.search = '';
            STATE.market.page = 1;
            renderDashboard();
        }
        
        // НОВОЕ: Функция применения фильтров с debounce
        function applyMarketFilters() {
            STATE.market.page = 1;
            renderDashboard();
        }
        
        // НОВОЕ: Сброс всех фильтров Market
        function resetMarketFilters() {
            STATE.market = {
                posFilter: 'ALL',
                posExact: '',
                sort: 'RATING',
                sortDir: 'DESC',
                search: '',
                ageMin: '',
                ageMax: '',
                ratingMin: '',
                ratingMax: '',
                priceMin: '',
                priceMax: '',
                nation: '',
                page: 1,
                perPage: 50,
                debounceTimer: null,
                showFreeAgents: false // НОВОЕ: сброс переключателя свободных агентов
            };
            renderDashboard();
        }

        // НОВОЕ: Wishlist функции
        function toggleWishlist(internalId) {
            const existingIndex = STATE.wishlist.findIndex(w => w.internalId === internalId);
            
            if (existingIndex !== -1) {
                // Удаляем из wishlist
                STATE.wishlist.splice(existingIndex, 1);
            } else {
                // Добавляем в wishlist
                let player = null;
                let fromClubId = null;
                
                for (const t of STATE.allTeams) {
                    const p = t.squad.find(p => p.internalId === internalId);
                    if (p) {
                        player = p;
                        fromClubId = t.id;
                        break;
                    }
                }
                
                if (!player) {
                    player = STATE.freeAgents.find(p => p.internalId === internalId);
                    if (player) fromClubId = null;
                }
                
                if (player) {
                    STATE.wishlist.push({
                        internalId: player.internalId,
                        name: player.name,
                        pos: player.pos,
                        rating: player.rating,
                        age: player.age,
                        price: player.price,
                        clubId: fromClubId,
                        isFreeAgent: player.isFreeAgent || !fromClubId,
                        addedAt: Date.now()
                    });
                }
            }
            
            renderDashboard();
        }
        
        function removeFromWishlist(internalId) {
            STATE.wishlist = STATE.wishlist.filter(w => w.internalId !== internalId);
            renderDashboard();
        }
        
        function getWishlistPlayers() {
            // Возвращаем актуальные данные игроков из wishlist
            return STATE.wishlist.map(w => {
                // Ищем актуальные данные игрока
                for (const t of STATE.allTeams) {
                    const p = t.squad.find(p => p.internalId === w.internalId);
                    if (p) {
                        return { ...p, clubId: t.id, isFreeAgent: false, inWishlist: true };
                    }
                }
                
                const freeAgent = STATE.freeAgents.find(p => p.internalId === w.internalId);
                if (freeAgent) {
                    return { ...freeAgent, clubId: null, isFreeAgent: true, inWishlist: true };
                }
                
                // Игрок больше не существует (был куплен или ушел)
                return null;
            }).filter(Boolean);
        }


        function changeMarketPage(page) {
            const totalPlayers = getFilteredMarketPlayers().length;
            const totalPages = Math.ceil(totalPlayers / STATE.market.perPage);
            if (page >= 1 && page <= totalPages) {
                STATE.market.page = page;
                renderDashboard();
            }
        }

        function getFilteredMarketPlayers() {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) return [];
            
            let players = [];
            
            // НОВОЕ: Если режим Free Agents, берём из freeAgents
            if (STATE.market.showFreeAgents) {
                players = [...STATE.freeAgents];
            } else {
                // Обычный режим - игроки из других клубов
                for(const t of STATE.allTeams) {
                    if(t.id === userTeam.id) continue;
                    for(const p of t.squad) {
                        players.push(p);
                    }
                }
            }
            
            // Применяем фильтры
            players = players.filter(p => {
                let match = true;
                
                // Фильтр по группе позиций
                if (STATE.market.posFilter !== 'ALL' && STATE.market.posFilter !== 'EXACT') {
                    const group = posGroup(p.pos);
                    if (STATE.market.posFilter === 'GK' && group !== 'GK') match = false;
                    else if (STATE.market.posFilter === 'DEF' && group !== 'DEF') match = false;
                    else if (STATE.market.posFilter === 'MID' && group !== 'MID') match = false;
                    else if (STATE.market.posFilter === 'FWD' && group !== 'FWD') match = false;
                }
                
                // Фильтр по точной позиции
                if (STATE.market.posFilter === 'EXACT' && STATE.market.posExact) {
                    if (p.pos !== STATE.market.posExact) match = false;
                }
                
                // Фильтр по имени
                if (STATE.market.search.trim() !== '') {
                    const searchTerm = STATE.market.search.toLowerCase().trim();
                    const playerName = p.name.toLowerCase();
                    if (!playerName.includes(searchTerm)) {
                        match = false;
                    }
                }
                
                // Возраст мин
                if (STATE.market.ageMin !== '' && !isNaN(Number(STATE.market.ageMin))) {
                    if (p.age < Number(STATE.market.ageMin)) match = false;
                }
                
                // Возраст макс
                if (STATE.market.ageMax !== '' && !isNaN(Number(STATE.market.ageMax))) {
                    if (p.age > Number(STATE.market.ageMax)) match = false;
                }
                
                // Рейтинг мин
                if (STATE.market.ratingMin !== '' && !isNaN(Number(STATE.market.ratingMin))) {
                    if (p.rating < Number(STATE.market.ratingMin)) match = false;
                }
                
                // Рейтинг макс
                if (STATE.market.ratingMax !== '' && !isNaN(Number(STATE.market.ratingMax))) {
                    if (p.rating > Number(STATE.market.ratingMax)) match = false;
                }
                
                // Цена мин (только для обычного режима)
                if (!STATE.market.showFreeAgents && STATE.market.priceMin !== '' && !isNaN(Number(STATE.market.priceMin))) {
                    if (p.price < Number(STATE.market.priceMin)) match = false;
                }
                
                // Цена макс (только для обычного режима)
                if (!STATE.market.showFreeAgents && STATE.market.priceMax !== '' && !isNaN(Number(STATE.market.priceMax))) {
                    if (p.price > Number(STATE.market.priceMax)) match = false;
                }
                
                // Национальность
                if (STATE.market.nation && STATE.market.nation.trim() !== '') {
                    const nationSearch = STATE.market.nation.toLowerCase().trim();
                    const playerNation = (p.nation || '').toLowerCase();
                    if (!playerNation.includes(nationSearch)) match = false;
                }
                
                return match;
            });

            // Сортировка с учётом направления
            const dir = STATE.market.sortDir === 'ASC' ? 1 : -1;
            
            if (STATE.market.sort === 'RATING') {
                players.sort((a,b) => (b.rating - a.rating) * dir);
            } else if (STATE.market.sort === 'PRICE') {
                players.sort((a,b) => (b.price - a.price) * dir);
            } else if (STATE.market.sort === 'AGE') {
                players.sort((a,b) => (a.age - b.age) * dir);
            }
            
            return players;
        }

        function showOfferModal(offer, onComplete) {
            const overlay = document.getElementById('offer-overlay');
            const body = document.getElementById('offer-body');
            const btnAccept = document.getElementById('btn-accept');
            const btnReject = document.getElementById('btn-reject');
            
            overlay.classList.remove('hidden');
            body.innerHTML = `
                <p class="text-slate-300 mb-2">An offer has been received for</p>
                <h4 class="text-xl font-black text-white mb-4">${offer.player.name}</h4>
                <div class="bg-slate-900 rounded-lg p-4 mb-4">
                    <div class="text-sm text-slate-400 uppercase font-bold">Offer From</div>
                    <div class="text-white font-bold mb-3">${offer.buyer.name}</div>
                    <div class="text-sm text-slate-400 uppercase font-bold">Amount</div>
                    <div class="text-2xl text-[#4caf50] font-black">${formatMoney(offer.price)}</div>
                </div>
                <p class="text-xs text-slate-500">Market Value: ${formatMoney(offer.player.price)}</p>
            `;

            btnAccept.onclick = () => {
                transferPlayer(offer.player, getTeam(STATE.userTeamId), offer.buyer, offer.price);
                addNews('Transfer News', `Sold ${offer.player.name} to ${offer.buyer.name} for ${formatMoney(offer.price)}`, 'transfer');
                overlay.classList.add('hidden');
                onComplete();
            };

            btnReject.onclick = () => {
                overlay.classList.add('hidden');
                onComplete();
            };
        }

        function showResultsModal(results, onContinue) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.remove('hidden');

            const userRes = results.find(r => r.homeId === STATE.userTeamId || r.awayId === STATE.userTeamId);
            const others = results.filter(r => r !== userRes);

            let mainHtml = '';
            if (userRes) {
                const h = getTeam(userRes.homeId);
                const a = getTeam(userRes.awayId);
                const s = userRes.stats;
                
                const getScorerHtml = (arr) => arr.map(p => 
                    `<div class="clickable-name hover:text-[#4caf50] text-xs" onclick="openPlayerProfile(${p.internalId})">${p.name} <span class="text-slate-500 text-[10px]">(${p.pos})</span></div>`
                ).join('');

                const redCardsInfo = s.redCardsHome > 0 || s.redCardsAway > 0 ? `
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <div class="flex justify-between text-xs">
                            <span class="${s.redCardsHome > 0 ? 'text-red-400 font-bold' : 'text-slate-500'}">
                                ${s.redCardsHome > 0 ? `🟥 ${s.redCardsHome} red card${s.redCardsHome > 1 ? 's' : ''}` : 'No red cards'}
                            </span>
                            <span class="text-slate-500">Red Cards</span>
                            <span class="${s.redCardsAway > 0 ? 'text-red-400 font-bold' : 'text-slate-500'}">
                                ${s.redCardsAway > 0 ? `🟥 ${s.redCardsAway} red card${s.redCardsAway > 1 ? 's' : ''}` : 'No red cards'}
                            </span>
                        </div>
                    </div>
                ` : '';

                mainHtml = `
                    <div class="bg-slate-900 p-3 border-b border-slate-700">
                        <div class="flex justify-between items-center">
                            <div class="text-center w-1/3">
                                <div class="font-black text-sm text-white leading-none truncate px-1">${h.name}</div>
                            </div>
                            <div class="bg-black border border-slate-700 rounded-lg px-3 py-1 text-xl font-black text-[#4caf50]">
                                ${userRes.homeGoals} - ${userRes.awayGoals}
                            </div>
                            <div class="text-center w-1/3">
                                <div class="font-black text-sm text-white leading-none truncate px-1">${a.name}</div>
                            </div>
                        </div>
                        
                        <!-- Scorers - compact -->
                        <div class="flex justify-between mt-2 text-[10px]">
                            <div class="text-left flex-1 text-slate-400">${s.scorersHome.filter(p => !p.isAssist).map(p => p.name.split(' ').pop() + " " + p.minute + "'").join(', ')}</div>
                            <div class="text-right flex-1 text-slate-400">${s.scorersAway.filter(p => !p.isAssist).map(p => p.name.split(' ').pop() + " " + p.minute + "'").join(', ')}</div>
                        </div>
                        
                        <!-- Stats - very compact -->
                        <div class="grid grid-cols-2 gap-2 mt-2 text-[10px]">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500 w-10">Poss</span>
                                <div class="flex-1 h-1 bg-slate-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-[#4caf50]" style="width:${s.possHome}%"></div>
                                </div>
                                <span class="text-slate-400 w-8">${s.possHome}%</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-slate-400 w-8 text-right">${s.possAway}%</span>
                                <div class="flex-1 h-1 bg-slate-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-slate-600" style="width:${s.possAway}%"></div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500 w-10">Shots</span>
                                <span class="text-slate-400">${s.shotsHome}</span>
                            </div>
                            <div class="flex items-center gap-2 justify-end">
                                <span class="text-slate-400">${s.shotsAway}</span>
                            </div>
                        </div>
                        ${redCardsInfo ? `<div class="mt-2 text-[10px] text-red-400">${s.redCardsHome > 0 ? '🟥' + s.redCardsHome : ''} ${s.redCardsAway > 0 ? '🟥' + s.redCardsAway : ''}</div>` : ''}
                    </div>
                `;
            }

            content.innerHTML = `
                ${mainHtml}
                <div class="flex-grow overflow-y-auto bg-slate-800 p-4 space-y-1">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Other Results</h4>
                    ${others.map(r => {
                        const h = getTeam(r.homeId);
                        const a = getTeam(r.awayId);
                        return `
                            <div class="flex justify-between text-xs md:text-sm py-2 border-b border-slate-700/50 last:border-0">
                                <span class="text-right w-5/12 truncate text-slate-300">${h.name}</span>
                                <span class="text-center font-bold text-white bg-slate-700 px-2 rounded">${r.homeGoals}-${r.awayGoals}</span>
                                <span class="text-left w-5/12 truncate text-slate-300">${a.name}</span>
                            </div>
                        `
                    }).join('')}
                </div>
                <div class="p-4 bg-slate-900 border-t border-slate-700">
                    <button id="modal-continue-btn" class="w-full bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 rounded-lg uppercase tracking-wider">Continue</button>
                </div>
            `;

            document.getElementById('modal-continue-btn').onclick = () => {
                document.getElementById('modal-overlay').classList.add('hidden');
                if (onContinue) onContinue();
            };
        }

        // FEATURE #7: Show play options modal instead of directly playing
        document.addEventListener('click', function(event) {
            const playWeekBtn = event.target.closest('#playWeekBtn');
            if (playWeekBtn) {
                event.preventDefault();
                event.stopPropagation();
                
                const isFinished = STATE.calendar.currentWeek >= STATE.calendar.weeks.length;
                if (isFinished) {
                    endSeason();
                    return;
                }
                
                const userTeam = getTeam(STATE.userTeamId);
                if (userTeam) {
                    const validation = validateStartingXI(userTeam);
                    if (!validation.valid) {
                        alert(validation.message);
                        return;
                    }
                }
                
                // Show play options modal
                showPlayOptionsModal();
            }
        });
        
        // ========== PLAY OPTIONS MODAL FUNCTIONS ==========
        function showPlayOptionsModal() {
            const overlay = document.getElementById('play-options-overlay');
            const matchInfo = document.getElementById('play-options-match-info');
            const homeSquadDiv = document.getElementById('play-options-home-squad');
            const awaySquadDiv = document.getElementById('play-options-away-squad');
            const homeLogoDiv = document.getElementById('play-options-home-logo');
            const awayLogoDiv = document.getElementById('play-options-away-logo');
            const homeNameDiv = document.getElementById('play-options-home-name');
            const awayNameDiv = document.getElementById('play-options-away-name');
            
            const currentWeek = STATE.calendar.weeks[STATE.calendar.currentWeek];
            if (!currentWeek) {
                playWeek();
                return;
            }
            
            let matchInfoHtml = '<div class="text-slate-400 text-sm">Week ' + (STATE.calendar.currentWeek + 1) + '</div>';
            let homeTeam = null, awayTeam = null;
            
            for (const event of currentWeek.events) {
                if (event.type === 'LEAGUE') {
                    const weekMatches = STATE.schedule[event.matchday];
                    const userMatch = weekMatches?.find(m => m.home === STATE.userTeamId || m.away === STATE.userTeamId);
                    if (userMatch) {
                        homeTeam = getTeam(userMatch.home);
                        awayTeam = getTeam(userMatch.away);
                        matchInfoHtml = `<div class="flex flex-col items-center justify-center gap-3"><div class="text-center">${renderTeamLogo(homeTeam, 'md')}<div class="text-white font-bold text-sm mt-2">${homeTeam?.name || 'Home'}</div></div><div class="text-slate-500 font-bold text-lg">VS</div><div class="text-center">${renderTeamLogo(awayTeam, 'md')}<div class="text-white font-bold text-sm mt-2">${awayTeam?.name || 'Away'}</div></div><div class="text-slate-500 text-xs mt-2">Week ${STATE.calendar.currentWeek + 1}</div></div>`;
                        break;
                    }
                } else if (event.type === 'CUP') {
                    matchInfoHtml = `<div class="text-purple-400 font-bold text-sm">League Cup</div>`;
                    break;
                } else if (event.type === 'EURO') {
                    const compName = EURO_COMP_NAMES[event.cup] || 'European Cup';
                    matchInfoHtml = `<div class="text-blue-400 font-bold text-sm">${compName}</div>`;
                    break;
                }
            }
            
            matchInfo.innerHTML = matchInfoHtml;
            
            if (homeTeam && awayTeam) {
                homeLogoDiv.innerHTML = renderTeamLogo(homeTeam, 'md');
                awayLogoDiv.innerHTML = renderTeamLogo(awayTeam, 'md');
                homeNameDiv.textContent = homeTeam.name;
                awayNameDiv.textContent = awayTeam.name;
                
                const renderSquadList = (team) => {
                    const sortedSquad = [...team.squad].sort((a, b) => b.rating - a.rating);
                    let html = '<div class="grid grid-cols-1 gap-2">';
                    sortedSquad.forEach(p => {
                        const ratingClass = getRatingBg(p.rating);
                        const posClass = getPosColor(p.pos).split(' ')[0];
                        html += `<div class="flex items-center justify-between p-2 rounded bg-slate-800/40 hover:bg-slate-700/50 cursor-pointer transition-all text-sm"><div class="flex items-center gap-2 min-w-0"><span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 ${ratingClass}">${p.rating}</span><div class="min-w-0"><div class="font-bold text-slate-200 truncate">${p.name}</div><div class="text-xs ${posClass}">${p.pos}</div></div></div></div>`;
                    });
                    html += '</div>';
                    return html;
                };
                homeSquadDiv.innerHTML = renderSquadList(homeTeam);
                awaySquadDiv.innerHTML = renderSquadList(awayTeam);
            }
            
            overlay.classList.remove('hidden');
        }
        
        function closePlayOptions() {
            document.getElementById('play-options-overlay').classList.add('hidden');
        }
        
        function skipMatch() {
            closePlayOptions();
            // Flag that we are skipping so 2D doesn't trigger playWeek again
            if (simState) simState.alreadySkipped = true; 
            playWeek();
        }
        
        // ========== 2D MATCH SIMULATION ENGINE ==========
        let simState = null;
        let simAnimationId = null;
        let simSpeed = 1;
        let simPaused = false;
        
        function startSimulateMatch() {
            closePlayOptions();
            
            // Get the match to simulate
            const currentWeek = STATE.calendar.weeks[STATE.calendar.currentWeek];
            if (!currentWeek) return;
            
            let homeId = null, awayId = null;
            
            for (const event of currentWeek.events) {
                if (event.type === 'LEAGUE' && !event.played) {
                    const weekMatches = STATE.schedule[event.matchday];
                    const userMatch = weekMatches?.find(m => m.home === STATE.userTeamId || m.away === STATE.userTeamId);
                    if (userMatch) {
                        homeId = userMatch.home;
                        awayId = userMatch.away;
                        break;
                    }
                } else if (event.type === 'CUP' && !event.played) {
                    // Find cup match
                    const cup = STATE.cups.leagueCup;
                    if (cup) {
                        const round = cup.rounds.find(r => !r.played);
                        if (round) {
                            const fixture = round.fixtures.find(f => f.homeId === STATE.userTeamId || f.awayId === STATE.userTeamId);
                            if (fixture) {
                                homeId = fixture.homeId;
                                awayId = fixture.awayId;
                                break;
                            }
                        }
                    }
                }
            }
            
            if (!homeId || !awayId) {
                // No user match found, just skip
                playWeek();
                return;
            }
            
            initSimulation(homeId, awayId);
        }
        
        function initSimulation(homeId, awayId) {
            const homeTeam = getTeam(homeId);
            const awayTeam = getTeam(awayId);
            
            if (!homeTeam || !awayTeam) {
                playWeek();
                return;
            }
            
            // Show simulation overlay
            document.getElementById('match-simulation-overlay').classList.remove('hidden');
            
            // Set team info
            document.getElementById('sim-home-name').textContent = homeTeam.name;
            document.getElementById('sim-away-name').textContent = awayTeam.name;
            document.getElementById('sim-home-logo').innerHTML = renderTeamLogo(homeTeam, 'sm');
            document.getElementById('sim-away-logo').innerHTML = renderTeamLogo(awayTeam, 'sm');
            document.getElementById('sim-score').textContent = '0 - 0';
            document.getElementById('sim-timer').textContent = '0:00';
            document.getElementById('sim-events-feed').innerHTML = '';
            
            // Initialize simulation state
            const canvas = document.getElementById('match-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size with internal high resolution for crisp rendering
            const container = canvas.parentElement;
            // Use a fixed internal resolution for consistent physics, CSS will scale it
            canvas.width = 1200;
            canvas.height = 800;
            
            // Pre-calculate match result
            const matchResult = simulateMatch(homeId, awayId);
            
            // Initialize 2D simulation state
            simState = {
                canvas, ctx,
                width: canvas.width,
                height: canvas.height,
                homeTeam, awayTeam,
                homeId, awayId,
                matchResult,
                homeScore: 0,
                awayScore: 0,
                matchTime: 0, // 0 to 90 minutes
                realTime: 0,
                ball: {
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: 0,
                    vy: 0,
                    radius: 8,
                    owner: null,
                    lastTouch: null
                },
                homePlayers: createTeamPlayers(homeTeam, true, canvas),
                awayPlayers: createTeamPlayers(awayTeam, false, canvas),
                events: [],
                pendingGoals: [...matchResult.stats.scorersHome.filter(s => !s.isAssist).map(s => ({...s, team: 'home'})),
                              ...matchResult.stats.scorersAway.filter(s => !s.isAssist).map(s => ({...s, team: 'away'}))].sort((a, b) => a.minute - b.minute),
                lastGoalCheck: 0,
                lastUpdate: performance.now()
            };
            
            simSpeed = 1;
            simPaused = false;
            updateSpeedButtons();
            
            // Set initial possession (Kickoff)
            const kickoffTeam = Math.random() < 0.5 ? simState.homePlayers : simState.awayPlayers;
            const striker = kickoffTeam.find(p => p.role === 'ST') || kickoffTeam[9];
            simState.ball.owner = striker;
            simState.ball.lastTouch = striker;

            // Start animation loop
            simAnimationId = requestAnimationFrame(updateSimulation);
        }
        
        function createTeamPlayers(team, isHome, canvas) {
            const players = [];
            // Try to use the user's specific lineup slots if it's the user team
            let starters = [];
            if (team.id === STATE.userTeamId) {
                STATE.userLineupSlots.forEach(id => {
                    if (id) {
                        const p = team.squad.find(pl => pl.internalId === id);
                        if (p) starters.push(p);
                    }
                });
            }
            
            // Fallback or for AI teams
            if (starters.length < 11) {
                const existingIds = starters.map(s => s.internalId);
                const extra = team.squad.filter(p => p.isStarter && !existingIds.includes(p.internalId)).slice(0, 11 - starters.length);
                starters = [...starters, ...extra];
            }
            
            // Final fallback to any players
            if (starters.length < 11) {
                const existingIds = starters.map(s => s.internalId);
                const extra = team.squad.filter(p => !existingIds.includes(p.internalId)).slice(0, 11 - starters.length);
                starters = [...starters, ...extra];
            }

            // 4-3-3 Position Map (Normalized 0-1)
            const formationMap = [
                { pos: 'GK', x: 0.05, y: 0.5 },
                { pos: 'LB', x: 0.25, y: 0.15 }, { pos: 'CB', x: 0.2, y: 0.38 }, { pos: 'CB', x: 0.2, y: 0.62 }, { pos: 'RB', x: 0.25, y: 0.85 },
                { pos: 'CM', x: 0.45, y: 0.25 }, { pos: 'CDM', x: 0.4, y: 0.5 }, { pos: 'CM', x: 0.45, y: 0.75 },
                { pos: 'LW', x: 0.75, y: 0.2 }, { pos: 'ST', x: 0.8, y: 0.5 }, { pos: 'RW', x: 0.75, y: 0.8 }
            ];

            const teamColor = team.color || (isHome ? '#3b82f6' : '#ef4444');

            for (let i = 0; i < 11; i++) {
                const pData = starters[i] || { name: 'Player', rating: 60 };
                const fPos = formationMap[i];
                
                // Mirror X for away team
                const startX = isHome ? fPos.x : (1 - fPos.x);
                const startY = fPos.y;

                players.push({
                    id: pData.internalId || Math.random(),
                    name: pData.name.split(' ').pop(),
                    teamName: team.name,
                    rating: pData.rating || 70,
                    isGK: i === 0,
                    isHome: isHome,
                    color: teamColor,
                    radius: 9, // Slightly smaller for better scale
                    x: startX * canvas.width,
                    y: startY * canvas.height,
                    baseX: startX * canvas.width,
                    baseY: startY * canvas.height,
                    vx: 0, vy: 0,
                    // УЛУЧШЕНО: Более быстрое и динамичное движение игроков
                    speed: 2.2 + (pData.rating / 45),
                    stamina: 100,
                    role: fPos.pos
                });
            }
            return players;
        }
        
        // Helper: Distance from point p to line segment v-w
        function distToSegment(p, v, w) {
            const l2 = (v.x - w.x)**2 + (v.y - w.y)**2;
            if (l2 === 0) return Math.sqrt((p.x - v.x)**2 + (p.y - v.y)**2);
            let t = ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2;
            t = Math.max(0, Math.min(1, t));
            return Math.sqrt((p.x - (v.x + t * (w.x - v.x)))**2 + (p.y - (v.y + t * (w.y - v.y)))**2);
        }

        function updateSimulation(timestamp) {
            if (!simState || simPaused) {
                if (simState) simAnimationId = requestAnimationFrame(updateSimulation);
                return;
            }
            
            // УЛУЧШЕНО: Более динамичный темп 2D симуляции
            let tempoMult = simState.isSetPieceAnimation ? 0.15 : 0.85;
            const deltaTime = (timestamp - simState.lastUpdate) / 1000 * simSpeed * tempoMult;
            simState.lastUpdate = timestamp;
            simState.realTime += deltaTime;
            
            // Match clock: ~90 mins in ~50-60 seconds (более быстрый темп)
            simState.matchTime = Math.min(90, simState.realTime * 1.5);
            
            // Update timer display
            const mins = Math.floor(simState.matchTime);
            const secs = Math.floor((simState.matchTime % 1) * 60);
            document.getElementById('sim-timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            // Check for set piece animation
            if (simState.isSetPieceAnimation) {
                // Use a constant time step for the timer to avoid issues with lastUpdate
                simState.setPieceTimer -= 0.016 * simSpeed; // ~60fps
                if (simState.setPieceTimer <= 0) {
                    simState.isSetPieceAnimation = false;
                }
            }

            // Check for pending goals
            if (!simState.isGoalAnimation) {
                while (simState.pendingGoals.length > 0 && simState.pendingGoals[0].minute <= simState.matchTime) {
                    const goal = simState.pendingGoals.shift();
                    simState.isGoalAnimation = true;
                    simState.goalTimer = 1.0; // УЛУЧШЕНО: ещё короче для динамики
                    
                    if (goal.team === 'home') {
                        simState.homeScore++;
                        simState.lastScorerTeam = 'home';
                    } else {
                        simState.awayScore++;
                        simState.lastScorerTeam = 'away';
                    }
                    
                    document.getElementById('sim-score').textContent = `${simState.homeScore} - ${simState.awayScore}`;
                    addSimEvent(`⚽ GOAL! ${goal.name} (${goal.minute}')`);
                    
                    // Ball to center
                    simState.ball.x = simState.width / 2;
                    simState.ball.y = simState.height / 2;
                    simState.ball.vx = 0; simState.ball.vy = 0;
                    simState.ball.owner = null;
                }
            } else {
                simState.goalTimer -= deltaTime;
                if (simState.goalTimer <= 0) {
                    simState.isGoalAnimation = false;
                    // Kickoff for the team that conceded
                    const concedingTeam = simState.lastScorerTeam === 'home' ? simState.awayPlayers : simState.homePlayers;
                    const striker = concedingTeam.find(p => p.role === 'ST') || concedingTeam[9];
                    simState.ball.owner = striker;
                }
            }
            
            // Update physics
            updatePhysics(deltaTime);
            
            // Render
            renderSimulation();
            
            // Check if match ended
            if (simState.matchTime >= 90) {
                endSimulation();
                return;
            }
            
            simAnimationId = requestAnimationFrame(updateSimulation);
        }
        
        function updatePhysics(deltaTime) {
            if (simState.isGoalAnimation) return;

            const ball = simState.ball;
            const homePlayers = simState.homePlayers;
            const awayPlayers = simState.awayPlayers;
            const allPlayers = [...homePlayers, ...awayPlayers];
            
            // IMPROVED: More realistic ball physics with speed-dependent friction
            const ballSpeed = Math.sqrt(ball.vx * ball.vx + ball.vy * ball.vy);
            
            // Apply velocity with smoother movement
            ball.x += ball.vx * (1 + deltaTime * 0.5);
            ball.y += ball.vy * (1 + deltaTime * 0.5);
            
            // Dynamic friction - faster balls slow down more gradually
            const friction = ballSpeed > 15 ? 0.96 : (ballSpeed > 8 ? 0.94 : 0.91);
            ball.vx *= friction; 
            ball.vy *= friction;
            
            // Stop ball completely if moving very slowly
            if (ballSpeed < 0.5 && !ball.owner) {
                ball.vx = 0;
                ball.vy = 0;
            }
            
            // Ball boundary & set piece detection
            const m = 30;
            const goalTop = simState.height / 2 - 45;
            const goalBottom = simState.height / 2 + 45;
            
            // Check for out of bounds and set pieces
            if (ball.x < m - 2 || ball.x > simState.width - m + 2) {
                // Ball went out on sidelines - check if it's a goal or corner/throw
                if (ball.y >= goalTop && ball.y <= goalBottom) {
                    // Goal detected - let the goal animation handle it
                } else {
                    // Corner kick / Goal kick detection
                    const lastTouch = ball.owner || ball.lastTouch;
                    if (lastTouch) {
                        const isHomeTouch = lastTouch.isHome;
                        const isLeftSide = ball.x < simState.width / 2;
                        
                        // Set piece animation trigger
                        simState.isSetPieceAnimation = true;
                        simState.setPieceTimer = 2.0;

                        if ((isHomeTouch && isLeftSide) || (!isHomeTouch && !isLeftSide)) {
                            // Defending team touched it last - attacking corner
                            takeCorner(!isHomeTouch, ball.y < simState.height / 2);
                            const cornerTeam = isHomeTouch ? awayPlayers[0].teamName : homePlayers[0].teamName;
                            addSimEvent(`🚩 Corner for ${cornerTeam}! A chance to cross...`);
                        } else {
                            // Attacking team touched it last - goal kick
                            takeGoalKick(isLeftSide);
                            const goalKickTeam = isLeftSide ? homePlayers[0].teamName : awayPlayers[0].teamName;
                            addSimEvent(`🥅 Goal kick for ${goalKickTeam}. Building from the back.`);
                        }
                    }
                }
            }
            
            if (ball.y < m || ball.y > simState.height - m) {
                // Throw-in
                const lastTouch = ball.owner || ball.lastTouch;
                if (lastTouch) {
                    simState.isSetPieceAnimation = true;
                    simState.setPieceTimer = 1.5;
                    takeThrowIn(ball.x, ball.y < simState.height / 2, !lastTouch.isHome);
                    const throwTeam = lastTouch.isHome ? awayPlayers[0].teamName : homePlayers[0].teamName;
                    addSimEvent(`👐 Throw-in for ${throwTeam}.`);
                }
            }
            
            ball.x = Math.max(m, Math.min(simState.width - m, ball.x));
            ball.y = Math.max(m, Math.min(simState.height - m, ball.y));
            
            let ownerTeam = ball.owner ? (ball.owner.isHome ? 'home' : 'away') : null;
            
            // Find closest players
            const getClosest = (players) => {
                let best = null, minDist = Infinity;
                players.forEach(p => {
                    const d = Math.sqrt((ball.x-p.x)**2 + (ball.y-p.y)**2);
                    if (d < minDist) { minDist = d; best = p; }
                });
                return best;
            };
            const closestHome = getClosest(homePlayers);
            const closestAway = getClosest(awayPlayers);
            
                allPlayers.forEach(player => {
                    const teammates = player.isHome ? homePlayers : awayPlayers;
                    const opponents = player.isHome ? awayPlayers : homePlayers;
                    const attackingGoalX = player.isHome ? simState.width - m : m;
                    const defendingGoalX = player.isHome ? m : simState.width - m;
                    const isClosest = (player.isHome ? closestHome : closestAway) === player;
                    const ballDist = Math.sqrt((ball.x-player.x)**2 + (ball.y-player.y)**2);
                    const ratingFactor = player.rating / 100;
                    const vision = 0.3 + (ratingFactor * 0.6);
                    
                    let targetX = player.baseX, targetY = player.baseY;
                    let speedMult = 0.7;

                    // 1. ADVANCED POSITIONING ENGINE
                    if (player.isGK) {
                        // IMPROVED: Smarter goalkeeper positioning
                        const ballSpeed = Math.sqrt(ball.vx * ball.vx + ball.vy * ball.vy);
                        const isShotcoming = ballSpeed > 10 && 
                            ((player.isHome && ball.vx < -5) || (!player.isHome && ball.vx > 5));
                        
                        if (isShotcoming) {
                            // React to shot - move towards predicted ball position
                            const predictedY = ball.y + ball.vy * 8;
                            targetX = defendingGoalX + (player.isHome ? 20 : -20);
                            targetY = Math.max(simState.height * 0.3, Math.min(simState.height * 0.7, predictedY));
                            speedMult = 1.3 + (ratingFactor * 0.3); // GK rating affects reaction speed
                        } else {
                            // Normal positioning - track ball but stay near goal
                            const ballDistToGoal = Math.abs(ball.x - defendingGoalX);
                            const comeOutDist = Math.min(80, ballDistToGoal * 0.15);
                            targetX = defendingGoalX + (player.isHome ? comeOutDist : -comeOutDist);
                            targetY = (simState.height / 2 + ball.y) / 2;
                            targetY = Math.max(simState.height * 0.35, Math.min(simState.height * 0.65, targetY));
                            speedMult = 0.85;
                        }
                    } else if (ball.owner === player) {
                        // BALL CARRIER: Strategic Dribbling
                        const distToGoal = Math.abs(attackingGoalX - player.x);
                        targetX = attackingGoalX;
                        targetY = player.y + (Math.random() - 0.5) * 60; // Natural weaving
                        speedMult = 0.95 + (ratingFactor * 0.2);
                        
                        if (player.possessionTime === undefined) player.possessionTime = 0;
                        player.possessionTime += deltaTime;

                        // IMPROVED TACTICAL DECISION ENGINE - ГАРАНТИРОВАННЫЙ УДАР
                        // Если игрок очень близко к воротам (< 250), всегда бьём
                        const mustShoot = distToGoal < 250;
                        const shootChance = mustShoot ? 1.0 : (distToGoal < 350) ? (0.95 + vision * 0.05) : (distToGoal < 550 ? 0.60 : 0.20);
                        const passChance = (distToGoal > 250) ? (0.55 + vision * 0.35) : 0.2;
                        const forceDecision = player.possessionTime > (0.35 + vision * 0.3);

                        // Wing play: wingers sometimes cross instead of always forcing a dribble/shot/pass
                        const isWinger = player.role === 'LW' || player.role === 'RW';
                        const isWide = player.y < simState.height * 0.22 || player.y > simState.height * 0.78;
                        const crossChance = isWinger && isWide && distToGoal < 420 && !mustShoot ? (0.22 + vision * 0.25) : 0;

                        // ГЛАВНОЕ ИЗМЕНЕНИЕ: Сначала проверяем mustShoot или shootChance!
                        if (mustShoot || Math.random() < shootChance || (forceDecision && distToGoal < 350)) {
                            // EXECUTE SHOT - ГАРАНТИРОВАННЫЙ УДАР КОГДА БЛИЗКО
                            const mistakeChance = mustShoot ? 0.02 : (0.06 - (ratingFactor * 0.05));
                            let shotTargetY = simState.height/2 + (Math.random() - 0.5) * 100;
                            if (Math.random() < mistakeChance) {
                                shotTargetY += (Math.random() - 0.5) * 350;
                                addSimEvent(`🔫 ${player.name} takes a shot... it flies wide!`);
                            } else {
                                const shotType = mustShoot ? 'powerful close-range' : (distToGoal < 200 ? 'close-range' : 'long-range');
                                addSimEvent(`🔫 ${player.name} unleashes a ${shotType} shot!`);
                            }
                            const dx = attackingGoalX - ball.x, dy = shotTargetY - ball.y;
                            const d = Math.sqrt(dx*dx + dy*dy);
                            const power = mustShoot ? (22 + ratingFactor * 12) : (18 + (ratingFactor * 14));
                            ball.vx = (dx/d) * power; ball.vy = (dy/d) * power;
                            ball.owner = null; ball.lastTouch = player; player.possessionTime = 0;
                        } else if (Math.random() < crossChance) {
                            const targets = teammates
                                .filter(t => t !== player && !t.isGK)
                                .map(t => {
                                    const inBox = Math.abs(attackingGoalX - t.x) < 260;
                                    const central = Math.abs(t.y - simState.height / 2) < 180;
                                    const score = (inBox ? 120 : 0) + (central ? 40 : 0) + (t.role === 'ST' ? 80 : 0) + (t.rating / 2) + Math.random() * 40;
                                    return { player: t, score };
                                })
                                .sort((a, b) => b.score - a.score);

                            const target = targets[0]?.player;
                            if (target) {
                                addSimEvent(`🪽 ${player.name} whips in a cross towards ${target.name}!`);
                                const dx = target.x - ball.x, dy = target.y - ball.y;
                                const d = Math.sqrt(dx*dx + dy*dy) || 1;
                                const crossSpeed = 16 + (ratingFactor * 10);
                                ball.vx = (dx/d) * crossSpeed;
                                ball.vy = (dy/d) * crossSpeed;
                                ball.owner = null; ball.lastTouch = player; player.possessionTime = -0.5;
                            }
                        } else if (Math.random() < passChance || forceDecision) {
                            // EXECUTE STRATEGIC PASS - improved pass selection
                            const options = teammates.filter(t => t !== player && !t.isGK).map(t => {
                                const distToGoalT = Math.abs(attackingGoalX - t.x);
                                const progress = (Math.abs(attackingGoalX - player.x) - distToGoalT);
                                const distToMe = Math.sqrt((t.x-player.x)**2 + (t.y-player.y)**2);
                                
                                // IMPROVED Lane quality check
                                let laneClearance = 100;
                                opponents.forEach(opp => {
                                    const dToLane = distToSegment({x:opp.x, y:opp.y}, {x:player.x, y:player.y}, {x:t.x, y:t.y});
                                    if (dToLane < 60) laneClearance -= (60 - dToLane) * 2.5;
                                });
                                
                                // Bonus for players in space and ahead
                                const spaceBonus = isPlayerInSpace(t, opponents) ? 50 : 0;
                                
                                return { player: t, score: progress * 7 + laneClearance + (350 - distToMe) * 0.15 + spaceBonus + Math.random() * 60 };
                            }).sort((a, b) => b.score - a.score);

                            if (options.length > 0 && options[0].score > 40) {
                                const target = options[0].player;
                                const passType = Math.random() < 0.3 ? 'through ball' : 'crisp pass';
                                addSimEvent(`⚽ ${player.name} plays a ${passType} to ${target.name}`);
                                const dx = target.x - ball.x, dy = target.y - ball.y;
                                const d = Math.sqrt(dx*dx + dy*dy);
                                const passSpeed = 14 + (ratingFactor * 10);
                                ball.vx = (dx/d) * passSpeed; ball.vy = (dy/d) * passSpeed;
                                ball.owner = null; ball.lastTouch = player; player.possessionTime = -0.7;
                            }
                        }
                    } else {
                        // OFF-BALL MOVEMENT ENGINE
                        const isAttacking = ball.owner && ball.owner.isHome === player.isHome;
                        const isDefending = ball.owner && ball.owner.isHome !== player.isHome;

                        if (isAttacking) {
                            // IMPROVED: Intelligent off-ball movement
                            const distToBall = Math.sqrt((ball.x-player.x)**2 + (ball.y-player.y)**2);
                            const aheadOfBall = player.isHome ? (player.x > ball.x) : (player.x < ball.x);
                            const isStriker = player.role === 'ST';
                            const isWinger = player.role === 'LW' || player.role === 'RW';
                            const distToGoal = Math.abs(attackingGoalX - player.x);
                            
                            if (isStriker) {
                                // Striker makes runs into box, stays central
                                if (distToGoal > 200) {
                                    targetX = attackingGoalX - (player.isHome ? 150 : -150);
                                    targetY = simState.height / 2 + (Math.random() - 0.5) * 120;
                                    speedMult = 1.0;
                                } else {
                                    // In the box - find space
                                    targetX = player.x + (player.isHome ? 30 : -30);
                                    targetY = simState.height / 2 + (Math.sin(simState.matchTime * 0.5) * 80);
                                    speedMult = 0.9;
                                }
                            } else if (isWinger) {
                                // Wingers stretch play wide and make overlapping runs
                                const isLeftWing = player.role === 'LW';
                                targetX = Math.max(ball.x, player.isHome ? simState.width * 0.6 : simState.width * 0.4);
                                targetY = isLeftWing ? simState.height * 0.15 : simState.height * 0.85;
                                speedMult = 0.95;
                            } else if (aheadOfBall && distToBall < 350) {
                                // Move into space ahead
                                targetX = player.x + (player.isHome ? 50 : -50);
                                targetY = player.y + (Math.random() - 0.5) * 80;
                                speedMult = 0.85;
                            } else {
                                // Support from behind/side - create passing option
                                targetX = ball.x + (player.isHome ? -70 : 70);
                                targetY = ball.y + (player.y > ball.y ? 50 : -50);
                                speedMult = 0.75;
                            }
                        } else if (isDefending) {
                            // IMPROVED: Tactical Defending with role awareness
                            const distToBall = Math.sqrt((ball.x-player.x)**2 + (ball.y-player.y)**2);
                            const ballCarrier = ball.owner;
                            const isDefender = player.role === 'CB' || player.role === 'LB' || player.role === 'RB';
                            const isMidfielder = player.role === 'CM' || player.role === 'CDM';
                            
                            // Calculate threat level - how dangerous is the attack?
                            const ballDistToGoal = Math.abs(ball.x - defendingGoalX);
                            const threatLevel = ballDistToGoal < 300 ? 'high' : (ballDistToGoal < 500 ? 'medium' : 'low');
                            
                            if (isClosest && distToBall < 180) {
                                // Press the ball carrier aggressively
                                targetX = ball.x; 
                                targetY = ball.y; 
                                speedMult = 1.2 + (ratingFactor * 0.2);
                            } else if (isDefender && threatLevel === 'high') {
                                // Defenders drop deep and stay compact in danger zone
                                targetX = defendingGoalX + (player.isHome ? 100 : -100);
                                targetY = player.baseY + (ball.y - simState.height/2) * 0.4;
                                speedMult = 1.0;
                            } else if (isMidfielder && threatLevel !== 'low') {
                                // Midfielders track back and cut passing lanes
                                const interceptX = (ball.x + defendingGoalX) / 2;
                                targetX = interceptX;
                                targetY = ball.y + (player.baseY - simState.height/2) * 0.3;
                                speedMult = 0.95;
                            } else {
                                // Zonal Marking & Lane Blocking
                                const goalMidX = defendingGoalX;
                                const goalMidY = simState.height / 2;
                                targetX = (ball.x + goalMidX) / 2 + (player.baseX - simState.width/2) * 0.2;
                                targetY = (ball.y + goalMidY) / 2 + (player.baseY - simState.height/2) * 0.2;
                                speedMult = 0.8;
                            }
                        } else {
                            // Loose Ball Scramble
                            if (isClosest) {
                                targetX = ball.x; targetY = ball.y; speedMult = 1.1;
                            } else {
                                targetX = player.baseX + (ball.x - simState.width/2) * 0.3;
                                targetY = player.baseY + (ball.y - simState.height/2) * 0.3;
                                speedMult = 0.65;
                            }
                        }
                    }

                    // Natural Wandering & Boundary Constraints
                    if (!player.wanderAngle) player.wanderAngle = Math.random() * Math.PI * 2;
                    player.wanderAngle += (Math.random() - 0.5) * 0.25;
                    targetX += Math.cos(player.wanderAngle) * 15;
                    targetY += Math.sin(player.wanderAngle) * 15;
                    
                    targetX = Math.max(40, Math.min(simState.width - 40, targetX));
                    targetY = Math.max(30, Math.min(simState.height - 30, targetY));

                // Apply movement
                const dx = targetX - player.x, dy = targetY - player.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist > 5) {
                    const s = player.speed * speedMult;
                    player.vx += ( (dx/dist)*s - player.vx ) * 0.1;
                    player.vy += ( (dy/dist)*s - player.vy ) * 0.1;
                } else {
                    player.vx *= 0.9; player.vy *= 0.9;
                }
                player.x += player.vx; player.y += player.vy;

                // Improved Ball capture & Tackle logic
                if (player.possessionTime < 0) player.possessionTime += deltaTime;
                if (!ball.owner && ballDist < player.radius + 12 && (player.possessionTime === undefined || player.possessionTime >= 0)) {
                    // Check for offside before giving possession
                    if (checkOffside(player)) {
                        addSimEvent(`🚩 OFFSIDE! ${player.name} caught offside!`);
                        takeFreeKick(!player.isHome, ball.x, ball.y);
                    } else {
                        ball.owner = player;
                        ball.lastTouch = player;
                        ball.vx = 0; ball.vy = 0;
                        player.possessionTime = 0;
                    }
                } else if (ball.owner && ball.owner.isHome !== player.isHome && ballDist < 22) {
                    // IMPROVED: Tackling with foul possibility
                    const tackleProb = 0.06 + (ratingFactor * 0.05);
                    const foulProb = 0.02 + (1 - ratingFactor) * 0.03; // Lower rated players foul more
                    
                    if (Math.random() < tackleProb) { 
                        ball.owner = player;
                        ball.lastTouch = player;
                        player.possessionTime = 0;
                        addSimEvent(`💪 ${player.name} wins the ball with a clean tackle!`);
                    } else if (Math.random() < foulProb) {
                        // FOUL committed
                        simState.isSetPieceAnimation = true;
                        simState.setPieceTimer = 2.0;
                        const fouledPlayer = ball.owner;
                        addSimEvent(`⚠️ FOUL! ${player.name} brings down ${fouledPlayer.name}`);
                        takeFreeKick(fouledPlayer.isHome, ball.x, ball.y);
                    }
                }

                // Dynamic Dribble positioning
                if (ball.owner === player) {
                    // Ball follows player with natural "dribble" offset
                    const moveDirX = player.vx || (player.isHome ? 1 : -1);
                    const moveDirY = player.vy || 0;
                    const moveDist = Math.sqrt(moveDirX*moveDirX + moveDirY*moveDirY) || 1;
                    
                    const offset = 14;
                    ball.x = player.x + (moveDirX/moveDist) * offset;
                    ball.y = player.y + (moveDirY/moveDist) * offset;
                }
            });
        }
        
        // Offside detection function
        function checkOffside(player) {
            if (!simState || !player || player.isGK) return false;
            
            const ball = simState.ball;
            const isHome = player.isHome;
            const attackingGoalX = isHome ? simState.width - 30 : 30;
            const defenders = isHome ? simState.awayPlayers : simState.homePlayers;
            
            // Player is only offside if they're in the attacking half
            const isInAttackingHalf = isHome ? player.x > simState.width / 2 : player.x < simState.width / 2;
            if (!isInAttackingHalf) return false;
            
            // Find second-to-last defender position (including GK)
            const defenderPositions = defenders.map(d => isHome ? d.x : simState.width - d.x).sort((a, b) => b - a); // Sort descending (closest to goal first)
            
            // The offside line is the second-to-last opponent (usually the last outfield defender if GK is deepest)
            const offsideLine = defenderPositions.length >= 2 ? defenderPositions[1] : defenderPositions[0];
            
            const playerPos = isHome ? player.x : simState.width - player.x;
            const ballPos = isHome ? ball.x : simState.width - ball.x;
            
            // Offside if player is ahead of both ball and second-to-last defender
            // Using a small buffer to avoid "flickering" offsides
            return playerPos > offsideLine + 2 && playerPos > ballPos + 5;
        }
        
        // Helper function to check if player is in space
        function isPlayerInSpace(player, opponents) {
            let nearbyOpponents = 0;
            opponents.forEach(opp => {
                const dist = Math.sqrt((player.x - opp.x)**2 + (player.y - opp.y)**2);
                if (dist < 80) nearbyOpponents++;
            });
            return nearbyOpponents <= 1;
        }
        
        // IMPROVED: Set piece functions with better AI
        function takeCorner(isHomeTeam, isTopCorner) {
            if (!simState) return;
            const m = 30;
            const x = isHomeTeam ? simState.width - m : m;
            const y = isTopCorner ? m : simState.height - m;
            
            simState.ball.x = x;
            simState.ball.y = y;
            simState.ball.vx = 0;
            simState.ball.vy = 0;
            
            // Find best corner taker (midfielder with highest rating)
            const teamPlayers = isHomeTeam ? simState.homePlayers : simState.awayPlayers;
            const midfielders = teamPlayers.filter(p => !p.isGK && p.role !== 'ST');
            const taker = midfielders.sort((a, b) => b.rating - a.rating)[0] || teamPlayers.find(p => !p.isGK);
            
            simState.ball.owner = taker;
            simState.ball.lastTouch = taker;
            if (taker) {
                taker.x = x; taker.y = y;
                taker.possessionTime = 0;
                
                // After short delay, deliver the corner
                setTimeout(() => {
                    if (!simState || simState.ball.owner !== taker) return;
                    
                    // Target is the penalty area
                    const targetX = isHomeTeam ? simState.width - m - 100 : m + 100;
                    const targetY = simState.height / 2 + (Math.random() - 0.5) * 80;
                    
                    const dx = targetX - taker.x, dy = targetY - taker.y;
                    const d = Math.sqrt(dx*dx + dy*dy);
                    const power = 12 + Math.random() * 5;
                    
                    simState.ball.vx = (dx/d) * power;
                    simState.ball.vy = (dy/d) * power;
                    simState.ball.owner = null;
                    addSimEvent(`📌 Corner delivered into the box!`);
                }, 800);
            }
        }
        
        function takeThrowIn(x, isTop, isHomeTeam) {
            if (!simState) return;
            const m = 30;
            const y = isTop ? m : simState.height - m;
            
            simState.ball.x = Math.max(m, Math.min(simState.width - m, x));
            simState.ball.y = y;
            simState.ball.vx = 0;
            simState.ball.vy = 0;
            
            const taker = isHomeTeam ? simState.homePlayers.find(p => !p.isGK) : simState.awayPlayers.find(p => !p.isGK);
            simState.ball.owner = taker;
            simState.ball.lastTouch = taker;
            if (taker) {
                taker.x = simState.ball.x; taker.y = simState.ball.y;
                taker.possessionTime = 0;
            }
        }
        
        function takeGoalKick(isLeftSide) {
            if (!simState) return;
            const m = 30;
            const x = isLeftSide ? m + 40 : simState.width - m - 40;
            const y = simState.height / 2;
            
            simState.ball.x = x;
            simState.ball.y = y;
            simState.ball.vx = 0;
            simState.ball.vy = 0;
            
            const gk = isLeftSide ? simState.homePlayers.find(p => p.isGK) : simState.awayPlayers.find(p => p.isGK);
            simState.ball.owner = gk;
            simState.ball.lastTouch = gk;
            if (gk) {
                gk.x = x; gk.y = y;
                gk.possessionTime = 0;
            }
        }
        
        function takeFreeKick(isHomeTeam, x, y) {
            if (!simState) return;
            
            simState.ball.x = x;
            simState.ball.y = y;
            simState.ball.vx = 0;
            simState.ball.vy = 0;
            
            const taker = isHomeTeam ? simState.homePlayers.find(p => !p.isGK) : simState.awayPlayers.find(p => !p.isGK);
            simState.ball.owner = taker;
            simState.ball.lastTouch = taker;
            if (taker) {
                taker.x = x; taker.y = y;
                taker.possessionTime = 0;
            }
        }
        
        // НОВОЕ: Объект поля для 2D симуляции
        const PitchObject = {
            margin: 40,
            marginY: 30,
            penaltyAreaWidth: 120,
            penaltyAreaHeight: 240,
            goalAreaWidth: 40,
            goalAreaHeight: 100,
            centerCircleRadius: 70,
            cornerRadius: 15,
            goalSize: 90,
            goalDepth: 15,
            
            // Методы для получения позиций
            getLeftGoalX: function(width) { return this.margin; },
            getRightGoalX: function(width) { return width - this.margin; },
            getGoalTop: function(height) { return height / 2 - this.goalSize / 2; },
            getGoalBottom: function(height) { return height / 2 + this.goalSize / 2; },
            getLeftPenaltyArea: function(width, height) {
                return { x: this.margin, y: height/2 - this.penaltyAreaHeight/2, w: this.penaltyAreaWidth, h: this.penaltyAreaHeight };
            },
            getRightPenaltyArea: function(width, height) {
                return { x: width - this.margin - this.penaltyAreaWidth, y: height/2 - this.penaltyAreaHeight/2, w: this.penaltyAreaWidth, h: this.penaltyAreaHeight };
            },
            isInLeftPenaltyArea: function(x, y, width, height) {
                const pa = this.getLeftPenaltyArea(width, height);
                return x >= pa.x && x <= pa.x + pa.w && y >= pa.y && y <= pa.y + pa.h;
            },
            isInRightPenaltyArea: function(x, y, width, height) {
                const pa = this.getRightPenaltyArea(width, height);
                return x >= pa.x && x <= pa.x + pa.w && y >= pa.y && y <= pa.y + pa.h;
            },
            
            // Рисование поля
            draw: function(ctx, width, height) {
                const m = this.margin;
                const my = this.marginY;
                
                // 1. Grass base with high-quality gradient
                const pitchGrad = ctx.createLinearGradient(0, 0, 0, height);
                pitchGrad.addColorStop(0, '#1a4712');
                pitchGrad.addColorStop(1, '#225e19');
                ctx.fillStyle = pitchGrad;
                ctx.fillRect(0, 0, width, height);
                
                // High-quality grass stripes with subtle texture
                const stripeWidth = width / 15;
                for (let i = 0; i < 15; i++) {
                    ctx.fillStyle = i % 2 === 0 ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.02)';
                    ctx.fillRect(i * stripeWidth, 0, stripeWidth, height);
                }
    
                // Field markings
                ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                ctx.lineWidth = 2;
                
                // Pitch border
                ctx.strokeRect(m, my, width - 2*m, height - 2*my);
                
                // Center line
                ctx.beginPath();
                ctx.moveTo(width/2, my);
                ctx.lineTo(width/2, height - my);
                ctx.stroke();
                
                // Center circle & spot
                ctx.beginPath();
                ctx.arc(width/2, height/2, this.centerCircleRadius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(width/2, height/2, 3, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.fill();
                
                // Penalty areas
                const penW = this.penaltyAreaWidth, penH = this.penaltyAreaHeight;
                const goalAreaW = this.goalAreaWidth, goalAreaH = this.goalAreaHeight;
                
                // Left
                ctx.strokeRect(m, height/2 - penH/2, penW, penH);
                ctx.strokeRect(m, height/2 - goalAreaH/2, goalAreaW, goalAreaH);
                ctx.beginPath();
                ctx.arc(m + 90, height/2, 2, 0, Math.PI * 2); // Pen spot
                ctx.fill();
                
                // Right
                ctx.strokeRect(width - m - penW, height/2 - penH/2, penW, penH);
                ctx.strokeRect(width - m - goalAreaW, height/2 - goalAreaH/2, goalAreaW, goalAreaH);
                ctx.beginPath();
                ctx.arc(width - m - 90, height/2, 2, 0, Math.PI * 2); // Pen spot
                ctx.fill();
    
                // Corner arcs
                const cornerR = this.cornerRadius;
                ctx.beginPath(); ctx.arc(m, my, cornerR, 0, Math.PI/2); ctx.stroke();
                ctx.beginPath(); ctx.arc(width-m, my, cornerR, Math.PI/2, Math.PI); ctx.stroke();
                ctx.beginPath(); ctx.arc(m, height-my, cornerR, 1.5*Math.PI, 2*Math.PI); ctx.stroke();
                ctx.beginPath(); ctx.arc(width-m, height-my, cornerR, Math.PI, 1.5*Math.PI); ctx.stroke();
    
                // Goals (Nets)
                ctx.lineWidth = 4;
                ctx.strokeStyle = '#fff';
                // Left goal net
                ctx.strokeRect(m - this.goalDepth, height/2 - this.goalSize/2, this.goalDepth, this.goalSize);
                // Right goal net
                ctx.strokeRect(width - m, height/2 - this.goalSize/2, this.goalDepth, this.goalSize);
            }
        };
        
        function renderSimulation() {
            const { ctx, width, height, ball, homePlayers, awayPlayers } = simState;
            
            // 1. Draw Professional Pitch using PitchObject
            PitchObject.draw(ctx, width, height);

            // 3. Draw Player Shadows
            [...homePlayers, ...awayPlayers].forEach(p => {
                ctx.beginPath();
                ctx.ellipse(p.x + 3, p.y + 3, p.radius * 0.8, p.radius * 0.4, 0, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fill();
            });

            // 4. Draw Players
            const drawPlayer = (p, isHome) => {
                const isOwner = ball.owner === p;
                
                // Motion blur effect for fast moving players
                const speed = Math.sqrt(p.vx*p.vx + p.vy*p.vy);
                if (speed > 1) {
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x - p.vx * 2, p.y - p.vy * 2);
                    ctx.strokeStyle = p.color + '44';
                    ctx.lineWidth = p.radius * 2;
                    ctx.lineCap = 'round';
                    ctx.stroke();
                }

                // Glow for ball owner
                if (isOwner) {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius + 8, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(251, 191, 36, 0.3)';
                    ctx.fill();
                }

                // Main circle with team color and depth
                const grad = ctx.createRadialGradient(p.x - 4, p.y - 4, 2, p.x, p.y, p.radius);
                grad.addColorStop(0, p.color);
                grad.addColorStop(0.7, shadeColor(p.color, -15));
                grad.addColorStop(1, shadeColor(p.color, -30));

                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = grad;
                ctx.fill();
                
                // Border
                ctx.strokeStyle = isOwner ? '#fbbf24' : 'rgba(255,255,255,0.9)';
                ctx.lineWidth = isOwner ? 3 : 2;
                ctx.stroke();
                
                // IMPROVED: Direction indicator for ball carrier
                if (isOwner && (p.vx !== 0 || p.vy !== 0)) {
                    const angle = Math.atan2(p.vy, p.vx);
                    const arrowLen = 18;
                    const arrowX = p.x + Math.cos(angle) * (p.radius + 6);
                    const arrowY = p.y + Math.sin(angle) * (p.radius + 6);
                    
                    ctx.beginPath();
                    ctx.moveTo(arrowX, arrowY);
                    ctx.lineTo(arrowX + Math.cos(angle) * arrowLen, arrowY + Math.sin(angle) * arrowLen);
                    ctx.strokeStyle = '#fbbf24';
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.stroke();
                }

                // Player name label
                ctx.font = 'bold 10px Inter, sans-serif';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.shadowColor = 'rgba(0,0,0,0.8)';
                ctx.shadowBlur = 4;
                ctx.fillText(p.name, p.x, p.y + p.radius + 14);
                ctx.shadowBlur = 0; // Reset
            };

            homePlayers.forEach(p => drawPlayer(p, true));
            awayPlayers.forEach(p => drawPlayer(p, false));

            // 5. Draw Ball (УЛУЧШЕНО: более яркий и заметный мяч)
            const ballSpeed = Math.sqrt(ball.vx*ball.vx + ball.vy*ball.vy);
            
            // Motion Trail for high-speed balls (shots and passes) - УЛУЧШЕНО
            if (ballSpeed > 4) {
                ctx.beginPath();
                const trailLength = Math.min(ballSpeed * 5, 120);
                const gradTrail = ctx.createLinearGradient(ball.x, ball.y, ball.x - ball.vx * 5, ball.y - ball.vy * 5);
                gradTrail.addColorStop(0, 'rgba(255, 255, 255, 0.7)');
                gradTrail.addColorStop(0.5, 'rgba(255, 200, 100, 0.3)');
                gradTrail.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                ctx.moveTo(ball.x, ball.y);
                ctx.lineTo(ball.x - ball.vx * 5, ball.y - ball.vy * 5);
                ctx.strokeStyle = gradTrail;
                ctx.lineWidth = ball.radius * 1.8;
                ctx.lineCap = 'round';
                ctx.stroke();
            }

            // Ball shadow
            ctx.beginPath();
            ctx.ellipse(ball.x + 4, ball.y + 4, ball.radius * 0.7, ball.radius * 0.4, 0, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.fill();

            // Ball Glow when in flight
            if (ballSpeed > 2 && !ball.owner) {
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius + 4, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.fill();
            }

            // Ball body
            const ballGrad = ctx.createRadialGradient(ball.x - 2, ball.y - 2, 0, ball.x, ball.y, ball.radius);
            ballGrad.addColorStop(0, '#fff');
            ballGrad.addColorStop(1, '#ddd');
            
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = ballGrad;
            ctx.fill();
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 1;
            ctx.stroke();

            // Pentagon pattern
            ctx.beginPath();
            ctx.fillStyle = '#333';
            for (let i = 0; i < 5; i++) {
                const ang = (i * 72 - 90) * Math.PI / 180;
                const px = ball.x + Math.cos(ang) * ball.radius * 0.5;
                const py = ball.y + Math.sin(ang) * ball.radius * 0.5;
                if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
            }
            ctx.fill();
        }

        // Helper to darken color
        function shadeColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + 
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1);
        }
        
        
        function addSimEvent(text) {
            const feed = document.getElementById('sim-events-feed');
            const div = document.createElement('div');
            div.className = 'text-[#4caf50] font-bold';
            div.textContent = text;
            feed.insertBefore(div, feed.firstChild);
        }
        
        function setSimSpeed(speed) {
            simSpeed = speed;
            updateSpeedButtons();
        }
        
        function updateSpeedButtons() {
            document.querySelectorAll('.sim-speed-btn').forEach(btn => {
                const speed = parseInt(btn.textContent);
                if (speed === simSpeed) {
                    btn.className = 'sim-speed-btn flex-1 py-1 text-xs rounded bg-[#4caf50] text-white font-bold';
                } else {
                    btn.className = 'sim-speed-btn flex-1 py-1 text-xs rounded bg-slate-800 text-slate-400';
                }
            });
        }
        
        function toggleSimPause() {
            simPaused = !simPaused;
            document.getElementById('sim-pause-btn').textContent = simPaused ? '▶️' : '⏸️';
        }
        
        function endSimulation() {
            if (simAnimationId) {
                cancelAnimationFrame(simAnimationId);
                simAnimationId = null;
            }
            
            document.getElementById('match-simulation-overlay').classList.add('hidden');
            
            // ИСПРАВЛЕНО: Сохраняем результат 2D симуляции в глобальную переменную
            // чтобы playWeek мог использовать его вместо пересимуляции
            if (simState && simState.matchResult) {
                // Сохраняем результат с финальным счётом из 2D симуляции
                const finalResult = {
                    ...simState.matchResult,
                    homeGoals: simState.homeScore,
                    awayGoals: simState.awayScore
                };
                
                // Сохраняем в глобальную переменную для использования в playWeek
                window._sim2DResult = finalResult;
                window._sim2DHomeId = simState.homeId;
                window._sim2DAwayId = simState.awayId;
                
                // ИСПРАВЛЕНО: Вызываем playWeek асинхронно и очищаем результат ПОСЛЕ завершения
                // playWeek() - асинхронная функция, поэтому нужно ждать её завершения
                playWeek().then(() => {
                    // Очищаем только после полного завершения playWeek
                    window._sim2DResult = null;
                    window._sim2DHomeId = null;
                    window._sim2DAwayId = null;
                }).catch(err => {
                    console.error('Error in playWeek after 2D sim:', err);
                    window._sim2DResult = null;
                    window._sim2DHomeId = null;
                    window._sim2DAwayId = null;
                });
            }
            
            simState = null;
        }
        
        // Инициализация свайпа для мобильного меню
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            const swipeThreshold = 50;
            
            // Свайп слева направо для открытия меню
            if (touchEndX - touchStartX > swipeThreshold && touchStartX < 50) {
                toggleMobileMenu();
            }
            
            // Свайп справа налево для закрытия меню
            if (touchStartX - touchEndX > swipeThreshold && mobileMenuOpen) {
                toggleMobileMenu();
            }
            
            // ИСПРАВЛЕНО: Повторно скрываем статус бар после любого свайпа
            if (window.isCapacitorNative && window.isCapacitorNative()) {
                setTimeout(hideStatusBar, 50);
            }
        });

        
        // ИСПРАВЛЕНО: Гарантированная инициализация после загрузки DOM
        function safeInit() {
// Вызови при запуске, например:

            try {
                // Ensure all hidden overlays are actually hidden
                const overlays = ['signing-overlay', 'play-options-overlay', 'match-simulation-overlay', 'live-match-overlay', 'modal-overlay', 'season-end-overlay', 'player-stats-overlay', 'profile-overlay', 'offer-overlay', 'transfer-confirm-overlay', 'promo-relegation-overlay', 'slot-select-overlay'];
                overlays.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                
                if (STATE.loaded) {
                    renderDashboard();
                } else {
                    //renderUploadScreen();
                }
            } catch (e) {
                console.error("Error during initialization:", e);
                // Fallback to basic upload screen
               // if (typeof renderUploadScreen === 'function') renderUploadScreen();
            }
        }
        
        // MAIN MENU FUNCTIONS - Defined at top of script for early availability
        // (showMenuSubScreen, hideMenuSubScreen, startNewGameFromMenu are now at the beginning)

        // Final fail-safe initialization - ИСПРАВЛЕНО для Capacitor
        window.onload = async function() {
            console.log('Window onload fired');
            
            // Ждём готовности Capacitor перед инициализацией UI
            try {
                const isNative = await window.CapacitorReady;
                console.log('Capacitor ready, isNative:', isNative);
                
                // Для нативных приложений добавляем обработчики touch-событий
                if (isNative) {
                    // Убираем 300ms задержку на тач-устройствах
                    document.body.style.touchAction = 'manipulation';
                    
                    // ИСПРАВЛЕНО: Скрываем статус бар и делаем immersive mode
                    hideStatusBar();
                    
                    // Слушаем события focus/visibility для повторного скрытия статус бара
                    document.addEventListener('visibilitychange', function() {
                        if (document.visibilityState === 'visible') {
                            setTimeout(hideStatusBar, 100);
                            setTimeout(hideStatusBar, 500); // Дополнительная попытка
                        }
                    });
                    window.addEventListener('focus', function() {
                        setTimeout(hideStatusBar, 100);
                        setTimeout(hideStatusBar, 500);
                    });
                    
                    // Capacitor-специфичные события
                    document.addEventListener('resume', function() {
                        setTimeout(hideStatusBar, 100);
                        setTimeout(hideStatusBar, 300);
                        setTimeout(hideStatusBar, 500);
                    });
                    
                    // Также реагируем на resize (может означать изменение статус бара)
                    window.addEventListener('resize', function() {
                        setTimeout(hideStatusBar, 100);
                    });
                    
                    // Предотвращаем контекстное меню на долгом тапе
                    document.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        return false;
                    });
                    
                    // Фикс для Android WebView - принудительно активируем кнопки
                    document.querySelectorAll('button, .menu-card-item, [onclick]').forEach(el => {
                        el.style.cursor = 'pointer';
                        el.style.touchAction = 'manipulation';
                    });
                    
                    console.log('Native touch handlers initialized');
                }
            } catch (e) {
                console.warn('CapacitorReady error:', e);
            }
            
            // Load menu assets using LogoManager logic
            const bgImg = document.getElementById('menu-bg-img');
            const playerImg = document.getElementById('menu-player-img');
            
            if (bgImg && typeof LogoManager !== 'undefined') {
                bgImg.src = LogoManager.getUIIconPath('ui/menu/background.png');
                bgImg.onload = () => bgImg.style.display = 'block';
            }
            
            if (playerImg && typeof LogoManager !== 'undefined') {
                playerImg.src = LogoManager.getUIIconPath('ui/menu/player.png');
                playerImg.onload = () => playerImg.style.display = 'block';
                playerImg.onerror = () => {
                    playerImg.src = 'https://via.placeholder.com/400x600?text=Player';
                    playerImg.style.display = 'block';
                };
            }
            
            // ВАЖНО: Повторно привязываем обработчики событий для динамического контента
            setupGlobalClickHandlers();
        };
        
        // Глобальный обработчик кликов для Capacitor/WebView
        function setupGlobalClickHandlers() {
            // Используем делегирование событий для всех onclick элементов
            document.body.addEventListener('click', function(e) {
                const target = e.target.closest('[onclick]');
                if (target && !target._clickHandled) {
                    // Предотвращаем двойные срабатывания
                    target._clickHandled = true;
                    setTimeout(() => { target._clickHandled = false; }, 300);
                }
            }, { passive: true });
            
            // Добавляем touch-обработчики для лучшей отзывчивости
            document.body.addEventListener('touchstart', function(e) {
                const target = e.target.closest('button, .menu-card-item, [onclick]');
                if (target) {
                    target.classList.add('active');
                }
            }, { passive: true });
            
            document.body.addEventListener('touchend', function(e) {
                const target = e.target.closest('button, .menu-card-item, [onclick]');
                if (target) {
                    target.classList.remove('active');
                }
            }, { passive: true });
            
            console.log('Global click handlers set up');
        }
    </script>
    

<script>
        // Дублирующийся код удален - используется ENHANCED TRANSFER SYSTEM v6 ниже
</script>









<!-- ENHANCED_TRANSFER_SYSTEM_START -->
<script>

// ENHANCED TRANSFER SYSTEM v6 - LANDSCAPE OPTIMIZED
(function() {
    console.log("Initializing Enhanced Transfer System v6...");

    // ИСПРАВЛЕНО: Используем глобальную formatMoney если доступна, иначе локальную
    function formatMoney(amount) {
        // Пробуем глобальную функцию
        if (typeof window.formatMoney === 'function') {
            return window.formatMoney(amount);
        }
        // Fallback
        if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'M €';
        if (amount >= 1000) return (amount / 1000).toFixed(0) + 'K €';
        return amount + ' €';
    }

    window.openContactClubMenu = function(playerId) {
        console.log("Opening Contact Club Menu for:", playerId);
        
        if (!window.STATE || !window.STATE.allTeams) {
            console.error('STATE or allTeams not available');
            return;
        }

        let player = null;
        let fromTeam = null;
        
        // Find player and team
        for (const t of window.STATE.allTeams) {
            const p = t.squad.find(x => x.internalId === playerId || x.id === playerId);
            if (p) { player = p; fromTeam = t; break; }
        }

        if (!player || !fromTeam) {
            console.error('Player or team not found for ID:', playerId);
            return;
        }
        
        if (fromTeam.id === window.STATE.userTeamId) {
             console.log("Player is in user team");
             return;
        }

        const userTeam = window.STATE.allTeams.find(t => t.id === window.STATE.userTeamId);
        
        // Check feasibility
        const feasibility = checkTransferFeasibility(player, userTeam);
        if (!feasibility.canBuy) {
            alert(feasibility.reasons.map(r => r.message).join('\n'));
            return;
        }
        
        // Calculate importance and prices
        const importance = calculatePlayerImportance(player, fromTeam);
        const basePrice = player.price || player.value || 1000000;
        const importanceFactor = 1 + (importance * 0.8);
        const clubAskingPrice = Math.round(basePrice * importanceFactor);
        const clubMinPrice = Math.round(basePrice * 0.6);
        const clubMaxPrice = Math.round(basePrice * 1.8);
        const prestigeDiff = (userTeam.teamRating || 70) - (fromTeam.teamRating || 70);

        // Update Global State
        contactClubState = {
            player: player,
            fromTeam: fromTeam,
            userTeam: userTeam,
            transferType: null,
            offerFee: clubAskingPrice,
            offerSalary: calculatePlayerSalary(player),
            loanDuration: 1,
            loanSalaryPercent: 50,
            clubAskingPrice: clubAskingPrice,
            clubMinPrice: clubMinPrice,
            clubMaxPrice: clubMaxPrice,
            playerMinSalary: calculatePlayerSalary(player),
            playerImportance: importance,
            teamPrestigeDiff: prestigeDiff
        };

        // Ensure overlay exists
        let overlay = document.getElementById('contact-club-overlay');
        if (!overlay) {
            console.log('Creating Contact Club Overlay...');
            overlay = document.createElement('div');
            overlay.id = 'contact-club-overlay';
            overlay.className = 'fixed inset-0 z-[999999] bg-slate-950 flex flex-col hidden';
            overlay.innerHTML = `
                <div class="flex-shrink-0 p-4 border-b border-slate-700 bg-slate-800/50 flex items-center justify-between">
                    <div>
                        <h2 class="text-white font-black text-2xl uppercase tracking-tight">Transfer Negotiation</h2>
                        <p class="text-slate-400 text-xs mt-1">Contact the club to sign the player</p>
                    </div>
                    <button onclick="closeContactClubMenu()" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-700 hover:bg-red-600 text-white transition-colors text-lg">✕</button>
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <div class="max-w-4xl mx-auto">
                        <div id="ccm-player-card" class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 mb-6 border border-slate-700 shadow-2xl"></div>
                        <div id="ccm-negotiation-container" class="space-y-6">
                            <div id="ccm-step-type" class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                                <h3 class="text-white font-black text-lg mb-4 uppercase tracking-wide">Choose Transfer Type</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <button onclick="contactClubState.transferType='permanent'; renderClubNegotiation(); document.getElementById('ccm-step-type').classList.add('hidden'); document.getElementById('ccm-step-club').classList.remove('hidden'); document.getElementById('ccm-step-club').style.display='block';" class="transfer-type-btn bg-gradient-to-br from-emerald-600 to-emerald-700 hover:from-emerald-500 hover:to-emerald-600 text-white font-bold py-6 px-6 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                                        <div class="text-2xl mb-2">💰</div>
                                        <div class="text-lg font-black uppercase">Permanent Transfer</div>
                                        <div class="text-xs opacity-80 mt-2">Buy the player outright</div>
                                    </button>
                                    <button onclick="contactClubState.transferType='loan'; renderClubNegotiation(); document.getElementById('ccm-step-type').classList.add('hidden'); document.getElementById('ccm-step-club').classList.remove('hidden'); document.getElementById('ccm-step-club').style.display='block';" class="transfer-type-btn bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-6 px-6 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                                        <div class="text-2xl mb-2">🤝</div>
                                        <div class="text-lg font-black uppercase">Loan Deal</div>
                                        <div class="text-xs opacity-80 mt-2">Temporary transfer (1-2 years)</div>
                                    </button>
                                </div>
                            </div>
                            <div id="ccm-step-club" class="hidden bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                                <h3 class="text-white font-black text-lg mb-4 uppercase tracking-wide flex items-center gap-2"><span>📋</span> Club Negotiation</h3>
                                <div id="ccm-club-negotiation-box" class="space-y-4"></div>
                            </div>
                            <div id="ccm-step-player" class="hidden bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                                <h3 class="text-white font-black text-lg mb-4 uppercase tracking-wide flex items-center gap-2"><span>✍️</span> Player Contract</h3>
                                <div id="ccm-player-negotiation-box" class="space-y-4"></div>
                            </div>
                            <div id="ccm-step-summary" class="hidden bg-gradient-to-br from-emerald-900/30 to-emerald-800/20 rounded-xl p-6 border border-emerald-700/50">
                                <h3 class="text-emerald-400 font-black text-lg mb-4 uppercase tracking-wide flex items-center gap-2"><span>✅</span> Transfer Complete!</h3>
                                <div id="ccm-summary-content" class="space-y-3 text-slate-300"></div>
                                <button onclick="closeContactClubMenu(); renderDashboard();" class="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 rounded-lg uppercase tracking-wider shadow-lg">Continue</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        renderContactClubMenu();
    };
        overlay.offsetHeight; // Trigger reflow
        requestAnimationFrame(() => {
            overlay.style.display = 'flex';
        });
        
        console.log('Contact Club Overlay opened successfully for player:', player.name);

        // Render player identity (Landscape optimized) - FIFA Style Card
        const cardDiv = document.getElementById('ccm-player-card');
        if (cardDiv) {
            // Вычисляем оценки по FIFA-стилю (A/B/C/D/F) на основе статов
            const getGrade = (stat) => {
                if (stat >= 85) return { grade: 'S', color: 'from-yellow-400 to-orange-500', text: 'text-yellow-400', bg: 'bg-gradient-to-r from-yellow-500/20 to-orange-500/20' };
                if (stat >= 75) return { grade: 'A', color: 'from-emerald-400 to-green-500', text: 'text-emerald-400', bg: 'bg-gradient-to-r from-emerald-500/20 to-green-500/20' };
                if (stat >= 65) return { grade: 'B', color: 'from-blue-400 to-cyan-500', text: 'text-blue-400', bg: 'bg-gradient-to-r from-blue-500/20 to-cyan-500/20' };
                if (stat >= 55) return { grade: 'C', color: 'from-purple-400 to-pink-500', text: 'text-purple-400', bg: 'bg-gradient-to-r from-purple-500/20 to-pink-500/20' };
                if (stat >= 45) return { grade: 'D', color: 'from-orange-400 to-red-500', text: 'text-orange-400', bg: 'bg-gradient-to-r from-orange-500/20 to-red-500/20' };
                return { grade: 'F', color: 'from-red-500 to-red-700', text: 'text-red-500', bg: 'bg-gradient-to-r from-red-500/20 to-red-700/20' };
            };
            
            const speedGrade = getGrade(player.speed || 60);
            const shotGrade = getGrade(player.shot || 60);
            const passGrade = getGrade(player.pass || 60);
            const dribbleGrade = getGrade(player.dribble || 60);
            
            cardDiv.innerHTML = `
                <div class="relative overflow-hidden rounded-3xl border-2 border-slate-700/50 shadow-2xl bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
                    <!-- Фоновый эффект -->
                    <div class="absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-purple-500/5 opacity-50"></div>
                    <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-emerald-500/10 to-transparent rounded-full blur-3xl"></div>
                    
                    <div class="relative p-4 md:p-6">
                        <!-- Хедер с основной инфой -->
                        <div class="flex items-start gap-4 md:gap-6 mb-4">
                            <!-- Фото игрока -->
                            <div class="relative flex-shrink-0">
                                <div class="w-20 h-20 md:w-28 md:h-28 rounded-2xl overflow-hidden border-4 border-emerald-500/30 shadow-xl bg-gradient-to-br from-slate-700 to-slate-900">
                                    ${window.getPlayerFaceHTML(player.internalId || player.id, 'w-full h-full object-cover')}
                                </div>
                                <!-- Рейтинг как в FIFA -->
                                <div class="absolute -top-2 -right-2 bg-gradient-to-br from-emerald-400 to-emerald-600 text-black text-base md:text-2xl font-black px-3 py-2 md:px-4 md:py-3 rounded-xl shadow-lg border-2 border-emerald-300 transform rotate-3">
                                    ${player.rating}
                                </div>
                            </div>
                            
                            <!-- Информация об игроке -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 text-xs md:text-sm font-black uppercase rounded border border-emerald-500/30">${player.pos}</span>
                                    <span class="text-slate-500 text-xs md:text-sm">•</span>
                                    <span class="text-slate-400 text-xs md:text-sm font-bold">${player.age} лет</span>
                                </div>
                                <h2 class="text-xl md:text-3xl font-black text-white uppercase tracking-tight leading-none mb-2 drop-shadow-lg">${player.name}</h2>
                                <div class="text-slate-400 text-xs md:text-sm font-bold truncate mb-3">
                                    <span class="opacity-60">Клуб:</span> ${team.name}
                                </div>
                                
                                <!-- Цена и зарплата -->
                                <div class="flex gap-2">
                                    <div class="flex-1 bg-slate-800/60 backdrop-blur px-2 md:px-3 py-1.5 md:py-2 rounded-xl border border-white/10">
                                        <div class="text-[10px] text-slate-500 uppercase font-bold mb-0.5">Стоимость</div>
                                        <div class="text-white font-black text-xs md:text-sm">${formatMoney(player.price)}</div>
                                    </div>
                                    <div class="flex-1 bg-slate-800/60 backdrop-blur px-2 md:px-3 py-1.5 md:py-2 rounded-xl border border-white/10">
                                        <div class="text-[10px] text-slate-500 uppercase font-bold mb-0.5">Зарплата</div>
                                        <div class="text-white font-black text-xs md:text-sm">${formatMoney(player.salary)}/год</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Статы с оценками FIFA-стиль -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
                            <!-- Speed -->
                            <div class="relative overflow-hidden rounded-xl border border-white/10 ${speedGrade.bg} backdrop-blur">
                                <div class="p-2 md:p-3">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[10px] md:text-xs text-slate-300 uppercase font-bold tracking-wider">Скорость</span>
                                        <div class="text-lg md:text-2xl font-black ${speedGrade.text} drop-shadow-lg">${speedGrade.grade}</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r ${speedGrade.color} transition-all duration-500" style="width: ${player.speed}%"></div>
                                        </div>
                                        <span class="text-white font-black text-xs md:text-sm">${player.speed}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Shot -->
                            <div class="relative overflow-hidden rounded-xl border border-white/10 ${shotGrade.bg} backdrop-blur">
                                <div class="p-2 md:p-3">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[10px] md:text-xs text-slate-300 uppercase font-bold tracking-wider">Удар</span>
                                        <div class="text-lg md:text-2xl font-black ${shotGrade.text} drop-shadow-lg">${shotGrade.grade}</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r ${shotGrade.color} transition-all duration-500" style="width: ${player.shot}%"></div>
                                        </div>
                                        <span class="text-white font-black text-xs md:text-sm">${player.shot}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pass -->
                            <div class="relative overflow-hidden rounded-xl border border-white/10 ${passGrade.bg} backdrop-blur">
                                <div class="p-2 md:p-3">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[10px] md:text-xs text-slate-300 uppercase font-bold tracking-wider">Пас</span>
                                        <div class="text-lg md:text-2xl font-black ${passGrade.text} drop-shadow-lg">${passGrade.grade}</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r ${passGrade.color} transition-all duration-500" style="width: ${player.pass}%"></div>
                                        </div>
                                        <span class="text-white font-black text-xs md:text-sm">${player.pass}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dribble -->
                            <div class="relative overflow-hidden rounded-xl border border-white/10 ${dribbleGrade.bg} backdrop-blur">
                                <div class="p-2 md:p-3">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[10px] md:text-xs text-slate-300 uppercase font-bold tracking-wider">Дриблинг</span>
                                        <div class="text-lg md:text-2xl font-black ${dribbleGrade.text} drop-shadow-lg">${dribbleGrade.grade}</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r ${dribbleGrade.color} transition-all duration-500" style="width: ${player.dribble}%"></div>
                                        </div>
                                        <span class="text-white font-black text-xs md:text-sm">${player.dribble}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Легенда оценок -->
                        <div class="mt-3 pt-3 border-t border-white/10">
                            <div class="flex items-center justify-center gap-3 md:gap-4 text-[9px] md:text-xs flex-wrap">
                                <div class="flex items-center gap-1">
                                    <span class="font-black text-yellow-400">S</span>
                                    <span class="text-slate-500">85+</span>
                                </div>
                                <span class="text-slate-700">•</span>
                                <div class="flex items-center gap-1">
                                    <span class="font-black text-emerald-400">A</span>
                                    <span class="text-slate-500">75-84</span>
                                </div>
                                <span class="text-slate-700">•</span>
                                <div class="flex items-center gap-1">
                                    <span class="font-black text-blue-400">B</span>
                                    <span class="text-slate-500">65-74</span>
                                </div>
                                <span class="text-slate-700">•</span>
                                <div class="flex items-center gap-1">
                                    <span class="font-black text-purple-400">C</span>
                                    <span class="text-slate-500">55-64</span>
                                </div>
                                <span class="text-slate-700">•</span>
                                <div class="flex items-center gap-1">
                                    <span class="font-black text-orange-400">D</span>
                                    <span class="text-slate-500">45-54</span>
                                </div>
                                <span class="text-slate-700">•</span>
                                <div class="flex items-center gap-1">
                                    <span class="font-black text-red-500">F</span>
                                    <span class="text-slate-500">0-44</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.showNegotiationStep('type');
    };

    window.closeContactClubMenu = function() {
        const overlay = document.getElementById('contact-club-overlay');
        if (overlay) {
            overlay.classList.add('hidden');
            overlay.classList.remove('visible');
            overlay.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
        }
        window.currentNegotiation = null;
        console.log('Contact Club Overlay closed');
    };

    window.showNegotiationStep = function(step) {
        const steps = ['type', 'club', 'player', 'summary'];
        steps.forEach(s => {
            const el = document.getElementById('ccm-step-' + s);
            if (el) {
                if (s === step) {
                    el.classList.remove('hidden');
                    el.style.display = 'block';
                    el.classList.add('modal-animate');
                } else {
                    el.classList.add('hidden');
                    el.style.display = 'none';
                }
            }
        });
        if (window.currentNegotiation) window.currentNegotiation.step = step;
        
        if (step === 'club') window.initClubNegotiation();
        if (step === 'player') window.initPlayerNegotiation();
        if (step === 'summary') window.initNegotiationSummary();
    };

    window.selectTransferType = function(type) {
        if (!window.currentNegotiation) return;
        window.currentNegotiation.type = type;
        window.showNegotiationStep('club');
    };

    window.initClubNegotiation = function() {
        const neg = window.currentNegotiation;
        const container = document.getElementById('ccm-club-negotiation-box');
        if (!container) return;

        if (neg.type === 'loan') {
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5">
                        <label class="block text-slate-500 text-[10px] uppercase font-black tracking-widest mb-3">Loan Duration</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="setLoanDuration(1)" id="btn-loan-1" class="loan-dur-btn bg-slate-800 text-white py-3 rounded-xl font-black border-2 border-transparent transition-all">1 YEAR</button>
                            <button onclick="setLoanDuration(2)" id="btn-loan-2" class="loan-dur-btn bg-slate-800 text-white py-3 rounded-xl font-black border-2 border-transparent transition-all">2 YEARS</button>
                        </div>
                    </div>
                    <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5">
                        <label class="block text-slate-500 text-[10px] uppercase font-black tracking-widest mb-3">Wage Contribution: <span id="loan-wage-val" class="text-blue-400">50%</span></label>
                        <input type="range" min="30" max="100" step="5" value="50" oninput="updateLoanWage(this.value)" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        <div class="flex justify-between text-[8px] text-slate-500 mt-2 font-bold"><span>30% (HARD)</span><span>100% (EASY)</span></div>
                    </div>
                </div>
                <div id="club-response" class="mt-4 p-4 rounded-xl bg-slate-800/50 border border-white/5 text-xs text-slate-400 italic text-center">"Specify your loan terms."</div>
                <button onclick="submitClubOffer()" class="mt-6 w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl uppercase tracking-widest shadow-xl transition-all active:scale-95">Submit Loan Proposal</button>
            `;
            window.setLoanDuration(1);
        } else {
            container.innerHTML = `
                <div class="bg-slate-900/50 p-6 rounded-2xl border border-white/5 max-w-xl mx-auto">
                    <label class="block text-slate-500 text-[10px] uppercase font-black tracking-widest mb-4">Transfer Fee Proposal</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-black text-xl">€</span>
                        <input type="number" id="club-fee-input" value="${neg.player.price}" class="w-full bg-slate-800 text-white text-3xl font-black pl-10 pr-4 py-5 rounded-2xl border border-white/10 focus:border-emerald-500 outline-none transition-all">
                    </div>
                    <div class="flex justify-between text-[10px] text-slate-500 mt-3 font-bold px-1">
                        <span>VAL: ${formatMoney(neg.player.price)}</span>
                        <span>BUDGET: ${formatMoney(neg.userTeam.budget)}</span>
                    </div>
                </div>
                <div id="club-response" class="mt-4 p-4 rounded-xl bg-slate-800/50 border border-white/5 text-xs text-slate-400 italic text-center">"We are waiting for your opening bid."</div>
                <button onclick="submitClubOffer()" class="mt-6 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 rounded-2xl uppercase tracking-widest shadow-xl transition-all active:scale-95">Submit Transfer Bid</button>
            `;
        }
    };

    window.setLoanDuration = function(years) {
        window.currentNegotiation.duration = years;
        document.querySelectorAll('.loan-dur-btn').forEach(b => {
            b.classList.remove('border-blue-500', 'bg-blue-600/20', 'text-blue-400');
            b.classList.add('bg-slate-800');
        });
        const active = document.getElementById('btn-loan-' + years);
        if (active) {
            active.classList.add('border-blue-500', 'bg-blue-600/20', 'text-blue-400');
            active.classList.remove('bg-slate-800');
        }
    };

    window.updateLoanWage = function(val) {
        window.currentNegotiation.loanWagePct = parseInt(val);
        const label = document.getElementById('loan-wage-val');
        if (label) label.textContent = val + '%';
    };

    window.submitClubOffer = function() {
        const neg = window.currentNegotiation;
        const responseEl = document.getElementById('club-response');
        
        if (neg.type === 'loan') {
            const chance = (neg.loanWagePct - 20) / 80;
            if (Math.random() < chance) {
                responseEl.innerHTML = "<span class='text-emerald-400 font-black uppercase'>Accepted!</span> \"Terms agreed. Talk to the player.\"";
                setTimeout(() => window.showNegotiationStep('player'), 1200);
            } else {
                responseEl.innerHTML = "<span class='text-red-400 font-black uppercase'>Rejected!</span> \"We need a better wage split.\"";
            }
        } else {
            const fee = parseInt(document.getElementById('club-fee-input').value);
            if (fee > neg.userTeam.budget) { alert("Insufficient funds!"); return; }
            neg.clubOffer = fee;
            let acceptPrice = neg.player.price * (neg.player.rating > 80 ? 1.1 : 0.95);
            if (fee >= acceptPrice) {
                responseEl.innerHTML = "<span class='text-emerald-400 font-black uppercase'>Accepted!</span> \"Deal agreed at " + formatMoney(fee) + ".\"";
                setTimeout(() => window.showNegotiationStep('player'), 1200);
            } else {
                responseEl.innerHTML = "<span class='text-red-400 font-black uppercase'>Rejected!</span> \"Your bid is too low for a player of this quality.\"";
            }
        }
    };

    window.initPlayerNegotiation = function() {
        const neg = window.currentNegotiation;
        const container = document.getElementById('ccm-player-negotiation-box');
        if (!container) return;

        // Prestige check
        if ((neg.player.rating - neg.userTeam.rating) > 8 && Math.random() < 0.75) {
            container.innerHTML = `
                <div class="text-center p-10 bg-slate-900/50 rounded-3xl border border-red-500/20">
                    <div class="text-6xl mb-4">😤</div>
                    <h3 class="text-white font-black text-2xl mb-2 uppercase tracking-tighter">Negotiations Blocked</h3>
                    <p class="text-slate-400 text-sm max-w-md mx-auto italic">"I'm not interested in moving to a club of your stature. I have higher ambitions."</p>
                    <button onclick="closeContactClubMenu()" class="mt-8 bg-slate-700 hover:bg-slate-600 text-white px-10 py-3 rounded-xl font-black uppercase tracking-widest transition-all">Close</button>
                </div>
            `;
            return;
        }

        if (neg.type === 'loan') {
            neg.playerWage = neg.player.salary;
            neg.duration = neg.duration || 1;
            container.innerHTML = `
                <div class="text-center p-10 bg-slate-900/50 rounded-3xl border border-blue-500/20">
                    <div class="text-6xl mb-4">🤝</div>
                    <h3 class="text-white font-black text-2xl mb-2 uppercase tracking-tighter">Player is Interested</h3>
                    <p class="text-slate-400 text-sm mb-8 italic">"A loan move sounds like a great opportunity for my career. Let's do it!"</p>
                    <button onclick="showNegotiationStep('summary')" class="bg-blue-600 hover:bg-blue-500 text-white px-12 py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl transition-all active:scale-95">Finalize Terms</button>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5">
                        <label class="block text-slate-500 text-[10px] uppercase font-black tracking-widest mb-3">Proposed Annual Wage</label>
                        <input type="number" id="player-wage-input" value="${Math.floor(neg.player.salary * 1.1)}" class="w-full bg-slate-800 text-white text-xl font-black p-4 rounded-xl border border-white/10 focus:border-blue-500 outline-none">
                        <div class="text-[8px] text-slate-500 mt-2 font-bold uppercase tracking-widest">Current: ${formatMoney(neg.player.salary)}</div>
                    </div>
                    <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5">
                        <label class="block text-slate-500 text-[10px] uppercase font-black tracking-widest mb-3">Contract Duration</label>
                        <select id="player-dur-select" class="w-full bg-slate-800 text-white p-4 rounded-xl border border-white/10 font-black outline-none">
                            <option value="2">2 YEARS</option>
                            <option value="3" selected>3 YEARS</option>
                            <option value="4">4 YEARS</option>
                            <option value="5">5 YEARS</option>
                        </select>
                    </div>
                </div>
                <div id="player-response" class="mt-4 p-4 rounded-xl bg-slate-800/50 border border-white/5 text-xs text-slate-400 italic text-center">"I'm waiting for your contract offer."</div>
                <button onclick="submitPlayerOffer()" class="mt-6 w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl uppercase tracking-widest shadow-xl transition-all active:scale-95">Sign Player</button>
            `;
        }
    };

    window.submitPlayerOffer = function() {
        const neg = window.currentNegotiation;
        const wage = parseInt(document.getElementById('player-wage-input').value);
        const dur = parseInt(document.getElementById('player-dur-select').value);
        const responseEl = document.getElementById('player-response');
        
        if (wage >= neg.player.salary * 1.05) {
            neg.playerWage = wage;
            neg.duration = dur;
            responseEl.innerHTML = "<span class='text-emerald-400 font-black uppercase'>Deal!</span> \"I'm happy with these terms. Let's win together!\"";
            setTimeout(() => window.showNegotiationStep('summary'), 1200);
        } else {
            responseEl.innerHTML = "<span class='text-red-400 font-black uppercase'>Rejected!</span> \"My agent says this wage doesn't reflect my value.\"";
        }
    };

    window.initNegotiationSummary = function() {
        const neg = window.currentNegotiation;
        // ИСПРАВЛЕНО: Используем правильный ID контейнера ccm-summary-content
        const container = document.getElementById('ccm-summary-content');
        if (!container) {
            console.error("Summary container not found!");
            return;
        }

        const isLoan = neg.type === 'loan';
        container.innerHTML = `
            <div class="max-w-md mx-auto bg-gradient-to-br from-slate-900 to-black p-8 rounded-3xl border border-white/10 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">📝</div>
                <h4 class="text-white font-black text-2xl mb-8 uppercase tracking-tighter flex items-center gap-3">
                    <span class="w-2 h-8 ${isLoan ? 'bg-blue-500' : 'bg-emerald-500'} rounded-full"></span>
                    Final Agreement
                </h4>
                <div class="space-y-4 mb-10">
                    <div class="flex justify-between items-center pb-3 border-b border-white/5">
                        <span class="text-slate-500 text-[10px] font-black uppercase tracking-widest">Type</span>
                        <span class="text-white font-black">${isLoan ? 'LOAN' : 'TRANSFER'}</span>
                    </div>
                    <div class="flex justify-between items-center pb-3 border-b border-white/5">
                        <span class="text-slate-500 text-[10px] font-black uppercase tracking-widest">${isLoan ? 'Duration' : 'Fee'}</span>
                        <span class="text-white font-black">${isLoan ? neg.duration + ' Year(s)' : formatMoney(neg.clubOffer)}</span>
                    </div>
                    <div class="flex justify-between items-center pb-3 border-b border-white/5">
                        <span class="text-slate-500 text-[10px] font-black uppercase tracking-widest">New Wage</span>
                        <span class="${isLoan ? 'text-blue-400' : 'text-emerald-400'} font-black">${formatMoney(neg.playerWage)}/yr</span>
                    </div>
                </div>
                <button onclick="completeTransfer()" class="w-full ${isLoan ? 'bg-blue-600 hover:bg-blue-500' : 'bg-emerald-600 hover:bg-emerald-500'} text-white font-black py-5 rounded-2xl uppercase tracking-widest shadow-xl transition-all active:scale-95">Confirm & Sign</button>
            </div>
        `;
    };

    window.completeTransfer = function() {
        const neg = window.currentNegotiation;
        const userTeam = neg.userTeam;
        const fromTeam = neg.team;
        const player = neg.player;

        fromTeam.squad = fromTeam.squad.filter(p => p.internalId !== player.internalId);
        player.clubId = userTeam.id;
        player.isStarter = false;
        
        if (neg.type === 'loan') {
            player.onLoan = true;
            player.loanFromId = fromTeam.id;
            player.originalSalary = player.salary;
            player.salary = Math.floor(player.salary * neg.loanWagePct / 100);
            player.loanDuration = neg.duration;
            player.loanEndSeason = (window.STATE?.season || 1) + neg.duration;
            window.addNews('Transfer', `${player.name} joined ${userTeam.name} on loan!`, 'transfer');
        } else {
            fromTeam.budget += neg.clubOffer;
            userTeam.budget -= neg.clubOffer;
            player.salary = neg.playerWage;
            player.onLoan = false;
            player.endContract = (window.STATE?.season || 1) + neg.duration;
            window.addNews('Transfer', `${player.name} signed for ${userTeam.name} for ${formatMoney(neg.clubOffer)}!`, 'transfer');
        }

        userTeam.squad.push(player);
        window.calculateTeamRating(fromTeam);
        window.calculateTeamRating(userTeam);
        window.closeContactClubMenu();
        window.renderDashboard();
        if (window.saveGame) window.saveGame();
        
        // Создаём красивую карточку успешного трансфера
        showPlayerSignedCard(player, neg);
    };
    
    // LANDSCAPE PLAYER SIGNED CARD - FC25/FC26 STYLE with Transfer Level
    window.showPlayerSignedCard = function(player, negotiation) {
        const isLoan = negotiation.type === 'loan';
        
        // Функция для расчёта уровня трансфера (как в FC25-26)
        const getTransferLevel = (rating, potential, age, fee) => {
            let level = 1;
            let levelName = 'Bench Player';
            let levelColor = 'from-slate-500 to-slate-600';
            let stars = 1;
            
            const potentialGrowth = (potential || rating) - rating;
            const normalizedFee = (fee || 0) / 1000000; // В миллионах
            
            if (rating >= 88 || normalizedFee >= 100) {
                level = 5; levelName = 'World Class'; levelColor = 'from-amber-400 to-yellow-500'; stars = 5;
            } else if (rating >= 83 || normalizedFee >= 50) {
                level = 4; levelName = 'Elite Signing'; levelColor = 'from-purple-400 to-purple-600'; stars = 4;
            } else if (rating >= 78 || normalizedFee >= 20) {
                level = 3; levelName = 'Key Player'; levelColor = 'from-blue-400 to-blue-600'; stars = 3;
            } else if (rating >= 72 || potentialGrowth >= 10) {
                level = 2; levelName = 'Squad Depth'; levelColor = 'from-emerald-400 to-emerald-600'; stars = 2;
            } else if (age <= 21 && potentialGrowth >= 5) {
                level = 2; levelName = 'Future Star'; levelColor = 'from-cyan-400 to-cyan-600'; stars = 2;
            }
            
            return { level, levelName, levelColor, stars };
        };
        
        // Функция для оценки статов
        const getGrade = (stat) => {
            if (stat >= 90) return { grade: 'S+', color: 'from-amber-300 to-yellow-500', text: 'text-amber-300', bg: 'bg-gradient-to-br from-amber-500/30 to-yellow-500/20', glow: 'shadow-amber-500/30' };
            if (stat >= 85) return { grade: 'S', color: 'from-yellow-400 to-orange-500', text: 'text-yellow-400', bg: 'bg-gradient-to-br from-yellow-500/20 to-orange-500/20', glow: 'shadow-yellow-500/20' };
            if (stat >= 80) return { grade: 'A+', color: 'from-emerald-300 to-green-500', text: 'text-emerald-300', bg: 'bg-gradient-to-br from-emerald-500/20 to-green-500/20', glow: 'shadow-emerald-500/20' };
            if (stat >= 75) return { grade: 'A', color: 'from-emerald-400 to-green-500', text: 'text-emerald-400', bg: 'bg-gradient-to-br from-emerald-500/15 to-green-500/15', glow: '' };
            if (stat >= 70) return { grade: 'B+', color: 'from-blue-300 to-cyan-500', text: 'text-blue-300', bg: 'bg-gradient-to-br from-blue-500/15 to-cyan-500/15', glow: '' };
            if (stat >= 65) return { grade: 'B', color: 'from-blue-400 to-cyan-500', text: 'text-blue-400', bg: 'bg-gradient-to-br from-blue-500/10 to-cyan-500/10', glow: '' };
            if (stat >= 55) return { grade: 'C', color: 'from-purple-400 to-pink-500', text: 'text-purple-400', bg: 'bg-gradient-to-br from-purple-500/10 to-pink-500/10', glow: '' };
            if (stat >= 45) return { grade: 'D', color: 'from-orange-400 to-red-500', text: 'text-orange-400', bg: 'bg-gradient-to-br from-orange-500/10 to-red-500/10', glow: '' };
            return { grade: 'F', color: 'from-red-500 to-red-700', text: 'text-red-500', bg: 'bg-gradient-to-br from-red-500/10 to-red-700/10', glow: '' };
        };
        
        const transferLevel = getTransferLevel(player.rating, player.pot, player.age, negotiation.clubOffer);
        const ratingGrade = getGrade(player.rating);
        const speedGrade = getGrade(player.speed || 60);
        const shotGrade = getGrade(player.shot || 60);
        const passGrade = getGrade(player.pass || 60);
        const dribbleGrade = getGrade(player.dribble || 60);
        const defGrade = getGrade(player.def || 50);
        const physGrade = getGrade(player.phys || 65);
        
        // Генерируем звёзды
        const starsHTML = Array(5).fill(0).map((_, i) => 
            `<span class="${i < transferLevel.stars ? 'text-amber-400' : 'text-slate-600'} text-lg">★</span>`
        ).join('');
        
        const modalHTML = `
            <div id="player-signed-modal" class="fixed inset-0 z-[100000] bg-black/95 backdrop-blur-lg flex items-center justify-center p-2 md:p-4 animate-fadeIn">
                <!-- LANDSCAPE CARD - FC STYLE -->
                <div class="w-full max-w-4xl bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-2xl md:rounded-3xl border border-slate-700/50 shadow-2xl overflow-hidden animate-scaleIn">
                    
                    <!-- Top Banner - Transfer Level -->
                    <div class="relative bg-gradient-to-r ${transferLevel.levelColor} px-4 md:px-8 py-3 md:py-4">
                        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMjAgMGwyMCAyMC0yMCAyMEwwIDIweiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjAzKSIvPjwvc3ZnPg==')] opacity-50"></div>
                        <div class="relative flex items-center justify-between">
                            <div class="flex items-center gap-3 md:gap-4">
                                <div class="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-black/30 flex items-center justify-center">
                                    <span class="text-2xl md:text-3xl font-black text-white">${transferLevel.level}</span>
                                </div>
                                <div>
                                    <div class="text-[10px] md:text-xs text-white/70 uppercase tracking-widest font-bold">Transfer Level</div>
                                    <div class="text-lg md:text-xl font-black text-white uppercase tracking-tight">${transferLevel.levelName}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-1">${starsHTML}</div>
                        </div>
                    </div>
                    
                    <!-- Main Content - Landscape Layout -->
                    <div class="flex flex-col md:flex-row">
                        
                        <!-- Left Side - Player Photo & Rating -->
                        <div class="relative w-full md:w-2/5 p-4 md:p-6 flex flex-col items-center justify-center bg-gradient-to-br from-slate-800/50 to-transparent">
                            <!-- Background Glow -->
                            <div class="absolute inset-0 bg-gradient-to-br ${transferLevel.levelColor} opacity-10 blur-3xl"></div>
                            
                            <div class="relative">
                                <!-- Player Photo -->
                                <div class="relative w-32 h-32 md:w-40 md:h-40 rounded-2xl overflow-hidden border-4 border-white/10 shadow-2xl bg-gradient-to-br from-slate-700 to-slate-900">
                                    ${window.getPlayerFaceHTML(player.internalId || player.id, 'w-full h-full object-cover')}
                                </div>
                                
                                <!-- Overall Rating Badge -->
                                <div class="absolute -bottom-3 -right-3 ${ratingGrade.bg} ${ratingGrade.glow} shadow-lg rounded-xl px-3 py-2 border border-white/20">
                                    <div class="text-3xl md:text-4xl font-black text-white drop-shadow-lg">${player.rating}</div>
                                </div>
                                
                                <!-- Position Badge -->
                                <div class="absolute -top-2 -left-2 bg-gradient-to-br ${transferLevel.levelColor} text-white text-sm md:text-base font-black px-3 py-1.5 rounded-lg shadow-lg border border-white/20 uppercase">
                                    ${player.pos}
                                </div>
                            </div>
                            
                            <!-- Player Name -->
                            <div class="mt-4 md:mt-6 text-center">
                                <h2 class="text-xl md:text-2xl font-black text-white uppercase tracking-tight leading-none drop-shadow-lg">${player.name}</h2>
                                <div class="flex items-center justify-center gap-2 mt-2">
                                    <span class="text-slate-400 text-sm">${player.age} years</span>
                                    ${player.nation ? `<span class="text-slate-600">•</span><span class="text-xs font-mono bg-slate-700 px-2 py-0.5 rounded text-slate-300">${player.nation.substring(0,3).toUpperCase()}</span>` : ''}
                                </div>
                            </div>
                            
                            <!-- Potential -->
                            ${player.pot && player.pot > player.rating ? `
                            <div class="mt-3 px-4 py-2 bg-slate-800/60 rounded-xl border border-white/5">
                                <div class="text-[10px] text-slate-500 uppercase tracking-wider text-center">Potential</div>
                                <div class="text-xl font-black text-cyan-400 text-center">${player.pot}</div>
                            </div>` : ''}
                        </div>
                        
                        <!-- Right Side - Stats & Contract -->
                        <div class="flex-1 p-4 md:p-6 space-y-4">
                            
                            <!-- Deal Type Header -->
                            <div class="flex items-center justify-between pb-3 border-b border-slate-700/50">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">${isLoan ? '📋' : '✅'}</span>
                                    <div>
                                        <div class="text-lg font-black text-white uppercase">${isLoan ? 'Loan Deal' : 'Transfer'} Complete</div>
                                        <div class="text-xs text-emerald-400 uppercase tracking-widest font-bold">Welcome to the club!</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contract Details Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-3">
                                ${!isLoan ? `
                                <div class="bg-slate-800/60 backdrop-blur px-3 py-3 rounded-xl border border-emerald-500/20">
                                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Transfer Fee</div>
                                    <div class="text-emerald-400 font-black text-base md:text-lg">${formatMoney(negotiation.clubOffer)}</div>
                                </div>
                                ` : `
                                <div class="bg-slate-800/60 backdrop-blur px-3 py-3 rounded-xl border border-blue-500/20">
                                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Loan Fee</div>
                                    <div class="text-blue-400 font-black text-base md:text-lg">${formatMoney(negotiation.clubOffer || 0)}</div>
                                </div>
                                `}
                                <div class="bg-slate-800/60 backdrop-blur px-3 py-3 rounded-xl border border-white/5">
                                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Weekly Wage</div>
                                    <div class="text-white font-black text-base md:text-lg">${formatMoney(negotiation.playerWage)}</div>
                                </div>
                                <div class="bg-slate-800/60 backdrop-blur px-3 py-3 rounded-xl border border-white/5">
                                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">${isLoan ? 'Loan Duration' : 'Contract'}</div>
                                    <div class="text-white font-black text-base md:text-lg">${negotiation.duration} Year${negotiation.duration > 1 ? 's' : ''}</div>
                                </div>
                            </div>
                            
                            <!-- Player Attributes - 6 Stats Grid -->
                            <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                                <div class="${speedGrade.bg} ${speedGrade.glow} backdrop-blur px-2 py-2 rounded-xl border border-white/10 text-center">
                                    <div class="text-[9px] md:text-[10px] text-slate-400 uppercase font-bold">PAC</div>
                                    <div class="${speedGrade.text} font-black text-lg md:text-xl">${player.speed || 60}</div>
                                </div>
                                <div class="${shotGrade.bg} ${shotGrade.glow} backdrop-blur px-2 py-2 rounded-xl border border-white/10 text-center">
                                    <div class="text-[9px] md:text-[10px] text-slate-400 uppercase font-bold">SHO</div>
                                    <div class="${shotGrade.text} font-black text-lg md:text-xl">${player.shot || 60}</div>
                                </div>
                                <div class="${passGrade.bg} ${passGrade.glow} backdrop-blur px-2 py-2 rounded-xl border border-white/10 text-center">
                                    <div class="text-[9px] md:text-[10px] text-slate-400 uppercase font-bold">PAS</div>
                                    <div class="${passGrade.text} font-black text-lg md:text-xl">${player.pass || 60}</div>
                                </div>
                                <div class="${dribbleGrade.bg} ${dribbleGrade.glow} backdrop-blur px-2 py-2 rounded-xl border border-white/10 text-center">
                                    <div class="text-[9px] md:text-[10px] text-slate-400 uppercase font-bold">DRI</div>
                                    <div class="${dribbleGrade.text} font-black text-lg md:text-xl">${player.dribble || 60}</div>
                                </div>
                                <div class="${defGrade.bg} ${defGrade.glow} backdrop-blur px-2 py-2 rounded-xl border border-white/10 text-center">
                                    <div class="text-[9px] md:text-[10px] text-slate-400 uppercase font-bold">DEF</div>
                                    <div class="${defGrade.text} font-black text-lg md:text-xl">${player.def || 50}</div>
                                </div>
                                <div class="${physGrade.bg} ${physGrade.glow} backdrop-blur px-2 py-2 rounded-xl border border-white/10 text-center">
                                    <div class="text-[9px] md:text-[10px] text-slate-400 uppercase font-bold">PHY</div>
                                    <div class="${physGrade.text} font-black text-lg md:text-xl">${player.phys || 65}</div>
                                </div>
                            </div>
                            
                            <!-- Continue Button - ИСПРАВЛЕНО: Использует глобальную функцию -->
                            <button onclick="window.closePlayerSignedModal()" 
                                class="w-full bg-gradient-to-r ${transferLevel.levelColor} hover:brightness-110 text-white font-black py-3 md:py-4 rounded-xl uppercase tracking-widest shadow-xl transition-all active:scale-[0.98] text-sm md:text-base">
                                Continue
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Добавляем CSS анимации если их ещё нет
        if (!document.getElementById('transfer-animations')) {
            const style = document.createElement('style');
            style.id = 'transfer-animations';
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes scaleIn {
                    from { transform: scale(0.9) translateY(20px); opacity: 0; }
                    to { transform: scale(1) translateY(0); opacity: 1; }
                }
                .animate-fadeIn {
                    animation: fadeIn 0.3s ease-out;
                }
                .animate-scaleIn {
                    animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    };
    
    // ИСПРАВЛЕНО: Глобальная функция для закрытия модального окна после покупки игрока
    window.closePlayerSignedModal = function() {
        const modal = document.getElementById('player-signed-modal');
        if (modal) {
            modal.remove();
        }
        console.log('Player signed modal closed');
    };

    console.log("Enhanced Transfer System v6 Landscape ready.");
})();

</script>
<!-- ENHANCED_TRANSFER_SYSTEM_END -->

<!-- ========== EXAMPLE MODS v4.0 ========== -->
<script>
// ============================================================
// EXAMPLE MOD 1: Budget Booster
// Добавляет €50M к бюджету команды при загрузке карьеры
// ============================================================
/*
ModAPI.registerMod({
    id: 'budget-booster',
    name: 'Budget Booster',
    version: '1.0.0',
    author: 'FootLogic',
    description: 'Adds €50M to your team budget when you load the game',
    
    init: function(api) {
        api.log('Budget Booster initialized');
    },
    
    onGameLoad: function(data) {
        const userTeam = ModAPI.getUserTeam();
        if (userTeam) {
            const bonus = 50000000;
            userTeam.budget = (userTeam.budget || 0) + bonus;
            ModAPI.showNotification(`💰 Budget Booster: +${ModAPI.formatMoney(bonus)}!`, 3000, 'success');
        }
    },
    
    onEnable: function(api) {
        api.showNotification('Budget Booster enabled!', 2000);
    },
    
    onDisable: function(api) {
        api.showNotification('Budget Booster disabled', 2000);
    }
});
*/

// ============================================================
// EXAMPLE MOD 2: Match Stats Tracker
// Отслеживает статистику матчей и показывает уведомления
// ============================================================
/*
ModAPI.registerMod({
    id: 'match-stats-tracker',
    name: 'Match Stats Tracker',
    version: '1.0.0',
    author: 'FootLogic',
    description: 'Tracks your match statistics and shows detailed notifications after each game',
    
    stats: {
        totalMatches: 0,
        wins: 0,
        draws: 0,
        losses: 0,
        goalsScored: 0,
        goalsConceded: 0
    },
    
    init: function(api) {
        // Загружаем сохранённую статистику
        api.loadModData('match-stats-tracker').then(data => {
            if (data) this.stats = data;
        });
    },
    
    onMatchEnd: function(matchData) {
        if (!matchData) return;
        
        const userTeamId = ModAPI.getUserTeamId();
        const isHome = matchData.homeId === userTeamId;
        const isAway = matchData.awayId === userTeamId;
        
        if (!isHome && !isAway) return;
        
        const ourGoals = isHome ? matchData.homeGoals : matchData.awayGoals;
        const theirGoals = isHome ? matchData.awayGoals : matchData.homeGoals;
        
        this.stats.totalMatches++;
        this.stats.goalsScored += ourGoals;
        this.stats.goalsConceded += theirGoals;
        
        if (ourGoals > theirGoals) {
            this.stats.wins++;
            ModAPI.showNotification(`🎉 WIN! ${ourGoals}-${theirGoals} | Record: ${this.stats.wins}W-${this.stats.draws}D-${this.stats.losses}L`, 4000, 'success');
        } else if (ourGoals < theirGoals) {
            this.stats.losses++;
            ModAPI.showNotification(`😔 Loss ${ourGoals}-${theirGoals} | Record: ${this.stats.wins}W-${this.stats.draws}D-${this.stats.losses}L`, 4000, 'error');
        } else {
            this.stats.draws++;
            ModAPI.showNotification(`🤝 Draw ${ourGoals}-${theirGoals} | Record: ${this.stats.wins}W-${this.stats.draws}D-${this.stats.losses}L`, 4000);
        }
        
        // Сохраняем статистику
        ModAPI.saveModData('match-stats-tracker', this.stats);
    }
});
*/

// ============================================================
// EXAMPLE MOD 3: Youth Academy Pro
// Генерирует молодых талантов каждый сезон
// ============================================================
/*
ModAPI.registerMod({
    id: 'youth-academy-pro',
    name: 'Youth Academy Pro',
    version: '1.0.0',
    author: 'FootLogic',
    description: 'Generates young talents for your team at the start of each season',
    
    config: {
        playersPerSeason: 2,
        minRating: 55,
        maxRating: 70,
        minPotential: 75,
        maxPotential: 92
    },
    
    init: function(api) {
        api.log('Youth Academy Pro initialized');
    },
    
    onSeasonStart: function(seasonData) {
        const api = ModAPI;
        const userTeam = api.getUserTeam();
        if (!userTeam) return;
        
        const youthNames = [
            'João Silva', 'Marco Rossi', 'Pierre Dubois', 'Hans Müller', 
            'Carlos García', 'Tom Williams', 'Ali Hassan', 'Yuki Tanaka',
            'Andrei Popov', 'Lars Eriksson', 'Ahmed Benali', 'Diego Costa'
        ];
        
        const positions = ['CB', 'CM', 'ST', 'LW', 'RW', 'CDM', 'CAM'];
        
        for (let i = 0; i < this.config.playersPerSeason; i++) {
            const rating = api.random(this.config.minRating, this.config.maxRating);
            const potential = api.random(Math.max(rating + 10, this.config.minPotential), this.config.maxPotential);
            
            const player = api.generatePlayer({
                name: api.randomPick(youthNames) + ' Jr.',
                age: api.random(16, 19),
                rating: rating,
                potential: potential,
                position: api.randomPick(positions)
            });
            
            api.addPlayerToTeam(player, userTeam.id);
        }
        
        api.showNotification(`⚽ Youth Academy: ${this.config.playersPerSeason} new talents joined!`, 4000, 'success');
    }
});
*/

// ============================================================
// EXAMPLE MOD 4: Transfer Market Modifier
// Модифицирует цены на трансферном рынке
// ============================================================
/*
ModAPI.registerMod({
    id: 'transfer-market-mod',
    name: 'Transfer Market Modifier',
    version: '1.0.0',
    author: 'FootLogic',
    description: 'Reduces all player values by 30% making transfers easier',
    
    priceMultiplier: 0.7, // 30% discount
    
    init: function(api) {
        // Перехватываем расчёт стоимости игроков
        api.intercept('calculatePlayerValue', (args, result) => {
            return Math.floor(result * this.priceMultiplier);
        }, 'transfer-market-mod');
        
        api.log('Transfer Market Modifier: Prices reduced by 30%');
    },
    
    onTransfer: function(transferData) {
        if (transferData && transferData.fee) {
            ModAPI.showNotification(`💸 Deal done! Saved ${ModAPI.formatMoney(transferData.fee * 0.3)} with discount!`, 3000);
        }
    }
});
*/

// ============================================================
// EXAMPLE MOD 5: Custom Dashboard Widget
// Добавляет виджет с информацией о команде на dashboard
// ============================================================
/*
ModAPI.registerMod({
    id: 'team-info-widget',
    name: 'Team Info Widget',
    version: '1.0.0',
    author: 'FootLogic',
    description: 'Adds a team overview widget to the dashboard',
    
    init: function(api) {
        // Добавляем виджет
        api.addDashboardWidget('team-overview', {
            title: 'Team Overview',
            position: 'bottom',
            modId: 'team-info-widget',
            render: function(api) {
                const team = api.getUserTeam();
                if (!team) return '';
                
                const avgRating = team.squad.length > 0 
                    ? (team.squad.reduce((sum, p) => sum + (p.rating || 0), 0) / team.squad.length).toFixed(1)
                    : 0;
                
                const avgAge = team.squad.length > 0
                    ? (team.squad.reduce((sum, p) => sum + (p.age || 0), 0) / team.squad.length).toFixed(1)
                    : 0;
                
                return `
                    <div class="bg-slate-800/50 rounded-xl p-4 border border-white/5 mt-4">
                        <h3 class="text-sm font-bold text-slate-400 uppercase mb-3">📊 Team Overview</h3>
                        <div class="grid grid-cols-4 gap-3 text-center">
                            <div>
                                <div class="text-2xl font-black text-white">${team.squad.length}</div>
                                <div class="text-xs text-slate-500">Squad Size</div>
                            </div>
                            <div>
                                <div class="text-2xl font-black text-emerald-400">${avgRating}</div>
                                <div class="text-xs text-slate-500">Avg Rating</div>
                            </div>
                            <div>
                                <div class="text-2xl font-black text-blue-400">${avgAge}</div>
                                <div class="text-xs text-slate-500">Avg Age</div>
                            </div>
                            <div>
                                <div class="text-2xl font-black text-yellow-400">${api.formatMoney(team.budget)}</div>
                                <div class="text-xs text-slate-500">Budget</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
    },
    
    onDisable: function(api) {
        api.removeWidget('team-overview');
    }
});
*/

// ============================================================
// EXAMPLE MOD 6: Auto-Training
// Автоматически тренирует всех игроков каждую неделю
// ============================================================
/*
ModAPI.registerMod({
    id: 'auto-training',
    name: 'Auto Training',
    version: '1.0.0',
    author: 'FootLogic',
    description: 'Automatically trains all your players each week, improving young players faster',
    
    init: function(api) {
        api.log('Auto Training system initialized');
    },
    
    onWeekEnd: function() {
        const api = ModAPI;
        const userTeam = api.getUserTeam();
        if (!userTeam || !userTeam.squad) return;
        
        let trained = 0;
        
        userTeam.squad.forEach(player => {
            // Молодые игроки тренируются лучше
            const ageBonus = player.age < 23 ? 0.3 : (player.age < 28 ? 0.1 : 0);
            const potentialRoom = (player.pot || player.rating) - player.rating;
            
            // Шанс на рост зависит от возраста и потенциала
            if (potentialRoom > 0 && api.chance(15 + ageBonus * 50)) {
                player.rating = Math.min(player.pot || 99, player.rating + 1);
                if (window.ModAPI) window.ModAPI.trigger("playerTrain", player);
                trained++;
                
                // Также улучшаем случайный стат
                const stats = ['speed', 'shot', 'pass', 'dribble', 'def', 'phys'];
                const randomStat = api.randomPick(stats);
                if (player[randomStat]) {
                    player[randomStat] = Math.min(99, player[randomStat] + 1);
                }
            }
        });
        
        if (trained > 0) {
            api.showNotification(`📈 Training: ${trained} player(s) improved!`, 2000, 'success');
        }
    }
});
*/

console.log("Example mods loaded. Uncomment any mod to activate it!");
</script>
<script src="super_scout.js"></script>
</body>
</html>